[{"path":"dns_query\\dns_query_win_vscode_tunnel_communication.yml","content":"title: DNS Query To Visual Studio Code Tunnels Domain\nid: b3e6418f-7c7a-4fad-993a-93b65027a9f1\nrelated:\n    - id: 9501f8e6-8e3d-48fc-a8a6-1089dd5d7ef4 # Net Connection DevTunnels\n      type: similar\n    - id: 4b657234-038e-4ad5-997c-4be42340bce4 # Net Connection VsCode\n      type: similar\n    - id: 1cb0c6ce-3d00-44fc-ab9c-6d6d577bf20b # DNS DevTunnels\n      type: similar\nstatus: test\ndescription: |\n    Detects DNS query requests to Visual Studio Code tunnel domains. Attackers can abuse that feature to establish a reverse shell or persistence on a machine.\nreferences:\n    - https://ipfyx.fr/post/visual-studio-code-tunnel/\n    - https://badoption.eu/blog/2023/01/31/code_c2.html\n    - https://cydefops.com/vscode-data-exfiltration\nauthor: citron_ninja\ndate: 2023-10-25\nmodified: 2023-11-20\ntags:\n    - attack.command-and-control\n    - attack.t1071.001\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|endswith: '.tunnels.api.visualstudio.com'\n    condition: selection\nfalsepositives:\n    - Legitimate use of Visual Studio Code tunnel will also trigger this.\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_ufile_io_query.yml","content":"title: DNS Query To Ufile.io\nid: 1cbbeaaf-3c8c-4e4c-9d72-49485b6a176b\nrelated:\n    - id: 090ffaad-c01a-4879-850c-6d57da98452d\n      type: similar\nstatus: test\ndescription: Detects DNS queries to \"ufile.io\", which was seen abused by malware and threat actors as a method for data exfiltration\nreferences:\n    - https://thedfirreport.com/2021/12/13/diavol-ransomware/\nauthor: yatinwad, TheDFIRReport\ndate: 2022-06-23\nmodified: 2023-09-18\ntags:\n    - attack.exfiltration\n    - attack.t1567.002\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|contains: 'ufile.io'\n    condition: selection\nfalsepositives:\n    - DNS queries for \"ufile\" are not malicious by nature necessarily. Investigate the source to determine the necessary actions to take\nlevel: low\n"},{"path":"dns_query\\dns_query_win_tor_onion_domain_query.yml","content":"title: DNS Query Tor .Onion Address - Sysmon\nid: b55ca2a3-7cff-4dda-8bdd-c7bfa63bf544\nrelated:\n    - id: 8384bd26-bde6-4da9-8e5d-4174a7a47ca2\n      type: similar\n    - id: a8322756-015c-42e7-afb1-436e85ed3ff5\n      type: similar\nstatus: test\ndescription: Detects DNS queries to an \".onion\" address related to Tor routing networks\nreferences:\n    - https://www.logpoint.com/en/blog/detecting-tor-use-with-logpoint/\n    - https://github.com/Azure/Azure-Sentinel/blob/f99542b94afe0ad2f19a82cc08262e7ac8e1428e/Detections/ASimDNS/imDNS_TorProxies.yaml\nauthor: frack113\ndate: 2022-02-20\nmodified: 2025-09-12\ntags:\n    - attack.command-and-control\n    - attack.t1090.003\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|endswith:\n            - '.hiddenservice.net'\n            - '.onion.ca'\n            - '.onion.cab'\n            - '.onion.casa'\n            - '.onion.city'\n            - '.onion.direct'\n            - '.onion.dog'\n            - '.onion.glass'\n            - '.onion.gq'\n            - '.onion.ink'\n            - '.onion.it'\n            - '.onion.link'\n            - '.onion.lt'\n            - '.onion.lu'\n            - '.onion.nu'\n            - '.onion.pet'\n            - '.onion.plus'\n            - '.onion.rip'\n            - '.onion.sh'\n            - '.onion.to'\n            - '.onion.top'\n            - '.onion'\n            - '.s1.tor-gateways.de'\n            - '.s2.tor-gateways.de'\n            - '.s3.tor-gateways.de'\n            - '.s4.tor-gateways.de'\n            - '.s5.tor-gateways.de'\n            - '.t2w.pw'\n            - '.tor2web.ae.org'\n            - '.tor2web.blutmagie.de'\n            - '.tor2web.com'\n            - '.tor2web.fi'\n            - '.tor2web.io'\n            - '.tor2web.org'\n            - '.tor2web.xyz'\n            - '.torlink.co'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"dns_query\\dns_query_win_teamviewer_domain_query_by_uncommon_app.yml","content":"title: TeamViewer Domain Query By Non-TeamViewer Application\nid: 778ba9a8-45e4-4b80-8e3e-34a419f0b85e\nstatus: test\ndescription: Detects DNS queries to a TeamViewer domain only resolved by a TeamViewer client by an image that isn't named TeamViewer (sometimes used by threat actors for obfuscation)\nreferences:\n    - https://www.teamviewer.com/en-us/\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-01-30\nmodified: 2023-09-18\ntags:\n    - attack.command-and-control\n    - attack.t1219.002\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName:\n            - 'taf.teamviewer.com'\n            - 'udp.ping.teamviewer.com'\n    filter_main_teamviewer:\n        # Note: To avoid evasion based on similar names. Best add full install location of TeamViewer\n        Image|contains: 'TeamViewer'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unknown binary names of TeamViewer\n    - Depending on the environment the rule might require some initial tuning before usage to avoid FP with third party applications\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_susp_external_ip_lookup.yml","content":"title: Suspicious DNS Query for IP Lookup Service APIs\nid: ec82e2a5-81ea-4211-a1f8-37a0286df2c2\nstatus: test\ndescription: Detects DNS queries for IP lookup services such as \"api.ipify.org\" originating from a non browser process.\nreferences:\n    - https://www.binarydefense.com/analysis-of-hancitor-when-boring-begets-beacon\n    - https://twitter.com/neonprimetime/status/1436376497980428318\n    - https://www.trendmicro.com/en_us/research/23/e/managed-xdr-investigation-of-ducktail-in-trend-micro-vision-one.html\nauthor: Brandon George (blog post), Thomas Patzke\ndate: 2021-07-08\nmodified: 2024-03-22\ntags:\n    - attack.reconnaissance\n    - attack.t1590\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        - QueryName:\n              - 'www.ip.cn'\n              - 'l2.io'\n        - QueryName|contains:\n              - 'api.2ip.ua'\n              - 'api.bigdatacloud.net'\n              - 'api.ipify.org'\n              - 'bot.whatismyipaddress.com'\n              - 'canireachthe.net'\n              - 'checkip.amazonaws.com'\n              - 'checkip.dyndns.org'\n              - 'curlmyip.com'\n              - 'db-ip.com'\n              - 'edns.ip-api.com'\n              - 'eth0.me'\n              - 'freegeoip.app'\n              - 'geoipy.com'\n              - 'getip.pro'\n              - 'icanhazip.com'\n              - 'ident.me'\n              - 'ifconfig.io'\n              - 'ifconfig.me'\n              - 'ip-api.com'\n              - 'ip.360.cn'\n              - 'ip.anysrc.net'\n              - 'ip.taobao.com'\n              - 'ip.tyk.nu'\n              - 'ipaddressworld.com'\n              - 'ipapi.co'\n              - 'ipconfig.io'\n              - 'ipecho.net'\n              - 'ipinfo.io'\n              - 'ipip.net'\n              - 'ipof.in'\n              - 'ipv4.icanhazip.com'\n              - 'ipv4bot.whatismyipaddress.com'\n              - 'ipv6-test.com'\n              - 'ipwho.is'\n              - 'jsonip.com'\n              - 'myexternalip.com'\n              - 'seeip.org'\n              - 'wgetip.com'\n              - 'whatismyip.akamai.com'\n              - 'whois.pconline.com.cn'\n              - 'wtfismyip.com'\n    filter_optional_brave:\n        Image|endswith: '\\brave.exe'\n    filter_optional_chrome:\n        Image:\n            - 'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe'\n            - 'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe'\n    filter_optional_firefox:\n        Image:\n            - 'C:\\Program Files\\Mozilla Firefox\\firefox.exe'\n            - 'C:\\Program Files (x86)\\Mozilla Firefox\\firefox.exe'\n    filter_optional_ie:\n        Image:\n            - 'C:\\Program Files (x86)\\Internet Explorer\\iexplore.exe'\n            - 'C:\\Program Files\\Internet Explorer\\iexplore.exe'\n    filter_optional_maxthon:\n        Image|endswith: '\\maxthon.exe'\n    filter_optional_edge_1:\n        - Image|startswith: 'C:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\'\n        - Image|endswith: '\\WindowsApps\\MicrosoftEdge.exe'\n        - Image:\n              - 'C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe'\n              - 'C:\\Program Files\\Microsoft\\Edge\\Application\\msedge.exe'\n    filter_optional_edge_2:\n        Image|startswith:\n            - 'C:\\Program Files (x86)\\Microsoft\\EdgeCore\\'\n            - 'C:\\Program Files\\Microsoft\\EdgeCore\\'\n        Image|endswith:\n            - '\\msedge.exe'\n            - '\\msedgewebview2.exe'\n    filter_optional_opera:\n        Image|endswith: '\\opera.exe'\n    filter_optional_safari:\n        Image|endswith: '\\safari.exe'\n    filter_optional_seamonkey:\n        Image|endswith: '\\seamonkey.exe'\n    filter_optional_vivaldi:\n        Image|endswith: '\\vivaldi.exe'\n    filter_optional_whale:\n        Image|endswith: '\\whale.exe'\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Legitimate usage of IP lookup services such as ipify API\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_remote_access_software_domains_non_browsers.yml","content":"title: DNS Query To Remote Access Software Domain From Non-Browser App\nid: 4d07b1f4-cb00-4470-b9f8-b0191d48ff52\nrelated:\n    - id: 71ba22cb-8a01-42e2-a6dd-5bf9b547498f\n      type: obsolete\n    - id: 7c4cf8e0-1362-48b2-a512-b606d2065d7d\n      type: obsolete\n    - id: ed785237-70fa-46f3-83b6-d264d1dc6eb4\n      type: obsolete\nstatus: test\ndescription: |\n    An adversary may use legitimate desktop support and remote access software, such as Team Viewer, Go2Assist, LogMein, AmmyyAdmin, etc, to establish an interactive command and control channel to target systems within networks.\n    These services are commonly used as legitimate technical support software, and may be allowed by application control within a target environment.\n    Remote access tools like VNC, Ammyy, and Teamviewer are used frequently when compared with other legitimate software commonly used by adversaries. (Citation: Symantec Living off the Land)\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1219/T1219.md#atomic-test-4---gotoassist-files-detected-test-on-windows\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1219/T1219.md#atomic-test-3---logmein-files-detected-test-on-windows\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1219/T1219.md#atomic-test-6---ammyy-admin-software-execution\n    - https://redcanary.com/blog/misbehaving-rats/\n    - https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/hunting-for-omi-vulnerability-exploitation-with-azure-sentinel/ba-p/2764093\n    - https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-320a\n    - https://blog.sekoia.io/scattered-spider-laying-new-eggs/\n    - https://learn.microsoft.com/en-us/windows/client-management/client-tools/quick-assist#disable-quick-assist-within-your-organization\nauthor: frack113, Connor Martin\ndate: 2022-07-11\nmodified: 2024-12-17\ntags:\n    - attack.command-and-control\n    - attack.t1219.002\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection_generic:\n        QueryName|endswith:\n            - 'agent.jumpcloud.com'\n            - 'agentreporting.atera.com'\n            - 'ammyy.com'\n            - 'api.parsec.app'\n            - 'api.playanext.com'\n            - 'api.splashtop.com'\n            - 'app.atera.com'\n            - 'assist.zoho.com'\n            - 'authentication.logmeininc.com'\n            - 'beyondtrustcloud.com'\n            - 'cdn.kaseya.net'\n            - 'client.teamviewer.com'\n            - 'comserver.corporate.beanywhere.com'\n            - 'control.connectwise.com'\n            - 'downloads.zohocdn.com'\n            - 'dwservice.net'\n            - 'express.gotoassist.com'\n            - 'getgo.com'\n            - 'getscreen.me'  # https://x.com/malmoeb/status/1868757130624614860?s=12&t=C0_T_re0wRP_NfKa27Xw9w\n            - 'integratedchat.teamviewer.com'\n            - 'join.zoho.com'\n            - 'kickstart.jumpcloud.com'\n            - 'license.bomgar.com'\n            - 'logmein-gateway.com'\n            - 'logmein.com'\n            - 'logmeincdn.http.internapcdn.net'\n            - 'n-able.com'\n            - 'net.anydesk.com'\n            - 'netsupportsoftware.com' # For NetSupport Manager RAT\n            - 'parsecusercontent.com'\n            - 'pubsub.atera.com'\n            - 'relay.kaseya.net'\n            - 'relay.screenconnect.com'\n            - 'relay.splashtop.com'\n            - 'remoteassistance.support.services.microsoft.com' # Quick Assist Application\n            - 'remotedesktop-pa.googleapis.com'\n            - 'remoteutilities.com' # Usage of Remote Utilities RAT\n            - 'secure.logmeinrescue.com'\n            - 'services.vnc.com'\n            - 'static.remotepc.com'\n            - 'swi-rc.com'\n            - 'swi-tc.com'\n            - 'tailscale.com' # Scattered Spider threat group used this RMM tool\n            - 'telemetry.servers.qetqo.com'\n            - 'tmate.io'\n            - 'twingate.com'  # Scattered Spider threat group used this RMM tool\n            - 'zohoassist.com'\n    selection_rustdesk:  # https://twitter.com/malmoeb/status/1668504345132822531?s=20 and https://www.adamsdesk.com/posts/rustdesk-not-connecting/ mention this pattern\n        QueryName|endswith: '.rustdesk.com'\n        QueryName|startswith: 'rs-'\n    # Exclude browsers for legitimate visits of the domains mentioned above\n    # Add missing browsers you use and exclude the ones you don't\n    filter_optional_chrome:\n        Image:\n            - 'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe'\n            - 'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe'\n    filter_optional_firefox:\n        Image:\n            - 'C:\\Program Files\\Mozilla Firefox\\firefox.exe'\n            - 'C:\\Program Files (x86)\\Mozilla Firefox\\firefox.exe'\n    filter_optional_ie:\n        Image:\n            - 'C:\\Program Files (x86)\\Internet Explorer\\iexplore.exe'\n            - 'C:\\Program Files\\Internet Explorer\\iexplore.exe'\n    filter_optional_edge_1:\n        - Image|startswith: 'C:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\'\n        - Image|endswith: '\\WindowsApps\\MicrosoftEdge.exe'\n        - Image:\n              - 'C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe'\n              - 'C:\\Program Files\\Microsoft\\Edge\\Application\\msedge.exe'\n    filter_optional_edge_2:\n        Image|startswith:\n            - 'C:\\Program Files (x86)\\Microsoft\\EdgeCore\\'\n            - 'C:\\Program Files\\Microsoft\\EdgeCore\\'\n        Image|endswith:\n            - '\\msedge.exe'\n            - '\\msedgewebview2.exe'\n    filter_optional_safari:\n        Image|endswith: '\\safari.exe'\n    filter_optional_defender:\n        Image|endswith:\n            - '\\MsMpEng.exe' # Microsoft Defender executable\n            - '\\MsSense.exe' # Windows Defender Advanced Threat Protection Service Executable\n    filter_optional_brave:\n        Image|endswith: '\\brave.exe'\n        Image|startswith: 'C:\\Program Files\\BraveSoftware\\'\n    filter_optional_maxthon:\n        Image|contains: '\\AppData\\Local\\Maxthon\\'\n        Image|endswith: '\\maxthon.exe'\n    filter_optional_opera:\n        Image|contains: '\\AppData\\Local\\Programs\\Opera\\'\n        Image|endswith: '\\opera.exe'\n    filter_optional_seamonkey:\n        Image|startswith:\n            - 'C:\\Program Files\\SeaMonkey\\'\n            - 'C:\\Program Files (x86)\\SeaMonkey\\'\n        Image|endswith: '\\seamonkey.exe'\n    filter_optional_vivaldi:\n        Image|contains: '\\AppData\\Local\\Vivaldi\\'\n        Image|endswith: '\\vivaldi.exe'\n    filter_optional_whale:\n        Image|startswith:\n            - 'C:\\Program Files\\Naver\\Naver Whale\\'\n            - 'C:\\Program Files (x86)\\Naver\\Naver Whale\\'\n        Image|endswith: '\\whale.exe'\n    filter_optional_tor:\n        Image|contains: '\\Tor Browser\\'\n    filter_optional_whaterfox:\n        Image|startswith:\n            - 'C:\\Program Files\\Waterfox\\'\n            - 'C:\\Program Files (x86)\\Waterfox\\'\n        Image|endswith: '\\Waterfox.exe'\n    filter_optional_midori:\n        Image|contains: '\\AppData\\Local\\Programs\\midori-ng\\'\n        Image|endswith: '\\Midori Next Generation.exe'\n    filter_optional_slimbrowser:\n        Image|startswith:\n            - 'C:\\Program Files\\SlimBrowser\\'\n            - 'C:\\Program Files (x86)\\SlimBrowser\\'\n        Image|endswith: '\\slimbrowser.exe'\n    filter_optional_flock:\n        Image|contains: '\\AppData\\Local\\Flock\\'\n        Image|endswith: '\\Flock.exe'\n    filter_optional_phoebe:\n        Image|contains: '\\AppData\\Local\\Phoebe\\'\n        Image|endswith: '\\Phoebe.exe'\n    filter_optional_falkon:\n        Image|startswith:\n            - 'C:\\Program Files\\Falkon\\'\n            - 'C:\\Program Files (x86)\\Falkon\\'\n        Image|endswith: '\\falkon.exe'\n    filter_optional_avant:\n        Image|startswith:\n            - 'C:\\Program Files (x86)\\Avant Browser\\'\n            - 'C:\\Program Files\\Avant Browser\\'\n        Image|endswith: '\\avant.exe'\n    condition: 1 of selection_* and not 1 of filter_optional_*\nfalsepositives:\n    - Likely with other browser software. Apply additional filters for any other browsers you might use.\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_regsvr32_dns_query.yml","content":"title: DNS Query Request By Regsvr32.EXE\nid: 36e037c4-c228-4866-b6a3-48eb292b9955\nrelated:\n    - id: c7e91a02-d771-4a6d-a700-42587e0b1095\n      type: derived\nstatus: test\ndescription: Detects DNS queries initiated by \"Regsvr32.exe\"\nreferences:\n    - https://pentestlab.blog/2017/05/11/applocker-bypass-regsvr32/\n    - https://oddvar.moe/2017/12/13/applocker-case-study-how-insecure-is-it-really-part-1/\nauthor: Dmitriy Lifanov, oscd.community\ndate: 2019-10-25\nmodified: 2023-09-18\ntags:\n    - attack.execution\n    - attack.t1559.001\n    - attack.defense-evasion\n    - attack.t1218.010\nlogsource:\n    category: dns_query\n    product: windows\ndetection:\n    selection:\n        Image|endswith: '\\regsvr32.exe'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_quickassist.yml","content":"title: DNS Query Request By QuickAssist.EXE\nid: 882e858a-3233-4ba8-855e-2f3d3575803d\nstatus: experimental\ndescription: |\n    Detects DNS queries initiated by \"QuickAssist.exe\" to Microsoft Quick Assist primary endpoint that is used to establish a session.\nreferences:\n    - https://www.microsoft.com/en-us/security/blog/2024/05/15/threat-actors-misusing-quick-assist-in-social-engineering-attacks-leading-to-ransomware/\n    - https://www.linkedin.com/posts/kevin-beaumont-security_ive-been-assisting-a-few-orgs-hit-with-successful-activity-7268055739116445701-xxjZ/\n    - https://x.com/cyb3rops/status/1862406110365245506\n    - https://learn.microsoft.com/en-us/windows/client-management/client-tools/quick-assist\nauthor: Muhammad Faisal (@faisalusuf)\ndate: 2024-12-19\ntags:\n    - attack.command-and-control\n    - attack.initial-access\n    - attack.lateral-movement\n    - attack.t1071.001\n    - attack.t1210\nlogsource:\n    category: dns_query\n    product: windows\ndetection:\n    selection:\n        Image|endswith: '\\QuickAssist.exe'\n        QueryName|endswith: 'remoteassistance.support.services.microsoft.com'\n    condition: selection\nfalsepositives:\n    - Legitimate use of Quick Assist in the environment.\nlevel: low\n"},{"path":"dns_query\\dns_query_win_onelaunch_update_service.yml","content":"title: DNS Query Request To OneLaunch Update Service\nid: df68f791-ad95-447f-a271-640a0dab9cf8\nstatus: test\ndescription: |\n    Detects DNS query requests to \"update.onelaunch.com\". This domain is associated with the OneLaunch adware application.\n    When the OneLaunch application is installed it will attempt to get updates from this domain.\nreferences:\n    - https://www.malwarebytes.com/blog/detections/pup-optional-onelaunch-silentcf\n    - https://www.myantispyware.com/2020/12/14/how-to-uninstall-onelaunch-browser-removal-guide/\n    - https://malware.guide/browser-hijacker/remove-onelaunch-virus/\nauthor: Josh Nickels\ndate: 2024-02-26\ntags:\n    - attack.credential-access\n    - attack.collection\n    - attack.t1056\nlogsource:\n    category: dns_query\n    product: windows\ndetection:\n    selection:\n        QueryName: 'update.onelaunch.com'\n        Image|endswith: '\\OneLaunch.exe'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: low\n"},{"path":"dns_query\\dns_query_win_mega_nz.yml","content":"title: DNS Query To MEGA Hosting Website\nid: 613c03ba-0779-4a53-8a1f-47f914a4ded3\nrelated:\n    - id: 66474410-b883-415f-9f8d-75345a0a66a6\n      type: similar\nstatus: test\ndescription: Detects DNS queries for subdomains related to MEGA sharing website\nreferences:\n    - https://research.nccgroup.com/2021/05/27/detecting-rclone-an-effective-tool-for-exfiltration/\nauthor: Aaron Greetham (@beardofbinary) - NCC Group\ndate: 2021-05-26\nmodified: 2023-09-18\ntags:\n    - attack.exfiltration\n    - attack.t1567.002\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|contains: 'userstorage.mega.co.nz'\n    condition: selection\nfalsepositives:\n    - Legitimate DNS queries and usage of Mega\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_mal_cobaltstrike.yml","content":"title: Suspicious Cobalt Strike DNS Beaconing - Sysmon\nid: f356a9c4-effd-4608-bbf8-408afd5cd006\nrelated:\n    - id: 0d18728b-f5bf-4381-9dcf-915539fff6c2\n      type: similar\nstatus: test\ndescription: Detects a program that invoked suspicious DNS queries known from Cobalt Strike beacons\nreferences:\n    - https://www.icebrg.io/blog/footprints-of-fin7-tracking-actor-patterns\n    - https://www.sekoia.io/en/hunting-and-detecting-cobalt-strike/\nauthor: Florian Roth (Nextron Systems)\ndate: 2021-11-09\nmodified: 2023-01-16\ntags:\n    - attack.command-and-control\n    - attack.t1071.004\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection1:\n        QueryName|startswith:\n            - 'aaa.stage.'\n            - 'post.1'\n    selection2:\n        QueryName|contains: '.stage.123456.'\n    condition: 1 of selection*\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"dns_query\\dns_query_win_kerberos_coercion_via_dns_object_spoofing.yml","content":"title: Suspicious DNS Query Indicating Kerberos Coercion via DNS Object SPN Spoofing\nid: e7a21b5f-d8c4-4ae5-b8d9-93c5d3f28e1c\nrelated:\n    - id: b07e58cf-cacc-4135-8473-ccb2eba63dd2 # Potential Kerberos Coercion via DNS Object Spoofing\n      type: similar\n    - id: 5588576c-5898-4fac-bcdd-7475a60e8f43 # Suspicious DNS Query Indicating Kerberos Coercion via DNS Object Spoofing - Network\n      type: similar\nstatus: experimental\ndescription: |\n    Detects DNS queries containing patterns associated with Kerberos coercion attacks via DNS object spoofing.\n    The pattern \"1UWhRCAAAAA..BAAAA\" is a base64-encoded signature that corresponds to a marshaled CREDENTIAL_TARGET_INFORMATION structure.\n    Attackers can use this technique to coerce authentication from victim systems to attacker-controlled hosts.\n    It is one of the strong indicators of a Kerberos coercion attack, where adversaries manipulate DNS records\n    to spoof Service Principal Names (SPNs) and redirect authentication requests like CVE-2025-33073.\nreferences:\n    - https://www.synacktiv.com/publications/ntlm-reflection-is-dead-long-live-ntlm-reflection-an-in-depth-analysis-of-cve-2025\n    - https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html\nauthor: Swachchhanda Shrawan Poudel (Nextron Systems)\ndate: 2025-06-20\ntags:\n    - attack.collection\n    - attack.credential-access\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1557.001\n    - attack.t1187\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|contains|all:\n            - 'UWhRCA'\n            - 'BAAAA'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"dns_query\\dns_query_win_hybridconnectionmgr_servicebus.yml","content":"title: DNS HybridConnectionManager Service Bus\nid: 7bd3902d-8b8b-4dd4-838a-c6862d40150d\nstatus: test\ndescription: Detects Azure Hybrid Connection Manager services querying the Azure service bus service\nreferences:\n    - https://twitter.com/Cyb3rWard0g/status/1381642789369286662\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2021-04-12\nmodified: 2023-01-16\ntags:\n    - attack.persistence\n    - attack.t1554\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|contains: 'servicebus.windows.net'\n        Image|contains: 'HybridConnectionManager'\n    condition: selection\nfalsepositives:\n    - Legitimate use of Azure Hybrid Connection Manager and the Azure Service Bus service\nlevel: high\n"},{"path":"dns_query\\dns_query_win_finger.yml","content":"title: DNS Query by Finger Utility\nid: c082c2b0-525b-4dbc-9a26-a57dc4692074\nrelated:\n    - id: 2fdaf50b-9fd5-449f-ba69-f17248119af6\n      type: similar\n    - id: af491bca-e752-4b44-9c86-df5680533dbc\n      type: similar\nstatus: experimental\ndescription: |\n    Detects DNS queries made by the finger utility, which can be abused by threat actors to retrieve remote commands for execution on Windows devices.\n    In one ClickFix malware campaign, adversaries leveraged the finger protocol to fetch commands from a remote server.\n    Since the finger utility is not commonly used in modern Windows environments, its presence already raises suspicion.\n    Investigating such DNS queries can also help identify potential malicious infrastructure used by threat actors for command and control (C2) communication.\nreferences:\n    - https://www.bleepingcomputer.com/news/security/decades-old-finger-protocol-abused-in-clickfix-malware-attacks/\nauthor: Swachchhanda Shrawan Poudel (Nextron Systems)\ndate: 2025-11-19\ntags:\n    - attack.command-and-control\n    - attack.t1071.004\n    - attack.execution\n    - attack.t1059.003\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        Image|endswith: '\\finger.exe'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"dns_query\\dns_query_win_domain_azurewebsites.yml","content":"title: DNS Query To AzureWebsites.NET By Non-Browser Process\nid: e043f529-8514-4205-8ab0-7f7d2927b400\nrelated:\n    - id: 5c80b618-0dbb-46e6-acbb-03d90bcb6d83\n      type: derived\nstatus: test\ndescription: |\n    Detects a DNS query by a non browser process on the system to \"azurewebsites.net\". The latter was often used by threat actors as a malware hosting and exfiltration site.\nreferences:\n    - https://www.sentinelone.com/labs/wip26-espionage-threat-actors-abuse-cloud-infrastructure-in-targeted-telco-attacks/\n    - https://symantec-enterprise-blogs.security.com/threat-intelligence/harvester-new-apt-attacks-asia\n    - https://www.ptsecurity.com/ww-en/analytics/pt-esc-threat-intelligence/higaisa-or-winnti-apt-41-backdoors-old-and-new/\n    - https://intezer.com/blog/research/how-we-escaped-docker-in-azure-functions/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2024-06-24\ntags:\n    - attack.command-and-control\n    - attack.t1219.002\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|endswith: 'azurewebsites.net'\n    filter_optional_chrome:\n        Image:\n            - 'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe'\n            - 'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe'\n    filter_optional_firefox:\n        Image:\n            - 'C:\\Program Files\\Mozilla Firefox\\firefox.exe'\n            - 'C:\\Program Files (x86)\\Mozilla Firefox\\firefox.exe'\n    filter_optional_ie:\n        Image:\n            - 'C:\\Program Files (x86)\\Internet Explorer\\iexplore.exe'\n            - 'C:\\Program Files\\Internet Explorer\\iexplore.exe'\n    filter_optional_edge_1:\n        - Image|startswith: 'C:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\'\n        - Image|endswith: '\\WindowsApps\\MicrosoftEdge.exe'\n        - Image:\n              - 'C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe'\n              - 'C:\\Program Files\\Microsoft\\Edge\\Application\\msedge.exe'\n    filter_optional_edge_2:\n        Image|startswith:\n            - 'C:\\Program Files (x86)\\Microsoft\\EdgeCore\\'\n            - 'C:\\Program Files\\Microsoft\\EdgeCore\\'\n        Image|endswith:\n            - '\\msedge.exe'\n            - '\\msedgewebview2.exe'\n    filter_optional_safari:\n        Image|endswith: '\\safari.exe'\n    filter_optional_defender:\n        Image|endswith:\n            - '\\MsMpEng.exe' # Microsoft Defender executable\n            - '\\MsSense.exe' # Windows Defender Advanced Threat Protection Service Executable\n    filter_optional_brave:\n        Image|endswith: '\\brave.exe'\n        Image|startswith: 'C:\\Program Files\\BraveSoftware\\'\n    filter_optional_maxthon:\n        Image|contains: '\\AppData\\Local\\Maxthon\\'\n        Image|endswith: '\\maxthon.exe'\n    filter_optional_opera:\n        Image|contains: '\\AppData\\Local\\Programs\\Opera\\'\n        Image|endswith: '\\opera.exe'\n    filter_optional_seamonkey:\n        Image|startswith:\n            - 'C:\\Program Files\\SeaMonkey\\'\n            - 'C:\\Program Files (x86)\\SeaMonkey\\'\n        Image|endswith: '\\seamonkey.exe'\n    filter_optional_vivaldi:\n        Image|contains: '\\AppData\\Local\\Vivaldi\\'\n        Image|endswith: '\\vivaldi.exe'\n    filter_optional_whale:\n        Image|startswith:\n            - 'C:\\Program Files\\Naver\\Naver Whale\\'\n            - 'C:\\Program Files (x86)\\Naver\\Naver Whale\\'\n        Image|endswith: '\\whale.exe'\n    filter_optional_tor:\n        Image|contains: '\\Tor Browser\\'\n    filter_optional_whaterfox:\n        Image|startswith:\n            - 'C:\\Program Files\\Waterfox\\'\n            - 'C:\\Program Files (x86)\\Waterfox\\'\n        Image|endswith: '\\Waterfox.exe'\n    filter_optional_midori:\n        Image|contains: '\\AppData\\Local\\Programs\\midori-ng\\'\n        Image|endswith: '\\Midori Next Generation.exe'\n    filter_optional_slimbrowser:\n        Image|startswith:\n            - 'C:\\Program Files\\SlimBrowser\\'\n            - 'C:\\Program Files (x86)\\SlimBrowser\\'\n        Image|endswith: '\\slimbrowser.exe'\n    filter_optional_flock:\n        Image|contains: '\\AppData\\Local\\Flock\\'\n        Image|endswith: '\\Flock.exe'\n    filter_optional_phoebe:\n        Image|contains: '\\AppData\\Local\\Phoebe\\'\n        Image|endswith: '\\Phoebe.exe'\n    filter_optional_falkon:\n        Image|startswith:\n            - 'C:\\Program Files\\Falkon\\'\n            - 'C:\\Program Files (x86)\\Falkon\\'\n        Image|endswith: '\\falkon.exe'\n    filter_optional_avant:\n        Image|startswith:\n            - 'C:\\Program Files (x86)\\Avant Browser\\'\n            - 'C:\\Program Files\\Avant Browser\\'\n        Image|endswith: '\\avant.exe'\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Likely with other browser software. Apply additional filters for any other browsers you might use.\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_dns_server_discovery_via_ldap_query.yml","content":"title: DNS Server Discovery Via LDAP Query\nid: a21bcd7e-38ec-49ad-b69a-9ea17e69509e\nstatus: test\ndescription: Detects DNS server discovery via LDAP query requests from uncommon applications\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/980f3f83fd81f37c1ca9c02dccfd1c3d9f9d0841/atomics/T1016/T1016.md#atomic-test-9---dns-server-discovery-using-nslookup\n    - https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/7fcdce70-5205-44d6-9c3a-260e616a2f04\nauthor: frack113\ndate: 2022-08-20\nmodified: 2023-09-18\ntags:\n    - attack.discovery\n    - attack.t1482\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|startswith: '_ldap.'\n    filter_main_generic:\n        Image|contains:\n            - ':\\Program Files\\'\n            - ':\\Program Files (x86)\\'\n            - ':\\Windows\\'\n    filter_main_defender:\n        Image|contains: ':\\ProgramData\\Microsoft\\Windows Defender\\Platform\\'\n        Image|endswith: '\\MsMpEng.exe'\n    filter_main_unknown:\n        Image: '<unknown process>'\n    filter_optional_azure:\n        Image|startswith: 'C:\\WindowsAzure\\GuestAgent'\n    filter_main_null:\n        Image: null\n    filter_optional_browsers:\n        # Note: This list is for browsers installed in the user context. To avoid basic evasions based on image name. Best to baseline this list with the browsers you use internally and add their full paths.\n        Image|endswith:\n            - '\\chrome.exe'\n            - '\\firefox.exe'\n            - '\\opera.exe'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Likely\n# Note: Incrase the level once a baseline is established\nlevel: low\n"},{"path":"dns_query\\dns_query_win_devtunnels_communication.yml","content":"title: DNS Query To Devtunnels Domain\nid: 1cb0c6ce-3d00-44fc-ab9c-6d6d577bf20b\nrelated:\n    - id: 9501f8e6-8e3d-48fc-a8a6-1089dd5d7ef4 # Net Connection DevTunnels\n      type: similar\n    - id: 4b657234-038e-4ad5-997c-4be42340bce4 # Net Connection VsCode\n      type: similar\n    - id: b3e6418f-7c7a-4fad-993a-93b65027a9f1 # DNS VsCode\n      type: similar\nstatus: test\ndescription: |\n    Detects DNS query requests to Devtunnels domains. Attackers can abuse that feature to establish a reverse shell or persistence on a machine.\nreferences:\n    - https://blueteamops.medium.com/detecting-dev-tunnels-16f0994dc3e2\n    - https://learn.microsoft.com/en-us/azure/developer/dev-tunnels/security\n    - https://cydefops.com/devtunnels-unleashed\nauthor: citron_ninja\ndate: 2023-10-25\nmodified: 2023-11-20\ntags:\n    - attack.command-and-control\n    - attack.t1071.001\n    - attack.t1572\nlogsource:\n    category: dns_query\n    product: windows\ndetection:\n    selection:\n        QueryName|endswith: '.devtunnels.ms'\n    condition: selection\nfalsepositives:\n    - Legitimate use of Devtunnels will also trigger this.\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_common_malware_hosting_services.yml","content":"title: DNS Query To Common Malware Hosting and Shortener Services\nid: f8c1e80b-c73a-476a-ae24-6c72528b1521\nstatus: experimental\ndescription: |\n    Detects DNS queries to domains commonly used by threat actors to host malware payloads or redirect through URL shorteners.\n    These include platforms like Cloudflare Workers, TryCloudflare, InfinityFree, and URL shorteners such as tinyurl and lihi.cc.\n    Such DNS activity can indicate potential delivery or command-and-control communication attempts.\nreferences:\n    - https://cloud.google.com/blog/topics/threat-intelligence/apt41-innovative-tactics\nauthor: Ahmed Nosir (@egycondor)\ndate: 2025-06-02\ntags:\n    - attack.command-and-control\n    - attack.t1071.004\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|contains:\n            - 'msapp.workers.dev'\n            - 'trycloudflare.com'\n            - 'infinityfreeapp.com'\n            - 'my5353.com'\n            - 'reurl.cc'\n            - 'lihi.cc'\n            - 'tinyurl.com'\n    condition: selection\nfalsepositives:\n    - Legitimate use of these services is possible but rare in enterprise environments\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_cloudflared_communication.yml","content":"title: Cloudflared Tunnels Related DNS Requests\nid: a1d9eec5-33b2-4177-8d24-27fe754d0812\nrelated:\n    - id: 7cd1dcdc-6edf-4896-86dc-d1f19ad64903\n      type: similar\nstatus: test\ndescription: |\n    Detects DNS requests to Cloudflared tunnels domains.\n    Attackers can abuse that feature to establish a reverse shell or persistence on a machine.\nreferences:\n    - https://www.guidepointsecurity.com/blog/tunnel-vision-cloudflared-abused-in-the-wild/\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-12-20\ntags:\n    - attack.command-and-control\n    - attack.t1071.001\n    - attack.t1572\nlogsource:\n    category: dns_query\n    product: windows\ndetection:\n    selection:\n        QueryName|endswith:\n            - '.v2.argotunnel.com'\n            - 'protocol-v2.argotunnel.com'\n            - 'trycloudflare.com'\n            - 'update.argotunnel.com'\n    condition: selection\nfalsepositives:\n    - Legitimate use of cloudflare tunnels will also trigger this.\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_appinstaller.yml","content":"title: AppX Package Installation Attempts Via AppInstaller.EXE\nid: 7cff77e1-9663-46a3-8260-17f2e1aa9d0a\nrelated:\n    - id: 180c7c5c-d64b-4a63-86e9-68910451bc8b\n      type: derived\nstatus: test\ndescription: |\n    Detects DNS queries made by \"AppInstaller.EXE\". The AppInstaller is the default handler for the \"ms-appinstaller\" URI. It attempts to load/install a package from the referenced URL\nreferences:\n    - https://twitter.com/notwhickey/status/1333900137232523264\n    - https://lolbas-project.github.io/lolbas/Binaries/AppInstaller/\nauthor: frack113\ndate: 2021-11-24\nmodified: 2023-11-09\ntags:\n    - attack.command-and-control\n    - attack.t1105\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        Image|startswith: 'C:\\Program Files\\WindowsApps\\Microsoft.DesktopAppInstaller_'\n        Image|endswith: '\\AppInstaller.exe'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"dns_query\\dns_query_win_anonymfiles_com.yml","content":"title: DNS Query for Anonfiles.com Domain - Sysmon\nid: 065cceea-77ec-4030-9052-fc0affea7110\nrelated:\n    - id: 29f171d7-aa47-42c7-9c7b-3c87938164d9\n      type: similar\nstatus: test\ndescription: Detects DNS queries for \"anonfiles.com\", which is an anonymous file upload platform often used for malicious purposes\nreferences:\n    - https://www.trendmicro.com/vinfo/us/security/news/ransomware-spotlight/ransomware-spotlight-blackbyte\nauthor: pH-T (Nextron Systems)\ndate: 2022-07-15\nmodified: 2023-01-16\ntags:\n    - attack.exfiltration\n    - attack.t1567.002\nlogsource:\n    product: windows\n    category: dns_query\ndetection:\n    selection:\n        QueryName|contains: '.anonfiles.com'\n    condition: selection\nfalsepositives:\n    - Rare legitimate access to anonfiles.com\nlevel: high\n"}]