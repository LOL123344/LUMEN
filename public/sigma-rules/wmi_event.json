[{"path":"wmi_event\\sysmon_wmi_susp_scripting.yml","content":"title: Suspicious Scripting in a WMI Consumer\nid: fe21810c-2a8c-478f-8dd3-5a287fb2a0e0\nstatus: test\ndescription: Detects suspicious commands that are related to scripting/powershell in WMI Event Consumers\nreferences:\n    - https://in.security/an-intro-into-abusing-and-identifying-wmi-event-subscriptions-for-persistence/\n    - https://github.com/Neo23x0/signature-base/blob/615bf1f6bac3c1bdc417025c40c073e6c2771a76/yara/gen_susp_lnk_files.yar#L19\n    - https://github.com/RiccardoAncarani/LiquidSnake\nauthor: Florian Roth (Nextron Systems), Jonhnathan Ribeiro\ndate: 2019-04-15\nmodified: 2023-09-09\ntags:\n    - attack.execution\n    - attack.t1059.005\nlogsource:\n    product: windows\n    category: wmi_event\ndetection:\n    selection_destination:\n        - Destination|contains|all:\n              - 'new-object'\n              - 'net.webclient'\n              - '.downloadstring'\n        - Destination|contains|all:\n              - 'new-object'\n              - 'net.webclient'\n              - '.downloadfile'\n        - Destination|contains:\n              - ' iex('\n              - ' -nop '\n              - ' -noprofile '\n              - ' -decode '\n              - ' -enc '\n              - 'WScript.Shell'\n              - 'System.Security.Cryptography.FromBase64Transform'\n    condition: selection_destination\nfalsepositives:\n    - Legitimate administrative scripts\nlevel: high\n"},{"path":"wmi_event\\sysmon_wmi_susp_encoded_scripts.yml","content":"title: Suspicious Encoded Scripts in a WMI Consumer\nid: 83844185-1c5b-45bc-bcf3-b5bf3084ca5b\nstatus: test\ndescription: Detects suspicious encoded payloads in WMI Event Consumers\nreferences:\n    - https://github.com/RiccardoAncarani/LiquidSnake\nauthor: Florian Roth (Nextron Systems)\ndate: 2021-09-01\nmodified: 2022-10-09\ntags:\n    - attack.privilege-escalation\n    - attack.execution\n    - attack.t1047\n    - attack.persistence\n    - attack.t1546.003\nlogsource:\n    product: windows\n    category: wmi_event\ndetection:\n    selection_destination:\n        Destination|base64offset|contains:\n            - 'WriteProcessMemory'\n            - 'This program cannot be run in DOS mode'\n            - 'This program must be run under Win32'\n    condition: selection_destination\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"wmi_event\\sysmon_wmi_event_subscription.yml","content":"title: WMI Event Subscription\nid: 0f06a3a5-6a09-413f-8743-e6cf35561297\nstatus: test\ndescription: Detects creation of WMI event subscription persistence method\nreferences:\n    - https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#event-id-19-wmievent-wmieventfilter-activity-detected\n    - https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#event-id-20-wmievent-wmieventconsumer-activity-detected\n    - https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#event-id-21-wmievent-wmieventconsumertofilter-activity-detected\nauthor: Tom Ueltschi (@c_APT_ure)\ndate: 2019-01-12\nmodified: 2021-11-27\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1546.003\nlogsource:\n    product: windows\n    category: wmi_event\ndetection:\n    selection:\n        EventID:\n            - 19\n            - 20\n            - 21\n    condition: selection\nfalsepositives:\n    - Exclude legitimate (vetted) use of WMI event subscription in your network\nlevel: medium\n"}]