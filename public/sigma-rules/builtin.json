[{"path":"builtin\\win_alert_mimikatz_keywords.yml","content":"title: Mimikatz Use\nid: 06d71506-7beb-4f22-8888-e2e5e2ca7fd8\nstatus: test\ndescription: This method detects mimikatz keywords in different Eventlogs (some of them only appear in older Mimikatz version that are however still used by different threat groups)\nreferences:\n    - https://tools.thehacker.recipes/mimikatz/modules\nauthor: Florian Roth (Nextron Systems), David ANDRE (additional keywords)\ndate: 2017-01-10\nmodified: 2022-01-05\ntags:\n    - attack.s0002\n    - attack.lateral-movement\n    - attack.credential-access\n    - car.2013-07-001\n    - car.2019-04-004\n    - attack.t1003.002\n    - attack.t1003.004\n    - attack.t1003.001\n    - attack.t1003.006\nlogsource:\n    product: windows\ndetection:\n    keywords:\n        - 'dpapi::masterkey'\n        - 'eo.oe.kiwi'\n        - 'event::clear'\n        - 'event::drop'\n        - 'gentilkiwi.com'\n        - 'kerberos::golden'\n        - 'kerberos::ptc'\n        - 'kerberos::ptt'\n        - 'kerberos::tgt'\n        - 'Kiwi Legit Printer'\n        - 'lsadump::'\n        - 'mimidrv.sys'\n        - '\\mimilib.dll'\n        - 'misc::printnightmare'\n        - 'misc::shadowcopies'\n        - 'misc::skeleton'\n        - 'privilege::backup'\n        - 'privilege::debug'\n        - 'privilege::driver'\n        - 'sekurlsa::'\n    filter:\n        EventID: 15  # Sysmon's FileStream Events (could cause false positives when Sigma rules get copied on/to a system)\n    condition: keywords and not filter\nfalsepositives:\n    - Naughty administrators\n    - AV Signature updates\n    - Files with Mimikatz in their filename\nlevel: high\n"},{"path":"builtin\\wmi\\win_wmi_persistence.yml","content":"title: WMI Persistence\nid: 0b7889b4-5577-4521-a60a-3376ee7f9f7b\nstatus: test\ndescription: Detects suspicious WMI event filter and command line event consumer based on WMI and Security Logs.\nreferences:\n    - https://twitter.com/mattifestation/status/899646620148539397\n    - https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/\nauthor: Florian Roth (Nextron Systems), Gleb Sukhodolskiy, Timur Zinniatullin oscd.community\ndate: 2017-08-22\nmodified: 2022-02-10\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1546.003\nlogsource:\n    product: windows\n    service: wmi\n    definition: 'WMI Namespaces Auditing and SACL should be configured, EventID 5861 and 5859 detection requires Windows 10, 2012 and higher'\ndetection:\n    wmi_filter_to_consumer_binding:\n        EventID: 5861\n    consumer_keywords:\n        - 'ActiveScriptEventConsumer'\n        - 'CommandLineEventConsumer'\n        - 'CommandLineTemplate'\n        # - 'Binding EventFilter'  # too many false positive with HP Health Driver\n    wmi_filter_registration:\n        EventID: 5859\n    filter_scmevent:\n        Provider: 'SCM Event Provider'\n        Query: 'select * from MSFT_SCMEventLogEvent'\n        User: 'S-1-5-32-544'\n        PossibleCause: 'Permanent'\n    condition: ( (wmi_filter_to_consumer_binding and consumer_keywords) or (wmi_filter_registration) ) and not filter_scmevent\nfalsepositives:\n    - Unknown (data set is too small; further testing needed)\nlevel: medium\n"},{"path":"builtin\\windefend\\win_defender_virus_scan_disabled.yml","content":"title: Windows Defender Virus Scanning Feature Disabled\nid: 686c0b4b-9dd3-4847-9077-d6c1bbe36fcb\nrelated:\n    - id: fe34868f-6e0e-4882-81f6-c43aa8f15b62\n      type: obsolete\nstatus: stable\ndescription: Detects disabling of the Windows Defender virus scanning feature\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide#event-id-5012\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md\n    - https://craigclouditpro.wordpress.com/2020/03/04/hunting-malicious-windows-defender-activity/\nauthor: Ján Trenčanský, frack113\ndate: 2020-07-28\nmodified: 2023-11-22\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 5012 # Scanning for viruses is disabled.\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_threat.yml","content":"title: Windows Defender Threat Detected\nid: 57b649ef-ff42-4fb0-8bf6-62da243a1708\nstatus: stable\ndescription: Detects actions taken by Windows Defender malware detection engines\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus\nauthor: Ján Trenčanský\ndate: 2020-07-28\ntags:\n    - attack.execution\n    - attack.t1059\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID:\n            - 1006 # The antimalware engine found malware or other potentially unwanted software.\n            - 1015 # The antimalware platform detected suspicious behavior.\n            - 1116 # The antimalware platform detected malware or other potentially unwanted software.\n            - 1117 # he antimalware platform performed an action to protect your system from malware or other potentially unwanted software.\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_tamper_protection_trigger.yml","content":"title: Microsoft Defender Tamper Protection Trigger\nid: 49e5bc24-8b86-49f1-b743-535f332c2856\nstatus: stable\ndescription: Detects blocked attempts to change any of Defender's settings such as \"Real Time Monitoring\" and \"Behavior Monitoring\"\nreferences:\n    - https://bhabeshraj.com/post/tampering-with-microsoft-defenders-tamper-protection\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide\nauthor: Bhabesh Raj, Nasreddine Bencherchali\ndate: 2021-07-05\nmodified: 2022-12-06\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 5013 # Tamper protection blocked a change to Microsoft Defender Antivirus. If Tamper protection is enabled then, any attempt to change any of Defender's settings is blocked. Event ID 5013 is generated and states which setting change was blocked.\n        Value|endswith:\n            - '\\Windows Defender\\DisableAntiSpyware'\n            - '\\Windows Defender\\DisableAntiVirus'\n            - '\\Windows Defender\\Scan\\DisableArchiveScanning'\n            - '\\Windows Defender\\Scan\\DisableScanningNetworkFiles'\n            - '\\Real-Time Protection\\DisableRealtimeMonitoring'\n            - '\\Real-Time Protection\\DisableBehaviorMonitoring'\n            - '\\Real-Time Protection\\DisableIOAVProtection'\n            - '\\Real-Time Protection\\DisableScriptScanning'\n    condition: selection\nfalsepositives:\n    - Administrator might try to disable defender features during testing (must be investigated)\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_suspicious_features_tampering.yml","content":"title: Windows Defender Configuration Changes\nid: 801bd44f-ceed-4eb6-887c-11544633c0aa\nrelated:\n    - id: 1321dc4e-a1fe-481d-a016-52c45f0c8b4f\n      type: similar\n    - id: a3ab73f1-bd46-4319-8f06-4b20d0617886\n      type: similar\n    - id: 91903aba-1088-42ee-b680-d6d94fe002b0\n      type: similar\nstatus: stable\ndescription: Detects suspicious changes to the Windows Defender configuration\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide\n    - https://bidouillesecurity.com/disable-windows-defender-in-powershell/#DisableAntiSpyware\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-06\nmodified: 2023-11-24\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 5007 # The antimalware platform configuration changed.\n        NewValue|contains:\n            # TODO: Add more suspicious values\n            - '\\Windows Defender\\DisableAntiSpyware '\n            # - '\\Windows Defender\\Features\\TamperProtection ' # Might produce FP\n            - '\\Windows Defender\\Scan\\DisableRemovableDriveScanning '\n            - '\\Windows Defender\\Scan\\DisableScanningMappedNetworkDrivesForFullScan '\n            - '\\Windows Defender\\SpyNet\\DisableBlockAtFirstSeen '\n            - '\\Real-Time Protection\\SpyNetReporting '\n            # Exclusions changes are covered in 1321dc4e-a1fe-481d-a016-52c45f0c8b4f\n            # Exploit guard changes are covered in a3ab73f1-bd46-4319-8f06-4b20d0617886\n    condition: selection\nfalsepositives:\n    - Administrator activity (must be investigated)\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_restored_quarantine_file.yml","content":"title: Win Defender Restored Quarantine File\nid: bc92ca75-cd42-4d61-9a37-9d5aa259c88b\nstatus: test\ndescription: Detects the restoration of files from the defender quarantine\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-06\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 1009 # The antimalware platform restored an item from quarantine.\n    condition: selection\nfalsepositives:\n    - Legitimate administrator activity restoring a file\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_real_time_protection_errors.yml","content":"title: Windows Defender Real-Time Protection Failure/Restart\nid: dd80db93-6ec2-4f4c-a017-ad40da6ffe81\nstatus: stable\ndescription: Detects issues with Windows Defender Real-Time Protection features\nreferences:\n    - Internal Research\n    - https://www.microsoft.com/en-us/security/blog/2023/04/11/guidance-for-investigating-attacks-using-cve-2022-21894-the-blacklotus-campaign/\n    - https://gist.github.com/nasbench/33732d6705cbdc712fae356f07666346 # Contains the list of Feature Names (use for filtering purposes)\nauthor: Nasreddine Bencherchali (Nextron Systems), Christopher Peacock '@securepeacock' (Update)\ndate: 2023-03-28\nmodified: 2023-05-05\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID:\n            - 3002 # Real-Time Protection feature has encountered an error and failed\n            - 3007 # Real-time Protection feature has restarted\n    filter_optional_network_inspection:\n        Feature_Name: '%%886' # Network Inspection System\n        Reason:\n            - '%%892' # The system is missing updates that are required for running Network Inspection System.  Install the required updates and restart the device.\n            - '%%858' # Antimalware security intelligence has stopped functioning for an unknown reason. In some instances, restarting the service may resolve the problem.\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Some crashes can occur sometimes and the event doesn't provide enough information to tune out these cases. Manual exception is required\nlevel: medium\n"},{"path":"builtin\\windefend\\win_defender_real_time_protection_disabled.yml","content":"title: Windows Defender Real-time Protection Disabled\nid: b28e58e4-2a72-4fae-bdee-0fbe904db642\nrelated:\n    - id: fe34868f-6e0e-4882-81f6-c43aa8f15b62\n      type: obsolete\nstatus: stable\ndescription: |\n    Detects disabling of Windows Defender Real-time Protection. As this event doesn't contain a lot of information on who initiated this action you might want to reduce it to a \"medium\" level if this occurs too many times in your environment\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide#event-id-5001\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md\n    - https://craigclouditpro.wordpress.com/2020/03/04/hunting-malicious-windows-defender-activity/\nauthor: Ján Trenčanský, frack113\ndate: 2020-07-28\nmodified: 2023-11-22\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 5001 # Real-time protection is disabled.\n    condition: selection\nfalsepositives:\n    - Administrator actions (should be investigated)\n    - Seen being triggered occasionally during Windows 8 Defender Updates\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_malware_detected_amsi_source.yml","content":"title: Windows Defender AMSI Trigger Detected\nid: ea9bf0fa-edec-4fb8-8b78-b119f2528186\nstatus: stable\ndescription: Detects triggering of AMSI by Windows Defender.\nreferences:\n    - https://learn.microsoft.com/en-us/windows/win32/amsi/how-amsi-helps\nauthor: Bhabesh Raj\ndate: 2020-09-14\nmodified: 2022-12-07\ntags:\n    - attack.execution\n    - attack.t1059\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 1116 # The antimalware platform detected malware or other potentially unwanted software.\n        SourceName: 'AMSI'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_malware_and_pua_scan_disabled.yml","content":"title: Windows Defender Malware And PUA Scanning Disabled\nid: bc275be9-0bec-4d77-8c8f-281a2df6710f\nrelated:\n    - id: fe34868f-6e0e-4882-81f6-c43aa8f15b62\n      type: obsolete\nstatus: stable\ndescription: Detects disabling of the Windows Defender feature of scanning for malware and other potentially unwanted software\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide#event-id-5010\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md\n    - https://craigclouditpro.wordpress.com/2020/03/04/hunting-malicious-windows-defender-activity/\nauthor: Ján Trenčanský, frack113\ndate: 2020-07-28\nmodified: 2023-11-22\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 5010 # Scanning for malware and other potentially unwanted software is disabled.\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_history_delete.yml","content":"title: Windows Defender Malware Detection History Deletion\nid: 2afe6582-e149-11ea-87d0-0242ac130003\nstatus: test\ndescription: Windows Defender logs when the history of detected infections is deleted.\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus\n    - https://web.archive.org/web/20160727113019/https://answers.microsoft.com/en-us/protect/forum/mse-protect_scanning/microsoft-antimalware-has-removed-history-of/f15af6c9-01a9-4065-8c6c-3f2bdc7de45e\nauthor: Cian Heasley\ndate: 2020-08-13\nmodified: 2023-11-24\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 1013 # The antimalware platform deleted history of malware and other potentially unwanted software.\n    condition: selection\nfalsepositives:\n    - Deletion of Defender malware detections history for legitimate reasons\nlevel: informational\n"},{"path":"builtin\\windefend\\win_defender_config_change_sample_submission_consent.yml","content":"title: Windows Defender Submit Sample Feature Disabled\nid: 91903aba-1088-42ee-b680-d6d94fe002b0\nrelated:\n    - id: 1321dc4e-a1fe-481d-a016-52c45f0c8b4f\n      type: similar\n    - id: a3ab73f1-bd46-4319-8f06-4b20d0617886\n      type: similar\n    - id: 801bd44f-ceed-4eb6-887c-11544633c0aa\n      type: similar\nstatus: stable\ndescription: Detects disabling of the \"Automatic Sample Submission\" feature of Windows Defender.\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide\n    - https://bidouillesecurity.com/disable-windows-defender-in-powershell/#DisableAntiSpyware\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-06\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 5007 # The antimalware platform configuration changed.\n        NewValue|contains: '\\Real-Time Protection\\SubmitSamplesConsent = 0x0'\n    condition: selection\nfalsepositives:\n    - Administrator activity (must be investigated)\nlevel: low\n"},{"path":"builtin\\windefend\\win_defender_config_change_exploit_guard_tamper.yml","content":"title: Windows Defender Exploit Guard Tamper\nid: a3ab73f1-bd46-4319-8f06-4b20d0617886\nstatus: test\ndescription: |\n    Detects when someone is adding or removing applications or folders from exploit guard \"ProtectedFolders\" or \"AllowedApplications\"\nreferences:\n    - https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/windows-10-controlled-folder-access-event-search/ba-p/2326088\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-05\nmodified: 2022-12-06\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    allowed_apps_key:\n        EventID: 5007 # The antimalware platform configuration changed.\n        NewValue|contains: '\\Windows Defender\\Windows Defender Exploit Guard\\Controlled Folder Access\\AllowedApplications\\'\n    allowed_apps_path:\n        NewValue|contains:\n            # Add more paths you don't allow in your org\n            - '\\Users\\Public\\'\n            - '\\AppData\\Local\\Temp\\'\n            - '\\Desktop\\'\n            - '\\PerfLogs\\'\n            - '\\Windows\\Temp\\'\n    protected_folders:\n        EventID: 5007 # The antimalware platform configuration changed.\n        # This will trigger on any folder removal. If you experience FP's then add another selection with specific paths\n        OldValue|contains: '\\Windows Defender\\Windows Defender Exploit Guard\\Controlled Folder Access\\ProtectedFolders\\'\n    condition: all of allowed_apps* or protected_folders\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_config_change_exclusion_added.yml","content":"title: Windows Defender Exclusions Added\nid: 1321dc4e-a1fe-481d-a016-52c45f0c8b4f\nstatus: stable\ndescription: Detects the Setting of Windows Defender Exclusions\nreferences:\n    - https://twitter.com/_nullbind/status/1204923340810543109\nauthor: Christian Burkard (Nextron Systems)\ndate: 2021-07-06\nmodified: 2022-12-06\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 5007 # The antimalware platform configuration changed.\n        NewValue|contains: '\\Microsoft\\Windows Defender\\Exclusions'\n    condition: selection\nfalsepositives:\n    - Administrator actions\nlevel: medium\n"},{"path":"builtin\\windefend\\win_defender_asr_psexec_wmi.yml","content":"title: PSExec and WMI Process Creations Block\nid: 97b9ce1e-c5ab-11ea-87d0-0242ac130003\nstatus: test\ndescription: Detects blocking of process creations originating from PSExec and WMI commands\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference?view=o365-worldwide#block-process-creations-originating-from-psexec-and-wmi-commands\n    - https://twitter.com/duff22b/status/1280166329660497920\nauthor: Bhabesh Raj\ndate: 2020-07-14\nmodified: 2022-12-25\ntags:\n    - attack.execution\n    - attack.lateral-movement\n    - attack.t1047\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: windefend\n    definition: 'Requirements:Enabled Block process creations originating from PSExec and WMI commands from Attack Surface Reduction (GUID: d1e49aac-8f56-4280-b9ba-993a6d77406c)'\ndetection:\n    selection:\n        EventID: 1121\n        ProcessName|endswith:\n            - '\\wmiprvse.exe'\n            - '\\psexesvc.exe'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_asr_lsass_access.yml","content":"title: LSASS Access Detected via Attack Surface Reduction\nid: a0a278fe-2c0e-4de2-ac3c-c68b08a9ba98\nstatus: test\ndescription: Detects Access to LSASS Process\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction\nauthor: Markus Neis\ndate: 2018-08-26\nmodified: 2022-08-13\ntags:\n    - attack.credential-access\n    - attack.t1003.001\nlogsource:\n    product: windows\n    service: windefend\n    definition: 'Requirements:Enabled Block credential stealing from the Windows local security authority subsystem (lsass.exe) from Attack Surface Reduction (GUID: 9e6c4e1f-7d60-472f-ba1a-a39ef669e4b2)'\ndetection:\n    selection:\n        EventID: 1121\n        Path|endswith: '\\lsass.exe'\n    filter_thor:\n        ProcessName|startswith: 'C:\\Windows\\Temp\\asgard2-agent\\'\n        ProcessName|endswith:\n            - '\\thor64.exe'\n            - '\\thor.exe'\n    filter_exact:\n        ProcessName:\n            - 'C:\\Windows\\System32\\atiesrxx.exe'\n            - 'C:\\Windows\\System32\\CompatTelRunner.exe'\n            - 'C:\\Windows\\System32\\msiexec.exe'\n            - 'C:\\Windows\\System32\\nvwmi64.exe'\n            - 'C:\\Windows\\System32\\svchost.exe'\n            - 'C:\\Windows\\System32\\Taskmgr.exe'\n            - 'C:\\Windows\\System32\\wbem\\WmiPrvSE.exe'\n            - 'C:\\Windows\\SysWOW64\\msiexec.exe'\n    filter_begins:\n        ProcessName|startswith:\n            - 'C:\\Windows\\System32\\DriverStore\\'\n            - 'C:\\WINDOWS\\Installer\\'\n            - 'C:\\Program Files\\'\n            - 'C:\\Program Files (x86)\\'\n    condition: selection and not 1 of filter_*\nfalsepositives:\n    - Google Chrome GoogleUpdate.exe\n    - Some Taskmgr.exe related activity\nlevel: high\n"},{"path":"builtin\\windefend\\win_defender_antimalware_platform_expired.yml","content":"title: Windows Defender Grace Period Expired\nid: 360a1340-398a-46b6-8d06-99b905dc69d2\nrelated:\n    - id: fe34868f-6e0e-4882-81f6-c43aa8f15b62\n      type: obsolete\nstatus: stable\ndescription: |\n    Detects the expiration of the grace period of Windows Defender. This means protection against viruses, spyware, and other potentially unwanted software is disabled.\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide#event-id-5101\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md\n    - https://craigclouditpro.wordpress.com/2020/03/04/hunting-malicious-windows-defender-activity/\nauthor: Ján Trenčanský, frack113\ndate: 2020-07-28\nmodified: 2023-11-22\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: windefend\ndetection:\n    selection:\n        EventID: 5101 # The antimalware platform is expired.\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\terminalservices\\win_terminalservices_rdp_ngrok.yml","content":"title: Ngrok Usage with Remote Desktop Service\nid: 64d51a51-32a6-49f0-9f3d-17e34d640272\nstatus: test\ndescription: Detects cases in which ngrok, a reverse proxy tool, forwards events to the local RDP port, which could be a sign of malicious behaviour\nreferences:\n    - https://twitter.com/tekdefense/status/1519711183162556416?s=12&t=OTsHCBkQOTNs1k3USz65Zg\n    - https://ngrok.com/\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-04-29\ntags:\n    - attack.command-and-control\n    - attack.t1090\nlogsource:\n    product: windows\n    service: terminalservices-localsessionmanager\ndetection:\n    selection:\n        EventID: 21\n        Address|contains: '16777216'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\taskscheduler\\win_taskscheduler_susp_schtasks_delete.yml","content":"title: Important Scheduled Task Deleted\nid: 9e3cb244-bdb8-4632-8c90-6079c8f4f16d\nrelated:\n    - id: dbc1f800-0fe0-4bc0-9c66-292c2abe3f78 # ProcCreation schtasks delete\n      type: similar\n    - id: 7595ba94-cf3b-4471-aa03-4f6baa9e5fad # Security-Audting Eventlog\n      type: similar\nstatus: test\ndescription: |\n    Detects when adversaries try to stop system services or processes by deleting their respective scheduled tasks in order to conduct data destructive activities\nreferences:\n    - https://www.socinvestigation.com/most-common-windows-event-ids-to-hunt-mind-map/\nauthor: frack113\ndate: 2023-01-13\nmodified: 2023-02-07\ntags:\n    - attack.impact\n    - attack.t1489\nlogsource:\n    product: windows\n    service: taskscheduler\n    definition: 'Requirements: The \"Microsoft-Windows-TaskScheduler/Operational\" is disabled by default and needs to be enabled in order for this detection to trigger'\ndetection:\n    selection:\n        EventID: 141\n        TaskName|contains:\n            - '\\Windows\\SystemRestore\\SR'\n            - '\\Windows\\Windows Defender\\'\n            - '\\Windows\\BitLocker'\n            - '\\Windows\\WindowsBackup\\'\n            - '\\Windows\\WindowsUpdate\\'\n            - '\\Windows\\UpdateOrchestrator\\'\n            - '\\Windows\\ExploitGuard'\n    filter:\n        UserName|contains:\n            - 'AUTHORI'\n            - 'AUTORI'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\taskscheduler\\win_taskscheduler_lolbin_execution_via_task_scheduler.yml","content":"title: Scheduled Task Executed Uncommon LOLBIN\nid: f0767f15-0fb3-44b9-851e-e8d9a6d0005d\nstatus: test\ndescription: Detects the execution of Scheduled Tasks where the program being run is located in a suspicious location or where it is an unusual program to be run from a Scheduled Task\nreferences:\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-05\nmodified: 2023-02-07\ntags:\n    - attack.privilege-escalation\n    - attack.execution\n    - attack.persistence\n    - attack.t1053.005\nlogsource:\n    product: windows\n    service: taskscheduler\n    definition: 'Requirements: The \"Microsoft-Windows-TaskScheduler/Operational\" is disabled by default and needs to be enabled in order for this detection to trigger'\ndetection:\n    selection:\n        EventID: 129 # Created Task Process\n        Path|endswith:\n            - '\\calc.exe'\n            - '\\cscript.exe'\n            - '\\mshta.exe'\n            - '\\mspaint.exe'\n            - '\\notepad.exe'\n            - '\\regsvr32.exe'\n            # - '\\rundll32.exe'\n            - '\\wscript.exe'\n    # filter_system:\n    #     Path|endswith: '\\rundll32.exe'\n    #     TaskName|startswith: '\\Microsoft\\Windows\\'\n    # condition: selection and not 1 of filter_*\n    condition: selection\nfalsepositives:\n    - False positives may occur with some of the selected binaries if you have tasks using them (which could be very common in your environment). Exclude all the specific trusted tasks before using this rule\nlevel: medium\n"},{"path":"builtin\\taskscheduler\\win_taskscheduler_execution_from_susp_locations.yml","content":"title: Scheduled Task Executed From A Suspicious Location\nid: 424273ea-7cf8-43a6-b712-375f925e481f\nstatus: test\ndescription: Detects the execution of Scheduled Tasks where the Program being run is located in a suspicious location or it's an unusale program to be run from a Scheduled Task\nreferences:\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-05\nmodified: 2023-02-07\ntags:\n    - attack.privilege-escalation\n    - attack.execution\n    - attack.persistence\n    - attack.t1053.005\nlogsource:\n    product: windows\n    service: taskscheduler\n    definition: 'Requirements: The \"Microsoft-Windows-TaskScheduler/Operational\" is disabled by default and needs to be enabled in order for this detection to trigger'\ndetection:\n    selection:\n        EventID: 129 # Created Task Process\n        Path|contains:\n            - 'C:\\Windows\\Temp\\'\n            - '\\AppData\\Local\\Temp\\'\n            - '\\Desktop\\'\n            - '\\Downloads\\'\n            - '\\Users\\Public\\'\n            - 'C:\\Temp\\'\n    # If you experience FP. Uncomment the filter below and add the specific TaskName with the Program to it\n    # filter:\n    #     TaskName: '\\Exact\\Task\\Name'\n    #     Path: 'Exact\\Path'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_susp_service_installation_script.yml","content":"title: Suspicious Service Installation Script\nid: 70f00d10-60b2-4f34-b9a0-dc3df3fe762a\nstatus: test\ndescription: Detects suspicious service installation scripts\nreferences:\n    - Internal Research\nauthor: pH-T (Nextron Systems)\ndate: 2022-03-18\nmodified: 2024-03-05\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - car.2013-09-005\n    - attack.t1543.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_cmd_flags:\n        ImagePath|contains|windash:\n            - ' -c '\n            - ' -r '\n            - ' -k '\n    selection_binaries:\n        ImagePath|contains:\n            - 'cscript'\n            - 'mshta'\n            - 'powershell'\n            - 'pwsh'\n            - 'regsvr32'\n            - 'rundll32'\n            - 'wscript'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_susp_service_installation_folder_pattern.yml","content":"title: Service Installation with Suspicious Folder Pattern\nid: 1b2ae822-6fe1-43ba-aa7c-d1a3b3d1d5f2\nstatus: test\ndescription: Detects service installation with suspicious folder patterns\nreferences:\n    - Internal Research\nauthor: pH-T (Nextron Systems)\ndate: 2022-03-18\nmodified: 2022-03-24\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - car.2013-09-005\n    - attack.t1543.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_img_paths:\n        - ImagePath|re: '^[Cc]:\\\\[Pp]rogram[Dd]ata\\\\.{1,9}\\.exe'\n        - ImagePath|re: '^[Cc]:\\\\.{1,9}\\.exe'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_susp_service_installation_folder.yml","content":"title: Service Installation in Suspicious Folder\nid: 5e993621-67d4-488a-b9ae-b420d08b96cb\nstatus: test\ndescription: Detects service installation in suspicious folder appdata\nauthor: pH-T (Nextron Systems)\nreferences:\n    - Internal Research\ndate: 2022-03-18\nmodified: 2024-01-18\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - car.2013-09-005\n    - attack.t1543.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains:\n            - '\\AppData\\'\n            - '\\\\\\\\127.0.0.1'\n            - '\\\\\\\\localhost'\n    filter_optional_zoom:\n        ServiceName: 'Zoom Sharing Service'\n        ImagePath|contains: ':\\Program Files\\Common Files\\Zoom\\Support\\CptService.exe'\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_susp_rtcore64_service_install.yml","content":"title: RTCore Suspicious Service Installation\nid: 91c49341-e2ef-40c0-ac45-49ec5c3fe26c\nstatus: test\ndescription: Detects the installation of RTCore service. Which could be an indication of Micro-Star MSI Afterburner vulnerable driver abuse\nreferences:\n    - https://github.com/br-sn/CheekyBlinder/blob/e1764a8a0e7cda8a3716aefa35799f560686e01c/CheekyBlinder/CheekyBlinder.cpp\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-30\ntags:\n    - attack.persistence\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ServiceName: 'RTCore64'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_terminated_unexpectedly.yml","content":"title: Important Windows Service Terminated Unexpectedly\nid: 56abae0c-6212-4b97-adc0-0b559bb950c3\nstatus: test\ndescription: Detects important or interesting Windows services that got terminated unexpectedly.\nreferences:\n    - https://www.randori.com/blog/vulnerability-analysis-queuejumper-cve-2023-21554/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-04-14\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7034 # The X service terminated unexpectedly. It has done this Y time(s).\n    selection_name:\n        # Note that these names contained in \"param1\" are \"Display Names\" and are language specific. If you're using a non-english system these can and will be different\n        - param1|contains: 'Message Queuing'\n        # Use this If you collect the binary value provided from this event, which is the wide hex encoded value of the service name.\n        - Binary|contains:\n              - '4d0053004d005100' # MSMQ (Microsoft Message Queuing). Encoded in upper case just in case\n              - '6d0073006d007100' # msmq\n    condition: all of selection_*\nfalsepositives:\n    - Rare false positives could occur since service termination could happen due to multiple reasons\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_terminated_error_important.yml","content":"title: Important Windows Service Terminated With Error\nid: d6b5520d-3934-48b4-928c-2aa3f92d6963\nrelated:\n    - id: acfa2210-0d71-4eeb-b477-afab494d596c\n      type: similar\nstatus: test\ndescription: Detects important or interesting Windows services that got terminated for whatever reason\nreferences:\n    - https://www.microsoft.com/en-us/security/blog/2023/04/11/guidance-for-investigating-attacks-using-cve-2022-21894-the-blacklotus-campaign/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-04-14\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7023 # The X Service service terminated with the following error\n    selection_name:\n        - param1|contains:\n              # Note that these names are \"Display Names\" and are language specific. If you're using a non-english system these can and will be different\n              - ' Antivirus'\n              - ' Firewall'\n              - 'Application Guard'\n              - 'BitLocker Drive Encryption Service'\n              - 'Encrypting File System'\n              - 'Microsoft Defender'\n              - 'Threat Protection'\n              - 'Windows Event Log'\n        # Use this If you collect the binary value provided from this event, which is the wide hex encoded value of the service name.\n        - Binary|contains:\n              - '770069006e0064006500660065006e006400' # windefend (Microsoft Defender Antivirus Service)\n              - '4500760065006e0074004c006f006700' # EventLog\n              - '6d0070007300730076006300' # mpssvc (Windows Defender Firewall)\n              - '530065006e0073006500' # Sense (Windows Defender Advanced Threat Protection Service)\n              - '450046005300' # EFS (Encrypting File System)\n              - '420044004500530056004300' # BDESVC (BitLocker Drive Encryption Service)\n    condition: all of selection_*\nfalsepositives:\n    - Rare false positives could occur since service termination could happen due to multiple reasons\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_terminated_error_generic.yml","content":"title: Windows Service Terminated With Error\nid: acfa2210-0d71-4eeb-b477-afab494d596c\nrelated:\n    - id: d6b5520d-3934-48b4-928c-2aa3f92d6963\n      type: similar\nstatus: test\ndescription: Detects Windows services that got terminated for whatever reason\nreferences:\n    - https://www.microsoft.com/en-us/security/blog/2023/04/11/guidance-for-investigating-attacks-using-cve-2022-21894-the-blacklotus-campaign/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-04-14\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7023 # The X Service service terminated with the following error\n    condition: selection\nfalsepositives:\n    - False positives could occur since service termination could happen due to multiple reasons\nlevel: low\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_uncommon.yml","content":"title: Uncommon Service Installation Image Path\nid: 26481afe-db26-4228-b264-25a29fe6efc7\nrelated:\n    - id: ca83e9f3-657a-45d0-88d6-c1ac280caf53\n      type: obsolete\n    - id: 1d61f71d-59d2-479e-9562-4ff5f4ead16b\n      type: derived\nstatus: test\ndescription: |\n    Detects uncommon service installation commands by looking at suspicious or uncommon image path values containing references to encoded powershell commands, temporary paths, etc.\nreferences:\n    - Internal Research\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-03-18\nmodified: 2024-02-09\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - car.2013-09-005\n    - attack.t1543.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    suspicious_paths:\n        ImagePath|contains:\n            - '\\\\\\\\.\\\\pipe'\n            - '\\Users\\Public\\'\n            - '\\Windows\\Temp\\'\n    suspicious_encoded_flag:\n        ImagePath|contains: ' -e'\n    suspicious_encoded_keywords:\n        ImagePath|contains:\n            - ' aQBlAHgA' # PowerShell encoded commands\n            - ' aWV4I' # PowerShell encoded commands\n            - ' IAB' # PowerShell encoded commands\n            - ' JAB' # PowerShell encoded commands\n            - ' PAA' # PowerShell encoded commands\n            - ' SQBFAFgA' # PowerShell encoded commands\n            - ' SUVYI' # PowerShell encoded commands\n    filter_optional_thor_remote:\n        ImagePath|startswith: 'C:\\WINDOWS\\TEMP\\thor10-remote\\thor64.exe'\n    filter_main_defender_def_updates:\n        ImagePath|startswith: 'C:\\ProgramData\\Microsoft\\Windows Defender\\Definition Updates\\'\n    condition: selection and ( suspicious_paths or all of suspicious_encoded_* ) and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_tap_driver.yml","content":"title: Tap Driver Installation\nid: 8e4cf0e5-aa5d-4dc3-beff-dc26917744a9\nstatus: test\ndescription: Well-known TAP software installation. Possible preparation for data exfiltration using tunnelling techniques\nreferences:\n    - https://community.openvpn.net/openvpn/wiki/ManagingWindowsTAPDrivers\nauthor: Daniil Yugoslavskiy, Ian Davis, oscd.community\ndate: 2019-10-24\nmodified: 2022-12-25\ntags:\n    - attack.exfiltration\n    - attack.t1048\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains: 'tap0901'\n    condition: selection\nfalsepositives:\n    - Legitimate OpenVPN TAP installation\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_tacticalrmm.yml","content":"title: TacticalRMM Service Installation\nid: 4bb79b62-ef12-4861-981d-2aab43fab642\nstatus: test\ndescription: Detects a TacticalRMM service installation. Tactical RMM is a remote monitoring & management tool.\nreferences:\n    - https://thedfirreport.com/2022/11/28/emotet-strikes-again-lnk-file-leads-to-domain-wide-ransomware/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-11-28\ntags:\n    - attack.command-and-control\n    - attack.t1219.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_root:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ImagePath|contains: 'tacticalrmm.exe'\n        - ServiceName|contains: 'TacticalRMM Agent Service'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use of the tool\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_sysinternals_psexec.yml","content":"title: PsExec Service Installation\nid: 42c575ea-e41e-41f1-b248-8093c3e82a28\nstatus: test\ndescription: Detects PsExec service installation and execution events\nreferences:\n    - https://www.jpcert.or.jp/english/pub/sr/ir_research.html\n    - https://jpcertcc.github.io/ToolAnalysisResultSheet\nauthor: Thomas Patzke\ndate: 2017-06-12\nmodified: 2023-08-04\ntags:\n    - attack.execution\n    - attack.t1569.002\n    - attack.s0029\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ServiceName: 'PSEXESVC'\n        - ImagePath|endswith: '\\PSEXESVC.exe'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_susp.yml","content":"title: Suspicious Service Installation\nid: 1d61f71d-59d2-479e-9562-4ff5f4ead16b\nrelated:\n    - id: ca83e9f3-657a-45d0-88d6-c1ac280caf53\n      type: obsolete\n    - id: 26481afe-db26-4228-b264-25a29fe6efc7\n      type: similar\nstatus: test\ndescription: Detects suspicious service installation commands\nreferences:\n    - Internal Research\nauthor: pH-T (Nextron Systems), Florian Roth (Nextron Systems)\ndate: 2022-03-18\nmodified: 2023-12-04\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - car.2013-09-005\n    - attack.t1543.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains:\n            - ' -nop '\n            - ' -sta '\n            - ' -w hidden '\n            - ':\\Temp\\'\n            - '.downloadfile(' # PowerShell download command\n            - '.downloadstring(' # PowerShell download command\n            - '\\ADMIN$\\'\n            - '\\Perflogs\\'\n            - '&&'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_sups_unusal_client.yml","content":"title: Service Installed By Unusual Client - System\nid: 71c276aa-49cd-43d2-b920-2dcd3e6962d5\nrelated:\n    - id: c4e92a97-a9ff-4392-9d2d-7a4c642768ca\n      type: similar\nstatus: test\ndescription: Detects a service installed by a client which has PID 0 or whose parent has PID 0\nreferences:\n    - https://www.elastic.co/guide/en/security/current/windows-service-installed-via-an-unusual-client.html\nauthor: Tim Rauch (Nextron Systems), Elastic (idea)\ndate: 2022-09-15\nmodified: 2023-01-04\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1543\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ProcessId: 0\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_sliver.yml","content":"title: Sliver C2 Default Service Installation\nid: 31c51af6-e7aa-4da7-84d4-8f32cc580af2\nstatus: test\ndescription: Detects known malicious service installation that appear in cases in which a Sliver implants execute the PsExec commands\nreferences:\n    - https://github.com/BishopFox/sliver/blob/79f2d48fcdfc2bee4713b78d431ea4b27f733f30/client/command/commands.go#L1231\n    - https://www.microsoft.com/security/blog/2022/08/24/looking-for-the-sliver-lining-hunting-for-emerging-command-and-control-frameworks/\nauthor: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-25\ntags:\n    - attack.persistence\n    - attack.execution\n    - attack.privilege-escalation\n    - attack.t1543.003\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service_1:\n        ImagePath|re: '^[a-zA-Z]:\\\\windows\\\\temp\\\\[a-zA-Z0-9]{10}\\.exe'\n    selection_service_2:\n        ServiceName:\n            - 'Sliver'\n            - 'Sliver implant'\n    condition: selection_eid and 1 of selection_service_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_remote_utilities.yml","content":"title: Remote Utilities Host Service Install\nid: 85cce894-dd8b-4427-a958-5cc47a4dc9b9\nstatus: test\ndescription: Detects Remote Utilities Host service installation on the target system.\nreferences:\n    - https://www.remoteutilities.com/support/kb/host-service-won-t-start/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-10-31\ntags:\n    - attack.persistence\nlogsource:\n    product: windows\n    service: system\ndetection:\n    # Example:\n    #   <EventData>\n    #       <Data Name=\"ServiceName\">Remote Utilities - Host</Data>\n    #       <Data Name=\"ImagePath\">\"C:\\Program Files (x86)\\Remote Utilities - Host\\rutserv.exe\" -service</Data>\n    #       <Data Name=\"ServiceType\">user mode service</Data>\n    #       <Data Name=\"StartType\">auto start</Data>\n    #       <Data Name=\"AccountName\">LocalSystem</Data>\n    #   </EventData>\n    selection_root:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ImagePath|contains|all:\n              - '\\rutserv.exe'\n              - '-service'\n        - ServiceName: 'Remote Utilities - Host'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use of the tool\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_remote_access_software.yml","content":"title: Remote Access Tool Services Have Been Installed - System\nid: 1a31b18a-f00c-4061-9900-f735b96c99fc\nrelated:\n    - id: c8b00925-926c-47e3-beea-298fd563728e\n      type: similar\nstatus: test\ndescription: Detects service installation of different remote access tools software. These software are often abused by threat actors to perform\nreferences:\n    - https://redcanary.com/blog/misbehaving-rats/\nauthor: Connor Martin, Nasreddine Bencherchali\ndate: 2022-12-23\nmodified: 2023-06-22\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.execution\n    - attack.t1543.003\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID:\n            - 7045\n            - 7036\n        ServiceName|contains:\n            # Based on https://github.com/SigmaHQ/sigma/pull/2841\n            - 'AmmyyAdmin' # https://www.ammyy.com/en/\n            - 'Atera'\n            - 'BASupportExpressSrvcUpdater' # https://www.systemlookup.com/O23/6837-BASupSrvcUpdater_exe.html\n            - 'BASupportExpressStandaloneService' # https://www.systemlookup.com/O23/6839-BASupSrvc_exe.html\n            - 'chromoting'\n            - 'GoToAssist' # https://www.goto.com/it-management/resolve\n            - 'GoToMyPC' # https://get.gotomypc.com/\n            - 'jumpcloud'\n            - 'LMIGuardianSvc' # https://www.logmein.com/\n            - 'LogMeIn' # https://www.logmein.com/\n            - 'monblanking'\n            - 'Parsec'\n            - 'RManService' # https://www.systemlookup.com/O23/7855-rutserv_exe.html\n            - 'RPCPerformanceService' # https://www.remotepc.com/\n            - 'RPCService' # https://www.remotepc.com/\n            - 'SplashtopRemoteService' # https://www.splashtop.com/\n            - 'SSUService'\n            - 'TeamViewer'\n            - 'TightVNC' # https://www.tightvnc.com/\n            - 'vncserver'\n            - 'Zoho'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_remcom.yml","content":"title: RemCom Service Installation\nid: 9e36ed87-4986-482e-8e3b-5c23ffff11bf\nstatus: test\ndescription: Detects RemCom service installation and execution events\nreferences:\n    - https://github.com/kavika13/RemCom/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-08-07\ntags:\n    - attack.execution\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ServiceName: 'RemComSvc'\n        - ImagePath|endswith: '\\RemComSvc.exe'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_pua_proceshacker.yml","content":"title: ProcessHacker Privilege Elevation\nid: c4ff1eac-84ad-44dd-a6fb-d56a92fc43a9\nstatus: test\ndescription: Detects a ProcessHacker tool that elevated privileges to a very high level\nreferences:\n    - https://twitter.com/1kwpeter/status/1397816101455765504\nauthor: Florian Roth (Nextron Systems)\ndate: 2021-05-27\nmodified: 2022-12-25\ntags:\n    - attack.persistence\n    - attack.execution\n    - attack.privilege-escalation\n    - attack.t1543.003\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ServiceName|startswith: 'ProcessHacker'\n        AccountName: 'LocalSystem'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_pdqdeploy_runner.yml","content":"title: New PDQDeploy Service - Client Side\nid: b98a10af-1e1e-44a7-bab2-4cc026917648\nstatus: test\ndescription: |\n    Detects PDQDeploy service installation on the target system.\n    When a package is deployed via PDQDeploy it installs a remote service on the target machine with the name \"PDQDeployRunner-X\" where \"X\" is an integer starting from 1\nreferences:\n    - https://documentation.pdq.com/PDQDeploy/13.0.3.0/index.html?windows-services.htm\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-22\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1543.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_root:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ImagePath|contains: 'PDQDeployRunner-'\n        - ServiceName|startswith: 'PDQDeployRunner-'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use of the tool\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_pdqdeploy.yml","content":"title: New PDQDeploy Service - Server Side\nid: ee9ca27c-9bd7-4cee-9b01-6e906be7cae3\nstatus: test\ndescription: |\n    Detects a PDQDeploy service installation which indicates that PDQDeploy was installed on the machines.\n    PDQDeploy can be abused by attackers to remotely install packages or execute commands on target machines\nreferences:\n    - https://documentation.pdq.com/PDQDeploy/13.0.3.0/index.html?windows-services.htm\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-22\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1543.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_root:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ImagePath|contains: 'PDQDeployService.exe'\n        - ServiceName:\n              - 'PDQDeploy'\n              - 'PDQ Deploy'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use of the tool\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_paexec.yml","content":"title: PAExec Service Installation\nid: de7ce410-b3fb-4e8a-b38c-3b999e2c3420\nstatus: test\ndescription: Detects PAExec service installation\nreferences:\n    - https://www.poweradmin.com/paexec/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-10-26\ntags:\n    - attack.execution\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_image:\n        - ServiceName|startswith: 'PAExec-'\n        - ImagePath|startswith: 'C:\\WINDOWS\\PAExec-'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_netsupport_manager.yml","content":"title: NetSupport Manager Service Install\nid: 2d510d8d-912b-45c5-b1df-36faa3d8c3f4\nstatus: test\ndescription: Detects NetSupport Manager service installation on the target system.\nreferences:\n    - http://resources.netsupportsoftware.com/resources/manualpdfs/nsm_manual_uk.pdf\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-10-31\ntags:\n    - attack.persistence\nlogsource:\n    product: windows\n    service: system\ndetection:\n    # Example:\n    #   <EventData>\n    #       <Data Name=\"ServiceName\">Client32</Data>\n    #       <Data Name=\"ImagePath\">\"C:\\Program Files (x86)\\NetSupport\\NetSupport Manager\\client32.exe\" /* *</Data>\n    #       <Data Name=\"ServiceType\">user mode service</Data>\n    #       <Data Name=\"StartType\">auto start</Data>\n    #       <Data Name=\"AccountName\">LocalSystem</Data>\n    #   </EventData>\n    selection_root:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ImagePath|contains: '\\NetSupport Manager\\client32.exe'\n        - ServiceName: 'Client32'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use of the tool\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_mesh_agent.yml","content":"title: Mesh Agent Service Installation\nid: e0d1ad53-c7eb-48ec-a87a-72393cc6cedc\nstatus: test\ndescription: Detects a Mesh Agent service installation. Mesh Agent is used to remotely manage computers\nreferences:\n    - https://thedfirreport.com/2022/11/28/emotet-strikes-again-lnk-file-leads-to-domain-wide-ransomware/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-11-28\ntags:\n    - attack.command-and-control\n    - attack.t1219.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_root:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ImagePath|contains: 'MeshAgent.exe'\n        - ServiceName|contains: 'Mesh Agent'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use of the tool\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_hacktools.yml","content":"title: HackTool Service Registration or Execution\nid: d26ce60c-2151-403c-9a42-49420d87b5e4\nstatus: test\ndescription: Detects installation or execution of services\nreferences:\n    - Internal Research\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-03-21\nmodified: 2023-08-07\ntags:\n    - attack.execution\n    - attack.t1569.002\n    - attack.s0029\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID:\n            - 7045\n            - 7036\n    selection_service_name:\n        ServiceName|contains:\n            - 'cachedump'\n            - 'DumpSvc'\n            - 'gsecdump'\n            - 'pwdump'\n            - 'UACBypassedService'\n            - 'WCE SERVICE'\n            - 'WCESERVICE'\n            - 'winexesvc'\n    selection_service_image:\n        ImagePath|contains: 'bypass' # https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82#file-scmuacbypass-cpp-L159\n    condition: selection_eid and 1 of selection_service_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_csexecsvc.yml","content":"title: CSExec Service Installation\nid: a27e5fa9-c35e-4e3d-b7e0-1ce2af66ad12\nstatus: test\ndescription: Detects CSExec service installation and execution events\nreferences:\n    - https://github.com/malcomvetter/CSExec\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-08-07\ntags:\n    - attack.execution\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ServiceName: 'csexecsvc'\n        - ImagePath|endswith: '\\csexecsvc.exe'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n\n"},{"path":"builtin\\system\\service_control_manager\\win_system_service_install_anydesk.yml","content":"title: Anydesk Remote Access Software Service Installation\nid: 530a6faa-ff3d-4022-b315-50828e77eef5\nstatus: test\ndescription: Detects the installation of the anydesk software service. Which could be an indication of anydesk abuse if you the software isn't already used.\nreferences:\n    - https://thedfirreport.com/2022/08/08/bumblebee-roasts-its-way-to-domain-admin/\n    - https://thedfirreport.com/2025/02/24/confluence-exploit-leads-to-lockbit-ransomware/\nauthor: Nasreddine Bencherchali (Nextron Systems), Swachchhanda Shrawan Poudel (Nextron Systems)\ndate: 2022-08-11\nmodified: 2025-02-24\ntags:\n    - attack.persistence\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_provider:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service:\n        - ServiceName|contains|all:\n              - 'AnyDesk' # Covers both AnyDesk Service and AnyDesk MSI Service\n              - 'Service'\n        - ImagePath|contains: 'AnyDesk'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate usage of the anydesk tool\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_powershell_script_installed_as_service.yml","content":"title: PowerShell Scripts Installed as Services\nid: a2e5019d-a658-4c6a-92bf-7197b54e2cae\nstatus: test\ndescription: Detects powershell script installed as a Service\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse\nauthor: oscd.community, Natalia Shornikova\ndate: 2020-10-06\nmodified: 2022-12-25\ntags:\n    - attack.execution\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains:\n            - 'powershell'\n            - 'pwsh'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_moriya_rootkit.yml","content":"title: Moriya Rootkit - System\nid: 25b9c01c-350d-4b95-bed1-836d04a4f324\nstatus: test\ndescription: Detects the use of Moriya rootkit as described in the securelist's Operation TunnelSnake report\nreferences:\n    - https://securelist.com/operation-tunnelsnake-and-moriya-rootkit/101831\nauthor: Bhabesh Raj\ndate: 2021-05-06\nmodified: 2022-11-29\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1543.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ServiceName: ZzNetSvc\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"builtin\\system\\service_control_manager\\win_system_meterpreter_or_cobaltstrike_getsystem_service_installation.yml","content":"title: Meterpreter or Cobalt Strike Getsystem Service Installation - System\nid: 843544a7-56e0-4dcc-a44f-5cc266dd97d6\nstatus: test\ndescription: Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting a specific service installation\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-privilege-escalation-in-windows-environment\n    - https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/\nauthor: Teymur Kheirkhabarov, Ecco, Florian Roth (Nextron Systems)\ndate: 2019-10-26\nmodified: 2023-11-15\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1134.001\n    - attack.t1134.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_id:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_cli_cmd:\n        # meterpreter getsystem technique 1: cmd.exe /c echo 559891bb017 > \\\\.\\pipe\\5e120a\n        # cobaltstrike getsystem technique 1: %COMSPEC% /c echo 559891bb017 > \\\\.\\pipe\\5e120a\n        # cobaltstrike getsystem technique 1b (expanded %COMSPEC%): %COMSPEC% /c echo 559891bb017 > \\\\.\\pipe\\5e120a\n        ImagePath|contains|all:\n            - '/c'\n            - 'echo'\n            - '\\pipe\\'\n        ImagePath|contains:\n        - 'cmd'\n        - '%COMSPEC%'\n    selection_cli_rundll:\n        # meterpreter getsystem technique 2: rundll32.exe C:\\Users\\test\\AppData\\Local\\Temp\\tmexsn.dll,a /p:tmexsn\n        ImagePath|contains|all:\n            - 'rundll32'\n            - '.dll,a'\n            - '/p:'\n    selection_cli_share:\n        ImagePath|startswith: '\\\\\\\\127.0.0.1\\\\ADMIN$\\'  # https://twitter.com/svch0st/status/1413688851877416960?lang=en\n    condition: selection_id and 1 of selection_cli_*\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_mal_creddumper.yml","content":"title: Credential Dumping Tools Service Execution - System\nid: 4976aa50-8f41-45c6-8b15-ab3fc10e79ed\nstatus: test\ndescription: Detects well-known credential dumping tools execution via service execution events\nreferences:\n    - https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment\nauthor: Florian Roth (Nextron Systems), Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community\ndate: 2017-03-05\nmodified: 2022-11-29\ntags:\n    - attack.credential-access\n    - attack.execution\n    - attack.t1003.001\n    - attack.t1003.002\n    - attack.t1003.004\n    - attack.t1003.005\n    - attack.t1003.006\n    - attack.t1569.002\n    - attack.s0005\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains:\n            - 'cachedump'\n            - 'dumpsvc'\n            - 'fgexec'\n            - 'gsecdump'\n            - 'mimidrv'\n            - 'pwdump'\n            - 'servpw'\n    condition: selection\nfalsepositives:\n    - Legitimate Administrator using credential dumping tool for password recovery\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_krbrelayup_service_installation.yml","content":"title: KrbRelayUp Service Installation\nid: e97d9903-53b2-41fc-8cb9-889ed4093e80\nstatus: test\ndescription: Detects service creation from KrbRelayUp tool used for privilege escalation in Windows domain environments where LDAP signing is not enforced (the default settings)\nreferences:\n    - https://github.com/Dec0ne/KrbRelayUp\nauthor: Sittikorn S, Tim Shelton\ndate: 2022-05-11\nmodified: 2022-10-05\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1543\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        EventID: 7045\n        ServiceName: 'KrbSCM'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_via_var_services.yml","content":"title: Invoke-Obfuscation VAR++ LAUNCHER OBFUSCATION - System\nid: 14bcba49-a428-42d9-b943-e2ce0f0f7ae6\nstatus: test\ndescription: Detects Obfuscated Powershell via VAR++ LAUNCHER\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task27)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-13\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        # ImagePath|re: '(?i)&&set.*(\\{\\d\\}){2,}\\\\\\\"\\s+?\\-f.*&&.*cmd.*\\/c' # FPs with |\\/r\n        # Example 1: CMD /C\"sET KUR=Invoke-Expression (New-Object Net.WebClient).DownloadString&&Set MxI=C:\\wINDowS\\sYsWow64\\winDOWspoWERSheLl\\V1.0\\PowerShelL.EXe ${ExEcut`IoN`cON`TExT}.\\\"invo`kEcoMm`A`ND\\\".( \\\"{2}{1}{0}\\\" -f 'pt','EscRi','INvOk' ).Invoke( ( .( \\\"{0}{1}\\\" -f'D','IR' ) ( \\\"{0}{1}\\\"-f'ENV:kU','R')).\\\"vAl`Ue\\\" )&& CMD /C%mXI%\"\n        # Example 2: c:\\WiNDOWS\\sYSTEm32\\CmD.exE /C \"sEt DeJLz=Invoke-Expression (New-Object Net.WebClient).DownloadString&&set yBKM=PoWERShelL -noeX ^^^&(\\\"{2}{0}{1}\\\"-f '-ItE','m','seT') ( 'V' + 'a'+ 'RiAblE:z8J' +'U2' + 'l' ) ([TYpE]( \\\"{2}{3}{0}{1}\\\"-f 'e','NT','e','NViRONM' ) ) ; ^^^& ( ( [sTrIng]${VE`Rbo`SepReFER`Ence})[1,3] + 'X'-joIN'')( ( (.('gI') ('V' + 'a' + 'RIAbLe:z8j' + 'u2' +'l' ) ).vALUe::( \\\"{2}{5}{0}{1}{6}{4}{3}\\\" -f 'IRo','Nm','GETE','ABlE','I','nv','enTVAr').Invoke(( \\\"{0}{1}\\\"-f'd','ejLz' ),( \\\"{1}{2}{0}\\\"-f'cEss','P','RO') )) )&& c:\\WiNDOWS\\sYSTEm32\\CmD.exE /C %ybkm%\"\n        ImagePath|contains|all:\n            - '&&set'\n            - 'cmd'\n            - '/c'\n            - '-f'\n        ImagePath|contains:\n            - '{0}'\n            - '{1}'\n            - '{2}'\n            - '{3}'\n            - '{4}'\n            - '{5}'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_via_use_rundll32_services.yml","content":"title: Invoke-Obfuscation Via Use Rundll32 - System\nid: 641a4bfb-c017-44f7-800c-2aee0184ce9b\nstatus: test\ndescription: Detects Obfuscated Powershell via use Rundll32 in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task30)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-09\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains|all:\n            - '&&'\n            - 'rundll32'\n            - 'shell32.dll'\n            - 'shellexec_rundll'\n        ImagePath|contains:\n            - 'value'\n            - 'invoke'\n            - 'comspec'\n            - 'iex'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_via_use_mshta_services.yml","content":"title: Invoke-Obfuscation Via Use MSHTA - System\nid: 7e9c7999-0f9b-4d4a-a6ed-af6d553d4af4\nstatus: test\ndescription: Detects Obfuscated Powershell via use MSHTA in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task31)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-09\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains|all:\n            - 'mshta'\n            - 'vbscript:createobject'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_via_use_clip_services.yml","content":"title: Invoke-Obfuscation Via Use Clip - System\nid: 63e3365d-4824-42d8-8b82-e56810fefa0c\nstatus: test\ndescription: Detects Obfuscated Powershell via use Clip.exe in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task29)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-09\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains: '(Clipboard|i'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_via_stdin_services.yml","content":"title: Invoke-Obfuscation Via Stdin - System\nid: 487c7524-f892-4054-b263-8a0ace63fc25\nstatus: test\ndescription: Detects Obfuscated Powershell via Stdin in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task28)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-12\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        # ImagePath|re: '(?i)(set).*&&\\s?set.*(environment|invoke|\\${?input).*&&.*\"'\n        ImagePath|contains|all:\n            - 'set'\n            - '&&'\n        ImagePath|contains:\n            - 'environment'\n            - 'invoke'\n            - 'input'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_via_rundll_services.yml","content":"title: Invoke-Obfuscation RUNDLL LAUNCHER - System\nid: 11b52f18-aaec-4d60-9143-5dd8cc4706b9\nstatus: test\ndescription: Detects Obfuscated Powershell via RUNDLL LAUNCHER\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task 23)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-18\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains|all:\n            - 'rundll32.exe'\n            - 'shell32.dll'\n            - 'shellexec_rundll'\n            - 'powershell'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_via_compress_services.yml","content":"title: Invoke-Obfuscation COMPRESS OBFUSCATION - System\nid: 175997c5-803c-4b08-8bb0-70b099f47595\nstatus: test\ndescription: Detects Obfuscated Powershell via COMPRESS OBFUSCATION\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task 19)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-18\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains|all:\n            - 'new-object'\n            - 'text.encoding]::ascii'\n            - 'readtoend'\n        ImagePath|contains:\n            - ':system.io.compression.deflatestream'\n            - 'system.io.streamreader'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_var_services.yml","content":"title: Invoke-Obfuscation VAR+ Launcher - System\nid: 8ca7004b-e620-4ecb-870e-86129b5b8e75\nstatus: test\ndescription: Detects Obfuscated use of Environment Variables to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 24)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-15\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        # ImagePath|re: 'cmd.{0,5}(?:\\/c|\\/r)(?:\\s|)\\\"set\\s[a-zA-Z]{3,6}.*(?:\\{\\d\\}){1,}\\\\\\\"\\s+?\\-f(?:.*\\)){1,}.*\\\"'\n        # Example 1: C:\\winDoWs\\SySTeM32\\cmd.Exe /C\"SET NOtI=Invoke-Expression (New-Object Net.WebClient).DownloadString&& PowERshElL -NOl SET-iteM ( 'VAR' + 'i'+ 'A' + 'blE:Ao6' + 'I0') ( [TYpe](\\\"{2}{3}{0}{1}\\\"-F 'iRoN','mENT','e','nv') ) ; ${exECUtIONCOnTEXT}.\\\"IN`VO`KecOmMaND\\\".\\\"inVo`KES`crIPt\\\"( ( ( GEt-VAriAble ( 'a' + 'o6I0') -vaLU )::(\\\"{1}{4}{2}{3}{0}\\\" -f'e','gETenvIR','NtvaRIa','BL','ONme' ).Invoke(( \\\"{0}{1}\\\"-f'n','oti' ),( \\\"{0}{1}\\\" -f'pRoC','esS') )) )\"\n        # Example 2: cMD.exe /C \"seT SlDb=Invoke-Expression (New-Object Net.WebClient).DownloadString&& pOWErShell .(( ^&(\\\"{1}{0}{2}{3}\\\" -f 'eT-vaR','G','iab','lE' ) (\\\"{0}{1}\\\" -f '*m','DR*' ) ).\\\"na`ME\\\"[3,11,2]-JOIN'' ) ( ( ^&(\\\"{0}{1}\\\" -f'g','CI' ) (\\\"{0}{1}\\\" -f 'ENV',':SlDb' ) ).\\\"VA`luE\\\" ) \"\n        ImagePath|contains|all:\n            - 'cmd'\n            - '\"set'\n            - '-f'\n        ImagePath|contains:\n            - '/c'\n            - '/r'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_stdin_services.yml","content":"title: Invoke-Obfuscation STDIN+ Launcher - System\nid: 72862bf2-0eb1-11eb-adc1-0242ac120002\nstatus: test\ndescription: Detects Obfuscated use of stdin to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 25)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-15\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_main:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        # ImagePath|re: 'cmd.{0,5}(?:\\/c|\\/r).+powershell.+(?:\\$\\{?input\\}?|noexit).+\\\"'\n        # Example 1: c:\\windows\\sYstEm32\\CmD.eXE /C\"echO\\Invoke-Expression (New-Object Net.WebClient).DownloadString | POwersHELl -NoEXiT -\"\n        # Example 2: c:\\WiNDOws\\sysTEm32\\cmd.EXe /C \" ECHo Invoke-Expression (New-Object Net.WebClient).DownloadString | POwersHELl -nol ${EXEcUtIONCONTeXT}.INvOkEComMANd.InvOKEScRIPt( $InpUt )\"\n        ImagePath|contains|all:\n            - 'cmd'\n            - 'powershell'\n        ImagePath|contains:\n            - '/c'\n            - '/r'\n    selection_other:\n        - ImagePath|contains: 'noexit'\n        - ImagePath|contains|all:\n              - 'input'\n              - '$'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_obfuscated_iex_services.yml","content":"title: Invoke-Obfuscation Obfuscated IEX Invocation - System\nid: 51aa9387-1c53-4153-91cc-d73c59ae1ca9\nstatus: test\ndescription: Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the code block linked in the references\nreferences:\n    - https://github.com/danielbohannon/Invoke-Obfuscation/blob/f20e7f843edd0a3a7716736e9eddfa423395dd26/Out-ObfuscatedStringCommand.ps1#L873-L888\nauthor: Daniel Bohannon (@Mandiant/@FireEye), oscd.community\ndate: 2019-11-08\nmodified: 2022-11-27\ntags:\n    - attack.defense-evasion\n    - attack.t1027\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        EventID: 7045\n    selection_imagepath:\n        - ImagePath|re: '\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\['\n        - ImagePath|re: '\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\['\n        - ImagePath|re: '\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\['\n        - ImagePath|re: '\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}'\n        - ImagePath|re: '\\\\*mdr\\*\\W\\s*\\)\\.Name'\n        - ImagePath|re: '\\$VerbosePreference\\.ToString\\('\n        - ImagePath|re: '\\String\\]\\s*\\$VerbosePreference'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_invoke_obfuscation_clip_services.yml","content":"title: Invoke-Obfuscation CLIP+ Launcher - System\nid: f7385ee2-0e0c-11eb-adc1-0242ac120002\nstatus: test\ndescription: Detects Obfuscated use of Clip.exe to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 26)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-13\nmodified: 2023-02-20\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n        ImagePath|contains|all:\n            - 'cmd'\n            - '&&'\n            - 'clipboard]::'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_hack_smbexec.yml","content":"title: smbexec.py Service Installation\nid: 52a85084-6989-40c3-8f32-091e12e13f09\nstatus: test\ndescription: Detects the use of smbexec.py tool by detecting a specific service installation\nreferences:\n    - https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-2-psexec-and-services/\n    - https://github.com/fortra/impacket/blob/33058eb2fde6976ea62e04bc7d6b629d64d44712/examples/smbexec.py#L286-L296\n    - https://github.com/fortra/impacket/blob/edef71f17bc1240f9f8c957bbda98662951ac3ec/examples/smbexec.py#L60 # Old service name\nauthor: Omer Faruk Celik\ndate: 2018-03-20\nmodified: 2023-11-09\ntags:\n    - attack.lateral-movement\n    - attack.execution\n    - attack.t1021.002\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_eid:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection_service_name:\n        ServiceName: 'BTOBTO'\n    selection_service_image:\n        ImagePath|contains:\n            - '.bat & del '\n            - '__output 2^>^&1 >'\n    condition: selection_eid and 1 of selection_service_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\service_control_manager\\win_system_defender_disabled.yml","content":"title: Windows Defender Threat Detection Service Disabled\nid: 6c0a7755-6d31-44fa-80e1-133e57752680\nrelated:\n    - id: fe34868f-6e0e-4882-81f6-c43aa8f15b62\n      type: derived\nstatus: stable\ndescription: Detects when the \"Windows Defender Threat Protection\" service is disabled.\nreferences:\n    - https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md\nauthor: Ján Trenčanský, frack113\ndate: 2020-07-28\nmodified: 2024-07-02\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        EventID: 7036\n        Provider_Name: 'Service Control Manager'\n        # Note: The service name and messages are localized\n        param1:\n            - 'Windows Defender Antivirus Service'\n            - 'Service antivirus Microsoft Defender' # French OS\n        param2:\n            - 'stopped'\n            - 'arrêté' # French OS\n    condition: selection\nfalsepositives:\n    - Administrator actions\n    - Auto updates of Windows Defender causes restarts\nlevel: medium\n"},{"path":"builtin\\system\\service_control_manager\\win_system_cobaltstrike_service_installs.yml","content":"title: CobaltStrike Service Installations - System\nid: 5a105d34-05fc-401e-8553-272b45c1522d\nstatus: test\ndescription: Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement\nreferences:\n    - https://www.sans.org/webcasts/119395\n    - https://www.crowdstrike.com/blog/getting-the-bacon-from-cobalt-strike-beacon/\n    - https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/\nauthor: Florian Roth (Nextron Systems), Wojciech Lesicki\ndate: 2021-05-26\nmodified: 2022-11-27\ntags:\n    - attack.persistence\n    - attack.execution\n    - attack.privilege-escalation\n    - attack.lateral-movement\n    - attack.t1021.002\n    - attack.t1543.003\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection_id:\n        Provider_Name: 'Service Control Manager'\n        EventID: 7045\n    selection1:\n        ImagePath|contains|all:\n            - 'ADMIN$'\n            - '.exe'\n    selection2:\n        ImagePath|contains|all:\n            - '%COMSPEC%'\n            - 'start'\n            - 'powershell'\n    selection3:\n        ImagePath|contains: 'powershell -nop -w hidden -encodedcommand'\n    selection4:\n        ImagePath|base64offset|contains: \"IEX (New-Object Net.Webclient).DownloadString('http://127.0.0.1:\"\n    condition: selection_id and (selection1 or selection2 or selection3 or selection4)\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"builtin\\system\\ntfs\\win_system_ntfs_vuln_exploit.yml","content":"title: NTFS Vulnerability Exploitation\nid: f14719ce-d3ab-4e25-9ce6-2899092260b0\nstatus: test\ndescription: This the exploitation of a NTFS vulnerability as reported without many details via Twitter\nreferences:\n    - https://twitter.com/jonasLyk/status/1347900440000811010\n    - https://twitter.com/wdormann/status/1347958161609809921\n    - https://www.bleepingcomputer.com/news/security/windows-10-bug-corrupts-your-hard-drive-on-seeing-this-files-icon/\nauthor: Florian Roth (Nextron Systems)\ndate: 2021-01-11\nmodified: 2022-12-25\ntags:\n    - attack.impact\n    - attack.t1499.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: Ntfs\n        EventID: 55\n        Origin: 'File System Driver'\n        Description|contains|all:\n            - 'contains a corrupted file record'\n            - 'The name of the file is \"\\\"'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\system\\netlogon\\win_system_vul_cve_2020_1472.yml","content":"title: Vulnerable Netlogon Secure Channel Connection Allowed\nid: a0cb7110-edf0-47a4-9177-541a4083128a\nstatus: test\ndescription: Detects that a vulnerable Netlogon secure channel connection was allowed, which could be an indicator of CVE-2020-1472.\nreferences:\n    - https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc\nauthor: NVISO\ndate: 2020-09-15\nmodified: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1548\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: NetLogon  # Active Directory: NetLogon ETW GUID {F33959B4-DBEC-11D2-895B-00C04F79AB69}\n        EventID: 5829\n    condition: selection\nfalsepositives:\n    - Unknown\nfields:\n    - SAMAccountName\nlevel: high\n"},{"path":"builtin\\system\\netlogon\\win_system_possible_zerologon_exploitation_using_wellknown_tools.yml","content":"title: Zerologon Exploitation Using Well-known Tools\nid: 18f37338-b9bd-4117-a039-280c81f7a596\nstatus: stable\ndescription: This rule is designed to detect attempts to exploit Zerologon (CVE-2020-1472) vulnerability using mimikatz zerologon module or other exploits from machine with \"kali\" hostname.\nreferences:\n    - https://www.secura.com/blog/zero-logon\n    - https://bi-zone.medium.com/hunting-for-zerologon-f65c61586382\nauthor: 'Demyan Sokolin @_drd0c, Teymur Kheirkhabarov @HeirhabarovT, oscd.community'\ndate: 2020-10-13\nmodified: 2021-05-30\ntags:\n    - attack.t1210\n    - attack.lateral-movement\nlogsource:\n    service: system\n    product: windows\ndetection:\n    selection:\n        EventID:\n            - 5805\n            - 5723\n    keywords:\n        - kali\n        - mimikatz\n    condition: selection and keywords\nlevel: critical\n"},{"path":"builtin\\system\\microsoft_windows_windows_update_client\\win_system_susp_system_update_error.yml","content":"title: Windows Update Error\nid: 13cfeb75-9e33-4d04-b0f7-ab8faaa95a59\nstatus: stable\ndescription: |\n    Detects Windows update errors including installation failures and connection issues. Defenders should observe this in case critical update KBs aren't installed.\nreferences:\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/f1b010ce0ee1b71e3024180de1a3e67f99701fe4/ETWProvidersManifests/Windows10/1903/W10_1903_Pro_20200714_18362.959/WEPExplorer/Microsoft-Windows-WindowsUpdateClient.xml\nauthor: frack113\ndate: 2021-12-04\nmodified: 2023-09-07\ntags:\n    - attack.impact\n    - attack.resource-development\n    - attack.t1584\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: Microsoft-Windows-WindowsUpdateClient\n        EventID:\n            - 16 # Unable to Connect: Windows is unable to connect to the automatic updates service and therefore cannot download and install updates according to the set schedule\n            - 20 # Installation Failure: Windows failed to install the following update with error\n            - 24 # Uninstallation Failure: Windows failed to uninstall the following update with error\n            - 213 # Revert Failure: Windows failed to revert the following update with error\n            - 217 # Commit Failure: Windows failed to commit the following update with error\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: informational\n"},{"path":"builtin\\system\\microsoft_windows_wer_systemerrorreporting\\win_system_crash_dump_created.yml","content":"title: Crash Dump Created By Operating System\nid: 882fbe50-d8d7-4e29-ae80-0648a8556866\nrelated:\n    - id: 2ff692c2-4594-41ec-8fcb-46587de769e0\n      type: similar\nstatus: experimental\ndescription: Detects \"BugCheck\" errors indicating the system rebooted due to a crash, capturing the bugcheck code, dump file path, and report ID.\nreferences:\n    - https://www.sans.edu/cyber-research/from-crash-compromise-unlocking-potential-windows-crash-dumps-offensive-security/\n    - https://jasonmull.com/articles/offensive/2025-05-12-windows-crash-dumps-offensive-security/\nauthor: Jason Mull\ndate: 2025-05-12\ntags:\n    - attack.credential-access\n    - attack.collection\n    - attack.t1003.002\n    - attack.t1005\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Microsoft-Windows-WER-SystemErrorReporting'\n        EventID: 1001\n    condition: selection\nlevel: medium\n"},{"path":"builtin\\system\\microsoft_windows_ntfs\\win_system_volume_shadow_copy_mount.yml","content":"title: Volume Shadow Copy Mount\nid: f512acbf-e662-4903-843e-97ce4652b740\nstatus: test\ndescription: Detects volume shadow copy mount via Windows event log\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1003.002/T1003.002.md#atomic-test-3---esentutlexe-sam-copy\nauthor: Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR)\ndate: 2020-10-20\nmodified: 2022-12-25\ntags:\n    - attack.credential-access\n    - attack.t1003.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: Microsoft-Windows-Ntfs\n        EventID: 98\n        DeviceName|contains: HarddiskVolumeShadowCopy\n    condition: selection\nfalsepositives:\n    - Legitimate use of volume shadow copy mounts (backups maybe).\nlevel: low\n"},{"path":"builtin\\system\\microsoft_windows_kernel_general\\win_system_susp_critical_hive_location_access_bits_cleared.yml","content":"title: Critical Hive In Suspicious Location Access Bits Cleared\nid: 39f919f3-980b-4e6f-a975-8af7e507ef2b\nrelated:\n    - id: 839dd1e8-eda8-4834-8145-01beeee33acd\n      type: obsolete\nstatus: test\ndescription: |\n    Detects events from the Kernel-General ETW indicating that the access bits of a hive with a system like hive name located in the temp directory have been reset.\n    This occurs when an application tries to access a hive and the hive has not be recognized since the last 7 days (by default).\n    Registry hive dumping utilities such as QuarksPwDump were seen emitting this behavior.\nreferences:\n    - https://github.com/nasbench/Misc-Research/blob/b20da2336de0f342d31ef4794959d28c8d3ba5ba/ETW/Microsoft-Windows-Kernel-General.md\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-05-15\nmodified: 2024-01-18\ntags:\n    - attack.credential-access\n    - attack.t1003.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        EventID: 16\n        Provider_Name: Microsoft-Windows-Kernel-General\n        HiveName|contains:\n            - '\\Temp\\SAM'\n            - '\\Temp\\SECURITY'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\microsoft_windows_kerberos_key_distribution_center\\win_system_kdcsvc_tgs_no_suitable_encryption_key_found.yml","content":"title: No Suitable Encryption Key Found For Generating Kerberos Ticket\nid: b1e0b3f5-b62e-41be-886a-daffde446ad4\nstatus: test\ndescription: |\n    Detects errors when a target server doesn't have suitable keys for generating kerberos tickets.\n    This issue can occur for example when a service uses a user account or a computer account that is configured for only DES encryption on a computer that is running Windows 7 which has DES encryption for Kerberos authentication disabled.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd348773(v=ws.10)\n    - https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/kdc-event-16-27-des-encryption-disabled\nauthor: '@SerkinValery'\ndate: 2024-03-07\nmodified: 2025-09-22\ntags:\n    - attack.credential-access\n    - attack.t1558.003\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name:\n            - 'Kerberos-Key-Distribution-Center'\n            - 'Microsoft-Windows-Kerberos-Key-Distribution-Center'\n        EventID:\n            - 16 # KDCEVENT_NO_KEY_INTERSECTION_TGS\n            - 27 # KDCEVENT_UNSUPPORTED_ETYPE_REQUEST_TGS\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"builtin\\system\\microsoft_windows_kerberos_key_distribution_center\\win_system_kdcsvc_cert_use_no_strong_mapping.yml","content":"title: Certificate Use With No Strong Mapping\nid: 993c2665-e6ef-40e3-a62a-e1a97686af79\nstatus: test\ndescription: |\n    Detects a user certificate that was valid but could not be mapped to a user in a strong way (such as via explicit mapping, key trust mapping, or a SID)\n    This could be a sign of exploitation of the elevation of privilege vulnerabilities (CVE-2022-34691, CVE-2022-26931, CVE-2022-26923) that can occur when the KDC allows certificate spoofing by not requiring a strong mapping.\n    Events where the AccountName and CN of the Subject do not match, or where the CN ends in a dollar sign indicating a machine, may indicate certificate spoofing.\nreferences:\n    - https://support.microsoft.com/en-us/topic/kb5014754-certificate-based-authentication-changes-on-windows-domain-controllers-ad2c23b0-15d8-4340-a468-4d4f3b188f16\nauthor: '@br4dy5'\ndate: 2023-10-09\nmodified: 2025-09-22\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name:\n            - 'Kerberos-Key-Distribution-Center'\n            - 'Microsoft-Windows-Kerberos-Key-Distribution-Center'\n        EventID:\n            - 39\n            - 41 # For Windows Server 2008 R2 SP1 and Windows Server 2008 SP2\n    condition: selection\nfalsepositives:\n    - If prevalent in the environment, filter on events where the AccountName and CN of the Subject do not reference the same user\n    - If prevalent in the environment, filter on CNs that end in a dollar sign indicating it is a machine name\nlevel: medium\n"},{"path":"builtin\\system\\microsoft_windows_Iphlpsvc\\win_system_isatap_router_address_set.yml","content":"title: ISATAP Router Address Was Set\nid: d22df9cd-2aee-4089-93c7-9dc4eae77f2c\nstatus: experimental\ndescription: |\n    Detects the configuration of a new ISATAP router on a Windows host. While ISATAP is a legitimate Microsoft technology for IPv6 transition, unexpected or unauthorized ISATAP router configurations could indicate a potential IPv6 DNS Takeover attack using tools like mitm6.\n    In such attacks, adversaries advertise themselves as DHCPv6 servers and set malicious ISATAP routers to intercept traffic.\n    This detection should be correlated with network baselines and known legitimate ISATAP deployments in your environment.\nreferences:\n    - https://www.blackhillsinfosec.com/mitm6-strikes-again-the-dark-side-of-ipv6/\n    - https://redfoxsec.com/blog/ipv6-dns-takeover/\n    - https://www.securityhq.com/blog/malicious-isatap-tunneling-unearthed-on-windows-server/\n    - https://medium.com/@ninnesoturan/detecting-ipv6-dns-takeover-a54a6a88be1f\nauthor: hamid\ndate: 2025-10-19\ntags:\n    - attack.impact\n    - attack.credential-access\n    - attack.collection\n    - attack.initial-access\n    - attack.privilege-escalation\n    - attack.execution\n    - attack.t1557\n    - attack.t1565.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        EventID: 4100\n        Provider_Name: 'Microsoft-Windows-Iphlpsvc'\n    filter_main_localhost:\n        IsatapRouter:\n            - '127.0.0.1'\n            - '::1'\n    filter_optional_null:\n        IsatapRouter: null\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Legitimate ISATAP router configuration in enterprise environments\n    - IPv6 transition projects and network infrastructure changes\n    - Network administrators configuring dual-stack networking\n    - Automatic ISATAP configuration in some Windows deployments\nlevel: medium\n"},{"path":"builtin\\system\\microsoft_windows_eventlog\\win_system_susp_eventlog_cleared.yml","content":"title: Important Windows Eventlog Cleared\nid: 100ef69e-3327-481c-8e5c-6d80d9507556\nrelated:\n    - id: a62b37e0-45d3-48d9-a517-90c1a1b0186b\n      type: derived\nstatus: test\ndescription: Detects the clearing of one of the Windows Core Eventlogs. e.g. caused by \"wevtutil cl\" command execution\nreferences:\n    - https://twitter.com/deviouspolack/status/832535435960209408\n    - https://www.hybrid-analysis.com/sample/027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745?environmentId=100\nauthor: Florian Roth (Nextron Systems), Tim Shelton, Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-05-17\nmodified: 2023-11-15\ntags:\n    - attack.defense-evasion\n    - attack.t1070.001\n    - car.2016-04-002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        EventID: 104\n        Provider_Name: 'Microsoft-Windows-Eventlog'\n        Channel:\n            - 'Microsoft-Windows-PowerShell/Operational'\n            - 'Microsoft-Windows-Sysmon/Operational'\n            - 'PowerShellCore/Operational'\n            - 'Security'\n            - 'System'\n            - 'Windows PowerShell'\n    condition: selection\nfalsepositives:\n    - Rollout of log collection agents (the setup routine often includes a reset of the local Eventlog)\n    - System provisioning (system reset before the golden image creation)\nlevel: high\n"},{"path":"builtin\\system\\microsoft_windows_eventlog\\win_system_eventlog_cleared.yml","content":"title: Eventlog Cleared\nid: a62b37e0-45d3-48d9-a517-90c1a1b0186b\nrelated:\n    - id: f2f01843-e7b8-4f95-a35a-d23584476423\n      type: obsolete\n    - id: d99b79d2-0a6f-4f46-ad8b-260b6e17f982\n      type: derived\n    - id: 100ef69e-3327-481c-8e5c-6d80d9507556\n      type: derived\nstatus: test\ndescription: One of the Windows Eventlogs has been cleared. e.g. caused by \"wevtutil cl\" command execution\nreferences:\n    - https://twitter.com/deviouspolack/status/832535435960209408\n    - https://www.hybrid-analysis.com/sample/027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745?environmentId=100\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-01-10\nmodified: 2023-11-15\ntags:\n    - attack.defense-evasion\n    - attack.t1070.001\n    - car.2016-04-002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        EventID: 104\n        Provider_Name: 'Microsoft-Windows-Eventlog'\n    filter_main_covered:\n        # The channels below are already covered by the rule 100ef69e-3327-481c-8e5c-6d80d9507556\n        Channel:\n            - 'Microsoft-Windows-PowerShell/Operational'\n            - 'Microsoft-Windows-Sysmon/Operational'\n            - 'PowerShellCore/Operational'\n            - 'Security'\n            - 'System'\n            - 'Windows PowerShell'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Rollout of log collection agents (the setup routine often includes a reset of the local Eventlog)\n    - System provisioning (system reset before the golden image creation)\nlevel: medium\n"},{"path":"builtin\\system\\microsoft_windows_distributed_com\\win_system_lpe_indicators_tabtip.yml","content":"title: Local Privilege Escalation Indicator TabTip\nid: bc2e25ed-b92b-4daa-b074-b502bdd1982b\nstatus: test\ndescription: Detects the invocation of TabTip via CLSID as seen when JuicyPotatoNG is used on a system in brute force mode\nreferences:\n    - https://github.com/antonioCoco/JuicyPotatoNG\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-10-07\nmodified: 2023-04-14\ntags:\n    - attack.collection\n    - attack.execution\n    - attack.credential-access\n    - attack.t1557.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Microsoft-Windows-DistributedCOM'\n        EventID: 10001\n        param1: 'C:\\Program Files\\Common Files\\microsoft shared\\ink\\TabTip.exe'  # Binary starting/started\n        param2: 2147943140                                                       # ERROR id\n        param3: '{054AAE20-4BEA-4347-8A35-64A533254A9D}'                         # DCOM Server\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\microsoft_windows_dhcp_server\\win_system_susp_dhcp_config_failed.yml","content":"title: DHCP Server Error Failed Loading the CallOut DLL\nid: 75edd3fd-7146-48e5-9848-3013d7f0282c\nstatus: test\ndescription: This rule detects a DHCP server error in which a specified Callout DLL (in registry) could not be loaded\nreferences:\n    - https://blog.3or.de/mimilib-dhcp-server-callout-dll-injection.html\n    - https://technet.microsoft.com/en-us/library/cc726884(v=ws.10).aspx\n    - https://msdn.microsoft.com/de-de/library/windows/desktop/aa363389(v=vs.85).aspx\nauthor: 'Dimitrios Slamaris, @atc_project (fix)'\ndate: 2017-05-15\nmodified: 2022-12-25\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.t1574.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        EventID:\n            - 1031\n            - 1032\n            - 1034\n        Provider_Name: Microsoft-Windows-DHCP-Server\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\microsoft_windows_dhcp_server\\win_system_susp_dhcp_config.yml","content":"title: DHCP Server Loaded the CallOut DLL\nid: 13fc89a9-971e-4ca6-b9dc-aa53a445bf40\nstatus: test\ndescription: This rule detects a DHCP server in which a specified Callout DLL (in registry) was loaded\nreferences:\n    - https://blog.3or.de/mimilib-dhcp-server-callout-dll-injection.html\n    - https://technet.microsoft.com/en-us/library/cc726884(v=ws.10).aspx\n    - https://msdn.microsoft.com/de-de/library/windows/desktop/aa363389(v=vs.85).aspx\nauthor: Dimitrios Slamaris\ndate: 2017-05-15\nmodified: 2022-12-25\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.t1574.001\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        EventID: 1033\n        Provider_Name: Microsoft-Windows-DHCP-Server\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\system\\microsoft_windows_certification_authority\\win_system_adcs_enrollment_request_denied.yml","content":"title: Active Directory Certificate Services Denied Certificate Enrollment Request\nid: 994bfd6d-0a2e-481e-a861-934069fcf5f5\nstatus: test\ndescription: |\n    Detects denied requests by Active Directory Certificate Services.\n    Example of these requests denial include issues with permissions on the certificate template or invalid signatures.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd299871(v=ws.10)\n    - https://www.gradenegger.eu/en/details-of-the-event-with-id-53-of-the-source-microsoft-windows-certificationauthority/\nauthor: '@SerkinValery'\ndate: 2024-03-07\ntags:\n    - attack.credential-access\n    - attack.defense-evasion\n    - attack.t1553.004\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Microsoft-Windows-CertificationAuthority'\n        EventID: 53\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"builtin\\system\\lsasrv\\win_system_lsasrv_ntlmv1.yml","content":"title: NTLMv1 Logon Between Client and Server\nid: e9d4ab66-a532-4ef7-a502-66a9e4a34f5d\nstatus: test\ndescription: Detects the reporting of NTLMv1 being used between a client and server. NTLMv1 is insecure as the underlying encryption algorithms can be brute-forced by modern hardware.\nreferences:\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/f1b010ce0ee1b71e3024180de1a3e67f99701fe4/ETWProvidersManifests/Windows10/22H2/W10_22H2_Pro_20230321_19045.2728/WEPExplorer/LsaSrv.xml\nauthor: Tim Shelton, Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-04-26\nmodified: 2023-06-06\ntags:\n    - attack.defense-evasion\n    - attack.lateral-movement\n    - attack.t1550.002\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: \"LsaSrv\"\n        EventID:\n            - 6038\n            - 6039\n    condition: selection\nfalsepositives:\n    - Environments that use NTLMv1\nlevel: medium\n"},{"path":"builtin\\system\\application_popup\\win_system_application_sysmon_crash.yml","content":"title: Sysmon Application Crashed\nid: 4d7f1827-1637-4def-8d8a-fd254f9454df\nstatus: test\ndescription: Detects application popup reporting a failure of the Sysmon service\nreferences:\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/f1b010ce0ee1b71e3024180de1a3e67f99701fe4/ETWProvidersManifests/Windows10/1803/W10_1803_Pro_19700101_17134.1/WEPExplorer/Application%20Popup.xml#L36\nauthor: Tim Shelton\ndate: 2022-04-26\nmodified: 2024-01-17\ntags:\n    - attack.defense-evasion\n    - attack.t1562\nlogsource:\n    product: windows\n    service: system\ndetection:\n    selection:\n        Provider_Name: 'Application Popup'\n        EventID: 26\n        Caption:\n            - 'sysmon64.exe - Application Error'\n            - 'sysmon.exe - Application Error'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\smbserver\\connectivity\\win_smbserver_connectivity_unsigned_and_unencrypted_share_connection.yml","content":"title: Unsigned or Unencrypted SMB Connection to Share Established\nid: 8d91f6e4-9f3b-4c21-ae41-2c5b7d9f7a12\nstatus: experimental\ndescription: |\n    Detects SMB server connections to shares without signing or encryption enabled.\n    This could indicate potential lateral movement activity using unsecured SMB shares.\nauthor: Mohamed Abdelghani\ndate: 2025-10-19\nreferences:\n    - https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/overview-server-message-block-signing\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: smbserver-connectivity\ndetection:\n    selection_shares:\n        EventID: 4000\n        ShareName|contains:\n            - 'IPC$'\n            - 'ADMIN$'\n            - 'C$'\n    selection_status:\n        - SigningUsed: 'false'\n        - EncyptionUsed: 'false' # Note: typo in the original event field name\n    filter_main_local_ips:\n        - ClientAddress|cidr:\n              # IPv4\n              # - '10.0.0.0/8'\n              - '127.0.0.0/8'\n              - '169.254.0.0/16'\n              # - '172.16.0.0/12'\n              # - '192.168.0.0/16'\n              # IPv6\n              - '::1/128'  # IPv6 loopback\n              - 'fe80::/10'  # IPv6 link-local addresses\n              - 'fc00::/7'  # IPv6 private addresses\n        # The filters below cover the XML raw log\n        - ClientAddress|contains:\n              # IPv6\n              - '00000000000000000000000000000001' # ::1 - IPv6 loopback\n              - 'FE80000000000000' # fe80:: - IPv6 link-local addresses\n              - 'FC00000000000000' # fc00:: - IPv6 private addresses\n              # IPv4\n              # The \"?\" are meant to represent the port\n              # - '0200????C0A8' # 192.168.\n              # - '0200????AC' # 172.\n              # - '0200????0A' # 10.\n              - '0200????7F' # 127\n              - '0200????A9FE' # 169.254.\n    condition: all of selection_* and not 1 of filter_main_*\nfalsepositives:\n    - Connections from local or private IP addresses to SMB shares without signing or encryption enabled for older systems or misconfigured environments. Apply additional tuning as needed.\nlevel: medium\n"},{"path":"builtin\\smbclient\\security\\win_smbclient_security_susp_failed_guest_logon.yml","content":"title: Suspicious Rejected SMB Guest Logon From IP\nid: 71886b70-d7b4-4dbf-acce-87d2ca135262\nstatus: test\ndescription: Detect Attempt PrintNightmare (CVE-2021-1675) Remote code execution in Windows Spooler Service\nreferences:\n    - https://twitter.com/KevTheHermit/status/1410203844064301056\n    - https://web.archive.org/web/20210629055600/https://github.com/hhlxf/PrintNightmare/\n    - https://web.archive.org/web/20210701042336/https://github.com/afwu/PrintNightmare\nauthor: Florian Roth (Nextron Systems), KevTheHermit, fuzzyf10w\ndate: 2021-06-30\nmodified: 2023-01-02\ntags:\n    - attack.credential-access\n    - attack.t1110.001\nlogsource:\n    product: windows\n    service: smbclient-security\ndetection:\n    selection:\n        EventID: 31017\n        UserName: ''\n        ServerName|startswith: '\\1'\n    condition: selection\nfields:\n    - Computer\n    - User\nfalsepositives:\n    - Account fallback reasons (after failed login with specific account)\nlevel: medium\n"},{"path":"builtin\\shell_core\\win_shell_core_susp_packages_installed.yml","content":"title: Suspicious Application Installed\nid: 83c161b6-ca67-4f33-8ad0-644a0737cf07\nstatus: test\ndescription: Detects suspicious application installed by looking at the added shortcut to the app resolver cache\nreferences:\n    - https://nasbench.medium.com/finding-forensic-goodness-in-obscure-windows-event-logs-60e978ea45a3\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-14\ntags:\n    - attack.execution\nlogsource:\n    product: windows\n    service: shell-core\ndetection:\n    selection_name:\n        EventID: 28115\n        Name|contains:\n            # Please add more\n            - 'Zenmap'\n            - 'AnyDesk'\n            - 'wireshark'\n            - 'openvpn'\n    selection_packageid:\n        EventID: 28115\n        AppID|contains:\n            # Please add more\n            - 'zenmap.exe'\n            - 'prokzult ad' # AnyDesk\n            - 'wireshark'\n            - 'openvpn'\n    condition: 1 of selection_*\nfalsepositives:\n    - Packages or applications being legitimately used by users or administrators\nlevel: medium\n"},{"path":"builtin\\servicebus\\win_hybridconnectionmgr_svc_running.yml","content":"title: HybridConnectionManager Service Running\nid: b55d23e5-6821-44ff-8a6e-67218891e49f\nstatus: test\ndescription: Rule to detect the Hybrid Connection Manager service running on an endpoint.\nreferences:\n    - https://twitter.com/Cyb3rWard0g/status/1381642789369286662\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2021-04-12\nmodified: 2024-08-05\ntags:\n    - attack.persistence\n    - attack.t1554\nlogsource:\n    product: windows\n    service: microsoft-servicebus-client # Change to servicebus-client once validators are up to date\ndetection:\n    selection:\n        EventID:\n            - 40300\n            - 40301\n            - 40302\n    keywords:\n        - 'HybridConnection'\n        - 'sb://'\n        - 'servicebus.windows.net'\n        - 'HybridConnectionManage'\n    condition: selection and keywords\nfalsepositives:\n    - Legitimate use of Hybrid Connection Manager via Azure function apps.\nlevel: high\n"},{"path":"builtin\\security_mitigations\\win_security_mitigations_unsigned_dll_from_susp_location.yml","content":"title: Unsigned Binary Loaded From Suspicious Location\nid: 8289bf8c-4aca-4f5a-9db3-dc3d7afe5c10\nstatus: test\ndescription: Detects Code Integrity (CI) engine blocking processes from loading unsigned DLLs residing in suspicious locations\nreferences:\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/45fd5be71a51aa518b1b36d4e1f36af498084e27/ETWEventsList/CSV/Windows11/21H2/W11_21H2_Pro_20220719_22000.795/Providers/Microsoft-Windows-Security-Mitigations.csv\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-03\nmodified: 2022-09-28\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.t1574.001\nlogsource:\n    product: windows\n    service: security-mitigations\ndetection:\n    selection:\n        EventID:\n            - 11\n            - 12\n        ImageName|contains:\n            - '\\Users\\Public\\'\n            - '\\PerfLogs\\'\n            - '\\Desktop\\'\n            - '\\Downloads\\'\n            - '\\AppData\\Local\\Temp\\'\n            - 'C:\\Windows\\TEMP\\'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security_mitigations\\win_security_mitigations_defender_load_unsigned_dll.yml","content":"title: Microsoft Defender Blocked from Loading Unsigned DLL\nid: 0b0ea3cc-99c8-4730-9c53-45deee2a4c86\nstatus: test\ndescription: Detects Code Integrity (CI) engine blocking Microsoft Defender's processes (MpCmdRun and NisSrv) from loading unsigned DLLs which may be an attempt to sideload arbitrary DLL\nreferences:\n    - https://www.sentinelone.com/blog/living-off-windows-defender-lockbit-ransomware-sideloads-cobalt-strike-through-microsoft-security-tool\nauthor: Bhabesh Raj\ndate: 2022-08-02\nmodified: 2022-09-28\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.t1574.001\nlogsource:\n    product: windows\n    service: security-mitigations\ndetection:\n    selection:\n        EventID:\n            - 11\n            - 12 # MDE: ExploitGuardNonMicrosoftSignedBlocked\n        ProcessPath|endswith:\n            - '\\MpCmdRun.exe'\n            - '\\NisSrv.exe'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_workstation_was_locked.yml","content":"title: Locked Workstation\nid: 411742ad-89b0-49cb-a7b0-3971b5c1e0a4\nstatus: stable\ndescription: Detects locked workstation session events that occur automatically after a standard period of inactivity.\nreferences:\n    - https://www.cisecurity.org/controls/cis-controls-list/\n    - https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-2-1.pdf\n    - https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf\n    - https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4800\nauthor: Alexandr Yampolskyi, SOC Prime\ndate: 2019-03-26\nmodified: 2023-12-11\ntags:\n    - attack.impact\n    # - CSC16\n    # - CSC16.11\n    # - ISO27002-2013 A.9.1.1\n    # - ISO27002-2013 A.9.2.1\n    # - ISO27002-2013 A.9.2.2\n    # - ISO27002-2013 A.9.2.3\n    # - ISO27002-2013 A.9.2.4\n    # - ISO27002-2013 A.9.2.5\n    # - ISO27002-2013 A.9.2.6\n    # - ISO27002-2013 A.9.3.1\n    # - ISO27002-2013 A.9.4.1\n    # - ISO27002-2013 A.9.4.3\n    # - ISO27002-2013 A.11.2.8\n    # - PCI DSS 3.1 7.1\n    # - PCI DSS 3.1 7.2\n    # - PCI DSS 3.1 7.3\n    # - PCI DSS 3.1 8.7\n    # - PCI DSS 3.1 8.8\n    # - NIST CSF 1.1 PR.AC-1\n    # - NIST CSF 1.1 PR.AC-4\n    # - NIST CSF 1.1 PR.AC-6\n    # - NIST CSF 1.1 PR.AC-7\n    # - NIST CSF 1.1 PR.PT-3\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4800\n    condition: selection\nfalsepositives:\n    - Likely\nlevel: informational\n"},{"path":"builtin\\security\\win_security_wmi_persistence.yml","content":"title: WMI Persistence - Security\nid: f033f3f3-fd24-4995-97d8-a3bb17550a88\nrelated:\n    - id: 0b7889b4-5577-4521-a60a-3376ee7f9f7b\n      type: derived\nstatus: test\ndescription: Detects suspicious WMI event filter and command line event consumer based on WMI and Security Logs.\nreferences:\n    - https://twitter.com/mattifestation/status/899646620148539397\n    - https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/\nauthor: Florian Roth (Nextron Systems), Gleb Sukhodolskiy, Timur Zinniatullin oscd.community\ndate: 2017-08-22\nmodified: 2022-11-29\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1546.003\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4662\n        ObjectType: 'WMI Namespace'\n        ObjectName|contains: 'subscription'\n    condition: selection\nfalsepositives:\n    - Unknown (data set is too small; further testing needed)\nlevel: medium\n"},{"path":"builtin\\security\\win_security_wmiprvse_wbemcomn_dll_hijack.yml","content":"title: T1047 Wmiprvse Wbemcomn DLL Hijack\nid: f6c68d5f-e101-4b86-8c84-7d96851fd65c\nstatus: test\ndescription: Detects a threat actor creating a file named `wbemcomn.dll` in the `C:\\Windows\\System32\\wbem\\` directory over the network for a WMI DLL Hijack scenario.\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/201009-RemoteWMIWbemcomnDLLHijack/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR)\ndate: 2020-10-12\nmodified: 2022-02-24\ntags:\n    - attack.execution\n    - attack.t1047\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5145\n        RelativeTargetName|endswith: '\\wbem\\wbemcomn.dll'\n    filter:\n        SubjectUserName|endswith: '$'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_windows_defender_exclusions_write_access.yml","content":"title: Windows Defender Exclusion Registry Key - Write Access Requested\nid: e9c8808f-4cfb-4ba9-97d4-e5f3beaa244d\nrelated:\n    - id: 46a68649-f218-4f86-aea1-16a759d81820\n      type: derived\n    - id: a33f8808-2812-4373-ae95-8cfb82134978\n      type: derived\nstatus: test\ndescription: |\n    Detects write access requests to the Windows Defender exclusions registry keys. This could be an indication of an attacker trying to request a handle or access the object to write new exclusions in order to bypass security.\nreferences:\n    - https://www.bleepingcomputer.com/news/security/gootkit-malware-bypasses-windows-defender-by-setting-path-exclusions/\nauthor: '@BarryShooshooga, Nasreddine Bencherchali (Nextron Systems)'\ndate: 2019-10-26\nmodified: 2023-11-11\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Policy : Security Settings/Local Policies/Audit Policy, Registry System Access Control (SACL): Auditing/User'\ndetection:\n    selection:\n        AccessList|contains:\n            - '%%4417' # WriteData\n            - '%%4418' # AppendData\n        EventID:\n            - 4656 # A handle to an object was requested.\n            - 4663 # An attempt was made to access an object.\n        ObjectName|contains: '\\Microsoft\\Windows Defender\\Exclusions\\'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_windows_defender_exclusions_registry_modified.yml","content":"title: Windows Defender Exclusion List Modified\nid: 46a68649-f218-4f86-aea1-16a759d81820\nrelated:\n    - id: e9c8808f-4cfb-4ba9-97d4-e5f3beaa244d\n      type: derived\n    - id: a33f8808-2812-4373-ae95-8cfb82134978\n      type: derived\nstatus: test\ndescription: |\n    Detects modifications to the Windows Defender exclusion registry key. This could indicate a potentially suspicious or even malicious activity by an attacker trying to add a new exclusion in order to bypass security.\nreferences:\n    - https://www.bleepingcomputer.com/news/security/gootkit-malware-bypasses-windows-defender-by-setting-path-exclusions/\nauthor: '@BarryShooshooga'\ndate: 2019-10-26\nmodified: 2023-11-11\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Policy : Security Settings/Local Policies/Audit Policy, Registry System Access Control (SACL): Auditing/User'\ndetection:\n    selection:\n        EventID: 4657 # A registry value was modified.\n        ObjectName|contains: '\\Microsoft\\Windows Defender\\Exclusions\\'\n    condition: selection\nfalsepositives:\n    - Intended exclusions by administrators\nlevel: medium\n"},{"path":"builtin\\security\\win_security_vssaudit_secevent_source_registration.yml","content":"title: VSSAudit Security Event Source Registration\nid: e9faba72-4974-4ab2-a4c5-46e25ad59e9b\nstatus: test\ndescription: Detects the registration of the security event source VSSAudit. It would usually trigger when volume shadow copy operations happen.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1003.002/T1003.002.md#atomic-test-3---esentutlexe-sam-copy\nauthor: Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR)\ndate: 2020-10-20\nmodified: 2022-04-28\ntags:\n    - attack.credential-access\n    - attack.t1003.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        AuditSourceName: VSSAudit\n        EventID:\n            - 4904\n            - 4905\n    condition: selection\nfalsepositives:\n    - Legitimate use of VSSVC. Maybe backup operations. It would usually be done by C:\\Windows\\System32\\VSSVC.exe.\nlevel: informational\n"},{"path":"builtin\\security\\win_security_user_logoff.yml","content":"title: User Logoff Event\nid: 0badd08f-c6a3-4630-90d3-6875cca440be\nstatus: test\ndescription: Detects a user log-off activity. Could be used for example to correlate information during forensic investigations\nreferences:\n    - https://github.com/Yamato-Security/EnableWindowsLogSettings/blob/7f6d755d45ac7cc9fc35b0cbf498e6aa4ef19def/ConfiguringSecurityLogAuditPolicies.md\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4634\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4647\nauthor: frack113\ndate: 2022-10-14\ntags:\n    - attack.impact\n    - attack.t1531\nlogsource:\n    service: security\n    product: windows\ndetection:\n    selection:\n        EventID:\n            - 4634\n            - 4647\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: informational\n"},{"path":"builtin\\security\\win_security_user_driver_loaded.yml","content":"title: Potential Privileged System Service Operation - SeLoadDriverPrivilege\nid: f63508a0-c809-4435-b3be-ed819394d612\nstatus: test\ndescription: |\n    Detects the usage of the 'SeLoadDriverPrivilege' privilege. This privilege is required to load or unload a device driver.\n    With this privilege, the user can dynamically load and unload device drivers or other code in to kernel mode.\n    This user right does not apply to Plug and Play device drivers.\n    If you exclude privileged users/admins and processes, which are allowed to do so, you are maybe left with bad programs trying to load malicious kernel drivers.\n    This will detect Ghost-In-The-Logs (https://github.com/bats3c/Ghost-In-The-Logs) and the usage of Sysinternals and various other tools. So you have to work with a whitelist to find the bad stuff.\nreferences:\n    - https://web.archive.org/web/20230331181619/https://blog.dylan.codes/evading-sysmon-and-windows-event-logging/\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4673\nauthor: xknow (@xknow_infosec), xorxes (@xor_xes)\ndate: 2019-04-08\nmodified: 2025-10-07\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_1:\n        EventID: 4673\n        PrivilegeList: 'SeLoadDriverPrivilege'\n        Service: '-'\n    filter_main_exact:\n        ProcessName:\n            - 'C:\\Windows\\System32\\Dism.exe'\n            - 'C:\\Windows\\System32\\rundll32.exe'\n            - 'C:\\Windows\\System32\\fltMC.exe'\n            - 'C:\\Windows\\HelpPane.exe'\n            - 'C:\\Windows\\System32\\mmc.exe'\n            - 'C:\\Windows\\System32\\svchost.exe'\n            - 'C:\\Windows\\System32\\wimserv.exe'\n            - 'C:\\Windows\\System32\\RuntimeBroker.exe'\n            - 'C:\\Windows\\System32\\SystemSettingsBroker.exe'\n            - 'C:\\Windows\\explorer.exe'\n    filter_optional_others:\n        ProcessName|endswith:\n            - '\\procexp64.exe'\n            - '\\procexp.exe'\n            - '\\procmon64.exe'\n            - '\\procmon.exe'\n            - '\\Google\\Chrome\\Application\\chrome.exe'\n            - '\\AppData\\Local\\Microsoft\\Teams\\current\\Teams.exe'\n    filter_main_startswith:\n        ProcessName|startswith: 'C:\\Program Files\\WindowsApps\\Microsoft'\n    filter_optional_dropbox:\n        ProcessName|startswith:\n            - 'C:\\Program Files (x86)\\Dropbox\\'\n            - 'C:\\Program Files\\Dropbox\\'\n        ProcessName|endswith: '\\Dropbox.exe'\n    condition: selection_1 and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Other legimate tools loading drivers. Including but not limited to, Sysinternals, CPU-Z, AVs etc. A baseline needs to be created according to the used products and allowed tools. A good thing to do is to try and exclude users who are allowed to load drivers.\nlevel: medium\n"},{"path":"builtin\\security\\win_security_user_creation.yml","content":"title: Local User Creation\nid: 66b6be3d-55d0-4f47-9855-d69df21740ea\nstatus: test\ndescription: |\n    Detects local user creation on Windows servers, which shouldn't happen in an Active Directory environment. Apply this Sigma Use Case on your Windows server logs and not on your DC logs.\nreferences:\n    - https://patrick-bareiss.com/detecting-local-user-creation-in-ad-with-sigma/\nauthor: Patrick Bareiss\ndate: 2019-04-18\nmodified: 2021-01-17\ntags:\n    - attack.persistence\n    - attack.t1136.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4720\n    condition: selection\nfalsepositives:\n    - Domain Controller Logs\n    - Local accounts managed by privileged account management tools\nlevel: low\n"},{"path":"builtin\\security\\win_security_user_couldnt_call_priv_service_lsaregisterlogonprocess.yml","content":"title: User Couldn't Call a Privileged Service 'LsaRegisterLogonProcess'\nid: 6daac7fc-77d1-449a-a71a-e6b4d59a0e54\nstatus: test\ndescription: The 'LsaRegisterLogonProcess' function verifies that the application making the function call is a logon process by checking that it has the SeTcbPrivilege privilege set. Possible Rubeus tries to get a handle to LSA.\nreferences:\n    - https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1\nauthor: Roberto Rodriguez (source), Ilyas Ochkov (rule), oscd.community\ndate: 2019-10-24\nmodified: 2022-12-25\ntags:\n    - attack.credential-access\n    - attack.lateral-movement\n    - attack.privilege-escalation\n    - attack.t1558.003\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4673\n        Service: 'LsaRegisterLogonProcess()'\n        Keywords: '0x8010000000000000'     # failure\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_user_added_to_local_administrators.yml","content":"title: User Added to Local Administrator Group\nid: c265cf08-3f99-46c1-8d59-328247057d57\nstatus: stable\ndescription: Detects the addition of a new member to the local administrator group, which could be legitimate activity or a sign of privilege escalation activity\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4732\n    - https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-03-14\nmodified: 2021-01-17\ntags:\n    - attack.initial-access\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1078\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_eid:\n        EventID: 4732\n    selection_group:\n        - TargetUserName|startswith: 'Administr'\n        - TargetSid: 'S-1-5-32-544'\n    filter_main_computer_accounts:\n        SubjectUserName|endswith: '$'\n    condition: all of selection_* and not 1 of filter_*\nfalsepositives:\n    - Legitimate administrative activity\nlevel: medium\n"},{"path":"builtin\\security\\win_security_transf_files_with_cred_data_via_network_shares.yml","content":"title: Transferring Files with Credential Data via Network Shares\nid: 910ab938-668b-401b-b08c-b596e80fdca5\nrelated:\n    - id: 2e69f167-47b5-4ae7-a390-47764529eff5\n      type: similar\nstatus: test\ndescription: Transferring files with well-known filenames (sensitive files with credential data) using network shares\nreferences:\n    - https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment\nauthor: Teymur Kheirkhabarov, oscd.community\ndate: 2019-10-22\nmodified: 2025-07-11\ntags:\n    - attack.credential-access\n    - attack.t1003.002\n    - attack.t1003.001\n    - attack.t1003.003\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_eid:\n        EventID: 5145\n    selection_object:\n        - RelativeTargetName|contains:\n              - '\\mimidrv'\n              - '\\lsass'\n              - '\\windows\\minidump\\'\n              - '\\hiberfil'\n              - '\\sqldmpr'\n        - RelativeTargetName:\n              - 'Windows\\NTDS\\ntds.dit'\n              - 'Windows\\System32\\config\\SAM'\n              - 'Windows\\System32\\config\\SECURITY'\n              - 'Windows\\System32\\config\\SYSTEM'\n    condition: all of selection_*\nfalsepositives:\n    - Transferring sensitive files for legitimate administration work by legitimate administrator\nlevel: medium\n"},{"path":"builtin\\security\\win_security_teams_suspicious_objectaccess.yml","content":"title: Suspicious Teams Application Related ObjectAcess Event\nid: 25cde13e-8e20-4c29-b949-4e795b76f16f\nstatus: test\ndescription: Detects an access to authentication tokens and accounts of Microsoft Teams desktop application.\nreferences:\n    - https://www.bleepingcomputer.com/news/security/microsoft-teams-stores-auth-tokens-as-cleartext-in-windows-linux-macs/\n    - https://www.vectra.ai/blogpost/undermining-microsoft-teams-security-by-mining-tokens\nauthor: '@SerkinValery'\ndate: 2022-09-16\ntags:\n    - attack.credential-access\n    - attack.t1528\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4663\n        ObjectName|contains:\n            - '\\Microsoft\\Teams\\Cookies'\n            - '\\Microsoft\\Teams\\Local Storage\\leveldb'\n    filter:\n        ProcessName|contains: '\\Microsoft\\Teams\\current\\Teams.exe'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_tap_driver_installation.yml","content":"title: Tap Driver Installation - Security\nid: 9c8afa4d-0022-48f0-9456-3712466f9701\nrelated:\n    - id: 8e4cf0e5-aa5d-4dc3-beff-dc26917744a9\n      type: derived\nstatus: test\ndescription: |\n    Detects the installation of a well-known TAP driver service. This could be a sign of potential preparation for data exfiltration using tunnelling techniques.\nreferences:\n    - https://community.openvpn.net/openvpn/wiki/ManagingWindowsTAPDrivers\nauthor: Daniil Yugoslavskiy, Ian Davis, oscd.community\ndate: 2019-10-24\nmodified: 2022-11-29\ntags:\n    - attack.exfiltration\n    - attack.t1048\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: The System Security Extension audit subcategory need to be enabled to log the EID 4697'\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains: 'tap0901'\n    condition: selection\nfalsepositives:\n    - Legitimate OpenVPN TAP installation\nlevel: low\n"},{"path":"builtin\\security\\win_security_sysmon_channel_reference_deletion.yml","content":"title: Sysmon Channel Reference Deletion\nid: 18beca67-ab3e-4ee3-ba7a-a46ca8d7d0cc\nstatus: test\ndescription: Potential threat actor tampering with Sysmon manifest and eventually disabling it\nreferences:\n    - https://twitter.com/Flangvik/status/1283054508084473861\n    - https://twitter.com/SecurityJosh/status/1283027365770276866\n    - https://securityjosh.github.io/2020/04/23/Mute-Sysmon.html\n    - https://gist.github.com/Cyb3rWard0g/cf08c38c61f7e46e8404b38201ca01c8\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2020-07-14\nmodified: 2025-10-22\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.t1112\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection1:\n        EventID: 4657\n        ObjectName|contains:\n            - 'WINEVT\\Publishers\\{5770385f-c22a-43e0-bf4c-06f5698ffbd9}'\n            - 'WINEVT\\Channels\\Microsoft-Windows-Sysmon/Operational'\n        ObjectValueName: 'Enabled'\n        NewValue: 0\n    selection2:\n        EventID: 4663\n        ObjectName|contains:\n            - 'WINEVT\\Publishers\\{5770385f-c22a-43e0-bf4c-06f5698ffbd9}'\n            - 'WINEVT\\Channels\\Microsoft-Windows-Sysmon/Operational'\n        AccessMask: '0x10000'\n    condition: 1 of selection*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_syskey_registry_access.yml","content":"title: SysKey Registry Keys Access\nid: 9a4ff3b8-6187-4fd2-8e8b-e0eae1129495\nstatus: test\ndescription: Detects handle requests and access operations to specific registry keys to calculate the SysKey\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190625-RegKeyAccessSyskey/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-08-12\nmodified: 2021-11-27\ntags:\n    - attack.discovery\n    - attack.t1012\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4656\n            - 4663\n        ObjectType: 'key'\n        ObjectName|endswith:\n            - 'lsa\\JD'\n            - 'lsa\\GBG'\n            - 'lsa\\Skew1'\n            - 'lsa\\Data'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_svcctl_remote_service.yml","content":"title: Remote Service Activity via SVCCTL Named Pipe\nid: 586a8d6b-6bfe-4ad9-9d78-888cd2fe50c3\nstatus: test\ndescription: Detects remote service activity via remote access to the svcctl named pipe\nreferences:\n    - https://web.archive.org/web/20230329155141/https://blog.menasec.net/2019/03/threat-hunting-26-remote-windows.html\nauthor: Samir Bousseaden\ndate: 2019-04-03\nmodified: 2024-08-01\ntags:\n    - attack.lateral-movement\n    - attack.persistence\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection:\n        EventID: 5145\n        ShareName: '\\\\\\\\\\*\\\\IPC$' # looking for the string \\\\*\\IPC$\n        RelativeTargetName: svcctl\n        AccessList|contains: 'WriteData'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_time_modification.yml","content":"title: Unauthorized System Time Modification\nid: faa031b5-21ed-4e02-8881-2591f98d82ed\nstatus: test\ndescription: Detect scenarios where a potentially unauthorized application or user is modifying the system time.\nreferences:\n    - Private Cuckoo Sandbox (from many years ago, no longer have hash, NDA as well)\n    - Live environment caused by malware\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4616\nauthor: '@neu5ron'\ndate: 2019-02-05\nmodified: 2022-08-03\ntags:\n    - attack.defense-evasion\n    - attack.t1070.006\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Policy : System > Audit Security State Change, Group Policy : Computer Configuration\\Windows Settings\\Security Settings\\Advanced Audit Policy Configuration\\Audit Policies\\System\\Audit Security State Change'\ndetection:\n    selection:\n        EventID: 4616\n    filter1:\n        ProcessName:\n            - 'C:\\Program Files\\VMware\\VMware Tools\\vmtoolsd.exe'\n            - 'C:\\Windows\\System32\\VBoxService.exe'\n            - 'C:\\Windows\\System32\\oobe\\msoobe.exe'\n    filter2:\n        ProcessName: 'C:\\Windows\\System32\\svchost.exe'\n        SubjectUserSid: 'S-1-5-19'\n    condition: selection and not 1 of filter*\nfalsepositives:\n    - HyperV or other virtualization technologies with binary not listed in filter portion of detection\nlevel: low\n"},{"path":"builtin\\security\\win_security_susp_scheduled_task_update.yml","content":"title: Suspicious Scheduled Task Update\nid: 614cf376-6651-47c4-9dcc-6b9527f749f4\nrelated:\n    - id: 1c0e41cd-21bb-4433-9acc-4a2cd6367b9b # ProcCreation schtasks change\n      type: similar\nstatus: test\ndescription: Detects update to a scheduled task event that contain suspicious keywords.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4698\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-05\ntags:\n    - attack.execution\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1053.005\nlogsource:\n    product: windows\n    service: security\n    definition: 'The Advanced Audit Policy setting Object Access > Audit Other Object Access Events has to be configured to allow this detection. We also recommend extracting the Command field from the embedded XML in the event data.'\ndetection:\n    selection_eid:\n        EventID: 4702\n    selection_paths:\n        TaskContentNew|contains:\n            - '\\AppData\\Local\\Temp\\'\n            - '\\AppData\\Roaming\\'\n            - '\\Users\\Public\\'\n            - '\\WINDOWS\\Temp\\'\n            - 'C:\\Temp\\'\n            - '\\Desktop\\'\n            - '\\Downloads\\'\n            - '\\Temporary Internet'\n            - 'C:\\ProgramData\\'\n            - 'C:\\Perflogs\\'\n    selection_commands:\n        TaskContentNew|contains:\n            - 'regsvr32'\n            - 'rundll32'\n            - 'cmd.exe</Command>'\n            - 'cmd</Command>'\n            - '<Arguments>/c '\n            - '<Arguments>/k '\n            - '<Arguments>/r '\n            - 'powershell'\n            - 'pwsh'\n            - 'mshta'\n            - 'wscript'\n            - 'cscript'\n            - 'certutil'\n            - 'bitsadmin'\n            - 'bash.exe'\n            - 'bash '\n            - 'scrcons'\n            - 'wmic '\n            - 'wmic.exe'\n            - 'forfiles'\n            - 'scriptrunner'\n            - 'hh.exe'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_scheduled_task_delete_or_disable.yml","content":"title: Important Scheduled Task Deleted/Disabled\nid: 7595ba94-cf3b-4471-aa03-4f6baa9e5fad\nrelated:\n    - id: dbc1f800-0fe0-4bc0-9c66-292c2abe3f78 # ProcCreation schtasks delete\n      type: similar\n    - id: 9ac94dc8-9042-493c-ba45-3b5e7c86b980 # ProcCreation schtasks disable\n      type: similar\n    - id: 9e3cb244-bdb8-4632-8c90-6079c8f4f16d # TaskScheduler EventLog\n      type: similar\nstatus: test\ndescription: Detects when adversaries stop services or processes by deleting or disabling their respective scheduled tasks in order to conduct data destructive activities\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4699\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4701\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-05\nmodified: 2023-03-13\ntags:\n    - attack.execution\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1053.005\nlogsource:\n    product: windows\n    service: security\n    definition: 'The Advanced Audit Policy setting Object Access > Audit Other Object Access Events has to be configured to allow this detection. We also recommend extracting the Command field from the embedded XML in the event data.'\ndetection:\n    selection:\n        EventID:\n            - 4699 # Task Deleted Event\n            - 4701 # Task Disabled Event\n        TaskName|contains:\n            # Add more important tasks\n            - '\\Windows\\SystemRestore\\SR'\n            - '\\Windows\\Windows Defender\\'\n            - '\\Windows\\BitLocker'\n            - '\\Windows\\WindowsBackup\\'\n            - '\\Windows\\WindowsUpdate\\'\n            - '\\Windows\\UpdateOrchestrator\\Schedule'\n            - '\\Windows\\ExploitGuard'\n    filter_sys_username:\n        EventID: 4699\n        SubjectUserName|endswith: '$'  # False positives during upgrades of Defender, where its tasks get removed and added\n        TaskName|contains: '\\Windows\\Windows Defender\\'\n    condition: selection and not 1 of filter_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_scheduled_task_creation.yml","content":"title: Suspicious Scheduled Task Creation\nid: 3a734d25-df5c-4b99-8034-af1ddb5883a4\nstatus: test\ndescription: Detects suspicious scheduled task creation events. Based on attributes such as paths, commands line flags, etc.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4698\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-05\nmodified: 2022-12-07\ntags:\n    - attack.execution\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1053.005\nlogsource:\n    product: windows\n    service: security\n    definition: 'The Advanced Audit Policy setting Object Access > Audit Other Object Access Events has to be configured to allow this detection. We also recommend extracting the Command field from the embedded XML in the event data.'\ndetection:\n    selection_eid:\n        EventID: 4698\n    selection_paths:\n        TaskContent|contains:\n            - '\\AppData\\Local\\Temp\\'\n            - '\\AppData\\Roaming\\'\n            - '\\Users\\Public\\'\n            - '\\WINDOWS\\Temp\\'\n            - 'C:\\Temp\\'\n            - '\\Desktop\\'\n            - '\\Downloads\\'\n            - '\\Temporary Internet'\n            - 'C:\\ProgramData\\'\n            - 'C:\\Perflogs\\'\n    selection_commands:\n        TaskContent|contains:\n            - 'regsvr32'\n            - 'rundll32'\n            - 'cmd.exe</Command>'\n            - 'cmd</Command>'\n            - '<Arguments>/c '\n            - '<Arguments>/k '\n            - '<Arguments>/r '\n            - 'powershell'\n            - 'pwsh'\n            - 'mshta'\n            - 'wscript'\n            - 'cscript'\n            - 'certutil'\n            - 'bitsadmin'\n            - 'bash.exe'\n            - 'bash '\n            - 'scrcons'\n            - 'wmic '\n            - 'wmic.exe'\n            - 'forfiles'\n            - 'scriptrunner'\n            - 'hh.exe'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_rc4_kerberos.yml","content":"title: Suspicious Kerberos RC4 Ticket Encryption\nid: 496a0e47-0a33-4dca-b009-9e6ca3591f39\nstatus: test\ndescription: Detects service ticket requests using RC4 encryption type\nreferences:\n    - https://adsecurity.org/?p=3458\n    - https://www.trimarcsecurity.com/single-post/TrimarcResearch/Detecting-Kerberoasting-Activity\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-02-06\nmodified: 2022-06-19\ntags:\n    - attack.credential-access\n    - attack.t1558.003\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4769\n        TicketOptions: '0x40810000'\n        TicketEncryptionType: '0x17'\n    reduction:\n        ServiceName|endswith: '$'\n    condition: selection and not reduction\nfalsepositives:\n    - Service accounts used on legacy systems (e.g. NetApp)\n    - Windows Domains with DFL 2003 and legacy systems\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_raccess_sensitive_fext.yml","content":"title: Suspicious Access to Sensitive File Extensions\nid: 91c945bc-2ad1-4799-a591-4d00198a1215\nrelated:\n    - id: 286b47ed-f6fe-40b3-b3a8-35129acd43bc\n      type: similar\nstatus: test\ndescription: Detects known sensitive file extensions accessed on a network share\nreferences:\n    - Internal Research\nauthor: Samir Bousseaden\ndate: 2019-04-03\nmodified: 2025-10-17\ntags:\n    - attack.collection\n    - attack.t1039\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5145\n        RelativeTargetName|endswith:\n            - '.bak'\n            - '.dmp'\n            - '.edb'\n            - '.kirbi'\n            - '.msg'\n            - '.nsf'\n            - '.nst'\n            - '.oab'\n            - '.ost'\n            - '.pst'\n            - '.rdp'\n            # - '\\groups.xml'  # Commented out: groups.xml is accessed legitimately by Group Policy processing; high FP rate in enterprise environments\n    condition: selection\nfalsepositives:\n    - Help Desk operator doing backup or re-imaging end user machine or backup software\n    - Users working with these data types or exchanging message files\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_psexec.yml","content":"title: Suspicious PsExec Execution\nid: c462f537-a1e3-41a6-b5fc-b2c2cef9bf82\nstatus: test\ndescription: detects execution of psexec or paexec with renamed service name, this rule helps to filter out the noise if psexec is used for legit purposes or if attacker uses a different psexec client other than sysinternal one\nreferences:\n    - https://web.archive.org/web/20230329171218/https://blog.menasec.net/2019/02/threat-hunting-3-detecting-psexec.html\nauthor: Samir Bousseaden\ndate: 2019-04-03\nmodified: 2022-08-11\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection1:\n        EventID: 5145\n        ShareName: '\\\\\\\\\\*\\\\IPC$' # looking for the string \\\\*\\IPC$\n        RelativeTargetName|endswith:\n            - '-stdin'\n            - '-stdout'\n            - '-stderr'\n    filter:\n        RelativeTargetName|startswith: 'PSEXESVC'\n    condition: selection1 and not filter\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_possible_shadow_credentials_added.yml","content":"title: Possible Shadow Credentials Added\nid: f598ea0c-c25a-4f72-a219-50c44411c791\nstatus: test\ndescription: Detects possible addition of shadow credentials to an active directory object.\nreferences:\n    - https://www.elastic.co/guide/en/security/8.4/potential-shadow-credentials-added-to-ad-object.html\n    - https://cyberstoph.org/posts/2022/03/detecting-shadow-credentials/\n    - https://twitter.com/SBousseaden/status/1581300963650187264?\nauthor: Nasreddine Bencherchali (Nextron Systems), Elastic (idea)\ndate: 2022-10-17\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.credential-access\n    - attack.t1556\nlogsource:\n    product: windows\n    service: security\n    definition: The \"Audit Directory Service Changes\" logging policy must be configured in order to receive events. Audit events are generated only for objects with configured system access control lists (SACLs). Audit events are generated only for objects with configured system access control lists (SACLs) and only when accessed in a manner that matches their SACL settings. This policy covers the following events ids - 5136, 5137, 5138, 5139, 5141. Note that the default policy does not cover User objects. For that a custom AuditRule need to be setup (See https://github.com/OTRF/Set-AuditRule)\ndetection:\n    selection:\n        EventID: 5136\n        AttributeLDAPDisplayName: 'msDS-KeyCredentialLink'\n        # If you experience a lot of FP you could uncomment the selection below\n        # There could be other cases for other tooling add them accordingly\n        # AttributeValue|contains: 'B:828'\n        # OperationType: '%%14674' # Value Added\n    # As stated in the FP sections it's better to filter out the expected accounts that perform this operation to tighten the logic\n    # Uncomment the filter below and add the account name (or any other specific field) accordingly\n    # Don't forget to add it to the condition section below\n    # filter:\n        # SubjectUserName: \"%name%\"\n    condition: selection\nfalsepositives:\n    - Modifications in the msDS-KeyCredentialLink attribute can be done legitimately by the Azure AD Connect synchronization account or the ADFS service account. These accounts can be added as Exceptions. (From elastic FP section)\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_outbound_kerberos_connection.yml","content":"title: Uncommon Outbound Kerberos Connection - Security\nid: eca91c7c-9214-47b9-b4c5-cb1d7e4f2350\nrelated:\n    - id: e54979bd-c5f9-4d6c-967b-a04b19ac4c74\n      type: similar\nstatus: test\ndescription: |\n    Detects uncommon outbound network activity via Kerberos default port indicating possible lateral movement or first stage PrivEsc via delegation.\nreferences:\n    - https://github.com/GhostPack/Rubeus\nauthor: Ilyas Ochkov, oscd.community\ndate: 2019-10-24\nmodified: 2024-03-15\ntags:\n    - attack.lateral-movement\n    - attack.credential-access\n    - attack.t1558.003\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5156\n        DestPort: 88\n    filter_main_lsass:\n        Application|startswith:\n            - '\\device\\harddiskvolume'\n            - 'C:'\n        Application|endswith: '\\Windows\\System32\\lsass.exe'\n    filter_optional_chrome:\n        Application|startswith:\n            - '\\device\\harddiskvolume'\n            - 'C:'\n        Application|endswith:\n            - '\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe'\n            - '\\Program Files\\Google\\Chrome\\Application\\chrome.exe'\n    filter_optional_firefox:\n        Application|startswith:\n            - '\\device\\harddiskvolume'\n            - 'C:'\n        Application|endswith:\n            - '\\Program Files (x86)\\Mozilla Firefox\\firefox.exe'\n            - '\\Program Files\\Mozilla Firefox\\firefox.exe'\n    filter_optional_tomcat:\n        Application|endswith: '\\tomcat\\bin\\tomcat8.exe'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Web Browsers and third party application might generate similar activity. An initial baseline is required.\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_opened_encrypted_zip_outlook.yml","content":"title: Password Protected ZIP File Opened (Email Attachment)\nid: 571498c8-908e-40b4-910b-d2369159a3da\nstatus: test\ndescription: Detects the extraction of password protected ZIP archives. See the filename variable for more details on which file has been opened.\nreferences:\n    - https://twitter.com/sbousseaden/status/1523383197513379841\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-05-09\ntags:\n    - attack.defense-evasion\n    - attack.initial-access\n    - attack.t1027\n    - attack.t1566.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5379\n        TargetName|contains|all:\n            - 'Microsoft_Windows_Shell_ZipFolder:filename'\n            - '\\Temporary Internet Files\\Content.Outlook'\n    condition: selection\nfalsepositives:\n    - Legitimate used of encrypted ZIP files\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_opened_encrypted_zip_filename.yml","content":"title: Password Protected ZIP File Opened (Suspicious Filenames)\nid: 54f0434b-726f-48a1-b2aa-067df14516e4\nstatus: test\ndescription: Detects the extraction of password protected ZIP archives with suspicious file names. See the filename variable for more details on which file has been opened.\nreferences:\n    - https://twitter.com/sbousseaden/status/1523383197513379841\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-05-09\ntags:\n    - attack.command-and-control\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.t1105\n    - attack.t1036\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5379\n        TargetName|contains: 'Microsoft_Windows_Shell_ZipFolder:filename'\n    selection_filename:\n        TargetName|contains:\n            - 'invoice'\n            - 'new order'\n            - 'rechnung'\n            - 'factura'\n            - 'delivery'\n            - 'purchase'\n            - 'order'\n            - 'payment'\n    condition: selection and selection_filename\nfalsepositives:\n    - Legitimate used of encrypted ZIP files\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_opened_encrypted_zip.yml","content":"title: Password Protected ZIP File Opened\nid: 00ba9da1-b510-4f6b-b258-8d338836180f\nstatus: test\ndescription: Detects the extraction of password protected ZIP archives. See the filename variable for more details on which file has been opened.\nreferences:\n    - https://twitter.com/sbousseaden/status/1523383197513379841\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-05-09\ntags:\n    - attack.defense-evasion\n    - attack.t1027\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5379\n        TargetName|contains: 'Microsoft_Windows_Shell_ZipFolder:filename'\n    filter:  # avoid overlaps with 54f0434b-726f-48a1-b2aa-067df14516e4\n        TargetName|contains: '\\Temporary Internet Files\\Content.Outlook'\n    condition: selection and not filter\nfalsepositives:\n    - Legitimate used of encrypted ZIP files\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_net_recon_activity.yml","content":"title: Reconnaissance Activity\nid: 968eef52-9cff-4454-8992-1e74b9cbad6c\nstatus: test\ndescription: Detects activity as \"net user administrator /domain\" and \"net group domain admins /domain\"\nreferences:\n    - https://findingbad.blogspot.de/2017/01/hunting-what-does-it-look-like.html\nauthor: Florian Roth (Nextron Systems), Jack Croock (method), Jonhnathan Ribeiro (improvements), oscd.community\ndate: 2017-03-07\nmodified: 2022-08-22\ntags:\n    - attack.discovery\n    - attack.t1087.002\n    - attack.t1069.002\n    - attack.s0039\nlogsource:\n    product: windows\n    service: security\n    definition: The volume of Event ID 4661 is high on Domain Controllers and therefore \"Audit SAM\" and \"Audit Kernel Object\" advanced audit policy settings are not configured in the recommendations for server systems\ndetection:\n    selection:\n        EventID: 4661\n        AccessMask: '0x2d'\n        ObjectType:\n            - 'SAM_USER'\n            - 'SAM_GROUP'\n        ObjectName|startswith: 'S-1-5-21-'\n        ObjectName|endswith:\n            - '-500'\n            - '-512'\n    condition: selection\nfalsepositives:\n    - Administrator activity\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_lsass_dump_generic.yml","content":"title: Potentially Suspicious AccessMask Requested From LSASS\nid: 4a1b6da0-d94f-4fc3-98fc-2d9cb9e5ee76\nstatus: test\ndescription: Detects process handle on LSASS process with certain access mask\nreferences:\n    - https://web.archive.org/web/20230208123920/https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html\n    - https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment\nauthor: Roberto Rodriguez, Teymur Kheirkhabarov, Dimitrios Slamaris, Mark Russinovich, Aleksey Potapov, oscd.community (update)\ndate: 2019-11-01\nmodified: 2023-12-19\ntags:\n    - attack.credential-access\n    - car.2019-04-004\n    - attack.t1003.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_1:\n        EventID: 4656 # A handle to an object was requested.\n        ObjectName|endswith: '\\lsass.exe'\n        AccessMask|contains:\n            - '0x40'\n            - '0x1400'\n            # - '0x1000'  # minimum access requirements to query basic info from service\n            - '0x100000'\n            - '0x1410'    # car.2019-04-004\n            - '0x1010'    # car.2019-04-004\n            - '0x1438'    # car.2019-04-004\n            - '0x143a'    # car.2019-04-004\n            - '0x1418'    # car.2019-04-004\n            - '0x1f0fff'\n            - '0x1f1fff'\n            - '0x1f2fff'\n            - '0x1f3fff'\n    selection_2:\n        EventID: 4663 # An attempt was made to access an object\n        ObjectName|endswith: '\\lsass.exe'\n        AccessList|contains:\n            - '4484'\n            - '4416'\n    filter_main_specific:\n        ProcessName|endswith:\n            - '\\csrss.exe'\n            - '\\GamingServices.exe'\n            - '\\lsm.exe'\n            - '\\MicrosoftEdgeUpdate.exe'\n            - '\\minionhost.exe'  # Cyberreason\n            - '\\MRT.exe'         # MS Malware Removal Tool\n            - '\\MsMpEng.exe'     # Defender\n            - '\\perfmon.exe'\n            - '\\procexp.exe'\n            - '\\procexp64.exe'\n            - '\\svchost.exe'\n            - '\\taskmgr.exe'\n            - '\\thor.exe'        # THOR\n            - '\\thor64.exe'      # THOR\n            - '\\vmtoolsd.exe'\n            - '\\VsTskMgr.exe'    # McAfee Enterprise\n            - '\\wininit.exe'\n            - '\\wmiprvse.exe'\n            - 'RtkAudUService64' # https://medium.com/falconforce/the-curious-case-of-realtek-and-lsass-33fc0c8482ff\n        ProcessName|contains:\n            - ':\\Program Files (x86)\\'\n            - ':\\Program Files\\'\n            - ':\\ProgramData\\Microsoft\\Windows Defender\\Platform\\'\n            - ':\\Windows\\SysNative\\'\n            - ':\\Windows\\System32\\'\n            - ':\\Windows\\SysWow64\\'\n            - ':\\Windows\\Temp\\asgard2-agent\\'\n    filter_main_generic:\n        ProcessName|contains: ':\\Program Files'  # too many false positives with legitimate AV and EDR solutions\n    filter_main_exact:\n        ProcessName|endswith:\n            - ':\\Windows\\System32\\taskhostw.exe'\n            - ':\\Windows\\System32\\msiexec.exe'\n            - ':\\Windows\\CCM\\CcmExec.exe'\n    filter_main_sysmon:\n        ProcessName|endswith: ':\\Windows\\Sysmon64.exe'\n        AccessList|contains: '%%4484'\n    filter_main_aurora:\n        ProcessName|contains: ':\\Windows\\Temp\\asgard2-agent-sc\\aurora\\'\n        ProcessName|endswith: '\\aurora-agent-64.exe'\n        AccessList|contains: '%%4484'\n    filter_main_scenarioengine:\n        # Example: C:\\a70de9569c3a5aa22184ef52a890177b\\x64\\SCENARIOENGINE.EXE\n        ProcessName|endswith: '\\x64\\SCENARIOENGINE.EXE'\n        AccessList|contains: '%%4484'\n    filter_main_avira1:\n        ProcessName|contains|all:\n            - ':\\Users\\'\n            - '\\AppData\\Local\\Temp\\is-'\n        ProcessName|endswith: '\\avira_system_speedup.tmp'\n        AccessList|contains: '%%4484'\n    filter_main_avira2:\n        ProcessName|contains: ':\\Windows\\Temp\\'\n        ProcessName|endswith: '\\avira_speedup_setup_update.tmp'\n        AccessList|contains: '%%4484'\n    filter_main_snmp:\n        ProcessName|endswith: ':\\Windows\\System32\\snmp.exe'\n        AccessList|contains: '%%4484'\n    filter_main_googleupdate:\n        ProcessName|contains: ':\\Windows\\SystemTemp\\'\n        ProcessName|endswith: '\\GoogleUpdate.exe'\n        AccessList|contains: '%%4484'\n    filter_optional_procmon:\n        ProcessName|endswith:\n            - '\\procmon64.exe'\n            - '\\procmon.exe'\n        AccessList|contains: '%%4484'\n    condition: 1 of selection_* and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Legitimate software accessing LSASS process for legitimate reason; update the whitelist with it\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_lsass_dump.yml","content":"title: Password Dumper Activity on LSASS\nid: aa1697b7-d611-4f9a-9cb2-5125b4ccfd5c\nstatus: test\ndescription: Detects process handle on LSASS process with certain access mask and object type SAM_DOMAIN\nreferences:\n    - https://twitter.com/jackcr/status/807385668833968128\nauthor: sigma\ndate: 2017-02-12\nmodified: 2022-10-09\ntags:\n    - attack.credential-access\n    - attack.t1003.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4656\n        ProcessName|endswith: '\\lsass.exe'\n        AccessMask: '0x705'\n        ObjectType: 'SAM_DOMAIN'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_logon_explicit_credentials.yml","content":"title: Suspicious Remote Logon with Explicit Credentials\nid: 941e5c45-cda7-4864-8cea-bbb7458d194a\nstatus: test\ndescription: Detects suspicious processes logging on with explicit credentials\nreferences:\n    - https://drive.google.com/file/d/1lKya3_mLnR3UQuCoiYruO3qgu052_iS_/view\nauthor: oscd.community, Teymur Kheirkhabarov @HeirhabarovT, Zach Stanford @svch0st, Tim Shelton\ndate: 2020-10-05\nmodified: 2022-08-03\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.initial-access\n    - attack.defense-evasion\n    - attack.t1078\n    - attack.lateral-movement\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4648\n        ProcessName|endswith:\n            - '\\cmd.exe'\n            - '\\powershell.exe'\n            - '\\pwsh.exe'\n            - '\\winrs.exe'\n            - '\\wmic.exe'\n            - '\\net.exe'\n            - '\\net1.exe'\n            - '\\reg.exe'\n    filter1:\n        TargetServerName: 'localhost'\n    filter2:\n        SubjectUserName|endswith: '$'\n        TargetUserName|endswith: '$'\n    condition: selection and not 1 of filter*\nfalsepositives:\n    - Administrators that use the RunAS command or scheduled tasks\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_local_anon_logon_created.yml","content":"title: Suspicious Windows ANONYMOUS LOGON Local Account Created\nid: 1bbf25b9-8038-4154-a50b-118f2a32be27\nstatus: test\ndescription: Detects the creation of suspicious accounts similar to ANONYMOUS LOGON, such as using additional spaces. Created as an covering detection for exclusion of Logon Type 3 from ANONYMOUS LOGON accounts.\nreferences:\n    - https://twitter.com/SBousseaden/status/1189469425482829824\nauthor: James Pemberton / @4A616D6573\ndate: 2019-10-31\nmodified: 2022-10-09\ntags:\n    - attack.persistence\n    - attack.t1136.001\n    - attack.t1136.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4720\n        SamAccountName|contains|all:\n            - 'ANONYMOUS'\n            - 'LOGON'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_ldap_dataexchange.yml","content":"title: Suspicious LDAP-Attributes Used\nid: d00a9a72-2c09-4459-ad03-5e0a23351e36\nstatus: test\ndescription: Detects the usage of particular AttributeLDAPDisplayNames, which are known for data exchange via LDAP by the tool LDAPFragger and are additionally not commonly used in companies.\nreferences:\n    - https://medium.com/@ivecodoe/detecting-ldapfragger-a-newly-released-cobalt-strike-beacon-using-ldap-for-c2-communication-c274a7f00961\n    - https://blog.fox-it.com/2020/03/19/ldapfragger-command-and-control-over-ldap-attributes/\n    - https://github.com/fox-it/LDAPFragger\nauthor: xknow @xknow_infosec\ndate: 2019-03-24\nmodified: 2022-10-05\ntags:\n    - attack.t1001.003\n    - attack.command-and-control\nlogsource:\n    product: windows\n    service: security\n    definition: The \"Audit Directory Service Changes\" logging policy must be configured in order to receive events. Audit events are generated only for objects with configured system access control lists (SACLs). Audit events are generated only for objects with configured system access control lists (SACLs) and only when accessed in a manner that matches their SACL settings. This policy covers the following events ids - 5136, 5137, 5138, 5139, 5141. Note that the default policy does not cover User objects. For that a custom AuditRule need to be setup (See https://github.com/OTRF/Set-AuditRule)\ndetection:\n    selection:\n        EventID: 5136\n        AttributeValue|contains: '*'\n        AttributeLDAPDisplayName:\n            - 'primaryInternationalISDNNumber'\n            - 'otherFacsimileTelephoneNumber'\n            - 'primaryTelexNumber'\n    condition: selection\nfalsepositives:\n    - Companies, who may use these default LDAP-Attributes for personal information\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_kerberos_manipulation.yml","content":"title: Kerberos Manipulation\nid: f7644214-0eb0-4ace-9455-331ec4c09253\nstatus: test\ndescription: Detects failed Kerberos TGT issue operation. This can be a sign of manipulations of TGT messages by an attacker.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4771\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-02-10\nmodified: 2024-01-16\ntags:\n    - attack.credential-access\n    - attack.t1212\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 675\n            - 4768\n            - 4769\n            - 4771\n        Status:\n            - '0x9'\n            - '0xA'\n            - '0xB'\n            - '0xF'\n            - '0x10'\n            - '0x11'\n            - '0x13'\n            - '0x14'\n            - '0x1A'\n            - '0x1F'\n            - '0x21'\n            - '0x22'\n            - '0x23'\n            - '0x24'\n            - '0x26'\n            - '0x27'\n            - '0x28'\n            - '0x29'\n            - '0x2C'\n            - '0x2D'\n            - '0x2E'\n            - '0x2F'\n            - '0x31'\n            - '0x32'\n            - '0x3E'\n            - '0x3F'\n            - '0x40'\n            - '0x41'\n            - '0x43'\n            - '0x44'\n    condition: selection\nfalsepositives:\n    - Faulty legacy applications\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_group_policy_startup_script_added_to_gpo.yml","content":"title: Startup/Logon Script Added to Group Policy Object\nid: 123e4e6d-b123-48f8-b261-7214938acaf0\nstatus: test\ndescription: |\n    Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects.\nreferences:\n    - https://www.elastic.co/guide/en/security/current/startup-logon-script-added-to-group-policy-object.html\nauthor: Elastic, Josh Nickels, Marius Rothenbücher\ndate: 2024-09-06\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1484.001\n    - attack.t1547\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection_eventid:\n        EventID:\n            - 5136\n            - 5145\n    selection_attributes_main:\n        AttributeLDAPDisplayName:\n            - 'gPCMachineExtensionNames'\n            - 'gPCUserExtensionNames'\n        AttributeValue|contains: '42B5FAAE-6536-11D2-AE5A-0000F87571E3'\n    selection_attributes_optional:\n        AttributeValue|contains:\n            - '40B6664F-4972-11D1-A7CA-0000F87571E3'\n            - '40B66650-4972-11D1-A7CA-0000F87571E3'\n    selection_share:\n        ShareName|endswith: '\\SYSVOL'\n        RelativeTargetName|endswith:\n            - '\\scripts.ini'\n            - '\\psscripts.ini'\n        AccessList|contains: '%%4417'\n    condition: selection_eventid and (all of selection_attributes_* or selection_share)\nfalsepositives:\n    - Legitimate execution by system administrators.\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_group_policy_abuse_privilege_addition.yml","content":"title: Group Policy Abuse for Privilege Addition\nid: 1c480e10-7ee1-46d4-8ed2-85f9789e3ce4\nstatus: test\ndescription: |\n    Detects the first occurrence of a modification to Group Policy Object Attributes to add privileges to user accounts or use them to add users as local admins.\nauthor: Elastic, Josh Nickels, Marius Rothenbücher\nreferences:\n    - https://www.elastic.co/guide/en/security/current/group-policy-abuse-for-privilege-addition.html#_setup_275\ndate: 2024-09-04\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1484.001\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: The \"Audit Directory Service Changes\" logging policy must be configured in order to receive events.'\ndetection:\n    selection:\n        EventID: 5136\n        AttributeLDAPDisplayName: 'gPCMachineExtensionNames'\n        AttributeValue|contains:\n            - '827D319E-6EAC-11D2-A4EA-00C04F79F83A'\n            - '803E14A0-B4FB-11D0-A0D0-00A0C90F574B'\n    condition: selection\nfalsepositives:\n    - Users allowed to perform these modifications (user found in field SubjectUserName)\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_failed_logon_reasons.yml","content":"title: Account Tampering - Suspicious Failed Logon Reasons\nid: 9eb99343-d336-4020-a3cd-67f3819e68ee\nstatus: test\ndescription: This method uses uncommon error codes on failed logons to determine suspicious activity and tampering with accounts that have been disabled or somehow restricted.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4625\n    - https://twitter.com/SBousseaden/status/1101431884540710913\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-02-19\nmodified: 2025-10-17\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.initial-access\n    - attack.t1078\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_eid:\n        EventID:\n            - 4625\n            - 4776\n    selection_status:\n        - Status:\n              - '0xC0000072'  # User logon to account disabled by administrator\n              - '0xC000006F'  # User logon outside authorized hours\n              - '0xC0000070'  # User logon from unauthorized workstation\n              - '0xC0000413'  # Logon Failure: The machine you are logging onto is protected by an authentication firewall. The specified account is not allowed to authenticate to the machine\n              - '0xC000018C'  # The logon request failed because the trust relationship between the primary domain and the trusted domain failed\n              - '0xC000015B'  # The user has not been granted the requested logon type (aka logon right) at this machine\n        - SubStatus:\n              - '0xC0000072'  # User logon to account disabled by administrator\n              - '0xC000006F'  # User logon outside authorized hours\n              - '0xC0000070'  # User logon from unauthorized workstation\n              - '0xC0000413'  # Logon Failure: The machine you are logging onto is protected by an authentication firewall. The specified account is not allowed to authenticate to the machine\n              - '0xC000018C'  # The logon request failed because the trust relationship between the primary domain and the trusted domain failed\n              - '0xC000015B'  # The user has not been granted the requested logon type (aka logon right) at this machine\n    filter:\n        SubjectUserSid: 'S-1-0-0'\n    condition: all of selection_* and not filter\nfalsepositives:\n    - User using a disabled account\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_dsrm_password_change.yml","content":"title: Password Change on Directory Service Restore Mode (DSRM) Account\nid: 53ad8e36-f573-46bf-97e4-15ba5bf4bb51\nrelated:\n    - id: b61e87c0-50db-4b2e-8986-6a2be94b33b0\n      type: similar\nstatus: stable\ndescription: |\n    Detects potential attempts made to set the Directory Services Restore Mode administrator password.\n    The Directory Service Restore Mode (DSRM) account is a local administrator account on Domain Controllers.\n    Attackers may change the password in order to obtain persistence.\nreferences:\n    - https://adsecurity.org/?p=1714\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4794\nauthor: Thomas Patzke\ndate: 2017-02-19\nmodified: 2020-08-23\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4794\n    condition: selection\nfalsepositives:\n    - Initial installation of a domain controller.\nlevel: high\n"},{"path":"builtin\\security\\win_security_susp_computer_name.yml","content":"title: Win Susp Computer Name Containing Samtheadmin\nid: 39698b3f-da92-4bc6-bfb5-645a98386e45\nstatus: test\ndescription: Detects suspicious computer name samtheadmin-{1..100}$ generated by hacktool\nreferences:\n    - https://twitter.com/malmoeb/status/1511760068743766026\n    - https://github.com/helloexp/0day/blob/614227a7b9beb0e91e7e2c6a5e532e6f7a8e883c/00-CVE_EXP/CVE-2021-42287/sam-the-admin/sam_the_admin.py\nauthor: elhoim\ndate: 2022-09-09\nmodified: 2023-01-04\ntags:\n    - attack.initial-access\n    - attack.defense-evasion\n    - cve.2021-42278\n    - cve.2021-42287\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1078\nlogsource:\n    service: security\n    product: windows\ndetection:\n    # Not adding an EventID on purpose to try to match on any event in security (including use of account), not just 4741 (computer account created)\n    selection1:\n        SamAccountName|startswith: 'SAMTHEADMIN-'\n        SamAccountName|endswith: '$'\n    selection2:\n        TargetUserName|startswith: 'SAMTHEADMIN-'\n        TargetUserName|endswith: '$'\n    condition: 1 of selection*\nfields:\n    - EventID\n    - SamAccountName\n    - SubjectUserName\n    - TargetUserName\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"builtin\\security\\win_security_susp_add_sid_history.yml","content":"title: Addition of SID History to Active Directory Object\nid: 2632954e-db1c-49cb-9936-67d1ef1d17d2\nstatus: stable\ndescription: An attacker can use the SID history attribute to gain additional privileges.\nreferences:\n    - https://adsecurity.org/?p=1772\nauthor: Thomas Patzke, @atc_project (improvements)\ndate: 2017-02-19\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1134.005\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection1:\n        EventID:\n            - 4765\n            - 4766\n    selection2:\n        EventID: 4738\n    selection3:\n        SidHistory:\n            - '-'\n            - '%%1793'\n    filter_null:\n        SidHistory:\n    condition: selection1 or (selection2 and not selection3 and not filter_null)\nfalsepositives:\n    - Migration of an account into a new domain\nlevel: medium\n"},{"path":"builtin\\security\\win_security_susp_add_domain_trust.yml","content":"title: A New Trust Was Created To A Domain\nid: 0255a820-e564-4e40-af2b-6ac61160335c\nstatus: stable\ndescription: Addition of domains is seldom and should be verified for legitimacy.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4706\nauthor: Thomas Patzke\ndate: 2019-12-03\nmodified: 2024-01-16\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4706\n    condition: selection\nfalsepositives:\n    - Legitimate extension of domain structure\nlevel: medium\n"},{"path":"builtin\\security\\win_security_smb_file_creation_admin_shares.yml","content":"title: SMB Create Remote File Admin Share\nid: b210394c-ba12-4f89-9117-44a2464b9511\nstatus: test\ndescription: Look for non-system accounts SMB accessing a file with write (0x2) access mask via administrative share (i.e C$).\nreferences:\n    - https://github.com/OTRF/ThreatHunter-Playbook/blob/f7a58156dbfc9b019f17f638b8c62d22e557d350/playbooks/WIN-201012004336.yaml\n    - https://securitydatasets.com/notebooks/atomic/windows/lateral_movement/SDWIN-200806015757.html?highlight=create%20file\nauthor: Jose Rodriguez (@Cyb3rPandaH), OTR (Open Threat Research)\ndate: 2020-08-06\nmodified: 2025-10-17\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5145\n        ShareName|endswith: 'C$'\n        AccessMask: '0x2'\n    filter_main_subjectusername:\n        SubjectUserName|endswith: '$'\n    filter_optional_local_ip:\n        IpAddress: '::1'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_signal_sensitive_config_access.yml","content":"title: File Access Of Signal Desktop Sensitive Data\nid: 5d6c375a-18ae-4952-b4f6-8b803f6c8555\nstatus: experimental\ndescription: |\n    Detects access to Signal Desktop's sensitive data files: db.sqlite and config.json.\n    The db.sqlite file in Signal Desktop stores all locally saved messages in an encrypted SQLite database, while the config.json contains the decryption key needed to access that data.\n    Since the key is stored in plain text, a threat actor who gains access to both files can decrypt and read sensitive messages without needing the users credentials.\n    Currently the rule only covers the default Signal installation path in AppData\\Roaming. Signal Portable installations may use different paths based on user configuration. Additional paths can be added to the selection as needed.\nreferences:\n    - https://cloud.google.com/blog/topics/threat-intelligence/russia-targeting-signal-messenger/\n    - https://vmois.dev/query-signal-desktop-messages-sqlite/\nauthor: Andreas Braathen (mnemonic.io)\ndate: 2025-10-19\ntags:\n    - attack.credential-access\n    - attack.t1003\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: System Access Control List (SACL) policy with attributes List folder/read data on Objects'\ndetection:\n    selection:\n        EventID: 4663\n        ObjectType: 'File'\n        ObjectName|contains: '\\AppData\\Roaming\\Signal\\'\n        ObjectName|endswith:\n            - '\\config.json'\n            - '\\db.sqlite'\n    filter_main_signal:\n        ProcessName|endswith:\n            - '\\signal-portable.exe'\n            - '\\signal.exe'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unlikely, but possible from AV or backup software accessing the files.\nlevel: medium\n"},{"path":"builtin\\security\\win_security_service_install_remote_access_software.yml","content":"title: Remote Access Tool Services Have Been Installed - Security\nid: c8b00925-926c-47e3-beea-298fd563728e\nrelated:\n    - id: 1a31b18a-f00c-4061-9900-f735b96c99fc\n      type: similar\nstatus: test\ndescription: Detects service installation of different remote access tools software. These software are often abused by threat actors to perform\nreferences:\n    - https://redcanary.com/blog/misbehaving-rats/\nauthor: Connor Martin, Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-23\nmodified: 2024-12-07\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.execution\n    - attack.t1543.003\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceName|contains:\n            # Based on https://github.com/SigmaHQ/sigma/pull/2841\n            - 'AmmyyAdmin' # https://www.ammyy.com/en/\n            - 'AnyDesk' # https://usersince99.medium.com/windows-privilege-escalation-8214ceaf4db8\n            - 'Atera'\n            - 'BASupportExpressSrvcUpdater' # https://www.systemlookup.com/O23/6837-BASupSrvcUpdater_exe.html\n            - 'BASupportExpressStandaloneService' # https://www.systemlookup.com/O23/6839-BASupSrvc_exe.html\n            - 'chromoting'\n            - 'GoToAssist' # https://www.goto.com/it-management/resolve\n            - 'GoToMyPC' # https://get.gotomypc.com/\n            - 'jumpcloud'\n            - 'LMIGuardianSvc' # https://www.logmein.com/\n            - 'LogMeIn' # https://www.logmein.com/\n            - 'monblanking'\n            - 'Parsec'\n            - 'RManService' # https://www.systemlookup.com/O23/7855-rutserv_exe.html\n            - 'RPCPerformanceService' # https://www.remotepc.com/\n            - 'RPCService' # https://www.remotepc.com/\n            - 'SplashtopRemoteService' # https://www.splashtop.com/\n            - 'SSUService'\n            - 'TeamViewer'\n            - 'TightVNC' # https://www.tightvnc.com/\n            - 'vncserver'\n            - 'Zoho'\n    condition: selection\nfalsepositives:\n    - The rule doesn't look for anything suspicious so false positives are expected. If you use one of the tools mentioned, comment it out\nlevel: medium\n"},{"path":"builtin\\security\\win_security_service_installation_by_unusal_client.yml","content":"title: Service Installed By Unusual Client - Security\nid: c4e92a97-a9ff-4392-9d2d-7a4c642768ca\nrelated:\n    - id: 71c276aa-49cd-43d2-b920-2dcd3e6962d5\n      type: similar\nstatus: test\ndescription: Detects a service installed by a client which has PID 0 or whose parent has PID 0\nreferences:\n    - https://www.elastic.co/guide/en/security/current/windows-service-installed-via-an-unusual-client.html\n    - https://www.x86matthew.com/view_post?id=create_svc_rpc\n    - https://twitter.com/SBousseaden/status/1490608838701166596\nauthor: Tim Rauch (Nextron Systems), Elastic (idea)\ndate: 2022-09-15\nmodified: 2023-01-04\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1543\nlogsource:\n    service: security\n    product: windows\n    definition: 'Requirements: The System Security Extension audit subcategory need to be enabled to log the EID 4697'\ndetection:\n    selection_eid:\n        EventID: 4697\n    selection_pid:\n        - ClientProcessId: 0\n        - ParentProcessId: 0\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_sdelete_potential_secure_deletion.yml","content":"title: Potential Secure Deletion with SDelete\nid: 39a80702-d7ca-4a83-b776-525b1f86a36d\nstatus: test\ndescription: Detects files that have extensions commonly seen while SDelete is used to wipe files.\nreferences:\n    - https://jpcertcc.github.io/ToolAnalysisResultSheet/details/sdelete.htm\n    - https://www.jpcert.or.jp/english/pub/sr/ir_research.html\n    - https://learn.microsoft.com/en-gb/sysinternals/downloads/sdelete\nauthor: Thomas Patzke\ndate: 2017-06-14\nmodified: 2024-12-13\ntags:\n    - attack.impact\n    - attack.defense-evasion\n    - attack.t1070.004\n    - attack.t1027.005\n    - attack.t1485\n    - attack.t1553.002\n    - attack.s0195\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4656\n            - 4663\n            - 4658\n        ObjectName|endswith:\n            - '.AAA'\n            - '.ZZZ'\n    condition: selection\nfalsepositives:\n    - Legitimate usage of SDelete\n    - Files that are interacted with that have these extensions legitimately\nlevel: medium\n"},{"path":"builtin\\security\\win_security_scm_database_privileged_operation.yml","content":"title: SCM Database Privileged Operation\nid: dae8171c-5ec6-4396-b210-8466585b53e9\nstatus: test\ndescription: Detects non-system users performing privileged operation os the SCM database\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190826-RemoteSCMHandle/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g, Tim Shelton\ndate: 2019-08-15\nmodified: 2022-09-18\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1548\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4674\n        ObjectType: 'SC_MANAGER OBJECT'\n        ObjectName: 'servicesactive'\n        PrivilegeList: 'SeTakeOwnershipPrivilege'\n    filter:\n        SubjectLogonId: '0x3e4'\n        ProcessName|endswith: ':\\Windows\\System32\\services.exe'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_scm_database_handle_failure.yml","content":"title: SCM Database Handle Failure\nid: 13addce7-47b2-4ca0-a98f-1de964d1d669\nstatus: test\ndescription: Detects non-system users failing to get a handle of the SCM database.\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190826-RemoteSCMHandle/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-08-12\nmodified: 2022-07-11\ntags:\n    - attack.discovery\n    - attack.t1010\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4656\n        ObjectType: 'SC_MANAGER OBJECT'\n        ObjectName: 'ServicesActive'\n        AccessMask: '0xf003f'  # is used in the reference; otherwise too many FPs\n        # Keywords: 'Audit Failure' <-> in the ref 'Keywords':-9214364837600034816\n    filter:\n        SubjectLogonId: '0x3e4'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\n# triggering on many hosts in some environments\nlevel: medium\n"},{"path":"builtin\\security\\win_security_sam_registry_hive_handle_request.yml","content":"title: SAM Registry Hive Handle Request\nid: f8748f2c-89dc-4d95-afb0-5a2dfdbad332\nstatus: test\ndescription: Detects handles requested to SAM registry hive\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190725-SAMRegistryHiveHandleRequest/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-08-12\nmodified: 2021-11-27\ntags:\n    - attack.discovery\n    - attack.t1012\n    - attack.credential-access\n    - attack.t1552.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4656\n        ObjectType: 'Key'\n        ObjectName|endswith: '\\SAM'\n    condition: selection\nfields:\n    - ComputerName\n    - SubjectDomainName\n    - SubjectUserName\n    - ProcessName\n    - ObjectName\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_replay_attack_detected.yml","content":"title: Replay Attack Detected\nid: 5a44727c-3b85-4713-8c44-4401d5499629\nstatus: test\ndescription: Detects possible Kerberos Replay Attack on the domain controllers when \"KRB_AP_ERR_REPEAT\" Kerberos response is sent to the client\nreferences:\n    - https://github.com/Yamato-Security/EnableWindowsLogSettings/blob/7f6d755d45ac7cc9fc35b0cbf498e6aa4ef19def/ConfiguringSecurityLogAuditPolicies.md\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4649\nauthor: frack113\ndate: 2022-10-14\ntags:\n    - attack.credential-access\n    - attack.t1558\nlogsource:\n    service: security\n    product: windows\ndetection:\n    selection:\n        EventID: 4649\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_remote_powershell_session.yml","content":"title: Remote PowerShell Sessions Network Connections (WinRM)\nid: 13acf386-b8c6-4fe0-9a6e-c4756b974698\nstatus: test\ndescription: Detects basic PowerShell Remoting (WinRM) by monitoring for network inbound connections to ports 5985 OR 5986\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190511-RemotePwshExecution/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-09-12\nmodified: 2022-10-09\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5156\n        DestPort:\n            - 5985\n            - 5986\n        LayerRTID: 44\n    condition: selection\nfalsepositives:\n    - Legitimate use of remote PowerShell execution\nlevel: high\n"},{"path":"builtin\\security\\win_security_registry_permissions_weakness_check.yml","content":"title: Service Registry Key Read Access Request\nid: 11d00fff-5dc3-428c-8184-801f292faec0\nstatus: test\ndescription: |\n    Detects \"read access\" requests on the services registry key.\n    Adversaries may execute their own malicious payloads by hijacking the Registry entries used by services.\n    Adversaries may use flaws in the permissions for Registry keys related to services to redirect from the originally specified executable to one that they control, in order to launch their own code when a service starts.\nreferences:\n    - https://center-for-threat-informed-defense.github.io/summiting-the-pyramid/analytics/service_registry_permissions_weakness_check/\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1574.011/T1574.011.md#atomic-test-1---service-registry-permissions-weakness\nauthor: Center for Threat Informed Defense (CTID) Summiting the Pyramid Team\ndate: 2023-09-28\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1574.011\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: SACLs must be enabled for \"READ_CONTROL\" on the registry keys used in this rule'\ndetection:\n    selection:\n        EventID: 4663\n        ObjectName|contains|all:\n            - '\\SYSTEM\\'\n            - 'ControlSet\\Services\\'\n        AccessList|contains: '%%1538' # READ_CONTROL\n    condition: selection\nfalsepositives:\n    - Likely from legitimate applications reading their key. Requires heavy tuning\nlevel: low\n"},{"path":"builtin\\security\\win_security_register_new_logon_process_by_rubeus.yml","content":"title: Register new Logon Process by Rubeus\nid: 12e6d621-194f-4f59-90cc-1959e21e69f7\nstatus: test\ndescription: Detects potential use of Rubeus via registered new trusted logon process\nreferences:\n    - https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1\nauthor: Roberto Rodriguez (source), Ilyas Ochkov (rule), oscd.community\ndate: 2019-10-24\nmodified: 2022-10-09\ntags:\n    - attack.lateral-movement\n    - attack.privilege-escalation\n    - attack.credential-access\n    - attack.t1558.003\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4611\n        LogonProcessName: 'User32LogonProcesss'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_rdp_reverse_tunnel.yml","content":"title: RDP over Reverse SSH Tunnel WFP\nid: 5bed80b6-b3e8-428e-a3ae-d3c757589e41\nstatus: test\ndescription: Detects svchost hosting RDP termsvcs communicating with the loopback address\nreferences:\n    - https://twitter.com/SBousseaden/status/1096148422984384514\n    - https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/44fbe85f72ee91582876b49678f9a26292a155fb/Command%20and%20Control/DE_RDP_Tunnel_5156.evtx\nauthor: Samir Bousseaden\ndate: 2019-02-16\nmodified: 2022-09-02\ntags:\n    - attack.defense-evasion\n    - attack.command-and-control\n    - attack.lateral-movement\n    - attack.t1090.001\n    - attack.t1090.002\n    - attack.t1021.001\n    - car.2013-07-002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5156\n    sourceRDP:\n        SourcePort: 3389\n        DestAddress:\n            - '127.*'\n            - '::1'\n    destinationRDP:\n        DestPort: 3389\n        SourceAddress:\n            - '127.*'\n            - '::1'\n    filter_app_container:\n        FilterOrigin: 'AppContainer Loopback'\n    filter_thor:  # checking BlueKeep vulnerability\n        Application|endswith:\n            - '\\thor.exe'\n            - '\\thor64.exe'\n    condition: selection and ( sourceRDP or destinationRDP ) and not 1 of filter*\nfalsepositives:\n    - Programs that connect locally to the RDP port\nlevel: high\n"},{"path":"builtin\\security\\win_security_protected_storage_service_access.yml","content":"title: Protected Storage Service Access\nid: 45545954-4016-43c6-855e-eae8f1c369dc\nstatus: test\ndescription: Detects access to a protected_storage service over the network. Potential abuse of DPAPI to extract domain backup keys from Domain Controllers\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190620-DomainDPAPIBackupKeyExtraction/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-08-10\nmodified: 2021-11-27\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5145\n        ShareName|contains: 'IPC'\n        RelativeTargetName: 'protected_storage'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_powershell_script_installed_as_service.yml","content":"title: PowerShell Scripts Installed as Services - Security\nid: 2a926e6a-4b81-4011-8a96-e36cc8c04302\nrelated:\n    - id: a2e5019d-a658-4c6a-92bf-7197b54e2cae\n      type: derived\nstatus: test\ndescription: Detects powershell script installed as a Service\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse\nauthor: oscd.community, Natalia Shornikova\ndate: 2020-10-06\nmodified: 2022-11-29\ntags:\n    - attack.execution\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains:\n            - 'powershell'\n            - 'pwsh'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_possible_dc_shadow.yml","content":"title: Possible DC Shadow Attack\nid: 32e19d25-4aed-4860-a55a-be99cb0bf7ed\nrelated:\n    - id: 611eab06-a145-4dfa-a295-3ccc5c20f59a\n      type: derived\nstatus: test\ndescription: Detects DCShadow via create new SPN\nreferences:\n    - https://twitter.com/gentilkiwi/status/1003236624925413376\n    - https://gist.github.com/gentilkiwi/dcc132457408cf11ad2061340dcb53c2\n    - https://web.archive.org/web/20180203014709/https://blog.alsid.eu/dcshadow-explained-4510f52fc19d?gi=c426ac876c48\nauthor: Ilyas Ochkov, oscd.community, Chakib Gzenayi (@Chak092), Hosni Mribah\ndate: 2019-10-25\nmodified: 2022-10-17\ntags:\n    - attack.credential-access\n    - attack.defense-evasion\n    - attack.t1207\nlogsource:\n    product: windows\n    service: security\n    definition: The \"Audit Directory Service Changes\" logging policy must be configured in order to receive events. Audit events are generated only for objects with configured system access control lists (SACLs). Audit events are generated only for objects with configured system access control lists (SACLs) and only when accessed in a manner that matches their SACL settings. This policy covers the following events ids - 5136, 5137, 5138, 5139, 5141. Note that the default policy does not cover User objects. For that a custom AuditRule need to be setup (See https://github.com/OTRF/Set-AuditRule)\ndetection:\n    selection1:\n        EventID: 4742\n        ServicePrincipalNames|contains: 'GC/'\n    selection2:\n        EventID: 5136\n        AttributeLDAPDisplayName: servicePrincipalName\n        AttributeValue|startswith: 'GC/'\n    condition: 1 of selection*\nfalsepositives:\n    - Valid on domain controllers; exclude known DCs\nlevel: medium\n"},{"path":"builtin\\security\\win_security_petitpotam_susp_tgt_request.yml","content":"title: PetitPotam Suspicious Kerberos TGT Request\nid: 6a53d871-682d-40b6-83e0-b7c1a6c4e3a5\nstatus: test\ndescription: |\n    Detect suspicious Kerberos TGT requests.\n    Once an attacer obtains a computer certificate by abusing Active Directory Certificate Services in combination with PetitPotam, the next step would be to leverage the certificate for malicious purposes.\n    One way of doing this is to request a Kerberos Ticket Granting Ticket using a tool like Rubeus.\n    This request will generate a 4768 event with some unusual fields depending on the environment.\n    This analytic will require tuning, we recommend filtering Account_Name to the Domain Controller computer accounts.\nreferences:\n    - https://github.com/topotam/PetitPotam\n    - https://isc.sans.edu/forums/diary/Active+Directory+Certificate+Services+ADCS+PKI+domain+admin+vulnerability/27668/\n    - https://github.com/splunk/security_content/blob/88d689fe8a055d8284337b9fad5d9152b42043db/detections/endpoint/petitpotam_suspicious_kerberos_tgt_request.yml\nauthor: Mauricio Velazco, Michael Haag\ndate: 2021-09-02\nmodified: 2022-10-05\ntags:\n    - attack.credential-access\n    - attack.t1187\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Account Logon > Kerberos Authentication Service\" must be configured for Success/Failure'\ndetection:\n    selection:\n        EventID: 4768\n        TargetUserName|endswith: '$'\n        CertThumbprint|contains: '*'\n    filter_local:\n        IpAddress: '::1'\n    filter_thumbprint:\n        CertThumbprint: ''\n    condition: selection and not 1 of filter_*\nfalsepositives:\n    - False positives are possible if the environment is using certificates for authentication. We recommend filtering Account_Name to the Domain Controller computer accounts.\nlevel: high\n"},{"path":"builtin\\security\\win_security_petitpotam_network_share.yml","content":"title: Possible PetitPotam Coerce Authentication Attempt\nid: 1ce8c8a3-2723-48ed-8246-906ac91061a6\nstatus: test\ndescription: Detect PetitPotam coerced authentication activity.\nreferences:\n    - https://github.com/topotam/PetitPotam\n    - https://github.com/splunk/security_content/blob/0dd6de32de2118b2818550df9e65255f4109a56d/detections/endpoint/petitpotam_network_share_access_request.yml\nauthor: Mauricio Velazco, Michael Haag\ndate: 2021-09-02\nmodified: 2022-08-11\ntags:\n    - attack.credential-access\n    - attack.t1187\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection:\n        EventID: 5145\n        ShareName|startswith: '\\\\\\\\' # looking for the string \\\\somethink\\IPC$\n        ShareName|endswith: '\\IPC$'\n        RelativeTargetName: lsarpc\n        SubjectUserName: ANONYMOUS LOGON\n    condition: selection\nfalsepositives:\n    - Unknown. Feedback welcomed.\nlevel: high\n"},{"path":"builtin\\security\\win_security_pcap_drivers.yml","content":"title: Windows Pcap Drivers\nid: 7b687634-ab20-11ea-bb37-0242ac130002\nstatus: test\ndescription: Detects Windows Pcap driver installation based on a list of associated .sys files.\nreferences:\n    - https://ragged-lab.blogspot.com/2020/06/capturing-pcap-driver-installations.html#more\nauthor: Cian Heasley\ndate: 2020-06-10\nmodified: 2023-04-14\ntags:\n    - attack.discovery\n    - attack.credential-access\n    - attack.t1040\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains:\n            - 'pcap'\n            - 'npcap'\n            - 'npf'\n            - 'nm3'\n            - 'ndiscap'\n            - 'nmnt'\n            - 'windivert'\n            - 'USBPcap'\n            - 'pktmon'\n    condition: selection\nfields:\n    - EventID\n    - ServiceFileName\n    - Account_Name\n    - Computer_Name\n    - Originating_Computer\n    - ServiceName\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_password_policy_enumerated.yml","content":"title: Password Policy Enumerated\nid: 12ba6a38-adb3-4d6b-91ba-a7fb248e3199\nstatus: test\ndescription: Detects when the password policy is enumerated.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4661\n    - https://github.com/jpalanco/alienvault-ossim/blob/f74359c0c027e42560924b5cff25cdf121e5505a/os-sim/agent/src/ParserUtil.py#L951\nauthor: Zach Mathis\ndate: 2023-05-19\ntags:\n    - attack.discovery\n    - attack.t1201\nlogsource:\n    product: windows\n    service: security\n    definition: dfd8c0f4-e6ad-4e07-b91b-f2fca0ddef64\ndetection:\n    selection:\n        EventID: 4661 # A handle to an object was requested.\n        AccessList|contains: '%%5392' # ReadPasswordParameters\n        ObjectServer: 'Security Account Manager'\n    condition: selection\nlevel: medium\n"},{"path":"builtin\\security\\win_security_not_allowed_rdp_access.yml","content":"title: Denied Access To Remote Desktop\nid: 8e5c03fa-b7f0-11ea-b242-07e0576828d9\nstatus: test\ndescription: |\n  This event is generated when an authenticated user who is not allowed to log on remotely attempts to connect to this computer through Remote Desktop.\n  Often, this event can be generated by attackers when searching for available windows servers in the network.\nreferences:\n    - https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4825\nauthor: Pushkarev Dmitry\ndate: 2020-06-27\nmodified: 2021-11-27\ntags:\n    - attack.lateral-movement\n    - attack.t1021.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4825\n    condition: selection\nfields:\n    - EventCode\n    - AccountName\n    - ClientAddress\nfalsepositives:\n    - Valid user was not added to RDP group\nlevel: medium\n"},{"path":"builtin\\security\\win_security_new_or_renamed_user_account_with_dollar_sign.yml","content":"title: New or Renamed User Account with '$' Character\nid: cfeed607-6aa4-4bbd-9627-b637deb723c8\nstatus: test\ndescription: |\n    Detects the creation of a user with the \"$\" character. This can be used by attackers to hide a user or trick detection systems that lack the parsing mechanisms.\nreferences:\n    - https://twitter.com/SBousseaden/status/1387743867663958021\nauthor: Ilyas Ochkov, oscd.community\ndate: 2019-10-25\nmodified: 2024-01-16\ntags:\n    - attack.defense-evasion\n    - attack.t1036\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_create:\n        EventID: 4720 # create user\n        SamAccountName|contains: '$'\n    selection_rename:\n        EventID: 4781 # rename user\n        NewTargetUserName|contains: '$'\n    filter_main_homegroup:\n        EventID: 4720\n        TargetUserName: 'HomeGroupUser$'\n    condition: 1 of selection_* and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_net_share_obj_susp_desktop_ini.yml","content":"title: Windows Network Access Suspicious desktop.ini Action\nid: 35bc7e28-ee6b-492f-ab04-da58fcf6402e\nstatus: test\ndescription: Detects unusual processes accessing desktop.ini remotely over network share, which can be leveraged to alter how Explorer displays a folder's content (i.e. renaming files) without changing them on disk.\nreferences:\n    - https://isc.sans.edu/forums/diary/Desktopini+as+a+postexploitation+tool/25912/\nauthor: Tim Shelton (HAWK.IO)\ndate: 2021-12-06\nmodified: 2022-01-16\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1547.009\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5145\n        ObjectType: File\n        RelativeTargetName|endswith: '\\desktop.ini'\n        AccessList|contains:\n            - 'WriteData'\n            - 'DELETE'\n            - 'WriteDAC'\n            - 'AppendData'\n            - 'AddSubdirectory'\n    condition: selection\nfalsepositives:\n    - Read only access list authority\nlevel: medium\n"},{"path":"builtin\\security\\win_security_net_ntlm_downgrade.yml","content":"title: NetNTLM Downgrade Attack\nid: d3abac66-f11c-4ed0-8acb-50cc29c97eed\nrelated:\n    - id: d67572a0-e2ec-45d6-b8db-c100d14b8ef2\n      type: derived\nstatus: test\ndescription: Detects NetNTLM downgrade attack\nreferences:\n    - https://www.optiv.com/blog/post-exploitation-using-netntlm-downgrade-attacks\nauthor: Florian Roth (Nextron Systems), wagga\ndate: 2018-03-20\nmodified: 2022-10-09\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.t1562.001\n    - attack.t1112\n# Windows Security Eventlog: Process Creation with Full Command Line\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Policy : Object Access > Audit Registry (Success)'\ndetection:\n    selection:\n        EventID: 4657\n        ObjectName|contains|all:\n            - '\\REGISTRY\\MACHINE\\SYSTEM'\n            - 'ControlSet'\n            - '\\Control\\Lsa'\n        ObjectValueName:\n            - 'LmCompatibilityLevel'\n            - 'NtlmMinClientSec'\n            - 'RestrictSendingNTLMTraffic'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_meterpreter_or_cobaltstrike_getsystem_service_install.yml","content":"title: Meterpreter or Cobalt Strike Getsystem Service Installation - Security\nid: ecbc5e16-58e0-4521-9c60-eb9a7ea4ad34\nrelated:\n    - id: 843544a7-56e0-4dcc-a44f-5cc266dd97d6\n      type: derived\nstatus: test\ndescription: Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting a specific service installation\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-privilege-escalation-in-windows-environment\n    - https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/\nauthor: Teymur Kheirkhabarov, Ecco, Florian Roth (Nextron Systems)\ndate: 2019-10-26\nmodified: 2023-11-15\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1134.001\n    - attack.t1134.002\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection_eid:\n        EventID: 4697\n    selection_cli_cmd:\n        # meterpreter getsystem technique 1: cmd.exe /c echo 559891bb017 > \\\\.\\pipe\\5e120a\n        # cobaltstrike getsystem technique 1: %COMSPEC% /c echo 559891bb017 > \\\\.\\pipe\\5e120a\n        # cobaltstrike getsystem technique 1b (expanded %COMSPEC%): %COMSPEC% /c echo 559891bb017 > \\\\.\\pipe\\5e120a\n        ServiceFileName|contains|all:\n            - '/c'\n            - 'echo'\n            - '\\pipe\\'\n        ServiceFileName|contains:\n            - 'cmd'\n            - '%COMSPEC%'\n    selection_cli_rundll:\n        # meterpreter getsystem technique 2: rundll32.exe C:\\Users\\test\\AppData\\Local\\Temp\\tmexsn.dll,a /p:tmexsn\n        ServiceFileName|contains|all:\n            - 'rundll32'\n            - '.dll,a'\n            - '/p:'\n    selection_cli_share:\n        ServiceFileName|startswith: '\\\\\\\\127.0.0.1\\\\ADMIN$\\'  # https://twitter.com/svch0st/status/1413688851877416960?lang=en\n    condition: selection_eid and 1 of selection_cli_*\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\security\\win_security_metasploit_or_impacket_smb_psexec_service_install.yml","content":"title: Metasploit Or Impacket Service Installation Via SMB PsExec\nid: 6fb63b40-e02a-403e-9ffd-3bcc1d749442\nrelated:\n    - id: 1a17ce75-ff0d-4f02-9709-2b7bb5618cf0\n      type: derived\nstatus: test\ndescription: Detects usage of Metasploit SMB PsExec (exploit/windows/smb/psexec) and Impacket psexec.py by triggering on specific service installation\nreferences:\n    - https://bczyz1.github.io/2021/01/30/psexec.html\nauthor: Bartlomiej Czyz, Relativity\ndate: 2021-01-21\nmodified: 2022-10-05\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\n    - attack.t1570\n    - attack.execution\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|re: '^%systemroot%\\\\[a-zA-Z]{8}\\.exe$'\n        ServiceName|re: '(^[a-zA-Z]{4}$)|(^[a-zA-Z]{8}$)|(^[a-zA-Z]{16}$)'\n        ServiceStartType: 3  # on-demand start, see https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4697\n        ServiceType: '0x10'\n    filter:\n        ServiceName: 'PSEXESVC'\n    condition: selection and not filter\nfields:\n    - ComputerName\n    - SubjectDomainName\n    - SubjectUserName\n    - ServiceName\n    - ServiceFileName\nfalsepositives:\n    - Possible, different agents with a 8 character binary and a 4, 8 or 16 character service name\nlevel: high\n"},{"path":"builtin\\security\\win_security_metasploit_authentication.yml","content":"title: Metasploit SMB Authentication\nid: 72124974-a68b-4366-b990-d30e0b2a190d\nstatus: test\ndescription: Alerts on Metasploit host's authentications on the domain.\nreferences:\n    - https://github.com/rapid7/metasploit-framework/blob/1416b5776d963f21b7b5b45d19f3e961201e0aed/lib/rex/proto/smb/client.rb\nauthor: Chakib Gzenayi (@Chak092), Hosni Mribah\ndate: 2020-05-06\nmodified: 2024-01-25\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection1:\n        EventID:\n            - 4625\n            - 4624\n        LogonType: 3\n        AuthenticationPackageName: 'NTLM'\n        WorkstationName|re: '^[A-Za-z0-9]{16}$'\n    selection2:\n        EventID: 4776\n        Workstation|re: '^[A-Za-z0-9]{16}$'\n    condition: 1 of selection*\nfalsepositives:\n    - Linux hostnames composed of 16 characters.\nlevel: high\n"},{"path":"builtin\\security\\win_security_mal_wceaux_dll.yml","content":"title: WCE wceaux.dll Access\nid: 1de68c67-af5c-4097-9c85-fe5578e09e67\nstatus: test\ndescription: Detects wceaux.dll access while WCE pass-the-hash remote command execution on source host\nreferences:\n    - https://www.jpcert.or.jp/english/pub/sr/ir_research.html\n    - https://jpcertcc.github.io/ToolAnalysisResultSheet\nauthor: Thomas Patzke\ndate: 2017-06-14\nmodified: 2025-01-30\ntags:\n    - attack.credential-access\n    - attack.t1003\n    - attack.s0005\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4656\n            - 4663\n        ObjectName|endswith: '\\wceaux.dll'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"builtin\\security\\win_security_mal_creddumper.yml","content":"title: Credential Dumping Tools Service Execution - Security\nid: f0d1feba-4344-4ca9-8121-a6c97bd6df52\nrelated:\n    - id: 4976aa50-8f41-45c6-8b15-ab3fc10e79ed\n      type: derived\nstatus: test\ndescription: Detects well-known credential dumping tools execution via service execution events\nreferences:\n    - https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment\nauthor: Florian Roth (Nextron Systems), Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community\ndate: 2017-03-05\nmodified: 2022-11-29\ntags:\n    - attack.credential-access\n    - attack.execution\n    - attack.t1003.001\n    - attack.t1003.002\n    - attack.t1003.004\n    - attack.t1003.005\n    - attack.t1003.006\n    - attack.t1569.002\n    - attack.s0005\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains:\n            - 'cachedump'\n            - 'dumpsvc'\n            - 'fgexec'\n            - 'gsecdump'\n            - 'mimidrv'\n            - 'pwdump'\n            - 'servpw'\n    condition: selection\nfalsepositives:\n    - Legitimate Administrator using credential dumping tool for password recovery\nlevel: high\n"},{"path":"builtin\\security\\win_security_lsass_access_non_system_account.yml","content":"title: LSASS Access From Non System Account\nid: 962fe167-e48d-4fd6-9974-11e5b9a5d6d1\nstatus: test\ndescription: Detects potential mimikatz-like tools accessing LSASS from non system account\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-06-20\nmodified: 2023-12-11\ntags:\n    - attack.credential-access\n    - attack.t1003.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4663\n            - 4656\n        AccessMask:\n            - '0x100000'\n            - '0x1010'    # car.2019-04-004\n            - '0x1400'\n            - '0x1410'    # car.2019-04-004\n            - '0x1418'    # car.2019-04-004\n            - '0x1438'    # car.2019-04-004\n            - '0x143a'    # car.2019-04-004\n            - '0x1f0fff'\n            - '0x1f1fff'\n            - '0x1f2fff'\n            - '0x1f3fff'\n            - '0x40'\n            - '143a'    # car.2019-04-004\n            - '1f0fff'\n            - '1f1fff'\n            - '1f2fff'\n            - '1f3fff'\n            # - '0x1000'  # minimum access requirements to query basic info from service\n        ObjectType: 'Process'\n        ObjectName|endswith: '\\lsass.exe'\n    filter_main_service_account:\n        SubjectUserName|endswith: '$'\n    filter_main_generic:\n        ProcessName|contains:\n            # Legitimate AV and EDR solutions\n            - ':\\Program Files\\'\n            - ':\\Program Files (x86)\\'\n    filter_main_wmiprvse:\n        ProcessName: 'C:\\Windows\\System32\\wbem\\WmiPrvSE.exe'\n        AccessMask: '0x1410'\n    filter_optional_steam:\n        ProcessName|contains: '\\SteamLibrary\\steamapps\\'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_lm_namedpipe.yml","content":"title: First Time Seen Remote Named Pipe\nid: 52d8b0c6-53d6-439a-9e41-52ad442ad9ad\nstatus: test\ndescription: This detection excludes known namped pipes accessible remotely and notify on newly observed ones, may help to detect lateral movement and remote exec using named pipes\nreferences:\n    - https://twitter.com/menasec1/status/1104489274387451904\nauthor: Samir Bousseaden\ndate: 2019-04-03\nmodified: 2023-03-14\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection1:\n        EventID: 5145\n        ShareName: '\\\\\\\\\\*\\\\IPC$' # looking for the string \\\\*\\IPC$\n    false_positives:\n        RelativeTargetName:\n            - 'atsvc'\n            - 'samr'\n            - 'lsarpc'\n            - 'lsass'\n            - 'winreg'\n            - 'netlogon'\n            - 'srvsvc'\n            - 'protected_storage'\n            - 'wkssvc'\n            - 'browser'\n            - 'netdfs'\n            - 'svcctl'\n            - 'spoolss'\n            - 'ntsvcs'\n            - 'LSM_API_service'\n            - 'HydraLsPipe'\n            - 'TermSrv_API_service'\n            - 'MsFteWds'\n            - 'sql\\query'\n            - 'eventlog'\n    condition: selection1 and not false_positives\nfalsepositives:\n    - Update the excluded named pipe to filter out any newly observed legit named pipe\nlevel: high\n"},{"path":"builtin\\security\\win_security_kerberos_coercion_via_dns_object.yml","content":"title: Potential Kerberos Coercion by Spoofing SPNs via DNS Manipulation\nid: b07e58cf-cacc-4135-8473-ccb2eba63dd2\nrelated:\n    - id: e7a21b5f-d8c4-4ae5-b8d9-93c5d3f28e1c # Suspicious DNS Query Indicating Kerberos Coercion via DNS Object Spoofing\n      type: similar\n    - id: 5588576c-5898-4fac-bcdd-7475a60e8f43 # Suspicious DNS Query Indicating Kerberos Coercion via DNS Object Spoofing - Network\n      type: similar\n    - id: 0ed99dda-6a35-11ef-8c99-0242ac120002 # Kerberos Coercion Via DNS SPN Spoofing Attempt\n      type: similar\nstatus: experimental\ndescription: |\n    Detects modifications to DNS records in Active Directory where the Distinguished Name (DN) contains a base64-encoded blob\n    matching the pattern \"1UWhRCAAAAA...BAAAA\". This pattern corresponds to a marshaled CREDENTIAL_TARGET_INFORMATION structure,\n    commonly used in Kerberos coercion attacks. Adversaries may exploit this to coerce victim systems into authenticating to\n    attacker-controlled hosts by spoofing SPNs via DNS. It is one of the strong indicators of a Kerberos coercion attack,.\n    where adversaries manipulate DNS records to spoof Service Principal Names (SPNs) and redirect authentication requests like CVE-2025-33073.\n    Please investigate the user account that made the changes, as it is likely a low-privileged account that has been compromised.\nreferences:\n    - https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html\n    - https://www.synacktiv.com/publications/ntlm-reflection-is-dead-long-live-ntlm-reflection-an-in-depth-analysis-of-cve-2025\nauthor: Swachchhanda Shrawan Poudel (Nextron Systems)\ndate: 2025-06-20\ntags:\n    - attack.collection\n    - attack.credential-access\n    - attack.t1557.003\n    - attack.persistence\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: security\n    definition: |\n      By default these events are not logged by default for MicrosoftDNS objects in Active Directory.\n      To enable detection, configure an AuditRule on the DNS object container with the \"CreateChild\" permission for the \"Everyone\" principal.\n      This can be accomplished using tools such as Set-AuditRule (see https://github.com/OTRF/Set-AuditRule).\ndetection:\n    selection_directory_service_changes:\n        EventID:\n            - 5136\n            - 5137\n        ObjectClass: 'dnsNode'\n        ObjectDN|contains|all: # ObjectDN\">DC=foo-11UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA,DC=domain.com,CN=MicrosoftDNS,DC=DomainDnsZones,DC=domain,DC=com</Data>\n            - 'UWhRCA'\n            - 'BAAAA'\n            - 'CN=MicrosoftDNS'\n    selection_directory_service_access:\n        EventID: 4662\n        AdditionalInfo|contains|all: # AdditionalInfo\">DC=foo-11UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA,DC=domain.com,CN=MicrosoftDNS,DC=DomainDnsZones,DC=domain,DC=com</Data>\n            - 'UWhRCA'\n            - 'BAAAA'\n            - 'CN=MicrosoftDNS'\n    condition: 1 of selection_*\nfields:\n    - SubjectUserName # It is important to check the AccountName field to identify the user, it is likely an low-privileged account that has been compromised.\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_kerberos_asrep_roasting.yml","content":"title: Potential AS-REP Roasting via Kerberos TGT Requests\nid: 3e2f1b2c-4d5e-11ee-be56-0242ac120002\nstatus: experimental\ndescription: |\n    Detects suspicious Kerberos TGT requests with pre-authentication disabled (Pre-Authentication Type = 0) and Ticket Encryption Type (0x17) i.e, RC4-HMAC.\n    This may indicate an AS-REP Roasting attack, where attackers request AS-REP messages for accounts without pre-authentication and attempt to crack the encrypted ticket offline to recover user passwords.\nreferences:\n    - https://medium.com/system-weakness/detecting-as-rep-roasting-attacks-b5b3965f9714\n    - https://www.picussecurity.com/resource/blog/as-rep-roasting-attack-explained-mitre-attack-t1558.004\nauthor: ANosir\ndate: 2025-05-22\nmodified: 2025-07-04\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4768\n        TicketEncryptionType: '0x17'\n        ServiceName: 'krbtgt'\n        PreAuthType: 0\n    condition: selection\nfalsepositives:\n    - Legacy systems or applications that legitimately use RC4 encryption\n    - Misconfigured accounts with pre-authentication disabled\nlevel: medium\n"},{"path":"builtin\\security\\win_security_kerberoasting_activity.yml","content":"title: Kerberoasting Activity - Initial Query\nid: d04ae2b8-ad54-4de0-bd87-4bc1da66aa59\nstatus: test\ndescription: |\n    This rule will collect the data needed to start looking into possible kerberoasting activity.\n    Further analysis or computation within the query is needed focusing on requests from one specific host/IP towards multiple service names within a time period of 5 seconds.\n    You can then set a threshold for the number of requests and time between the requests to turn this into an alert.\nreferences:\n    - https://www.trustedsec.com/blog/art_of_kerberoast/\n    - https://adsecurity.org/?p=3513\nauthor: '@kostastsale'\ndate: 2022-01-21\nmodified: 2025-10-19\ntags:\n    - attack.credential-access\n    - attack.t1558.003\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4769\n        Status: '0x0' # Translated as status from failure code field. Query only for successes\n        TicketEncryptionType: '0x17' # RC4 ticket encryption type\n    filter_main_krbtgt:\n        ServiceName|endswith:\n            - 'krbtgt' # Ignore requests for the krbtgt service\n            - '$' # Ignore requests from service names that end with $ which are associated with genuine kerberos traffic\n    filter_main_machine_accounts:\n        TargetUserName|contains: '$@' # Ignore requests from machines\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Legacy applications.\nlevel: medium\n"},{"path":"builtin\\security\\win_security_iso_mount.yml","content":"title: ISO Image Mounted\nid: 0248a7bc-8a9a-4cd8-a57e-3ae8e073a073\nstatus: test\ndescription: Detects the mount of an ISO image on an endpoint\nreferences:\n    - https://www.trendmicro.com/vinfo/hk-en/security/news/cybercrime-and-digital-threats/malicious-spam-campaign-uses-iso-image-files-to-deliver-lokibot-and-nanocore\n    - https://www.proofpoint.com/us/blog/threat-insight/threat-actor-profile-ta2719-uses-colorful-lures-deliver-rats-local-languages\n    - https://twitter.com/MsftSecIntel/status/1257324139515269121\n    - https://github.com/redcanaryco/atomic-red-team/blob/0f229c0e42bfe7ca736a14023836d65baa941ed2/atomics/T1553.005/T1553.005.md#atomic-test-1---mount-iso-image\nauthor: Syed Hasan (@syedhasan009)\ndate: 2021-05-29\nmodified: 2023-11-09\ntags:\n    - attack.initial-access\n    - attack.t1566.001\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Removable Storage\" must be configured for Success/Failure'\ndetection:\n    selection:\n        EventID: 4663\n        ObjectServer: 'Security'\n        ObjectType: 'File'\n        ObjectName|startswith: '\\Device\\CdRom'\n    filter_main_generic:\n        ObjectName:\n            - '\\Device\\CdRom0\\autorun.ico'\n            - '\\Device\\CdRom0\\setup.exe'\n            - '\\Device\\CdRom0\\setup64.exe'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Software installation ISO files\nlevel: medium\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_via_var_services_security.yml","content":"title: Invoke-Obfuscation VAR++ LAUNCHER OBFUSCATION - Security\nid: 4c54ba8f-73d2-4d40-8890-d9cf1dca3d30\nrelated:\n    - id: 14bcba49-a428-42d9-b943-e2ce0f0f7ae6\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via VAR++ LAUNCHER\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task27)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-13\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        # ServiceFileName|re: '(?i)&&set.*(\\{\\d\\}){2,}\\\\\\\"\\s+?\\-f.*&&.*cmd.*\\/c' # FPs with |\\/r\n        # Example 1: CMD /C\"sET KUR=Invoke-Expression (New-Object Net.WebClient).DownloadString&&Set MxI=C:\\wINDowS\\sYsWow64\\winDOWspoWERSheLl\\V1.0\\PowerShelL.EXe ${ExEcut`IoN`cON`TExT}.\\\"invo`kEcoMm`A`ND\\\".( \\\"{2}{1}{0}\\\" -f 'pt','EscRi','INvOk' ).Invoke( ( .( \\\"{0}{1}\\\" -f'D','IR' ) ( \\\"{0}{1}\\\"-f'ENV:kU','R')).\\\"vAl`Ue\\\" )&& CMD /C%mXI%\"\n        # Example 2: c:\\WiNDOWS\\sYSTEm32\\CmD.exE /C \"sEt DeJLz=Invoke-Expression (New-Object Net.WebClient).DownloadString&&set yBKM=PoWERShelL -noeX ^^^&(\\\"{2}{0}{1}\\\"-f '-ItE','m','seT') ( 'V' + 'a'+ 'RiAblE:z8J' +'U2' + 'l' ) ([TYpE]( \\\"{2}{3}{0}{1}\\\"-f 'e','NT','e','NViRONM' ) ) ; ^^^& ( ( [sTrIng]${VE`Rbo`SepReFER`Ence})[1,3] + 'X'-joIN'')( ( (.('gI') ('V' + 'a' + 'RIAbLe:z8j' + 'u2' +'l' ) ).vALUe::( \\\"{2}{5}{0}{1}{6}{4}{3}\\\" -f 'IRo','Nm','GETE','ABlE','I','nv','enTVAr').Invoke(( \\\"{0}{1}\\\"-f'd','ejLz' ),( \\\"{1}{2}{0}\\\"-f'cEss','P','RO') )) )&& c:\\WiNDOWS\\sYSTEm32\\CmD.exE /C %ybkm%\"\n        ServiceFileName|contains|all:\n            - '&&set'\n            - 'cmd'\n            - '/c'\n            - '-f'\n        ServiceFileName|contains:\n            - '{0}'\n            - '{1}'\n            - '{2}'\n            - '{3}'\n            - '{4}'\n            - '{5}'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_via_use_rundll32_services_security.yml","content":"title: Invoke-Obfuscation Via Use Rundll32 - Security\nid: cd0f7229-d16f-42de-8fe3-fba365fbcb3a\nrelated:\n    - id: 641a4bfb-c017-44f7-800c-2aee0184ce9b\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via use Rundll32 in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task30)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-09\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains|all:\n            - '&&'\n            - 'rundll32'\n            - 'shell32.dll'\n            - 'shellexec_rundll'\n        ServiceFileName|contains:\n            - value\n            - invoke\n            - comspec\n            - iex\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_via_use_mshta_services_security.yml","content":"title: Invoke-Obfuscation Via Use MSHTA - Security\nid: 9b8d9203-4e0f-4cd9-bb06-4cc4ea6d0e9a\nrelated:\n    - id: 7e9c7999-0f9b-4d4a-a6ed-af6d553d4af4\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via use MSHTA in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task31)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-09\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains|all:\n            - 'mshta'\n            - 'vbscript:createobject'\n            - '.run'\n            - 'window.close'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_via_use_clip_services_security.yml","content":"title: Invoke-Obfuscation Via Use Clip - Security\nid: 1a0a2ff1-611b-4dac-8216-8a7b47c618a6\nrelated:\n    - id: 63e3365d-4824-42d8-8b82-e56810fefa0c\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via use Clip.exe in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task29)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-09\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains: '(Clipboard|i'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_via_stdin_services_security.yml","content":"title: Invoke-Obfuscation Via Stdin - Security\nid: 80b708f3-d034-40e4-a6c8-d23b7a7db3d1\nrelated:\n    - id: 487c7524-f892-4054-b263-8a0ace63fc25\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via Stdin in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task28)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-12\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains|all:\n            - 'set'\n            - '&&'\n        ServiceFileName|contains:\n            - 'environment'\n            - 'invoke'\n            - '${input)'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_via_rundll_services_security.yml","content":"title: Invoke-Obfuscation RUNDLL LAUNCHER - Security\nid: f241cf1b-3a6b-4e1a-b4f9-133c00dd95ca\nrelated:\n    - id: 11b52f18-aaec-4d60-9143-5dd8cc4706b9\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via RUNDLL LAUNCHER\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task 23)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-18\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains|all:\n            - 'rundll32.exe'\n            - 'shell32.dll'\n            - 'shellexec_rundll'\n            - 'powershell'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_via_compress_services_security.yml","content":"title: Invoke-Obfuscation COMPRESS OBFUSCATION - Security\nid: 7a922f1b-2635-4d6c-91ef-af228b198ad3\nrelated:\n    - id: 175997c5-803c-4b08-8bb0-70b099f47595\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via COMPRESS OBFUSCATION\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task 19)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-18\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains|all:\n            - 'new-object'\n            - 'text.encoding]::ascii'\n            - 'readtoend'\n        ServiceFileName|contains:\n            - 'system.io.compression.deflatestream'\n            - 'system.io.streamreader'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_var_services_security.yml","content":"title: Invoke-Obfuscation VAR+ Launcher - Security\nid: dcf2db1f-f091-425b-a821-c05875b8925a\nrelated:\n    - id: 8ca7004b-e620-4ecb-870e-86129b5b8e75\n      type: derived\nstatus: test\ndescription: Detects Obfuscated use of Environment Variables to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 24)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-15\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        # ServiceFileName|re: 'cmd.{0,5}(?:\\/c|\\/r)(?:\\s|)\\\"set\\s[a-zA-Z]{3,6}.*(?:\\{\\d\\}){1,}\\\\\\\"\\s+?\\-f(?:.*\\)){1,}.*\\\"'\n        # Example 1: C:\\winDoWs\\SySTeM32\\cmd.Exe /C\"SET NOtI=Invoke-Expression (New-Object Net.WebClient).DownloadString&& PowERshElL -NOl SET-iteM ( 'VAR' + 'i'+ 'A' + 'blE:Ao6' + 'I0') ( [TYpe](\\\"{2}{3}{0}{1}\\\"-F 'iRoN','mENT','e','nv') ) ; ${exECUtIONCOnTEXT}.\\\"IN`VO`KecOmMaND\\\".\\\"inVo`KES`crIPt\\\"( ( ( GEt-VAriAble ( 'a' + 'o6I0') -vaLU )::(\\\"{1}{4}{2}{3}{0}\\\" -f'e','gETenvIR','NtvaRIa','BL','ONme' ).Invoke(( \\\"{0}{1}\\\"-f'n','oti' ),( \\\"{0}{1}\\\" -f'pRoC','esS') )) )\"\n        # Example 2: cMD.exe /C \"seT SlDb=Invoke-Expression (New-Object Net.WebClient).DownloadString&& pOWErShell .(( ^&(\\\"{1}{0}{2}{3}\\\" -f 'eT-vaR','G','iab','lE' ) (\\\"{0}{1}\\\" -f '*m','DR*' ) ).\\\"na`ME\\\"[3,11,2]-JOIN'' ) ( ( ^&(\\\"{0}{1}\\\" -f'g','CI' ) (\\\"{0}{1}\\\" -f 'ENV',':SlDb' ) ).\\\"VA`luE\\\" ) \"\n        ServiceFileName|contains|all:\n            - 'cmd'\n            - '\"set'\n            - '-f'\n        ServiceFileName|contains:\n            - '/c'\n            - '/r'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_stdin_services_security.yml","content":"title: Invoke-Obfuscation STDIN+ Launcher - Security\nid: 0c718a5e-4284-4fb9-b4d9-b9a50b3a1974\nrelated:\n    - id: 72862bf2-0eb1-11eb-adc1-0242ac120002\n      type: derived\nstatus: test\ndescription: Detects Obfuscated use of stdin to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 25)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-15\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains|all:\n            - 'cmd'\n            - 'powershell'\n    selection2:\n        ServiceFileName|contains:\n            - '${input}'\n            - 'noexit'\n    selection3:\n        ServiceFileName|contains:\n            - ' /c '\n            - ' /r '\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_obfuscated_iex_services_security.yml","content":"title: Invoke-Obfuscation Obfuscated IEX Invocation - Security\nid: fd0f5778-d3cb-4c9a-9695-66759d04702a\nrelated:\n    - id: 51aa9387-1c53-4153-91cc-d73c59ae1ca9\n      type: derived\nstatus: test\ndescription: Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the code block linked in the references\nreferences:\n    - https://github.com/danielbohannon/Invoke-Obfuscation/blob/f20e7f843edd0a3a7716736e9eddfa423395dd26/Out-ObfuscatedStringCommand.ps1#L873-L888\nauthor: Daniel Bohannon (@Mandiant/@FireEye), oscd.community\ndate: 2019-11-08\nmodified: 2022-11-27\ntags:\n    - attack.defense-evasion\n    - attack.t1027\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection_eid:\n        EventID: 4697\n    selection_servicefilename:\n        - ServiceFileName|re: '\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\['\n        - ServiceFileName|re: '\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\['\n        - ServiceFileName|re: '\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\['\n        - ServiceFileName|re: '\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}'\n        - ServiceFileName|re: '\\\\*mdr\\*\\W\\s*\\)\\.Name'\n        - ServiceFileName|re: '\\$VerbosePreference\\.ToString\\('\n        - ServiceFileName|re: '\\String\\]\\s*\\$VerbosePreference'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_invoke_obfuscation_clip_services_security.yml","content":"title: Invoke-Obfuscation CLIP+ Launcher - Security\nid: 4edf51e1-cb83-4e1a-bc39-800e396068e3\nrelated:\n    - id: f7385ee2-0e0c-11eb-adc1-0242ac120002\n      type: derived\nstatus: test\ndescription: Detects Obfuscated use of Clip.exe to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 26)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-13\nmodified: 2022-11-27\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\n\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceFileName|contains|all:\n            - 'cmd'\n            - '&&'\n            - 'clipboard]::'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_impacket_secretdump.yml","content":"title: Possible Impacket SecretDump Remote Activity\nid: 252902e3-5830-4cf6-bf21-c22083dfd5cf\nstatus: test\ndescription: Detect AD credential dumping using impacket secretdump HKTL\nreferences:\n    - https://web.archive.org/web/20230329153811/https://blog.menasec.net/2019/02/threat-huting-10-impacketsecretdump.html\nauthor: Samir Bousseaden, wagga\ndate: 2019-04-03\nmodified: 2022-08-11\ntags:\n    - attack.credential-access\n    - attack.t1003.002\n    - attack.t1003.004\n    - attack.t1003.003\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection:\n        EventID: 5145\n        ShareName: '\\\\\\\\\\*\\\\ADMIN$'  # looking for the string  \\\\*\\ADMIN$\n        RelativeTargetName|contains|all:\n            - 'SYSTEM32\\'\n            - '.tmp'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_impacket_psexec.yml","content":"title: Impacket PsExec Execution\nid: 32d56ea1-417f-44ff-822b-882873f5f43b\nstatus: test\ndescription: Detects execution of Impacket's psexec.py.\nreferences:\n    - https://web.archive.org/web/20230329171218/https://blog.menasec.net/2019/02/threat-hunting-3-detecting-psexec.html\nauthor: Bhabesh Raj\ndate: 2020-12-14\nmodified: 2022-09-22\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection1:\n        EventID: 5145\n        ShareName: '\\\\\\\\\\*\\\\IPC$' # looking for the string \\\\*\\IPC$\n        RelativeTargetName|contains:\n            - 'RemCom_stdin'\n            - 'RemCom_stdout'\n            - 'RemCom_stderr'\n    condition: selection1\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_hybridconnectionmgr_svc_installation.yml","content":"title: HybridConnectionManager Service Installation\nid: 0ee4d8a5-4e67-4faf-acfa-62a78457d1f2\nstatus: test\ndescription: Rule to detect the Hybrid Connection Manager service installation.\nreferences:\n    - https://twitter.com/Cyb3rWard0g/status/1381642789369286662\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2021-04-12\nmodified: 2022-10-09\ntags:\n    - attack.persistence\n    - attack.t1554\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    selection:\n        EventID: 4697\n        ServiceName: HybridConnectionManager\n        ServiceFileName|contains: HybridConnectionManager\n    condition: selection\nfalsepositives:\n    - Legitimate use of Hybrid Connection Manager via Azure function apps.\nlevel: high\n"},{"path":"builtin\\security\\win_security_hktl_nofilter.yml","content":"title: HackTool - NoFilter Execution\nid: 7b14c76a-c602-4ae6-9717-eff868153fc0\nstatus: test\ndescription: |\n    Detects execution of NoFilter, a tool for abusing the Windows Filtering Platform for privilege escalation via hardcoded policy name indicators\nreferences:\n    - https://github.com/deepinstinct/NoFilter/blob/121d215ab130c5e8e3ad45a7e7fcd56f4de97b4d/NoFilter/Consts.cpp\n    - https://github.com/deepinstinct/NoFilter\n    - https://www.deepinstinct.com/blog/nofilter-abusing-windows-filtering-platform-for-privilege-escalation\n    - https://x.com/_st0pp3r_/status/1742203752361128162?s=20\nauthor: Stamatis Chatzimangou (st0pp3r)\ndate: 2024-01-05\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1134\n    - attack.t1134.001\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Filtering Platform Policy Change needs to be enabled'\ndetection:\n    selection_5447:\n        EventID: 5447\n        FilterName|contains: 'RonPolicy'\n    selection_5449:\n        EventID: 5449\n        ProviderContextName|contains: 'RonPolicy'\n    condition: 1 of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_hktl_edr_silencer.yml","content":"title: HackTool - EDRSilencer Execution - Filter Added\nid: 98054878-5eab-434c-85d4-72d4e5a3361b\nstatus: test\ndescription: |\n    Detects execution of EDRSilencer, a tool that abuses the Windows Filtering Platform (WFP) to block the outbound traffic of running EDR agents based on specific hardcoded filter names.\nreferences:\n    - https://github.com/netero1010/EDRSilencer\nauthor: Thodoris Polyzos (@SmoothDeploy)\ndate: 2024-01-29\nmodified: 2024-01-30\ntags:\n    - attack.defense-evasion\n    - attack.t1562\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Filtering Platform Policy Change needs to be enabled'\ndetection:\n    selection:\n        EventID:\n            - 5441\n            - 5447\n        FilterName|contains: 'Custom Outbound Filter'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_hidden_user_creation.yml","content":"title: Hidden Local User Creation\nid: 7b449a5e-1db5-4dd0-a2dc-4e3a67282538\nstatus: test\ndescription: Detects the creation of a local hidden user account which should not happen for event ID 4720.\nreferences:\n    - https://twitter.com/SBousseaden/status/1387743867663958021\nauthor: Christian Burkard (Nextron Systems)\ndate: 2021-05-03\nmodified: 2024-01-16\ntags:\n    - attack.persistence\n    - attack.t1136.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4720\n        TargetUserName|endswith: '$'\n    filter_main_homegroup:\n        TargetUserName: 'HomeGroupUser$'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_gpo_scheduledtasks.yml","content":"title: Persistence and Execution at Scale via GPO Scheduled Task\nid: a8f29a7b-b137-4446-80a0-b804272f3da2\nstatus: test\ndescription: Detect lateral movement using GPO scheduled task, usually used to deploy ransomware at scale\nreferences:\n    - https://twitter.com/menasec1/status/1106899890377052160\n    - https://www.secureworks.com/blog/ransomware-as-a-distraction\n    - https://www.elastic.co/guide/en/security/7.17/prebuilt-rule-0-16-1-scheduled-task-execution-at-scale-via-gpo.html\nauthor: Samir Bousseaden\ndate: 2019-04-03\nmodified: 2024-09-04\ntags:\n    - attack.privilege-escalation\n    - attack.execution\n    - attack.persistence\n    - attack.lateral-movement\n    - attack.t1053.005\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection_5136:\n        EventID: 5136\n        AttributeLDAPDisplayName:\n            - 'gPCMachineExtensionNames'\n            - 'gPCUserExtensionNames'\n        AttributeValue|contains:\n            - 'CAB54552-DEEA-4691-817E-ED4A4D1AFC72'\n            - 'AADCED64-746C-4633-A97C-D61349046527'\n    selection_5145:\n        EventID: 5145\n        ShareName|endswith: '\\SYSVOL' # looking for the string \\\\*\\SYSVOL\n        RelativeTargetName|endswith: 'ScheduledTasks.xml'\n        AccessList|contains:\n            - 'WriteData'\n            - '%%4417'\n    condition: 1 of selection_*\nfalsepositives:\n    - If the source IP is not localhost then it's super suspicious, better to monitor both local and remote changes to GPO scheduled tasks.\nlevel: high\n"},{"path":"builtin\\security\\win_security_external_device.yml","content":"title: External Disk Drive Or USB Storage Device Was Recognized By The System\nid: f69a87ea-955e-4fb4-adb2-bb9fd6685632\nstatus: test\ndescription: Detects external disk drives or plugged-in USB devices.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-6416\nauthor: Keith Wright\ndate: 2019-11-20\nmodified: 2024-02-09\ntags:\n    - attack.t1091\n    - attack.t1200\n    - attack.lateral-movement\n    - attack.initial-access\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_eid:\n        EventID: 6416\n    selection_field:\n        - ClassName: 'DiskDrive'\n        - DeviceDescription: 'USB Mass Storage Device'\n    condition: all of selection_*\nfalsepositives:\n    - Likely\nlevel: low\n"},{"path":"builtin\\security\\win_security_dpapi_domain_masterkey_backup_attempt.yml","content":"title: DPAPI Domain Master Key Backup Attempt\nid: 39a94fd1-8c9a-4ff6-bf22-c058762f8014\nstatus: test\ndescription: Detects anyone attempting a backup for the DPAPI Master Key. This events gets generated at the source and not the Domain Controller.\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190620-DomainDPAPIBackupKeyExtraction/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-08-10\nmodified: 2023-03-15\ntags:\n    - attack.credential-access\n    - attack.t1003.004\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4692\n    condition: selection\nfields:\n    - ComputerName\n    - SubjectDomainName\n    - SubjectUserName\nfalsepositives:\n    - If a computer is a member of a domain, DPAPI has a backup mechanism to allow unprotection of the data. Which will trigger this event.\nlevel: medium\n"},{"path":"builtin\\security\\win_security_dpapi_domain_backupkey_extraction.yml","content":"title: DPAPI Domain Backup Key Extraction\nid: 4ac1f50b-3bd0-4968-902d-868b4647937e\nstatus: test\ndescription: Detects tools extracting LSA secret DPAPI domain backup key from Domain Controllers\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190620-DomainDPAPIBackupKeyExtraction/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-06-20\nmodified: 2022-02-24\ntags:\n    - attack.credential-access\n    - attack.t1003.004\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4662\n        ObjectType: 'SecretObject'\n        AccessMask: '0x2'\n        ObjectName|contains: 'BCKUPKEY'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_dot_net_etw_tamper.yml","content":"title: ETW Logging Disabled In .NET Processes - Registry\nid: a4c90ea1-2634-4ca0-adbb-35eae169b6fc\nrelated:\n    - id: bf4fc428-dcc3-4bbd-99fe-2422aeee2544\n      type: similar\nstatus: test\ndescription: Potential adversaries stopping ETW providers recording loaded .NET assemblies.\nreferences:\n    - https://twitter.com/_xpn_/status/1268712093928378368\n    - https://social.msdn.microsoft.com/Forums/vstudio/en-US/0878832e-39d7-4eaf-8e16-a729c4c40975/what-can-i-use-e13c0d23ccbc4e12931bd9cc2eee27e4-for?forum=clr\n    - https://github.com/dotnet/runtime/blob/ee2355c801d892f2894b0f7b14a20e6cc50e0e54/docs/design/coreclr/jit/viewing-jit-dumps.md#setting-configuration-variables\n    - https://github.com/dotnet/runtime/blob/f62e93416a1799aecc6b0947adad55a0d9870732/src/coreclr/src/inc/clrconfigvalues.h#L35-L38\n    - https://github.com/dotnet/runtime/blob/7abe42dc1123722ed385218268bb9fe04556e3d3/src/coreclr/src/inc/clrconfig.h#L33-L39\n    - https://github.com/dotnet/runtime/search?p=1&q=COMPlus_&unscoped_q=COMPlus_\n    - https://bunnyinside.com/?term=f71e8cb9c76a\n    - http://managed670.rssing.com/chan-5590147/all_p1.html\n    - https://github.com/dotnet/runtime/blob/4f9ae42d861fcb4be2fcd5d3d55d5f227d30e723/docs/coding-guidelines/clr-jit-coding-conventions.md#1412-disabling-code\n    - https://i.blackhat.com/EU-21/Wednesday/EU-21-Teodorescu-Veni-No-Vidi-No-Vici-Attacks-On-ETW-Blind-EDRs.pdf\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2020-06-05\nmodified: 2022-12-20\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.t1112\n    - attack.t1562\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_etw_enabled:\n        EventID: 4657\n        ObjectName|endswith: '\\SOFTWARE\\Microsoft\\.NETFramework'\n        ObjectValueName: 'ETWEnabled'\n        NewValue: 0\n    selection_complus:\n        EventID: 4657\n        ObjectName|contains: '\\Environment'\n        ObjectValueName:\n            - 'COMPlus_ETWEnabled'\n            - 'COMPlus_ETWFlags'\n        NewValue: 0\n    condition: 1 of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_disable_event_auditing_critical.yml","content":"title: Important Windows Event Auditing Disabled\nid: ab4561b1-6c7e-48a7-ad08-087cfb9ce8f1\nrelated:\n    - id: 69aeb277-f15f-4d2d-b32a-55e883609563\n      type: derived\nstatus: test\ndescription: Detects scenarios where system auditing for important events such as \"Process Creation\" or \"Logon\" events is disabled.\nreferences:\n    - https://docs.google.com/presentation/d/1dkrldTTlN3La-OjWtkWJBb4hVk6vfsSMBFBERs6R8zA/edit\n    - https://github.com/SigmaHQ/sigma/blob/ad1bfd3d28aa0ccc9656240f845022518ef65a2e/documentation/logsource-guides/windows/service/security.md\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-20\nmodified: 2023-11-17\ntags:\n    - attack.defense-evasion\n    - attack.t1562.002\nlogsource:\n    product: windows\n    service: security\n    definition: dfd8c0f4-e6ad-4e07-b91b-f2fca0ddef64\ndetection:\n    selection_state_success_and_failure:\n        EventID: 4719\n        SubcategoryGuid:\n            # Note: Add or remove GUID as you see fit in your env\n            - '{0CCE9210-69AE-11D9-BED3-505054503030}' # Audit Security State Change\n            - '{0CCE9211-69AE-11D9-BED3-505054503030}' # Audit Security System Extension\n            - '{0CCE9212-69AE-11D9-BED3-505054503030}' # Audit System Integrity\n            - '{0CCE9215-69AE-11D9-BED3-505054503030}' # Audit Logon\n            - '{0CCE921B-69AE-11D9-BED3-505054503030}' # Audit Special Logon\n            - '{0CCE922B-69AE-11D9-BED3-505054503030}' # Audit Process Creation\n            - '{0CCE922F-69AE-11D9-BED3-505054503030}' # Audit Audit Policy Change\n            - '{0CCE9230-69AE-11D9-BED3-505054503030}' # Audit Authentication Policy Change\n            - '{0CCE9235-69AE-11D9-BED3-505054503030}' # Audit User Account Management\n            - '{0CCE9236-69AE-11D9-BED3-505054503030}' # Audit Computer Account Management\n            - '{0CCE9237-69AE-11D9-BED3-505054503030}' # Audit Security Group Management\n            - '{0CCE923F-69AE-11D9-BED3-505054503030}' # Audit Credential Validation\n            - '{0CCE9240-69AE-11D9-BED3-505054503030}' # Audit Kerberos Service Ticket Operations\n            - '{0CCE9242-69AE-11D9-BED3-505054503030}' # Audit Kerberos Authentication Service\n        AuditPolicyChanges|contains:\n            - '%%8448' # This is \"Success removed\"\n            - '%%8450' # This is \"Failure removed\"\n    selection_state_success_only:\n        EventID: 4719\n        SubcategoryGuid: '{0CCE9217-69AE-11D9-BED3-505054503030}' # Audit Account Lockout\n        AuditPolicyChanges|contains: '%%8448'\n    condition: 1 of selection_*\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\security\\win_security_disable_event_auditing.yml","content":"title: Windows Event Auditing Disabled\nid: 69aeb277-f15f-4d2d-b32a-55e883609563\nrelated:\n    - id: ab4561b1-6c7e-48a7-ad08-087cfb9ce8f1\n      type: derived\nstatus: test\ndescription: |\n    Detects scenarios where system auditing (i.e.: Windows event log auditing) is disabled.\n    This may be used in a scenario where an entity would want to bypass local logging to evade detection when Windows event logging is enabled and reviewed.\n    Also, it is recommended to turn off \"Local Group Policy Object Processing\" via GPO, which will make sure that Active Directory GPOs take precedence over local/edited computer policies via something such as \"gpedit.msc\".\n    Please note, that disabling \"Local Group Policy Object Processing\" may cause an issue in scenarios of one off specific GPO modifications - however, it is recommended to perform these modifications in Active Directory anyways.\nreferences:\n    - https://docs.google.com/presentation/d/1dkrldTTlN3La-OjWtkWJBb4hVk6vfsSMBFBERs6R8zA/edit\nauthor: '@neu5ron, Nasreddine Bencherchali (Nextron Systems)'\ndate: 2017-11-19\nmodified: 2023-11-15\ntags:\n    - attack.defense-evasion\n    - attack.t1562.002\nlogsource:\n    product: windows\n    service: security\n    definition: dfd8c0f4-e6ad-4e07-b91b-f2fca0ddef64\ndetection:\n    selection:\n        EventID: 4719\n        AuditPolicyChanges|contains:\n            - '%%8448' # This is \"Success removed\"\n            - '%%8450' # This is \"Failure removed\"\n    filter_main_guid:\n        # Note: We filter these GUID to avoid alert duplication as these are covered by ab4561b1-6c7e-48a7-ad08-087cfb9ce8f1\n        SubcategoryGuid:\n            - '{0CCE9210-69AE-11D9-BED3-505054503030}' # Audit Security State Change\n            - '{0CCE9211-69AE-11D9-BED3-505054503030}' # Audit Security System Extension\n            - '{0CCE9212-69AE-11D9-BED3-505054503030}' # Audit System Integrity\n            - '{0CCE9215-69AE-11D9-BED3-505054503030}' # Audit Logon\n            - '{0CCE9217-69AE-11D9-BED3-505054503030}' # Audit Account Lockout\n            - '{0CCE921B-69AE-11D9-BED3-505054503030}' # Audit Special Logon\n            - '{0CCE922B-69AE-11D9-BED3-505054503030}' # Audit Process Creation\n            - '{0CCE922F-69AE-11D9-BED3-505054503030}' # Audit Audit Policy Change\n            - '{0CCE9230-69AE-11D9-BED3-505054503030}' # Audit Authentication Policy Change\n            - '{0CCE9235-69AE-11D9-BED3-505054503030}' # Audit User Account Management\n            - '{0CCE9236-69AE-11D9-BED3-505054503030}' # Audit Computer Account Management\n            - '{0CCE9237-69AE-11D9-BED3-505054503030}' # Audit Security Group Management\n            - '{0CCE923F-69AE-11D9-BED3-505054503030}' # Audit Credential Validation\n            - '{0CCE9240-69AE-11D9-BED3-505054503030}' # Audit Kerberos Service Ticket Operations\n            - '{0CCE9242-69AE-11D9-BED3-505054503030}' # Audit Kerberos Authentication Service'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: low # Increase this after a testing period in your environment\n"},{"path":"builtin\\security\\win_security_device_installation_blocked.yml","content":"title: Device Installation Blocked\nid: c9eb55c3-b468-40ab-9089-db2862e42137\nstatus: test\ndescription: Detects an installation of a device that is forbidden by the system policy\nreferences:\n    - https://github.com/Yamato-Security/EnableWindowsLogSettings/blob/7f6d755d45ac7cc9fc35b0cbf498e6aa4ef19def/ConfiguringSecurityLogAuditPolicies.md\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-6423\nauthor: frack113\ndate: 2022-10-14\ntags:\n    - attack.initial-access\n    - attack.t1200\nlogsource:\n    service: security\n    product: windows\ndetection:\n    selection:\n        EventID: 6423\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_dcsync.yml","content":"title: Mimikatz DC Sync\nid: 611eab06-a145-4dfa-a295-3ccc5c20f59a\nstatus: test\ndescription: Detects Mimikatz DC sync security events\nreferences:\n    - https://twitter.com/gentilkiwi/status/1003236624925413376\n    - https://gist.github.com/gentilkiwi/dcc132457408cf11ad2061340dcb53c2\n    - https://blog.blacklanternsecurity.com/p/detecting-dcsync?s=r\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4662\nauthor: Benjamin Delpy, Florian Roth (Nextron Systems), Scott Dermott, Sorina Ionescu\ndate: 2018-06-03\nmodified: 2022-04-26\ntags:\n    - attack.credential-access\n    - attack.s0002\n    - attack.t1003.006\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4662\n        Properties|contains:\n            - 'Replicating Directory Changes All'\n            - '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2'\n            - '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2'\n            - '9923a32a-3607-11d2-b9be-0000f87a36b2'\n            - '89e95b76-444d-4c62-991a-0facbeda640c'\n        AccessMask: '0x100'\n    filter1:\n        SubjectDomainName: 'Window Manager'\n    filter2:\n        SubjectUserName|startswith:\n            - 'NT AUT'\n            - 'MSOL_'\n    filter3:\n        SubjectUserName|endswith: '$'\n    condition: selection and not 1 of filter*\nfalsepositives:\n    - Valid DC Sync that is not covered by the filters; please report\n    - Local Domain Admin account used for Azure AD Connect\nlevel: high\n"},{"path":"builtin\\security\\win_security_dcom_iertutil_dll_hijack.yml","content":"title: DCOM InternetExplorer.Application Iertutil DLL Hijack - Security\nid: c39f0c81-7348-4965-ab27-2fde35a1b641\nstatus: test\ndescription: Detects a threat actor creating a file named `iertutil.dll` in the `C:\\Program Files\\Internet Explorer\\` directory over the network for a DCOM InternetExplorer DLL Hijack scenario.\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/201009-RemoteDCOMIErtUtilDLLHijack/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR)\ndate: 2020-10-12\nmodified: 2022-11-26\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\n    - attack.t1021.003\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5145\n        RelativeTargetName|endswith: '\\Internet Explorer\\iertutil.dll'\n    filter:\n        SubjectUserName|endswith: '$'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_dce_rpc_smb_spoolss_named_pipe.yml","content":"title: DCERPC SMB Spoolss Named Pipe\nid: 214e8f95-100a-4e04-bb31-ef6cba8ce07e\nstatus: test\ndescription: Detects the use of the spoolss named pipe over SMB. This can be used to trigger the authentication via NTLM of any machine that has the spoolservice enabled.\nreferences:\n    - https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1\n    - https://dirkjanm.io/a-different-way-of-abusing-zerologon/\n    - https://twitter.com/_dirkjan/status/1309214379003588608\nauthor: OTR (Open Threat Research)\ndate: 2018-11-28\nmodified: 2022-08-11\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 5145\n        ShareName: '\\\\\\\\\\*\\\\IPC$' # looking for the string \\\\*\\IPC$\n        RelativeTargetName: spoolss\n    condition: selection\nfalsepositives:\n    - 'Domain Controllers acting as printer servers too? :)'\nlevel: medium\n"},{"path":"builtin\\security\\win_security_codeintegrity_check_failure.yml","content":"title: Failed Code Integrity Checks\nid: 470ec5fa-7b4e-4071-b200-4c753100f49b\nstatus: stable\ndescription: |\n    Detects code integrity failures such as missing page hashes or corrupted drivers due unauthorized modification. This could be a sign of tampered binaries.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-5038\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-6281\nauthor: Thomas Patzke\ndate: 2019-12-03\nmodified: 2025-01-19\ntags:\n    - attack.defense-evasion\n    - attack.t1027.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 5038\n            - 6281\n    filter_optional_crowdstrike:\n        param1|contains:\n            - '\\CSFalconServiceUninstallTool_'\n            - '\\Program Files\\CrowdStrike\\'\n            - '\\System32\\drivers\\CrowdStrike\\'\n            - '\\Windows\\System32\\ScriptControl64_'\n    filter_optional_sophos:\n        param1|contains: '\\Program Files\\Sophos\\'\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Disk device errors\nlevel: informational\n"},{"path":"builtin\\security\\win_security_cobaltstrike_service_installs.yml","content":"title: CobaltStrike Service Installations - Security\nid: d7a95147-145f-4678-b85d-d1ff4a3bb3f6\nrelated:\n    - id: 5a105d34-05fc-401e-8553-272b45c1522d\n      type: derived\nstatus: test\ndescription: Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement\nreferences:\n    - https://www.sans.org/webcasts/119395\n    - https://www.crowdstrike.com/blog/getting-the-bacon-from-cobalt-strike-beacon/\n    - https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/\nauthor: Florian Roth (Nextron Systems), Wojciech Lesicki\ndate: 2021-05-26\nmodified: 2022-11-27\ntags:\n    - attack.persistence\n    - attack.execution\n    - attack.privilege-escalation\n    - attack.lateral-movement\n    - attack.t1021.002\n    - attack.t1543.003\n    - attack.t1569.002\nlogsource:\n    product: windows\n    service: security\n    definition: The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697\ndetection:\n    event_id:\n        EventID: 4697\n    selection1:\n        ServiceFileName|contains|all:\n            - 'ADMIN$'\n            - '.exe'\n    selection2:\n        ServiceFileName|contains|all:\n            - '%COMSPEC%'\n            - 'start'\n            - 'powershell'\n    selection3:\n        ServiceFileName|contains: 'powershell -nop -w hidden -encodedcommand'\n    selection4:\n        ServiceFileName|base64offset|contains: \"IEX (New-Object Net.Webclient).DownloadString('http://127.0.0.1:\"\n    condition: event_id and 1 of selection*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_camera_microphone_access.yml","content":"title: Processes Accessing the Microphone and Webcam\nid: 8cd538a4-62d5-4e83-810b-12d41e428d6e\nstatus: test\ndescription: Potential adversaries accessing the microphone and webcam in an endpoint.\nreferences:\n    - https://twitter.com/duzvik/status/1269671601852813320\n    - https://medium.com/@7a616368/can-you-track-processes-accessing-the-camera-and-microphone-7e6885b37072\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2020-06-07\nmodified: 2021-11-27\ntags:\n    - attack.collection\n    - attack.t1123\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4657\n            - 4656\n            - 4663\n        ObjectName|contains:\n            - '\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\CapabilityAccessManager\\ConsentStore\\microphone\\NonPackaged'\n            - '\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\CapabilityAccessManager\\ConsentStore\\webcam\\NonPackaged'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_audit_log_cleared.yml","content":"title: Security Eventlog Cleared\nid: d99b79d2-0a6f-4f46-ad8b-260b6e17f982\nrelated:\n    - id: f2f01843-e7b8-4f95-a35a-d23584476423\n      type: obsolete\n    - id: a122ac13-daf8-4175-83a2-72c387be339d\n      type: obsolete\nstatus: test\ndescription: One of the Windows Eventlogs has been cleared. e.g. caused by \"wevtutil cl\" command execution\nreferences:\n    - https://twitter.com/deviouspolack/status/832535435960209408\n    - https://www.hybrid-analysis.com/sample/027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745?environmentId=100\n    - https://github.com/Azure/Azure-Sentinel/blob/f99542b94afe0ad2f19a82cc08262e7ac8e1428e/Detections/SecurityEvent/SecurityEventLogCleared.yaml\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-01-10\nmodified: 2022-02-24\ntags:\n    - attack.defense-evasion\n    - attack.t1070.001\n    - car.2016-04-002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection_517:\n        EventID: 517\n        Provider_Name: Security\n    selection_1102:\n        EventID: 1102\n        Provider_Name: Microsoft-Windows-Eventlog\n    condition: 1 of selection_*\nfalsepositives:\n    - Rollout of log collection agents (the setup routine often includes a reset of the local Eventlog)\n    - System provisioning (system reset before the golden image creation)\nlevel: high\n"},{"path":"builtin\\security\\win_security_atsvc_task.yml","content":"title: Remote Task Creation via ATSVC Named Pipe\nid: f6de6525-4509-495a-8a82-1f8b0ed73a00\nstatus: test\ndescription: Detects remote task creation via at.exe or API interacting with ATSVC namedpipe\nreferences:\n    - https://web.archive.org/web/20230409194125/https://blog.menasec.net/2019/03/threat-hunting-25-scheduled-tasks-for.html\nauthor: Samir Bousseaden\ndate: 2019-04-03\nmodified: 2024-08-01\ntags:\n    - attack.privilege-escalation\n    - attack.execution\n    - attack.lateral-movement\n    - attack.persistence\n    - car.2013-05-004\n    - car.2015-04-001\n    - attack.t1053.002\nlogsource:\n    product: windows\n    service: security\n    definition: 'The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure'\ndetection:\n    selection:\n        EventID: 5145\n        ShareName: '\\\\\\\\\\*\\\\IPC$' # looking for the string \\\\*\\IPC$\n        RelativeTargetName: atsvc\n        AccessList|contains: 'WriteData'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_alert_ruler.yml","content":"title: Hacktool Ruler\nid: 24549159-ac1b-479c-8175-d42aea947cae\nstatus: test\ndescription: This events that are generated when using the hacktool Ruler by Sensepost\nreferences:\n    - https://github.com/sensepost/ruler\n    - https://github.com/sensepost/ruler/issues/47\n    - https://github.com/staaldraad/go-ntlm/blob/cd032d41aa8ce5751c07cb7945400c0f5c81e2eb/ntlm/ntlmv1.go#L427\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4776\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4624\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-05-31\nmodified: 2022-10-09\ntags:\n    - attack.defense-evasion\n    - attack.discovery\n    - attack.execution\n    - attack.collection\n    - attack.lateral-movement\n    - attack.t1087\n    - attack.t1114\n    - attack.t1059\n    - attack.t1550.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection1:\n        EventID: 4776\n        Workstation: 'RULER'\n    selection2:\n        EventID:\n            - 4624\n            - 4625\n        WorkstationName: 'RULER'\n    condition: (1 of selection*)\nfalsepositives:\n    - Go utilities that use staaldraad awesome NTLM library\nlevel: high\n"},{"path":"builtin\\security\\win_security_alert_enable_weak_encryption.yml","content":"title: Weak Encryption Enabled and Kerberoast\nid: f6de9536-0441-4b3f-a646-f4e00f300ffd\nstatus: test\ndescription: Detects scenario where weak encryption is enabled for a user profile which could be used for hash/password cracking.\nreferences:\n    - https://adsecurity.org/?p=2053\n    - https://blog.harmj0y.net/redteaming/another-word-on-delegation/\nauthor: '@neu5ron'\ndate: 2017-07-30\nmodified: 2021-11-27\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Policy : Account Management > Audit User Account Management, Group Policy : Computer Configuration\\Windows Settings\\Security Settings\\Advanced Audit Policy Configuration\\Audit Policies\\Account Management\\Audit User Account Management'\ndetection:\n    selection:\n        EventID: 4738\n    # According to Microsoft, the bit values are listed here: https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4720\n    # However, that seems to be a simple copy from https://learn.microsoft.com/en-us/troubleshoot/windows-server/active-directory/useraccountcontrol-manipulate-account-properties\n    # and the actual flags that are used are quite different and, unfortunately, not documented.\n    # https://github.com/mdecrevoisier/EVTX-to-MITRE-Attack/ contains a number of EVTX files with relevant events, which can be used to extract\n    # the following values.\n    olduac_des: # 0x8000\n        OldUacValue|endswith:\n            - 8???\n            - 9???\n            - A???\n            - B???\n            - C???\n            - D???\n            - E???\n            - F???\n    newuac_des:\n        NewUacValue|endswith:\n            - 8???\n            - 9???\n            - A???\n            - B???\n            - C???\n            - D???\n            - E???\n            - F???\n    olduac_preauth: # 0x10000\n        OldUacValue|endswith:\n            - 1????\n            - 3????\n            - 5????\n            - 7????\n            - 9????\n            - B????\n            - D????\n            - F????\n    newuac_preauth:\n        NewUacValue|endswith:\n            - 1????\n            - 3????\n            - 5????\n            - 7????\n            - 9????\n            - B????\n            - D????\n            - F????\n    olduac_encrypted: # 0x800\n        OldUacValue|endswith:\n            - 8??\n            - 9??\n            - A??\n            - B??\n            - C??\n            - D??\n            - E??\n            - F??\n    newuac_encrypted:\n        NewUacValue|endswith:\n            - 8??\n            - 9??\n            - A??\n            - B??\n            - C??\n            - D??\n            - E??\n            - F??\n    condition: selection and ((newuac_des and not olduac_des) or (newuac_preauth and not olduac_preauth) or (newuac_encrypted and not olduac_encrypted))\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_alert_ad_user_backdoors.yml","content":"title: Active Directory User Backdoors\nid: 300bac00-e041-4ee2-9c36-e262656a6ecc\nstatus: test\ndescription: Detects scenarios where one can control another users or computers account without having to use their credentials.\nreferences:\n    - https://msdn.microsoft.com/en-us/library/cc220234.aspx\n    - https://adsecurity.org/?p=3466\n    - https://blog.harmj0y.net/redteaming/another-word-on-delegation/\nauthor: '@neu5ron'\ndate: 2017-04-13\nmodified: 2024-02-26\ntags:\n    - attack.privilege-escalation\n    - attack.t1098\n    - attack.persistence\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Policy : Account Management > Audit User Account Management, Group Policy : Computer Configuration\\Windows Settings\\Security Settings\\Advanced Audit Policy Configuration\\Audit Policies\\Account Management\\Audit User Account Management, DS Access > Audit Directory Service Changes, Group Policy : Computer Configuration\\Windows Settings\\Security Settings\\Advanced Audit Policy Configuration\\Audit Policies\\DS Access\\Audit Directory Service Changes'\ndetection:\n    selection1:\n        EventID: 4738\n    filter_empty:\n        AllowedToDelegateTo:\n            - ''\n            - '-'\n    filter_null:\n        AllowedToDelegateTo: null\n    selection_5136_1:\n        EventID: 5136\n        AttributeLDAPDisplayName: 'msDS-AllowedToDelegateTo'\n    selection_5136_2:\n        EventID: 5136\n        ObjectClass: 'user'\n        AttributeLDAPDisplayName: 'servicePrincipalName'\n    selection_5136_3:\n        EventID: 5136\n        AttributeLDAPDisplayName: 'msDS-AllowedToActOnBehalfOfOtherIdentity'\n    condition: (selection1 and not 1 of filter_*) or 1 of selection_5136_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_alert_active_directory_user_control.yml","content":"title: Enabled User Right in AD to Control User Objects\nid: 311b6ce2-7890-4383-a8c2-663a9f6b43cd\nstatus: test\ndescription: Detects scenario where if a user is assigned the SeEnableDelegationPrivilege right in Active Directory it would allow control of other AD user objects.\nreferences:\n    - https://blog.harmj0y.net/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/\nauthor: '@neu5ron'\ndate: 2017-07-30\nmodified: 2021-12-02\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Policy : Policy Change > Audit Authorization Policy Change, Group Policy : Computer Configuration\\Windows Settings\\Security Settings\\Advanced Audit Policy Configuration\\Audit Policies\\Policy Change\\Audit Authorization Policy Change'\ndetection:\n    selection_base:\n        EventID: 4704\n    selection_keywords:\n        PrivilegeList|contains: 'SeEnableDelegationPrivilege'\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\win_security_ad_user_enumeration.yml","content":"title: Potential AD User Enumeration From Non-Machine Account\nid: ab6bffca-beff-4baa-af11-6733f296d57a\nstatus: test\ndescription: Detects read access to a domain user from a non-machine account\nreferences:\n    - https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf\n    - http://www.stuffithoughtiknew.com/2019/02/detecting-bloodhound.html\n    - https://learn.microsoft.com/en-us/windows/win32/adschema/attributes-all # For further investigation of the accessed properties\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4662\nauthor: Maxime Thiebaut (@0xThiebaut)\ndate: 2020-03-30\nmodified: 2022-11-08\ntags:\n    - attack.discovery\n    - attack.t1087.002\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: The \"Read all properties\" permission on the user object needs to be audited for the \"Everyone\" principal'\ndetection:\n    selection:\n        EventID: 4662\n        # Using contains as the data commonly is structured as \"%{bf967aba-0de6-11d0-a285-00aa003049e2}\"\n        # The user class (https://learn.microsoft.com/en-us/windows/win32/adschema/c-user)\n        ObjectType|contains: 'bf967aba-0de6-11d0-a285-00aa003049e2'\n        AccessMask|endswith:\n            # Note: Since the Access Mask can have more than once permission we need to add all permutations that include the READ property\n            - '1?' # This covers all access masks that are 1 bytes or shorter and the \"Read Property\" itself\n            - '3?' # Read Property + Write Property\n            - '4?' # Read Property + Delete Tree\n            - '7?' # Read Property + Write Property + Delete Tree\n            - '9?' # Read Property + List Object\n            - 'B?' # Read Property + Write Property + List Object\n            - 'D?' # Read Property + Delete Tree + List Object\n            - 'F?' # Covers usage of all possible 2 bytes permissions with any or none of the single byte permissions\n    filter_main_machine_accounts:\n        SubjectUserName|endswith: '$' # Exclude machine accounts\n    filter_main_msql:\n        SubjectUserName|startswith: 'MSOL_' # https://learn.microsoft.com/en-us/azure/active-directory/hybrid/reference-connect-accounts-permissions#ad-ds-connector-account\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Administrators configuring new users.\nlevel: medium\n"},{"path":"builtin\\security\\win_security_ad_replication_non_machine_account.yml","content":"title: Active Directory Replication from Non Machine Account\nid: 17d619c1-e020-4347-957e-1d1207455c93\nstatus: test\ndescription: Detects potential abuse of Active Directory Replication Service (ADRS) from a non machine account to request credentials.\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/180815-ADObjectAccessReplication/notebook.html\n    - https://threathunterplaybook.com/library/windows/active_directory_replication.html\n    - https://threathunterplaybook.com/hunts/windows/190101-ADModDirectoryReplication/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-07-26\nmodified: 2021-11-27\ntags:\n    - attack.credential-access\n    - attack.t1003.006\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4662\n        AccessMask: '0x100'\n        Properties|contains:\n            - '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2'\n            - '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2'\n            - '89e95b76-444d-4c62-991a-0facbeda640c'\n    filter:\n        - SubjectUserName|endswith: '$'\n        - SubjectUserName|startswith: 'MSOL_' # https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/reference-connect-accounts-permissions#ad-ds-connector-account\n    condition: selection and not filter\nfields:\n    - ComputerName\n    - SubjectDomainName\n    - SubjectUserName\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"builtin\\security\\win_security_ad_object_writedac_access.yml","content":"title: AD Object WriteDAC Access\nid: 028c7842-4243-41cd-be6f-12f3cf1a26c7\nstatus: test\ndescription: Detects WRITE_DAC access to a domain object\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/180815-ADObjectAccessReplication/notebook.html\n    - https://threathunterplaybook.com/library/windows/active_directory_replication.html\n    - https://threathunterplaybook.com/hunts/windows/190101-ADModDirectoryReplication/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-09-12\nmodified: 2021-11-27\ntags:\n    - attack.defense-evasion\n    - attack.t1222.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4662\n        ObjectServer: 'DS'\n        AccessMask: '0x40000'\n        ObjectType:\n            - '19195a5b-6da0-11d0-afd3-00c04fd930c9'\n            - 'domainDNS'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"builtin\\security\\win_security_admin_share_access.yml","content":"title: Access To ADMIN$ Network Share\nid: 098d7118-55bc-4912-a836-dc6483a8d150\nstatus: test\ndescription: Detects access to ADMIN$ network share\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-5140\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-03-04\nmodified: 2024-01-16\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: The advanced audit policy setting \"Object Access > Audit File Share\" must be configured for Success/Failure'\ndetection:\n    selection:\n        EventID: 5140\n        ShareName: 'Admin$'\n    filter_main_computer_account:\n        SubjectUserName|endswith: '$'\n    condition: selection and not 1 of filter_*\nfalsepositives:\n    - Legitimate administrative activity\nlevel: low\n"},{"path":"builtin\\security\\win_security_add_remove_computer.yml","content":"title: Add or Remove Computer from DC\nid: 20d96d95-5a20-4cf1-a483-f3bda8a7c037\nstatus: test\ndescription: Detects the creation or removal of a computer. Can be used to detect attacks such as DCShadow via the creation of a new SPN.\nreferences:\n    - https://github.com/Yamato-Security/EnableWindowsLogSettings/blob/7f6d755d45ac7cc9fc35b0cbf498e6aa4ef19def/ConfiguringSecurityLogAuditPolicies.md\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4741\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4743\nauthor: frack113\ndate: 2022-10-14\ntags:\n    - attack.defense-evasion\n    - attack.t1207\nlogsource:\n    service: security\n    product: windows\ndetection:\n    selection:\n        EventID:\n            - 4741\n            - 4743\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"builtin\\security\\win_security_adcs_certificate_template_configuration_vulnerability_eku.yml","content":"title: ADCS Certificate Template Configuration Vulnerability with Risky EKU\nid: bfbd3291-de87-4b7c-88a2-d6a5deb28668\nstatus: test\ndescription: Detects certificate creation with template allowing risk permission subject and risky EKU\nreferences:\n    - https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf\nauthor: Orlinum , BlueDefenZer\ndate: 2021-11-17\nmodified: 2022-12-25\ntags:\n    - attack.privilege-escalation\n    - attack.credential-access\nlogsource:\n    product: windows\n    service: security\n    definition: Certificate services loaded a template would trigger event ID 4898 and certificate Services template was updated would trigger event ID 4899. A risk permission seems to be coming if template contain specific flag with risky EKU.\ndetection:\n    selection10:\n        EventID: 4898\n        TemplateContent|contains:\n            - '1.3.6.1.5.5.7.3.2'\n            - '1.3.6.1.5.2.3.4'\n            - '1.3.6.1.4.1.311.20.2.2'\n            - '2.5.29.37.0'\n    selection11:\n        TemplateContent|contains: 'CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT'\n\n    selection20:\n        EventID: 4899\n        NewTemplateContent|contains:\n            - '1.3.6.1.5.5.7.3.2'\n            - '1.3.6.1.5.2.3.4'\n            - '1.3.6.1.4.1.311.20.2.2'\n            - '2.5.29.37.0'\n    selection21:\n        NewTemplateContent|contains: 'CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT'\n\n    condition: (selection10 and selection11) or (selection20 and selection21)\nfalsepositives:\n    - Administrator activity\n    - Proxy SSL certificate with subject modification\n    - Smart card enrollement\nlevel: high\n"},{"path":"builtin\\security\\win_security_adcs_certificate_template_configuration_vulnerability.yml","content":"title: ADCS Certificate Template Configuration Vulnerability\nid: 5ee3a654-372f-11ec-8d3d-0242ac130003\nstatus: test\ndescription: Detects certificate creation with template allowing risk permission subject\nreferences:\n    - https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf\nauthor: Orlinum , BlueDefenZer\ndate: 2021-11-17\nmodified: 2022-12-25\ntags:\n    - attack.privilege-escalation\n    - attack.credential-access\nlogsource:\n    product: windows\n    service: security\n    definition: Certificate services loaded a template would trigger event ID 4898 and certificate Services template was updated would trigger event ID 4899. A risk permission seems to be coming if template contain specific flag.\ndetection:\n    selection1:\n        EventID: 4898\n        TemplateContent|contains: 'CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT'\n    selection2:\n        EventID: 4899\n        NewTemplateContent|contains: 'CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT'\n    condition: selection1 or selection2\nfalsepositives:\n    - Administrator activity\n    - Proxy SSL certificate with subject modification\n    - Smart card enrollement\nlevel: low\n"},{"path":"builtin\\security\\win_security_account_discovery.yml","content":"title: AD Privileged Users or Groups Reconnaissance\nid: 35ba1d85-724d-42a3-889f-2e2362bcaf23\nstatus: test\ndescription: Detect priv users or groups recon based on 4661 eventid and known privileged users or groups SIDs\nreferences:\n    - https://web.archive.org/web/20230329163438/https://blog.menasec.net/2019/02/threat-hunting-5-detecting-enumeration.html\nauthor: Samir Bousseaden\ndate: 2019-04-03\nmodified: 2022-07-13\ntags:\n    - attack.discovery\n    - attack.t1087.002\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: enable Object Access SAM on your Domain Controllers'\ndetection:\n    selection:\n        EventID: 4661\n        ObjectType:\n            - 'SAM_USER'\n            - 'SAM_GROUP'\n    selection_object:\n        - ObjectName|endswith:\n              - '-512'\n              - '-502'\n              - '-500'\n              - '-505'\n              - '-519'\n              - '-520'\n              - '-544'\n              - '-551'\n              - '-555'\n        - ObjectName|contains: 'admin'\n    filter:\n        SubjectUserName|endswith: '$'\n    condition: selection and selection_object and not filter\nfalsepositives:\n    - If source account name is not an admin then its super suspicious\nlevel: high\n"},{"path":"builtin\\security\\win_security_account_backdoor_dcsync_rights.yml","content":"title: Powerview Add-DomainObjectAcl DCSync AD Extend Right\nid: 2c99737c-585d-4431-b61a-c911d86ff32f\nstatus: test\ndescription: Backdooring domain object to grant the rights associated with DCSync to a regular user or machine account using Powerview\\Add-DomainObjectAcl DCSync Extended Right cmdlet, will allow to re-obtain the pwd hashes of any user/computer\nreferences:\n    - https://twitter.com/menasec1/status/1111556090137903104\n    - https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf\nauthor: Samir Bousseaden, Roberto Rodriguez @Cyb3rWard0g, oscd.community, Tim Shelton, Maxence Fossat\ndate: 2019-04-03\nmodified: 2022-08-16\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: The \"Audit Directory Service Changes\" logging policy must be configured in order to receive events. Audit events are generated only for objects with configured system access control lists (SACLs). Audit events are generated only for objects with configured system access control lists (SACLs) and only when accessed in a manner that matches their SACL settings. This policy covers the following events ids - 5136, 5137, 5138, 5139, 5141. Note that the default policy does not cover User objects. For that a custom AuditRule need to be setup (See https://github.com/OTRF/Set-AuditRule)'\ndetection:\n    selection:\n        EventID: 5136\n        AttributeLDAPDisplayName: 'ntSecurityDescriptor'\n        AttributeValue|contains:\n            - '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2'\n            - '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2'\n            - '89e95b76-444d-4c62-991a-0facbeda640c'\n    filter_main_dns_object_class:\n        ObjectClass:\n            - 'dnsNode'\n            - 'dnsZoneScope'\n            - 'dnsZone'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - New Domain Controller computer account, check user SIDs within the value attribute of event 5136 and verify if it's a regular user or DC computer account.\nlevel: high\n"},{"path":"builtin\\security\\win_security_aadhealth_svc_agent_regkey_access.yml","content":"title: Azure AD Health Service Agents Registry Keys Access\nid: 1d2ab8ac-1a01-423b-9c39-001510eae8e8\nstatus: test\ndescription: |\n    This detection uses Windows security events to detect suspicious access attempts to the registry key values and sub-keys of Azure AD Health service agents (e.g AD FS).\n    Information from AD Health service agents can be used to potentially abuse some of the features provided by those services in the cloud (e.g. Federation).\n    This detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object: HKLM:\\SOFTWARE\\Microsoft\\ADHealthAgent.\n    Make sure you set the SACL to propagate to its sub-keys.\nreferences:\n    - https://o365blog.com/post/hybridhealthagent/\n    - https://github.com/OTRF/Set-AuditRule/blob/c3dec5443414231714d850565d364ca73475ade5/rules/registry/aad_connect_health_service_agent.yml\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC\ndate: 2021-08-26\nmodified: 2022-10-09\ntags:\n    - attack.discovery\n    - attack.t1012\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4656\n            - 4663\n        ObjectType: 'Key'\n        ObjectName: '\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\ADHealthAgent'\n    filter:\n        ProcessName|contains:\n            - 'Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe'\n            - 'Microsoft.Identity.Health.Adfs.InsightsService.exe'\n            - 'Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe'\n            - 'Microsoft.Identity.Health.Adfs.PshSurrogate.exe'\n            - 'Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\win_security_aadhealth_mon_agent_regkey_access.yml","content":"title: Azure AD Health Monitoring Agent Registry Keys Access\nid: ff151c33-45fa-475d-af4f-c2f93571f4fe\nstatus: test\ndescription: |\n    This detection uses Windows security events to detect suspicious access attempts to the registry key of Azure AD Health monitoring agent.\n    This detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object HKLM\\SOFTWARE\\Microsoft\\Microsoft Online\\Reporting\\MonitoringAgent.\nreferences:\n    - https://o365blog.com/post/hybridhealthagent/\n    - https://github.com/OTRF/Set-AuditRule/blob/c3dec5443414231714d850565d364ca73475ade5/rules/registry/aad_connect_health_monitoring_agent.yml\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC\ndate: 2021-08-26\nmodified: 2022-10-09\ntags:\n    - attack.discovery\n    - attack.t1012\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4656\n            - 4663\n        ObjectType: 'Key'\n        ObjectName: '\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Microsoft Online\\Reporting\\MonitoringAgent'\n    filter:\n        ProcessName|contains:\n            - 'Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe'\n            - 'Microsoft.Identity.Health.Adfs.InsightsService.exe'\n            - 'Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe'\n            - 'Microsoft.Identity.Health.Adfs.PshSurrogate.exe'\n            - 'Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\security\\object_access\\win_security_wfp_endpoint_agent_blocked.yml","content":"title: Windows Filtering Platform Blocked Connection From EDR Agent Binary\nid: bacf58c6-e199-4040-a94f-95dea0f1e45a\nstatus: test\ndescription: |\n    Detects a Windows Filtering Platform (WFP) blocked connection event involving common Endpoint Detection and Response (EDR) agents.\n    Adversaries may use WFP filters to prevent Endpoint Detection and Response (EDR) agents from reporting security events.\nreferences:\n    - https://github.com/netero1010/EDRSilencer\n    - https://github.com/amjcyber/EDRNoiseMaker\n    - https://ghoulsec.medium.com/misc-series-4-forensics-on-edrsilencer-events-428b20b3f983\nauthor: '@gott_cyber'\ndate: 2024-01-08\ntags:\n    - attack.defense-evasion\n    - attack.t1562\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Audit Filtering Platform Connection needs to be enabled'\ndetection:\n    selection:\n        EventID: 5157\n        Application|endswith:\n            - '\\AmSvc.exe' # Cybereason\n            - '\\cb.exe' # Carbon Black EDR\n            - '\\CETASvc.exe' # TrendMicro Apex One\n            - '\\CNTAoSMgr.exe' # TrendMicro Apex One\n            - '\\CrAmTray.exe' # Cybereason\n            - '\\CrsSvc.exe' # Cybereason\n            - '\\CSFalconContainer.exe' # CrowdStrike Falcon\n            - '\\CSFalconService.exe' # CrowdStrike Falcon\n            - '\\CybereasonAV.exe' # Cybereason\n            - '\\CylanceSvc.exe' # Cylance\n            - '\\cyserver.exe' # Palo Alto Networks Traps/Cortex XDR\n            - '\\CyveraService.exe' # Palo Alto Networks Traps/Cortex XDR\n            - '\\CyvrFsFlt.exe' # Palo Alto Networks Traps/Cortex XDR\n            - '\\EIConnector.exe' # ESET Inspect\n            - '\\elastic-agent.exe' # Elastic EDR\n            - '\\elastic-endpoint.exe' # Elastic EDR\n            - '\\EndpointBasecamp.exe' # TrendMicro Apex One\n            - '\\ExecutionPreventionSvc.exe' # Cybereason\n            - '\\filebeat.exe' # Elastic EDR\n            - '\\fortiedr.exe' # FortiEDR\n            - '\\hmpalert.exe' # Sophos EDR\n            - '\\hurukai.exe' # Harfanglab EDR\n            - '\\LogProcessorService.exe' # SentinelOne\n            - '\\mcsagent.exe' # Sophos EDR\n            - '\\mcsclient.exe' # Sophos EDR\n            - '\\MsMpEng.exe' # Microsoft Defender for Endpoint and Microsoft Defender Antivirus\n            - '\\MsSense.exe' # Microsoft Defender for Endpoint and Microsoft Defender Antivirus\n            - '\\Ntrtscan.exe' # TrendMicro Apex One\n            - '\\PccNTMon.exe' # TrendMicro Apex One\n            - '\\QualysAgent.exe' # Qualys EDR\n            - '\\RepMgr.exe' # Carbon Black Cloud\n            - '\\RepUtils.exe' # Carbon Black Cloud\n            - '\\RepUx.exe' # Carbon Black Cloud\n            - '\\RepWAV.exe' # Carbon Black Cloud\n            - '\\RepWSC.exe' # Carbon Black Cloud\n            - '\\sedservice.exe' # Sophos EDR\n            - '\\SenseCncProxy.exe' # Microsoft Defender for Endpoint and Microsoft Defender Antivirus\n            - '\\SenseIR.exe' # Microsoft Defender for Endpoint and Microsoft Defender Antivirus\n            - '\\SenseNdr.exe' # Microsoft Defender for Endpoint and Microsoft Defender Antivirus\n            - '\\SenseSampleUploader.exe' # Microsoft Defender for Endpoint and Microsoft Defender Antivirus\n            - '\\SentinelAgent.exe' # SentinelOne\n            - '\\SentinelAgentWorker.exe' # SentinelOne\n            - '\\SentinelBrowserNativeHost.exe' # SentinelOne\n            - '\\SentinelHelperService.exe' # SentinelOne\n            - '\\SentinelServiceHost.exe' # SentinelOne\n            - '\\SentinelStaticEngine.exe' # SentinelOne\n            - '\\SentinelStaticEngineScanner.exe' # SentinelOne\n            - '\\sfc.exe' # Cisco Secure Endpoint (Formerly Cisco AMP)\n            - '\\sophos ui.exe' # Sophos EDR\n            - '\\sophosfilescanner.exe' # Sophos EDR\n            - '\\sophosfs.exe' # Sophos EDR\n            - '\\sophoshealth.exe' # Sophos EDR\n            - '\\sophosips.exe' # Sophos EDR\n            - '\\sophosLivequeryservice.exe' # Sophos EDR\n            - '\\sophosnetfilter.exe' # Sophos EDR\n            - '\\sophosntpservice.exe' # Sophos EDR\n            - '\\sophososquery.exe' # Sophos EDR\n            - '\\sspservice.exe' # Sophos EDR\n            - '\\TaniumClient.exe' # Tanium\n            - '\\TaniumCX.exe' # Tanium\n            - '\\TaniumDetectEngine.exe' # Tanium\n            - '\\TMBMSRV.exe' # TrendMicro Apex One\n            - '\\TmCCSF.exe' # TrendMicro Apex One\n            - '\\TmListen.exe' # TrendMicro Apex One\n            - '\\TmWSCSvc.exe' # TrendMicro Apex One\n            - '\\Traps.exe' # Palo Alto Networks Traps/Cortex XDR\n            - '\\winlogbeat.exe' # Elastic EDR\n            - '\\WSCommunicator.exe' # TrendMicro Apex One\n            - '\\xagt.exe' # Trellix EDR\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\security\\account_management\\win_security_susp_wmi_login.yml","content":"title: Successful Account Login Via WMI\nid: 5af54681-df95-4c26-854f-2565e13cfab0\nstatus: stable\ndescription: Detects successful logon attempts performed with WMI\nreferences:\n    - Internal Research\nauthor: Thomas Patzke\ndate: 2019-12-04\nmodified: 2024-01-17\ntags:\n    - attack.execution\n    - attack.t1047\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        ProcessName|endswith: '\\WmiPrvSE.exe'\n    condition: selection\nfalsepositives:\n    - Monitoring tools\n    - Legitimate system administration\nlevel: low\n"},{"path":"builtin\\security\\account_management\\win_security_susp_rottenpotato.yml","content":"title: RottenPotato Like Attack Pattern\nid: 16f5d8ca-44bd-47c8-acbe-6fc95a16c12f\nstatus: test\ndescription: Detects logon events that have characteristics of events generated during an attack with RottenPotato and the like\nreferences:\n    - https://twitter.com/SBousseaden/status/1195284233729777665\nauthor: '@SBousseaden, Florian Roth'\ndate: 2019-11-15\nmodified: 2022-12-22\ntags:\n    - attack.collection\n    - attack.privilege-escalation\n    - attack.credential-access\n    - attack.t1557.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 3\n        TargetUserName: 'ANONYMOUS LOGON'\n        WorkstationName: '-'\n        IpAddress:\n            - '127.0.0.1'\n            - '::1'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\account_management\\win_security_susp_privesc_kerberos_relay_over_ldap.yml","content":"title: Potential Privilege Escalation via Local Kerberos Relay over LDAP\nid: 749c9f5e-b353-4b90-a9c1-05243357ca4b\nstatus: test\ndescription: |\n    Detects a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to localhost, and the target user SID is the built-in local Administrator account.\n    This may indicate an attempt to leverage a Kerberos relay attack variant that can be used to elevate privilege locally from a domain joined limited user to local System privileges.\nreferences:\n    - https://twitter.com/sbousseaden/status/1518976397364056071?s=12&t=qKO5eKHvWhAP19a50FTZ7g\n    - https://github.com/elastic/detection-rules/blob/5fe7833312031a4787e07893e27e4ea7a7665745/rules/_deprecated/privilege_escalation_krbrelayup_suspicious_logon.toml#L38\nauthor: Elastic, @SBousseaden\ndate: 2022-04-27\nmodified: 2024-08-13\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.credential-access\n    - attack.t1548\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 3\n        AuthenticationPackageName: 'Kerberos'\n        IpAddress: '127.0.0.1'\n        TargetUserSid|startswith: 'S-1-5-21-'\n        TargetUserSid|endswith: '-500'\n    filter_main_ip_null:\n        IpPort: '0'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\account_management\\win_security_susp_logon_newcredentials.yml","content":"title: Outgoing Logon with New Credentials\nid: def8b624-e08f-4ae1-8612-1ba21190da6b\nstatus: test\ndescription: Detects logon events that specify new credentials\nreferences:\n    - https://go.recordedfuture.com/hubfs/reports/mtp-2021-0914.pdf\nauthor: Max Altgelt (Nextron Systems)\ndate: 2022-04-06\ntags:\n    - attack.defense-evasion\n    - attack.lateral-movement\n    - attack.t1550\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 9\n    condition: selection\nfalsepositives:\n    - Legitimate remote administration activity\nlevel: low\n"},{"path":"builtin\\security\\account_management\\win_security_susp_failed_logon_source.yml","content":"title: Failed Logon From Public IP\nid: f88e112a-21aa-44bd-9b01-6ee2a2bbbed1\nstatus: test\ndescription: Detects a failed logon attempt from a public IP. A login from a public IP can indicate a misconfigured firewall or network boundary.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4625\nauthor: NVISO\ndate: 2020-05-06\nmodified: 2024-03-11\ntags:\n    - attack.privilege-escalation\n    - attack.defense-evasion\n    - attack.initial-access\n    - attack.persistence\n    - attack.t1078\n    - attack.t1190\n    - attack.t1133\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4625\n    filter_main_ip_unknown:\n        IpAddress|contains: '-'\n    filter_main_local_ranges:\n        IpAddress|cidr:\n            - '::1/128'  # IPv6 loopback\n            - '10.0.0.0/8'\n            - '127.0.0.0/8'\n            - '172.16.0.0/12'\n            - '192.168.0.0/16'\n            - '169.254.0.0/16'\n            - 'fc00::/7'  # IPv6 private addresses\n            - 'fe80::/10'  # IPv6 link-local addresses\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Legitimate logon attempts over the internet\n    - IPv4-to-IPv6 mapped IPs\nlevel: medium\n"},{"path":"builtin\\security\\account_management\\win_security_successful_external_remote_smb_login.yml","content":"title: External Remote SMB Logon from Public IP\nid: 78d5cab4-557e-454f-9fb9-a222bd0d5edc\nrelated:\n    - id: 259a9cdf-c4dd-4fa2-b243-2269e5ab18a2\n      type: derived\nstatus: test\ndescription: Detects successful logon from public IP address via SMB. This can indicate a publicly-exposed SMB port.\nreferences:\n    - https://www.inversecos.com/2020/04/successful-4624-anonymous-logons-to.html\n    - https://twitter.com/Purp1eW0lf/status/1616144561965002752\nauthor: Micah Babinski (@micahbabinski), Zach Mathis (@yamatosecurity)\ndate: 2023-01-19\nmodified: 2024-03-11\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.initial-access\n    - attack.credential-access\n    - attack.t1133\n    - attack.t1078\n    - attack.t1110\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 3\n    filter_main_local_ranges:\n        IpAddress|cidr:\n            - '::1/128'  # IPv6 loopback\n            - '10.0.0.0/8'\n            - '127.0.0.0/8'\n            - '172.16.0.0/12'\n            - '192.168.0.0/16'\n            - '169.254.0.0/16'\n            - 'fc00::/7'  # IPv6 private addresses\n            - 'fe80::/10'  # IPv6 link-local addresses\n    filter_main_empty:\n        IpAddress: '-'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Legitimate or intentional inbound connections from public IP addresses on the SMB port.\nlevel: high\n"},{"path":"builtin\\security\\account_management\\win_security_successful_external_remote_rdp_login.yml","content":"title: External Remote RDP Logon from Public IP\nid: 259a9cdf-c4dd-4fa2-b243-2269e5ab18a2\nrelated:\n    - id: 78d5cab4-557e-454f-9fb9-a222bd0d5edc\n      type: derived\nstatus: test\ndescription: Detects successful logon from public IP address via RDP. This can indicate a publicly-exposed RDP port.\nreferences:\n    - https://www.inversecos.com/2020/04/successful-4624-anonymous-logons-to.html\n    - https://twitter.com/Purp1eW0lf/status/1616144561965002752\nauthor: Micah Babinski (@micahbabinski), Zach Mathis (@yamatosecurity)\ndate: 2023-01-19\nmodified: 2024-03-11\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.initial-access\n    - attack.credential-access\n    - attack.t1133\n    - attack.t1078\n    - attack.t1110\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 10\n    filter_main_local_ranges:\n        IpAddress|cidr:\n            - '::1/128'  # IPv6 loopback\n            - '10.0.0.0/8'\n            - '127.0.0.0/8'\n            - '172.16.0.0/12'\n            - '192.168.0.0/16'\n            - '169.254.0.0/16'\n            - 'fc00::/7'  # IPv6 private addresses\n            - 'fe80::/10'  # IPv6 link-local addresses\n    filter_main_empty:\n        IpAddress: '-'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Legitimate or intentional inbound connections from public IP addresses on the RDP port.\nlevel: medium\n"},{"path":"builtin\\security\\account_management\\win_security_security_enabled_global_group_deleted.yml","content":"title: A Security-Enabled Global Group Was Deleted\nid: b237c54b-0f15-4612-a819-44b735e0de27\nrelated:\n    - id: 9cf01b6c-e723-4841-a868-6d7f8245ca6e\n      type: obsolete\nstatus: stable\ndescription: Detects activity when a security-enabled global group is deleted\nreferences:\n    - https://www.cisecurity.org/controls/cis-controls-list/\n    - https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-2-1.pdf\n    - https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf\n    - https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4730\n    - https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=634\nauthor: Alexandr Yampolskyi, SOC Prime\ndate: 2023-04-26\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4730 # A security-enabled global group was deleted\n            - 634 # Security Enabled Global Group Deleted\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"builtin\\security\\account_management\\win_security_rdp_localhost_login.yml","content":"title: RDP Login from Localhost\nid: 51e33403-2a37-4d66-a574-1fda1782cc31\nstatus: test\ndescription: RDP login with localhost source address may be a tunnelled login\nreferences:\n    - https://www.fireeye.com/blog/threat-research/2019/01/bypassing-network-restrictions-through-rdp-tunneling.html\nauthor: Thomas Patzke\ndate: 2019-01-28\nmodified: 2022-10-09\ntags:\n    - attack.lateral-movement\n    - car.2013-07-002\n    - attack.t1021.001\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 10\n        IpAddress:\n            - '::1'\n            - '127.0.0.1'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\security\\account_management\\win_security_pass_the_hash_2.yml","content":"title: Pass the Hash Activity 2\nid: 8eef149c-bd26-49f2-9e5a-9b00e3af499b\nstatus: stable\ndescription: Detects the attack technique pass the hash which is used to move laterally inside the network\nreferences:\n    - https://github.com/iadgov/Event-Forwarding-Guidance/tree/master/Events\n    - https://web.archive.org/web/20170909091934/https://blog.binarydefense.com/reliably-detecting-pass-the-hash-through-event-log-analysis\n    - https://blog.stealthbits.com/how-to-detect-pass-the-hash-attacks/\nauthor: Dave Kennedy, Jeff Warren (method) / David Vassallo (rule)\ndate: 2019-06-14\nmodified: 2022-10-05\ntags:\n    - attack.defense-evasion\n    - attack.lateral-movement\n    - attack.t1550.002\nlogsource:\n    product: windows\n    service: security\n    definition: The successful use of PtH for lateral movement between workstations would trigger event ID 4624\ndetection:\n    selection_logon3:\n        EventID: 4624\n        SubjectUserSid: 'S-1-0-0'\n        LogonType: 3\n        LogonProcessName: 'NtLmSsp'\n        KeyLength: 0\n    selection_logon9:\n        EventID: 4624\n        LogonType: 9\n        LogonProcessName: 'seclogo'\n    filter:\n        TargetUserName: 'ANONYMOUS LOGON'\n    condition: 1 of selection_* and not filter\nfalsepositives:\n    - Administrator activity\nlevel: medium\n"},{"path":"builtin\\security\\account_management\\win_security_overpass_the_hash.yml","content":"title: Successful Overpass the Hash Attempt\nid: 192a0330-c20b-4356-90b6-7b7049ae0b87\nstatus: test\ndescription: Detects successful logon with logon type 9 (NewCredentials) which matches the Overpass the Hash behavior of e.g Mimikatz's sekurlsa::pth module.\nreferences:\n    - https://web.archive.org/web/20220419045003/https://cyberwardog.blogspot.com/2017/04/chronicles-of-threat-hunter-hunting-for.html\nauthor: Roberto Rodriguez (source), Dominik Schaudel (rule)\ndate: 2018-02-12\nmodified: 2021-11-27\ntags:\n    - attack.defense-evasion\n    - attack.lateral-movement\n    - attack.s0002\n    - attack.t1550.002\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 9\n        LogonProcessName: seclogo\n        AuthenticationPackageName: Negotiate\n    condition: selection\nfalsepositives:\n    - Runas command-line tool using /netonly parameter\nlevel: high\n"},{"path":"builtin\\security\\account_management\\win_security_member_removed_security_enabled_global_group.yml","content":"title: A Member Was Removed From a Security-Enabled Global Group\nid: 02c39d30-02b5-45d2-b435-8aebfe5a8629\nrelated:\n    - id: 9cf01b6c-e723-4841-a868-6d7f8245ca6e\n      type: obsolete\nstatus: stable\ndescription: Detects activity when a member is removed from a security-enabled global group\nreferences:\n    - https://www.cisecurity.org/controls/cis-controls-list/\n    - https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-2-1.pdf\n    - https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf\n    - https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4729\n    - https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=633\nauthor: Alexandr Yampolskyi, SOC Prime\ndate: 2023-04-26\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 633 # Security Enabled Global Group Member Removed\n            - 4729 # A member was removed from a security-enabled global group\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"builtin\\security\\account_management\\win_security_member_added_security_enabled_global_group.yml","content":"title: A Member Was Added to a Security-Enabled Global Group\nid: c43c26be-2e87-46c7-8661-284588c5a53e\nrelated:\n    - id: 9cf01b6c-e723-4841-a868-6d7f8245ca6e\n      type: obsolete\nstatus: stable\ndescription: Detects activity when a member is added to a security-enabled global group\nreferences:\n    - https://www.cisecurity.org/controls/cis-controls-list/\n    - https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-2-1.pdf\n    - https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf\n    - https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4728\n    - https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=632\nauthor: Alexandr Yampolskyi, SOC Prime\ndate: 2023-04-26\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID:\n            - 4728 # A member was added to a security-enabled global group\n            - 632 # Security Enabled Global Group Member Added\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"builtin\\security\\account_management\\win_security_diagtrack_eop_default_login_username.yml","content":"title: DiagTrackEoP Default Login Username\nid: 2111118f-7e46-4fc8-974a-59fd8ec95196\nstatus: test\ndescription: Detects the default \"UserName\" used by the DiagTrackEoP POC\nreferences:\n    - https://github.com/Wh04m1001/DiagTrackEoP/blob/3a2fc99c9700623eb7dc7d4b5f314fd9ce5ef51f/main.cpp#L46\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-03\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 9\n        TargetOutboundUserName: 'thisisnotvaliduser'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: critical\n"},{"path":"builtin\\security\\account_management\\win_security_admin_rdp_login.yml","content":"title: Admin User Remote Logon\nid: 0f63e1ef-1eb9-4226-9d54-8927ca08520a\nstatus: test\ndescription: Detect remote login by Administrator user (depending on internal pattern).\nreferences:\n    - https://car.mitre.org/wiki/CAR-2016-04-005\nauthor: juju4\ndate: 2017-10-29\nmodified: 2022-10-09\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.lateral-movement\n    - attack.initial-access\n    - attack.t1078.001\n    - attack.t1078.002\n    - attack.t1078.003\n    - car.2016-04-005\nlogsource:\n    product: windows\n    service: security\n    definition: 'Requirements: Identifiable administrators usernames (pattern or special unique character. ex: \"Admin-*\"), internal policy mandating use only as secondary account'\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 10\n        AuthenticationPackageName: Negotiate\n        TargetUserName|startswith: 'Admin'\n    condition: selection\nfalsepositives:\n    - Legitimate administrative activity.\nlevel: low\n"},{"path":"builtin\\security\\account_management\\win_security_access_token_abuse.yml","content":"title: Potential Access Token Abuse\nid: 02f7c9c1-1ae8-4c6a-8add-04693807f92f\nstatus: test\ndescription: Detects potential token impersonation and theft. Example, when using \"DuplicateToken(Ex)\" and \"ImpersonateLoggedOnUser\" with the \"LOGON32_LOGON_NEW_CREDENTIALS flag\".\nreferences:\n    - https://www.elastic.co/fr/blog/how-attackers-abuse-access-token-manipulation\n    - https://www.manageengine.com/log-management/cyber-security/access-token-manipulation.html\nauthor: Michaela Adams, Zach Mathis\ndate: 2022-11-06\nmodified: 2023-04-26\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1134.001\n    - stp.4u\nlogsource:\n    product: windows\n    service: security\ndetection:\n    selection:\n        EventID: 4624\n        LogonType: 9\n        LogonProcessName: 'Advapi'\n        AuthenticationPackageName: 'Negotiate'\n        ImpersonationLevel: '%%1833' # Impersonation\n    condition: selection\nfalsepositives:\n    - Anti-Virus\nlevel: medium\n"},{"path":"builtin\\openssh\\win_sshd_openssh_server_listening_on_socket.yml","content":"title: OpenSSH Server Listening On Socket\nid: 3ce8e9a4-bc61-4c9b-8e69-d7e2492a8781\nstatus: test\ndescription: Detects scenarios where an attacker enables the OpenSSH server and server starts to listening on SSH socket.\nreferences:\n    - https://github.com/mdecrevoisier/EVTX-to-MITRE-Attack/tree/master/TA0008-Lateral%20Movement/T1021.004-Remote%20Service%20SSH\n    - https://winaero.com/enable-openssh-server-windows-10/\n    - https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse\n    - https://virtualizationreview.com/articles/2020/05/21/ssh-server-on-windows-10.aspx\n    - https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16\nauthor: mdecrevoisier\ndate: 2022-10-25\ntags:\n    - attack.lateral-movement\n    - attack.t1021.004\nlogsource:\n    product: windows\n    service: openssh\ndetection:\n    selection:\n        EventID: 4\n        process: sshd\n        payload|startswith: 'Server listening on '\n    condition: selection\nfalsepositives:\n    - Legitimate administrator activity\nlevel: medium\n"},{"path":"builtin\\ntlm\\win_susp_ntlm_rdp.yml","content":"title: Potential Remote Desktop Connection to Non-Domain Host\nid: ce5678bb-b9aa-4fb5-be4b-e57f686256ad\nstatus: test\ndescription: Detects logons using NTLM to hosts that are potentially not part of the domain.\nreferences:\n    - n/a\nauthor: James Pemberton\ndate: 2020-05-22\nmodified: 2021-11-27\ntags:\n    - attack.command-and-control\n    - attack.t1219.002\nlogsource:\n    product: windows\n    service: ntlm\n    definition: Requires events from Microsoft-Windows-NTLM/Operational\ndetection:\n    selection:\n        EventID: 8001\n        TargetName|startswith: 'TERMSRV'\n    condition: selection\nfields:\n    - Computer\n    - UserName\n    - DomainName\n    - TargetName\nfalsepositives:\n    - Host connections to valid domains, exclude these.\n    - Host connections not using host FQDN.\n    - Host connections to external legitimate domains.\nlevel: medium\n"},{"path":"builtin\\ntlm\\win_susp_ntlm_brute_force.yml","content":"title: NTLM Brute Force\nid: 9c8acf1a-cbf9-4db6-b63c-74baabe03e59\nstatus: test\ndescription: Detects common NTLM brute force device names\nreferences:\n    - https://www.varonis.com/blog/investigate-ntlm-brute-force\nauthor: Jerry Shockley '@jsh0x'\ndate: 2022-02-02\ntags:\n    - attack.credential-access\n    - attack.t1110\nlogsource:\n    product: windows\n    service: ntlm\n    definition: Requires events from Microsoft-Windows-NTLM/Operational\ndetection:\n    selection:\n        EventID: 8004\n    devicename:\n        WorkstationName:\n            - 'Rdesktop'\n            - 'Remmina'\n            - 'Freerdp'\n            - 'Windows7'\n            - 'Windows8'\n            - 'Windows2012'\n            - 'Windows2016'\n            - 'Windows2019'\n    condition: selection and devicename\nfalsepositives:\n    - Systems with names equal to the spoofed ones used by the brute force tools\nlevel: medium\n"},{"path":"builtin\\ntlm\\win_susp_ntlm_auth.yml","content":"title: NTLM Logon\nid: 98c3bcf1-56f2-49dc-9d8d-c66cf190238b\nstatus: test\ndescription: Detects logons using NTLM, which could be caused by a legacy source or attackers\nreferences:\n    - https://twitter.com/JohnLaTwC/status/1004895028995477505\nauthor: Florian Roth (Nextron Systems)\ndate: 2018-06-08\nmodified: 2024-07-22\ntags:\n    - attack.defense-evasion\n    - attack.lateral-movement\n    - attack.t1550.002\nlogsource:\n    product: windows\n    service: ntlm\n    definition: Requires events from Microsoft-Windows-NTLM/Operational\ndetection:\n    selection:\n        EventID: 8002\n    condition: selection\nfalsepositives:\n    - Legacy hosts\nlevel: low\n"},{"path":"builtin\\msexchange\\win_exchange_transportagent_failed.yml","content":"title: Failed MSExchange Transport Agent Installation\nid: c7d16cae-aaf3-42e5-9c1c-fb8553faa6fa\nstatus: test\ndescription: Detects a failed installation of a Exchange Transport Agent\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-persistence-via-microsoft-exchange-server-or-outlook?slide=8\nauthor: Tobias Michalski (Nextron Systems)\ndate: 2021-06-08\nmodified: 2022-07-12\ntags:\n    - attack.persistence\n    - attack.t1505.002\nlogsource:\n    service: msexchange-management\n    product: windows\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        EventID: 6\n        Data|contains: 'Install-TransportAgent'\n    condition: selection\nfields:\n    - AssemblyPath\nfalsepositives:\n    - Legitimate installations of exchange TransportAgents. AssemblyPath is a good indicator for this.\nlevel: high\n"},{"path":"builtin\\msexchange\\win_exchange_transportagent.yml","content":"title: MSExchange Transport Agent Installation - Builtin\nid: 4fe151c2-ecf9-4fae-95ae-b88ec9c2fca6\nrelated:\n    - id: 83809e84-4475-4b69-bc3e-4aad8568612f\n      type: derived\nstatus: test\ndescription: Detects the Installation of a Exchange Transport Agent\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-persistence-via-microsoft-exchange-server-or-outlook?slide=7\nauthor: Tobias Michalski (Nextron Systems)\ndate: 2021-06-08\nmodified: 2022-11-27\ntags:\n    - attack.persistence\n    - attack.t1505.002\nlogsource:\n    product: windows\n    service: msexchange-management\ndetection:\n    selection:\n        - 'Install-TransportAgent'\n    condition: selection\nfields:\n    - AssemblyPath\nfalsepositives:\n    - Legitimate installations of exchange TransportAgents. AssemblyPath is a good indicator for this.\nlevel: medium\n"},{"path":"builtin\\msexchange\\win_exchange_set_oabvirtualdirectory_externalurl.yml","content":"title: Exchange Set OabVirtualDirectory ExternalUrl Property\nid: 9db37458-4df2-46a5-95ab-307e7f29e675\nstatus: test\ndescription: Rule to detect an adversary setting OabVirtualDirectory External URL property to a script in Exchange Management log\nreferences:\n    - https://twitter.com/OTR_Community/status/1371053369071132675\nauthor: Jose Rodriguez @Cyb3rPandaH\ndate: 2021-03-15\nmodified: 2023-01-23\ntags:\n    - attack.persistence\n    - attack.t1505.003\nlogsource:\n    product: windows\n    service: msexchange-management\ndetection:\n    keywords:\n        '|all':\n            - 'Set-OabVirtualDirectory'\n            - 'ExternalUrl'\n            - 'Page_Load'\n            - 'script'\n    condition: keywords\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\msexchange\\win_exchange_proxyshell_remove_mailbox_export.yml","content":"title: Remove Exported Mailbox from Exchange Webserver\nid: 09570ae5-889e-43ea-aac0-0e1221fb3d95\nstatus: test\ndescription: Detects removal of an exported Exchange mailbox which could be to cover tracks from ProxyShell exploit\nreferences:\n    - https://github.com/rapid7/metasploit-framework/blob/1416b5776d963f21b7b5b45d19f3e961201e0aed/modules/exploits/windows/http/exchange_proxyshell_rce.rb#L430\nauthor: Christian Burkard (Nextron Systems)\ndate: 2021-08-27\nmodified: 2023-01-23\ntags:\n    - attack.defense-evasion\n    - attack.t1070\nlogsource:\n    service: msexchange-management\n    product: windows\ndetection:\n    keywords:\n        '|all':\n            - 'Remove-MailboxExportRequest'\n            - ' -Identity '\n            - ' -Confirm \"False\"'\n    condition: keywords\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\msexchange\\win_exchange_proxyshell_mailbox_export.yml","content":"title: Mailbox Export to Exchange Webserver\nid: 516376b4-05cd-4122-bae0-ad7641c38d48\nstatus: test\ndescription: Detects a successful export of an Exchange mailbox to untypical directory or with aspx name suffix which can be used to place a webshell or the needed role assignment for it\nreferences:\n    - https://blog.orange.tw/2021/08/proxylogon-a-new-attack-surface-on-ms-exchange-part-1.html\nauthor: Florian Roth (Nextron Systems), Rich Warren, Christian Burkard (Nextron Systems)\ndate: 2021-08-09\nmodified: 2023-04-30\ntags:\n    - attack.persistence\n    - attack.t1505.003\nlogsource:\n    service: msexchange-management\n    product: windows\ndetection:\n    export_command:\n        '|all':\n            - 'New-MailboxExportRequest'\n            - ' -Mailbox '\n    export_params:\n        - '-FilePath \"\\\\\\\\' # We care about any share location.\n        - '.aspx'\n    role_assignment:\n        '|all':\n            - 'New-ManagementRoleAssignment'\n            - ' -Role \"Mailbox Import Export\"'\n            - ' -User '\n    condition: (export_command and export_params) or role_assignment\nfalsepositives:\n    - Unlikely\nlevel: critical\n"},{"path":"builtin\\msexchange\\win_exchange_proxyshell_certificate_generation.yml","content":"title: Certificate Request Export to Exchange Webserver\nid: b7bc7038-638b-4ffd-880c-292c692209ef\nstatus: test\ndescription: Detects a write of an Exchange CSR to an untypical directory or with aspx name suffix which can be used to place a webshell\nreferences:\n    - https://twitter.com/GossiTheDog/status/1429175908905127938\nauthor: Max Altgelt (Nextron Systems)\ndate: 2021-08-23\nmodified: 2023-01-23\ntags:\n    - attack.persistence\n    - attack.t1505.003\nlogsource:\n    service: msexchange-management\n    product: windows\ndetection:\n    keywords_export_command:\n        '|all':\n            - 'New-ExchangeCertificate'\n            - ' -GenerateRequest'\n            - ' -BinaryEncoded'\n            - ' -RequestFile'\n    keywords_export_params:\n        - '\\\\\\\\localhost\\\\C$'\n        - '\\\\\\\\127.0.0.1\\\\C$'\n        - 'C:\\\\inetpub'\n        - '.aspx'\n    condition: keywords_export_command and keywords_export_params\nfalsepositives:\n    - Unlikely\nlevel: critical\n"},{"path":"builtin\\msexchange\\win_exchange_proxylogon_oabvirtualdir.yml","content":"title: ProxyLogon MSExchange OabVirtualDirectory\nid: 550d3350-bb8a-4ff3-9533-2ba533f4a1c0\nstatus: test\ndescription: Detects specific patterns found after a successful ProxyLogon exploitation in relation to a Commandlet invocation of Set-OabVirtualDirectory\nreferences:\n    - https://bi-zone.medium.com/hunting-down-ms-exchange-attacks-part-1-proxylogon-cve-2021-26855-26858-27065-26857-6e885c5f197c\nauthor: Florian Roth (Nextron Systems)\ndate: 2021-08-09\nmodified: 2023-01-23\ntags:\n    - attack.t1587.001\n    - attack.resource-development\nlogsource:\n    product: windows\n    service: msexchange-management\ndetection:\n    keywords_cmdlet:\n        '|all':\n            - 'OabVirtualDirectory'\n            - ' -ExternalUrl '\n    keywords_params:\n        - 'eval(request'\n        - 'http://f/<script'\n        - '\"unsafe\"};'\n        - 'function Page_Load()'\n    condition: keywords_cmdlet and keywords_params\nfalsepositives:\n    - Unlikely\nlevel: critical\n"},{"path":"builtin\\lsa_server\\win_lsa_server_normal_user_admin.yml","content":"title: Standard User In High Privileged Group\nid: 7ac407cc-0f48-4328-aede-de1d2e6fef41\nstatus: test\ndescription: Detect standard users login that are part of high privileged groups such as the Administrator group\nreferences:\n    - https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers\n    - https://learn.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/7a806a148b3d9d381193d4a80356016e6e8b1ee8/ETWProvidersManifests/Windows11/22H2/W11_22H2_Pro_20221220_22621.963/WEPExplorer/LsaSrv.xml\nauthor: frack113\ndate: 2023-01-13\nmodified: 2023-05-05\ntags:\n    - attack.credential-access\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: lsa-server\n    definition: 'Requirements: Microsoft-Windows-LSA/Operational (199FE037-2B82-40A9-82AC-E1D46C792B99) Event Log must be enabled and collected in order to use this rule.'\ndetection:\n    selection:\n        EventID: 300\n        TargetUserSid|startswith: 'S-1-5-21-' # Standard user\n        SidList|contains:\n            - 'S-1-5-32-544'    # Local admin\n            - '-500}'           # Domain admin\n            - '-518}'           # Schema admin\n            - '-519}'           # Enterprise admin\n    filter_main_admin:\n        TargetUserSid|endswith:\n            - '-500'           # Domain admin\n            - '-518'           # Schema admin\n            - '-519'           # Enterprise admin\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Standard domain users who are part of the administrator group.\n      These users shouldn't have these right. But in the case where it's necessary. They should be filtered out using the \"TargetUserName\" field\nlevel: medium\n"},{"path":"builtin\\ldap\\win_ldap_recon.yml","content":"title: Potential Active Directory Reconnaissance/Enumeration Via LDAP\nid: 31d68132-4038-47c7-8f8e-635a39a7c174\nstatus: test\ndescription: Detects potential Active Directory enumeration via LDAP\nreferences:\n    - https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/hunting-for-reconnaissance-activities-using-ldap-search-filters/ba-p/824726\n    - https://github.com/PowerShellMafia/PowerSploit/blob/d943001a7defb5e0d1657085a77a0e78609be58f/Recon/PowerView.ps1\n    - https://github.com/BloodHoundAD/SharpHound3/blob/7d96b991b1887ff50349ce59c80980bc0d95c86a/SharpHound3/LdapBuilder.cs\n    - https://medium.com/falconforce/falconfriday-detecting-active-directory-data-collection-0xff21-c22d1a57494c\n    - https://github.com/fox-it/BloodHound.py/blob/d65eb614831cd30f26028ccb072f5e77ca287e0b/bloodhound/ad/domain.py#L427\n    - https://ipurple.team/2024/07/15/sharphound-detection/\nauthor: Adeem Mawani\ndate: 2021-06-22\nmodified: 2025-07-04\ntags:\n    - attack.discovery\n    - attack.t1069.002\n    - attack.t1087.002\n    - attack.t1482\nlogsource:\n    product: windows\n    service: ldap\n    definition: 'Requirements: Microsoft-Windows-LDAP-Client/Debug ETW logging'\ndetection:\n    generic_search:\n        EventID: 30\n        SearchFilter|contains:\n            - '(groupType:1.2.840.113556.1.4.803:=2147483648)'\n            - '(groupType:1.2.840.113556.1.4.803:=2147483656)'\n            - '(groupType:1.2.840.113556.1.4.803:=2147483652)'\n            - '(groupType:1.2.840.113556.1.4.803:=2147483650)'\n            - '(sAMAccountType=805306369)'\n            - '(sAMAccountType=805306368)'\n            - '(sAMAccountType=536870913)'\n            - '(sAMAccountType=536870912)'\n            - '(sAMAccountType=268435457)'\n            - '(sAMAccountType=268435456)'\n            - '(objectCategory=groupPolicyContainer)'\n            - '(objectCategory=organizationalUnit)'\n            # - '(objectCategory=Computer)' Prone to false positives\n            - '(objectCategory=nTDSDSA)'\n            - '(objectCategory=server)'\n            - '(objectCategory=domain)'\n            - '(objectCategory=person)'\n            - '(objectCategory=group)'\n            - '(objectCategory=user)'\n            - '(objectClass=trustedDomain)'\n            - '(objectClass=computer)'\n            - '(objectClass=server)'\n            - '(objectClass=group)'\n            - '(objectClass=user)'\n            - '(primaryGroupID=521)'\n            - '(primaryGroupID=516)'\n            - '(primaryGroupID=515)'\n            - '(primaryGroupID=512)'\n            - 'Domain Admins'\n            - 'objectGUID=\\*'\n            - '(schemaIDGUID=\\*)'\n            - 'admincount=1'\n    distinguished_name_enumeration:\n        EventID: 30\n        SearchFilter: '(objectclass=\\*)'\n        DistinguishedName|contains:\n            - 'CN=Domain Admins'\n            - 'CN=Enterprise Admins'\n            - 'CN=Group Policy Creator Owners'\n    suspicious_flag:\n        EventID: 30\n        SearchFilter|contains:\n            - '(userAccountControl:1.2.840.113556.1.4.803:=4194304)'\n            - '(userAccountControl:1.2.840.113556.1.4.803:=2097152)'\n            - '!(userAccountControl:1.2.840.113556.1.4.803:=1048574)'\n            - '(userAccountControl:1.2.840.113556.1.4.803:=524288)'\n            - '(userAccountControl:1.2.840.113556.1.4.803:=65536)'\n            - '(userAccountControl:1.2.840.113556.1.4.803:=8192)'\n            - '(userAccountControl:1.2.840.113556.1.4.803:=544)'\n            - '!(UserAccountControl:1.2.840.113556.1.4.803:=2)'\n            - 'msDS-AllowedToActOnBehalfOfOtherIdentity'\n            - 'msDS-AllowedToDelegateTo'\n            - 'msDS-GroupManagedServiceAccount'\n            - '(accountExpires=9223372036854775807)'\n            - '(accountExpires=0)'\n            - '(adminCount=1)'\n            - 'ms-MCS-AdmPwd'\n    narrow_down_filter:\n        EventID: 30\n        SearchFilter|contains:\n            - '(domainSid=*)'\n            - '(objectSid=*)'\n    condition: (generic_search and not narrow_down_filter) or suspicious_flag or distinguished_name_enumeration\nlevel: medium\n"},{"path":"builtin\\iis-configuration\\win_iis_module_removed.yml","content":"title: Previously Installed IIS Module Was Removed\nid: 9e1a1fdf-ee58-40ce-8e15-b66ca5a80e1f\nstatus: test\ndescription: Detects the removal of a previously installed IIS module.\nreferences:\n    - https://learn.microsoft.com/en-us/iis/manage/provisioning-and-managing-iis/configure-logging-in-iis\n    - https://www.microsoft.com/en-us/security/blog/2022/12/12/iis-modules-the-evolution-of-web-shells-and-how-to-detect-them/\n    - https://www.microsoft.com/en-us/security/blog/2022/07/26/malicious-iis-extensions-quietly-open-persistent-backdoors-into-servers/\n    - https://learn.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview\nauthor: Nasreddine Bencherchali\ndate: 2024-10-06\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1562.002\n    - attack.t1505.004\nlogsource:\n    product: windows\n    service: iis-configuration\ndetection:\n    selection:\n        EventID: 29\n        Configuration|contains: '/system.webServer/modules/remove'\n    condition: selection\nfalsepositives:\n    - Legitimate administrator activity\n# Note: Upgrade after an initial baseline\nlevel: low\n"},{"path":"builtin\\iis-configuration\\win_iis_module_added.yml","content":"title: New Module Module Added To IIS Server\nid: dd857d3e-0c6e-457b-9b48-e82ae7f86bd7\nstatus: test\ndescription: Detects the addition of a new module to an IIS server.\nreferences:\n    - https://learn.microsoft.com/en-us/iis/manage/provisioning-and-managing-iis/configure-logging-in-iis\n    - https://www.microsoft.com/en-us/security/blog/2022/12/12/iis-modules-the-evolution-of-web-shells-and-how-to-detect-them/\n    - https://www.microsoft.com/en-us/security/blog/2022/07/26/malicious-iis-extensions-quietly-open-persistent-backdoors-into-servers/\n    - https://learn.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview\nauthor: frack113\ndate: 2024-10-06\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1562.002\n    - attack.t1505.004\nlogsource:\n    product: windows\n    service: iis-configuration\ndetection:\n    selection:\n        EventID: 29\n        Configuration|contains: '/system.webServer/modules/add'\n    filter_main_builtin:\n        NewValue:\n            - 'AnonymousAuthenticationModule'\n            - 'CustomErrorModule'\n            - 'DefaultDocumentModule'\n            - 'DirectoryListingModule'\n            - 'FileCacheModule'\n            - 'HttpCacheModule'\n            - 'HttpLoggingModule'\n            - 'ProtocolSupportModule'\n            - 'RequestFilteringModule'\n            - 'StaticCompressionModule'\n            - 'StaticFileModule'\n            - 'TokenCacheModule'\n            - 'UriCacheModule'\n    filter_main_remove:\n        NewValue: ''\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Legitimate administrator activity\nlevel: medium\n"},{"path":"builtin\\iis-configuration\\win_iis_logging_http_disabled.yml","content":"title: HTTP Logging Disabled On IIS Server\nid: e8ebd53a-30c2-45bd-81bb-74befba07bdb\nstatus: test\ndescription: Detects changes to of the IIS server configuration in order to disable HTTP logging for successful requests.\nreferences:\n    - https://learn.microsoft.com/en-us/iis/manage/provisioning-and-managing-iis/configure-logging-in-iis\n    - https://www.microsoft.com/en-us/security/blog/2022/12/12/iis-modules-the-evolution-of-web-shells-and-how-to-detect-them/\n    - https://learn.microsoft.com/en-us/iis/configuration/system.webserver/httplogging\nauthor: frack113\ndate: 2024-10-06\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1562.002\n    - attack.t1505.004\nlogsource:\n    product: windows\n    service: iis-configuration\ndetection:\n    selection:\n        EventID: 29\n        Configuration: '/system.webServer/httpLogging/@dontLog'\n        NewValue: 'true'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\iis-configuration\\win_iis_logging_etw_disabled.yml","content":"title: ETW Logging/Processing Option Disabled On IIS Server\nid: a5b40a90-baf5-4bf7-a6f7-373494881d22\nstatus: test\ndescription: Detects changes to of the IIS server configuration in order to disable/remove the ETW logging/processing option.\nreferences:\n    - https://learn.microsoft.com/en-us/iis/manage/provisioning-and-managing-iis/configure-logging-in-iis\n    - https://www.microsoft.com/en-us/security/blog/2022/12/12/iis-modules-the-evolution-of-web-shells-and-how-to-detect-them/\n    - https://learn.microsoft.com/en-us/iis/configuration/system.applicationhost/sites/sitedefaults/logfile/\nauthor: frack113, Nasreddine Bencherchali\ndate: 2024-10-06\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1562.002\n    - attack.t1505.004\nlogsource:\n    product: windows\n    service: iis-configuration\ndetection:\n    selection:\n        EventID: 29\n        Configuration|endswith: '@logTargetW3C'\n        OldValue|contains: 'ETW'\n    filter_main_etw_added:\n        NewValue|contains: 'ETW'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Legitimate administrator activity\nlevel: medium\n"},{"path":"builtin\\firewall_as\\win_firewall_as_setting_change.yml","content":"title: Windows Firewall Settings Have Been Changed\nid: 00bb5bd5-1379-4fcf-a965-a5b6f7478064\nstatus: test\ndescription: Detects activity when the settings of the Windows firewall have been changed\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364427(v=ws.10)\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-02-19\nmodified: 2023-04-21\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    service: firewall-as\ndetection:\n    selection:\n        EventID:\n            - 2002 # A Windows Defender Firewall setting has changed.\n            - 2083 # A Windows Defender Firewall setting has changed. (Windows 11)\n            - 2003 # A Windows Firewall setting in the profile has changed\n            - 2082 # A Windows Defender Firewall setting in the %1 profile has changed. (Windows 11)\n            - 2008  # Windows Firewall Group Policy settings have changed. The new settings have been applied\n            # - 2010  # Network profile changed on an interface.\n    condition: selection\nlevel: low\n"},{"path":"builtin\\firewall_as\\win_firewall_as_reset_config.yml","content":"title: Windows Defender Firewall Has Been Reset To Its Default Configuration\nid: 04b60639-39c0-412a-9fbe-e82499c881a3\nstatus: test\ndescription: Detects activity when Windows Defender Firewall has been reset to its default configuration\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364427(v=ws.10)\nauthor: frack113\ndate: 2022-02-19\nmodified: 2023-04-21\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    service: firewall-as\ndetection:\n    selection:\n        EventID:\n            - 2032 # Windows Defender Firewall has been reset to its default configuration\n            - 2060 # Windows Defender Firewall has been reset to its default configuration. (Windows 11)\n    condition: selection\nlevel: low\n"},{"path":"builtin\\firewall_as\\win_firewall_as_failed_load_gpo.yml","content":"title: The Windows Defender Firewall Service Failed To Load Group Policy\nid: 7ec15688-fd24-4177-ba43-1a950537ee39\nstatus: test\ndescription: Detects activity when The Windows Defender Firewall service failed to load Group Policy\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364427(v=ws.10)\nauthor: frack113\ndate: 2022-02-19\nmodified: 2023-01-17\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    service: firewall-as\ndetection:\n    selection:\n        EventID: 2009 # The Windows Defender Firewall service failed to load Group Policy\n    condition: selection\nlevel: low\n"},{"path":"builtin\\firewall_as\\win_firewall_as_delete_rule.yml","content":"title: A Rule Has Been Deleted From The Windows Firewall Exception List\nid: c187c075-bb3e-4c62-b4fa-beae0ffc211f\nstatus: test\ndescription: Detects when a single rules or all of the rules have been deleted from the Windows Defender Firewall\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364427(v=ws.10)\nauthor: frack113\ndate: 2022-02-19\nmodified: 2024-08-29\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    service: firewall-as\ndetection:\n    selection:\n        EventID:\n            - 2006 # A rule has been deleted in the Windows Defender Firewall exception list\n            - 2052 # A rule has been deleted in the Windows Defender Firewall exception list. (Windows 11)\n    filter_main_generic:\n        ModifyingApplication|startswith:\n            - 'C:\\Program Files (x86)\\'\n            - 'C:\\Program Files\\'\n            - 'C:\\Windows\\WinSxS\\'\n    filter_main_svchost:\n        ModifyingApplication: 'C:\\Windows\\System32\\svchost.exe'\n    filter_optional_msmpeng:\n        ModifyingApplication|startswith: 'C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\'\n        ModifyingApplication|endswith: '\\MsMpEng.exe'\n    filter_main_null:\n        ModifyingApplication: null\n    filter_main_empty:\n        ModifyingApplication: ''\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nlevel: medium\n"},{"path":"builtin\\firewall_as\\win_firewall_as_delete_all_rules.yml","content":"title: All Rules Have Been Deleted From The Windows Firewall Configuration\nid: 79609c82-a488-426e-abcf-9f341a39365d\nstatus: test\ndescription: Detects when a all the rules have been deleted from the Windows Defender Firewall configuration\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364427(v=ws.10)\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-17\nmodified: 2024-01-22\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    service: firewall-as\ndetection:\n    selection:\n        EventID:\n            - 2033 # All rules have been deleted from the Windows Defender Firewall configuration on this computer\n            - 2059 # All rules have been deleted from the Windows Defender Firewall configuration on this computer. (Windows 11)\n    filter_main_svchost:\n        ModifyingApplication|endswith: ':\\Windows\\System32\\svchost.exe'\n    filter_optional_msmpeng:\n        ModifyingApplication|contains|all:\n            - ':\\ProgramData\\Microsoft\\Windows Defender\\Platform\\'\n            - '\\MsMpEng.exe'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nlevel: high\n"},{"path":"builtin\\firewall_as\\win_firewall_as_add_rule_wmiprvse.yml","content":"title: New Firewall Rule Added In Windows Firewall Exception List Via WmiPrvSE.EXE\nid: eca81e8d-09e1-4d04-8614-c91f44fd0519\nstatus: test\ndescription: |\n    Detects the addition of a new \"Allow\" firewall rule by the WMI process (WmiPrvSE.EXE).\n    This can occur if an attacker leverages PowerShell cmdlets such as \"New-NetFirewallRule\", or directly uses WMI CIM classes such as \"MSFT_NetFirewallRule\".\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1562.004/T1562.004.md#atomic-test-24---set-a-firewall-rule-using-new-netfirewallrule\n    - https://malware.news/t/the-rhysida-ransomware-activity-analysis-and-ties-to-vice-society/72170\n    - https://cybersecuritynews.com/rhysida-ransomware-attacking-windows/\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2024-05-10\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    service: firewall-as\ndetection:\n    selection:\n        EventID:\n            - 2004 # A rule has been added to the Windows Defender Firewall exception list\n            - 2071 # A rule has been added to the Windows Defender Firewall exception list. (Windows 11)\n            - 2097\n        Action: 3 # Allow\n        ModifyingApplication|endswith: ':\\Windows\\System32\\wbem\\WmiPrvSE.exe'\n    condition: selection\nfalsepositives:\n    - Administrator scripts or activity.\nlevel: medium\n"},{"path":"builtin\\firewall_as\\win_firewall_as_add_rule_susp_folder.yml","content":"title: New Firewall Rule Added In Windows Firewall Exception List For Potential Suspicious Application\nid: 9e2575e7-2cb9-4da1-adc8-ed94221dca5e\nrelated:\n    - id: cde0a575-7d3d-4a49-9817-b8004a7bf105\n      type: derived\nstatus: test\ndescription: Detects the addition of a new rule to the Windows Firewall exception list for an application located in a potentially suspicious location.\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364427(v=ws.10)\n    - https://app.any.run/tasks/7123e948-c91e-49e0-a813-00e8d72ab393/#\nauthor: frack113\ndate: 2023-02-26\nmodified: 2024-05-10\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    service: firewall-as\ndetection:\n    selection:\n        EventID:\n            - 2004 # A rule has been added to the Windows Defender Firewall exception list. (Windows 10)\n            - 2071 # A rule has been added to the Windows Defender Firewall exception list. (Windows 11)\n            - 2097\n        ApplicationPath|contains:\n            - ':\\PerfLogs\\'\n            - ':\\Temp\\'\n            - ':\\Tmp\\'\n            - ':\\Users\\Public\\'\n            - ':\\Windows\\Tasks\\'\n            - ':\\Windows\\Temp\\'\n            - '\\AppData\\Local\\Temp\\'\n    filter_main_block:\n        Action: 2 # Block\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\firewall_as\\win_firewall_as_add_rule.yml","content":"title: Uncommon New Firewall Rule Added In Windows Firewall Exception List\nid: cde0a575-7d3d-4a49-9817-b8004a7bf105\nstatus: test\ndescription: Detects when a rule has been added to the Windows Firewall exception list\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364427(v=ws.10)\nauthor: frack113\ndate: 2022-02-19\nmodified: 2025-10-08\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    service: firewall-as\ndetection:\n    selection:\n        EventID:\n            - 2004 # A rule has been added to the Windows Defender Firewall exception list\n            - 2071 # A rule has been added to the Windows Defender Firewall exception list. (Windows 11)\n            - 2097\n    filter_main_block:\n        Action: 2 # Block\n    filter_main_generic:\n        ApplicationPath|startswith:\n            - 'C:\\Program Files (x86)\\'\n            - 'C:\\Program Files\\'\n            - 'C:\\Windows\\System32\\'\n            - 'C:\\Windows\\SysWOW64\\'\n            - 'C:\\Windows\\WinSxS\\'\n    filter_main_covered_paths:\n        # This filter is added to avoid duplicate alerting from 9e2575e7-2cb9-4da1-adc8-ed94221dca5e\n        ApplicationPath|contains:\n            - 'C:\\PerfLogs\\'\n            - 'C:\\Temp\\'\n            - 'C:\\Tmp\\'\n            - 'C:\\Users\\Public\\'\n            - 'C:\\Windows\\Tasks\\'\n            - 'C:\\Windows\\Temp\\'\n            - '\\AppData\\Local\\Temp\\'\n    filter_main_system_dllhost:\n        ApplicationPath: 'System'\n        ModifyingApplication: 'C:\\Windows\\System32\\dllhost.exe'\n    filter_main_tiworker:\n        ModifyingApplication|startswith: 'C:\\Windows\\WinSxS\\'\n        ModifyingApplication|endswith: '\\TiWorker.exe'\n    filter_main_null:\n        ApplicationPath: null\n    filter_optional_no_path:\n        # This filter filters a lot of FPs related to Windows Services\n        ModifyingApplication:\n            - 'C:\\Windows\\System32\\svchost.exe'\n            - 'C:\\Windows\\System32\\dllhost.exe'\n        ApplicationPath: ''\n    filter_optional_msmpeng:\n        - ModifyingApplication|startswith:\n              - 'C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\'\n              - 'C:\\Program Files\\Windows Defender\\'\n          ModifyingApplication|endswith: '\\MsMpEng.exe'\n        - ApplicationPath|startswith:\n              - 'C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\'\n              - 'C:\\Program Files\\Windows Defender\\'\n          ApplicationPath|endswith: '\\MsMpEng.exe'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nlevel: medium\n"},{"path":"builtin\\driverframeworks\\win_usb_device_plugged.yml","content":"title: USB Device Plugged\nid: 1a4bd6e3-4c6e-405d-a9a3-53a116e341d4\nstatus: test\ndescription: Detects plugged/unplugged USB devices\nreferences:\n    - https://df-stream.com/2014/01/the-windows-7-event-log-and-usb-device/\n    - https://www.techrepublic.com/article/how-to-track-down-usb-flash-drive-usage-in-windows-10s-event-viewer/\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-11-09\nmodified: 2021-11-30\ntags:\n    - attack.initial-access\n    - attack.t1200\nlogsource:\n    product: windows\n    service: driver-framework\n    definition: 'Requires enabling and collection of the Microsoft-Windows-DriverFrameworks-UserMode/Operational eventlog'\ndetection:\n    selection:\n        EventID:\n            - 2003  # Loading drivers\n            - 2100  # Pnp or power management\n            - 2102  # Pnp or power management\n    condition: selection\nfalsepositives:\n    - Legitimate administrative activity\nlevel: low\n"},{"path":"builtin\\dns_server\\win_dns_server_susp_server_level_plugin_dll.yml","content":"title: DNS Server Error Failed Loading the ServerLevelPluginDLL\nid: cbe51394-cd93-4473-b555-edf0144952d9\nrelated:\n    - id: e61e8a88-59a9-451c-874e-70fcc9740d67\n      type: derived\n    - id: f63b56ee-3f79-4b8a-97fb-5c48007e8573\n      type: derived\nstatus: test\ndescription: Detects a DNS server error in which a specified plugin DLL (in registry) could not be loaded\nreferences:\n    - https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83\n    - https://technet.microsoft.com/en-us/library/cc735829(v=ws.10).aspx\n    - https://twitter.com/gentilkiwi/status/861641945944391680\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-05-08\nmodified: 2023-02-05\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.t1574.001\nlogsource:\n    product: windows\n    service: dns-server\ndetection:\n    selection:\n        EventID:\n            - 150\n            - 770\n            - 771\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\dns_server\\win_dns_server_failed_dns_zone_transfer.yml","content":"title: Failed DNS Zone Transfer\nid: 6d444368-6da1-43fe-b2fc-44202430480e\nstatus: test\ndescription: Detects when a DNS zone transfer failed.\nreferences:\n    - https://kb.eventtracker.com/evtpass/evtpages/EventId_6004_Microsoft-Windows-DNS-Server-Service_65410.asp\nauthor: Zach Mathis\ndate: 2023-05-24\ntags:\n    - attack.reconnaissance\n    - attack.t1590.002\nlogsource:\n    product: windows\n    service: dns-server\ndetection:\n    selection:\n        EventID: 6004 # The DNS server received a zone transfer request from %1 for a non-existent or non-authoritative zone %2.\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: medium\n"},{"path":"builtin\\dns_client\\win_dns_client_ufile_io.yml","content":"title: DNS Query To Ufile.io - DNS Client\nid: 090ffaad-c01a-4879-850c-6d57da98452d\nrelated:\n    - id: 1cbbeaaf-3c8c-4e4c-9d72-49485b6a176b\n      type: similar\nstatus: test\ndescription: Detects DNS queries to \"ufile.io\", which was seen abused by malware and threat actors as a method for data exfiltration\nreferences:\n    - https://thedfirreport.com/2021/12/13/diavol-ransomware/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-16\nmodified: 2023-09-18\ntags:\n    - attack.exfiltration\n    - attack.t1567.002\nlogsource:\n    product: windows\n    service: dns-client\n    definition: 'Requirements: Microsoft-Windows-DNS Client Events/Operational Event Log must be enabled/collected in order to receive the events.'\ndetection:\n    selection:\n        EventID: 3008\n        QueryName|contains: 'ufile.io'\n    condition: selection\nfalsepositives:\n    - DNS queries for \"ufile\" are not malicious by nature necessarily. Investigate the source to determine the necessary actions to take\nlevel: low\n"},{"path":"builtin\\dns_client\\win_dns_client_tor_onion.yml","content":"title: Query Tor Onion Address - DNS Client\nid: 8384bd26-bde6-4da9-8e5d-4174a7a47ca2\nrelated:\n    - id: b55ca2a3-7cff-4dda-8bdd-c7bfa63bf544\n      type: similar\n    - id: a8322756-015c-42e7-afb1-436e85ed3ff5\n      type: similar\nstatus: test\ndescription: Detects DNS resolution of an .onion address related to Tor routing networks\nreferences:\n    - https://www.logpoint.com/en/blog/detecting-tor-use-with-logpoint/\n    - https://github.com/Azure/Azure-Sentinel/blob/f99542b94afe0ad2f19a82cc08262e7ac8e1428e/Detections/ASimDNS/imDNS_TorProxies.yaml\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-02-20\nmodified: 2025-09-12\ntags:\n    - attack.command-and-control\n    - attack.t1090.003\nlogsource:\n    product: windows\n    service: dns-client\n    definition: 'Requirements: Microsoft-Windows-DNS Client Events/Operational Event Log must be enabled/collected in order to receive the events.'\ndetection:\n    selection:\n        EventID: 3008\n        QueryName|endswith:\n            - '.hiddenservice.net'\n            - '.onion.ca'\n            - '.onion.cab'\n            - '.onion.casa'\n            - '.onion.city'\n            - '.onion.direct'\n            - '.onion.dog'\n            - '.onion.glass'\n            - '.onion.gq'\n            - '.onion.guide'\n            - '.onion.in.net'\n            - '.onion.ink'\n            - '.onion.it'\n            - '.onion.link'\n            - '.onion.lt'\n            - '.onion.lu'\n            - '.onion.ly'\n            - '.onion.mn'\n            - '.onion.network'\n            - '.onion.nu'\n            - '.onion.pet'\n            - '.onion.plus'\n            - '.onion.pt'\n            - '.onion.pw'\n            - '.onion.rip'\n            - '.onion.sh'\n            - '.onion.si'\n            - '.onion.to'\n            - '.onion.top'\n            - '.onion.ws'\n            - '.onion'\n            - '.s1.tor-gateways.de'\n            - '.s2.tor-gateways.de'\n            - '.s3.tor-gateways.de'\n            - '.s4.tor-gateways.de'\n            - '.s5.tor-gateways.de'\n            - '.t2w.pw'\n            - '.tor2web.ae.org'\n            - '.tor2web.blutmagie.de'\n            - '.tor2web.com'\n            - '.tor2web.fi'\n            - '.tor2web.io'\n            - '.tor2web.org'\n            - '.tor2web.xyz'\n            - '.torlink.co'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\dns_client\\win_dns_client_put_io.yml","content":"title: DNS Query To Put.io - DNS Client\nid: 8b69fd42-9dad-4674-abef-7fdef43ef92a\nstatus: test\ndescription: Detects DNS queries for subdomains related to \"Put.io\" sharing website.\nreferences:\n    - https://darkatlas.io/blog/medusa-ransomware-group-opsec-failure\nauthor: Omar Khaled (@beacon_exe)\ndate: 2024-08-23\ntags:\n    - attack.command-and-control\nlogsource:\n    product: windows\n    service: dns-client\n    definition: 'Requirements: Microsoft-Windows-DNS Client Events/Operational Event Log must be enabled/collected in order to receive the events.'\ndetection:\n    selection:\n        EventID: 3008\n        QueryName|contains:\n            - 'api.put.io'\n            - 'upload.put.io'\n    condition: selection\nfalsepositives:\n    - Legitimate DNS queries and usage of Put.io\nlevel: medium\n"},{"path":"builtin\\dns_client\\win_dns_client_mega_nz.yml","content":"title: DNS Query To MEGA Hosting Website - DNS Client\nid: 66474410-b883-415f-9f8d-75345a0a66a6\nrelated:\n    - id: 613c03ba-0779-4a53-8a1f-47f914a4ded3\n      type: similar\nstatus: test\ndescription: Detects DNS queries for subdomains related to MEGA sharing website\nreferences:\n    - https://research.nccgroup.com/2021/05/27/detecting-rclone-an-effective-tool-for-exfiltration/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-16\ntags:\n    - attack.exfiltration\n    - attack.t1567.002\nlogsource:\n    product: windows\n    service: dns-client\n    definition: 'Requirements: Microsoft-Windows-DNS Client Events/Operational Event Log must be enabled/collected in order to receive the events.'\ndetection:\n    selection:\n        EventID: 3008\n        QueryName|contains: 'userstorage.mega.co.nz'\n    condition: selection\nfalsepositives:\n    - Legitimate DNS queries and usage of Mega\nlevel: medium\n"},{"path":"builtin\\dns_client\\win_dns_client_mal_cobaltstrike.yml","content":"title: Suspicious Cobalt Strike DNS Beaconing - DNS Client\nid: 0d18728b-f5bf-4381-9dcf-915539fff6c2\nrelated:\n    - id: f356a9c4-effd-4608-bbf8-408afd5cd006\n      type: similar\nstatus: test\ndescription: Detects a program that invoked suspicious DNS queries known from Cobalt Strike beacons\nreferences:\n    - https://www.icebrg.io/blog/footprints-of-fin7-tracking-actor-patterns\n    - https://www.sekoia.io/en/hunting-and-detecting-cobalt-strike/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-16\ntags:\n    - attack.t1071.004\n    - attack.command-and-control\nlogsource:\n    product: windows\n    service: dns-client\n    definition: 'Requirements: Microsoft-Windows-DNS Client Events/Operational Event Log must be enabled/collected in order to receive the events.'\ndetection:\n    selection_eid:\n        EventID: 3008\n    selection_query_1:\n        QueryName|startswith:\n            - 'aaa.stage.'\n            - 'post.1'\n    selection_query_2:\n        QueryName|contains: '.stage.123456.'\n    condition: selection_eid and 1 of selection_query_*\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"builtin\\dns_client\\win_dns_client_anonymfiles_com.yml","content":"title: DNS Query for Anonfiles.com Domain - DNS Client\nid: 29f171d7-aa47-42c7-9c7b-3c87938164d9\nrelated:\n    - id: 065cceea-77ec-4030-9052-fc0affea7110\n      type: similar\nstatus: test\ndescription: Detects DNS queries for anonfiles.com, which is an anonymous file upload platform often used for malicious purposes\nreferences:\n    - https://www.trendmicro.com/vinfo/us/security/news/ransomware-spotlight/ransomware-spotlight-blackbyte\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-16\ntags:\n    - attack.exfiltration\n    - attack.t1567.002\nlogsource:\n    product: windows\n    service: dns-client\n    definition: 'Requirements: Microsoft-Windows-DNS Client Events/Operational Event Log must be enabled/collected in order to receive the events.'\ndetection:\n    selection:\n        EventID: 3008\n        QueryName|contains: '.anonfiles.com'\n    condition: selection\nfalsepositives:\n    - Rare legitimate access to anonfiles.com\nlevel: high\n"},{"path":"builtin\\diagnosis\\scripted\\win_diagnosis_scripted_load_remote_diagcab.yml","content":"title: Loading Diagcab Package From Remote Path\nid: 50cb47b8-2c33-4b23-a2e9-4600657d9746\nstatus: test\ndescription: Detects loading of diagcab packages from a remote path, as seen in DogWalk vulnerability\nreferences:\n    - https://twitter.com/nas_bench/status/1539679555908141061\n    - https://twitter.com/j00sean/status/1537750439701225472\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-14\ntags:\n    - attack.execution\nlogsource:\n    product: windows\n    service: diagnosis-scripted\ndetection:\n    selection:\n        EventID: 101\n        PackagePath|contains: '\\\\\\\\' # Example would be: \\\\webdav-test.herokuapp.com@ssl\\DavWWWRoot\\package\n    condition: selection\nfalsepositives:\n    - Legitimate package hosted on a known and authorized remote location\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_whql_failure.yml","content":"title: CodeIntegrity - Unmet WHQL Requirements For Loaded Kernel Module\nid: 2f8cd7a0-9d5a-4f62-9f8b-2c951aa0dd1f\nstatus: test\ndescription: Detects loaded kernel modules that did not meet the WHQL signing requirements.\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-06\nmodified: 2023-06-14\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID:\n            - 3082 # Code Integrity determined kernel module %2 that did not meet the WHQL requirements is loaded into the system. However, due to code integrity auditing policy, the image was allowed to load\n            - 3083 # Code Integrity determined kernel module %2 that did not meet the WHQL requirements is loaded into the system. Check with the publisher to see if a WHQL compliant kernel module is available\n    filter_optional_vmware:\n        FileNameBuffer:\n            - 'system32\\drivers\\vsock.sys'\n            - 'System32\\drivers\\vmci.sys'\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_unsigned_image_loaded.yml","content":"title: CodeIntegrity - Unsigned Image Loaded\nid: c92c24e7-f595-493f-9c98-53d5142f5c18\nstatus: test\ndescription: Detects loaded unsigned image on the system\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-06\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID: 3037 # Code Integrity determined an unsigned image %2 is loaded into the system. Check with the publisher to see if a signed version of the image is available.\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_unsigned_driver_loaded.yml","content":"title: CodeIntegrity - Unsigned Kernel Module Loaded\nid: 951f8d29-f2f6-48a7-859f-0673ff105e6f\nstatus: test\ndescription: Detects the presence of a loaded unsigned kernel module on the system.\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-06\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID: 3001 # Code Integrity determined an unsigned kernel module %2 is loaded into the system. Check with the publisher to see if a signed version of the kernel module is available\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_revoked_image_loaded.yml","content":"title: CodeIntegrity - Revoked Image Loaded\nid: 881b7725-47cc-4055-8000-425823344c59\nstatus: test\ndescription: Detects image load events with revoked certificates by code integrity.\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-06\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID:\n            - 3032 # Code Integrity determined a revoked image %2 is loaded into the system. Check with the publisher to see if a new signed version of the image is available.\n            - 3035 # Code Integrity determined a revoked image %2 is loaded into the system. The image is allowed to load because kernel mode debugger is attached.\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_revoked_image_blocked.yml","content":"title: CodeIntegrity - Blocked Image Load With Revoked Certificate\nid: 6f156c48-3894-4952-baf0-16193e9067d2\nstatus: test\ndescription: Detects blocked image load events with revoked certificates by code integrity.\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-06\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID: 3036 # Windows is unable to verify the integrity of the file %2 because the signing certificate has been revoked.  Check with the publisher to see if a new signed version of the kernel module is available.\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_revoked_driver_loaded.yml","content":"title: CodeIntegrity - Revoked Kernel Driver Loaded\nid: 320fccbf-5e32-4101-82b8-2679c5f007c6\nstatus: test\ndescription: Detects the load of a revoked kernel driver\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-06\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID:\n            - 3021 # Code Integrity determined a revoked kernel module %2 is loaded into the system.  Check with the publisher to see if a new signed version of the kernel module is available.\n            - 3022 # Code Integrity determined a revoked kernel module %2 is loaded into the system. The image is allowed to load because kernel mode debugger is attached.\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_revoked_driver_blocked.yml","content":"title: CodeIntegrity - Blocked Driver Load With Revoked Certificate\nid: 9b72b82d-f1c5-4632-b589-187159bc6ec1\nstatus: test\ndescription: Detects blocked load attempts of revoked drivers\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-06\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1543\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID: 3023 # The driver %2 is blocked from loading as the driver has been revoked by Microsoft.\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_enforced_policy_block.yml","content":"title: CodeIntegrity - Blocked Image/Driver Load For Policy Violation\nid: e4be5675-4a53-426a-8c81-a8bb2387e947\nstatus: test\ndescription: Detects blocked load events that did not meet the authenticode signing level requirements or violated the code integrity policy.\nreferences:\n    - https://twitter.com/wdormann/status/1590434950335320065\n    - https://github.com/MicrosoftDocs/windows-itpro-docs/blob/40fe118976734578f83e5e839b9c63ae7a4af82d/windows/security/threat-protection/windows-defender-application-control/event-id-explanations.md#windows-codeintegrity-operational-log\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-11-10\nmodified: 2023-06-07\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1543\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID: 3077 # Code Integrity determined that a process (%4) attempted to load %2 that did not meet the %5 signing level requirements or violated code integrity policy (Policy ID:%XX).\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_blocked_protected_process_file.yml","content":"title: CodeIntegrity - Disallowed File For Protected Processes Has Been Blocked\nid: 5daf11c3-022b-4969-adb9-365e6c078c7c\nstatus: test\ndescription: Detects block events for files that are disallowed by code integrity for protected processes\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-06-06\ntags:\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID: 3104 # Windows blocked file %2 which has been disallowed for protected processes.\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"builtin\\code_integrity\\win_codeintegrity_attempted_dll_load.yml","content":"title: CodeIntegrity - Unmet Signing Level Requirements By File Under Validation\nid: f8931561-97f5-4c46-907f-0a4a592e47a7\nstatus: experimental\ndescription: |\n    Detects attempted file load events that did not meet the signing level requirements. It often means the file's signature is revoked or a signature with the Lifetime Signing EKU has expired.\n    This event is best correlated with EID 3089 to determine the error of the validation.\nreferences:\n    - https://twitter.com/SBousseaden/status/1483810148602814466\n    - https://github.com/MicrosoftDocs/windows-itpro-docs/blob/40fe118976734578f83e5e839b9c63ae7a4af82d/windows/security/threat-protection/windows-defender-application-control/event-id-explanations.md#windows-codeintegrity-operational-log\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-tag-explanations\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/operations/event-id-explanations\nauthor: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-01-20\nmodified: 2024-12-25\ntags:\n    - attack.execution\nlogsource:\n    product: windows\n    service: codeintegrity-operational\ndetection:\n    selection:\n        EventID:\n            - 3033 # Code Integrity determined that a process (%4) attempted to load %2 that did not meet the %5 signing level requirements.\n            - 3034 # Code Integrity determined that a process (%4) attempted to load %2 that did not meet the %5 signing level requirements or violated code integrity policy. However, due to code integrity auditing policy, the image was allowed to load.\n    filter_optional_dtrace:\n        # Example: Code Integrity determined that a process (\\Device\\HarddiskVolume5\\Windows\\System32\\svchost.exe) attempted to load \\Device\\HarddiskVolume5\\Program Files\\DTrace\\dtrace.dll that did not meet the Windows signing level requirements.\n        FileNameBuffer|endswith: '\\Program Files\\DTrace\\dtrace.dll'\n        ProcessNameBuffer|endswith: '\\Windows\\System32\\svchost.exe'\n        RequestedPolicy: 12\n    filter_optional_av_generic:\n        # Example: Code Integrity determined that a process (\\Device\\HarddiskVolume5\\ProgramData\\Microsoft\\Windows Defender\\Platform\\4.18.2207.7-0\\MsMpEng.exe) attempted to load \\Device\\HarddiskVolume5\\Windows\\System32\\DriverStore\\FileRepository\\iigd_dch.inf_amd64_36fb67bd6dbd887d\\igd10iumd64.dll that did not meet the Custom 3 / Antimalware signing level requirements.\n        FileNameBuffer|contains: '\\Windows\\System32\\DriverStore\\FileRepository\\'\n        FileNameBuffer|endswith: '\\igd10iumd64.dll'\n        # ProcessNameBuffer is AV products\n        RequestedPolicy: 7\n    filter_optional_electron_based_app:\n        # Example: Code Integrity determined that a process (\\Device\\HarddiskVolume5\\Users\\user\\AppData\\Local\\Keybase\\Gui\\Keybase.exe) attempted to load \\Device\\HarddiskVolume5\\Windows\\System32\\nvspcap64.dll that did not meet the Microsoft signing level requirements.\n        FileNameBuffer|endswith: '\\Windows\\System32\\nvspcap64.dll'\n        ProcessNameBuffer|endswith:\n            - '\\AppData\\Local\\Keybase\\Gui\\Keybase.exe'\n            - '\\Microsoft\\Teams\\stage\\Teams.exe'\n        RequestedPolicy: 8\n    filter_optional_bonjour:\n        FileNameBuffer|endswith: '\\Program Files\\Bonjour\\mdnsNSP.dll'\n        ProcessNameBuffer|endswith:\n            - '\\Windows\\System32\\svchost.exe'\n            - '\\Windows\\System32\\SIHClient.exe'\n        RequestedPolicy:\n            - 8\n            - 12\n    filter_optional_msoffice:\n        FileNameBuffer|contains: '\\Microsoft Office\\root\\vfs\\ProgramFilesCommonX64\\Microsoft Shared\\OFFICE'\n        FileNameBuffer|endswith: '\\MSOXMLMF.DLL'\n        # ProcessNameBuffer is AV products\n        RequestedPolicy: 7\n    filter_optional_slack:\n        # Example: https://user-images.githubusercontent.com/112784902/197407680-96d4b662-8a59-4289-a483-b24d630ac2a9.png\n        # Even though it's the same DLL as the one used in the electron based app filter. We need to do a separate selection due to slack's folder naming convention with the version number :)\n        FileNameBuffer|endswith: '\\Windows\\System32\\nvspcap64.dll'\n        ProcessNameBuffer|contains: '\\AppData\\Local\\slack\\app-'\n        ProcessNameBuffer|endswith: '\\slack.exe'\n        RequestedPolicy: 8\n    filter_optional_firefox:\n        # Example: https://user-images.githubusercontent.com/62423083/197451483-70e89010-ed96-4357-8079-b5a061a239d6.png\n        FileNameBuffer|endswith:\n            - '\\Mozilla Firefox\\mozavcodec.dll'\n            - '\\Mozilla Firefox\\mozavutil.dll'\n        ProcessNameBuffer|endswith: '\\Mozilla Firefox\\firefox.exe'\n        RequestedPolicy: 8\n    filter_optional_avast:\n        FileNameBuffer|endswith:\n            - '\\Program Files\\Avast Software\\Avast\\aswAMSI.dll'\n            - '\\Program Files (x86)\\Avast Software\\Avast\\aswAMSI.dll'\n        RequestedPolicy:\n            - 8\n            - 12\n    filter_main_gac:\n        # Filtering the path containing this string because of multiple possible DLLs in that location\n        FileNameBuffer|contains: '\\Windows\\assembly\\GAC\\'\n        ProcessNameBuffer|endswith: '\\mscorsvw.exe'\n        ProcessNameBuffer|contains: '\\Windows\\Microsoft.NET\\'\n        RequestedPolicy: 8\n    filter_optional_google_drive:\n        # Example: \\Program Files\\Google\\Drive File Stream\\67.0.2.0\\crashpad_handler.exe\n        FileNameBuffer|contains: '\\Program Files\\Google\\Drive File Stream\\'\n        FileNameBuffer|endswith: '\\crashpad_handler.exe'\n        ProcessNameBuffer|endswith: '\\Windows\\ImmersiveControlPanel\\SystemSettings.exe'\n        RequestedPolicy: 8\n    filter_optional_trend_micro:\n        FileNameBuffer|endswith: '\\Trend Micro\\Client Server Security Agent\\perficrcperfmonmgr.dll'\n        RequestedPolicy: 8\n    filter_optional_mdns_responder:\n        FileNameBuffer|endswith: '\\Program Files\\National Instruments\\Shared\\mDNS Responder\\nimdnsNSP.dll '\n    filter_optional_mcafee:\n        FileNameBuffer|endswith:\n            - '\\Program Files\\McAfee\\Endpoint Security\\Threat Prevention\\MfeAmsiProvider.dll'\n            - '\\Program Files\\McAfee\\MfeAV\\AMSIExt.dll'\n    filter_optional_eset:\n        FileNameBuffer|endswith: '\\Program Files\\ESET\\ESET Security\\eamsi.dll'\n    filter_optional_comodo:\n        FileNameBuffer|endswith: '\\Program Files\\comodo\\comodo internet security\\amsiprovider_x64.dll'\n    filter_optional_sentinel_one:\n        # Example: program files\\sentinelone\\sentinel agent 23.4.4.223\\inprocessclient64.dll\n        - FileNameBuffer|contains: '\\Program Files\\SentinelOne\\Sentinel Agent'\n        # Example: Program Files\\SentinelOne\\Sentinel Agent 23.4.4.223\\SentinelAgent.exe\n        - ProcessNameBuffer|contains: '\\Program Files\\SentinelOne\\Sentinel Agent'\n    filter_optional_national_instruments:\n        # Example: \\device\\harddiskvolume3\\program files\\national instruments\\shared\\mdns responder\\nimdnsnsp.dll\n        FileNameBuffer|contains: '\\National Instruments\\Shared\\mDNS Responder\\'\n    filter_optional_kaspersky:\n        # Example: \\Program Files (x86)\\Kaspersky Lab\\Kaspersky Endpoint Security for Windows\\x64\\antimalware_provider.dll\n        - ProcessNameBuffer|contains|all:\n              - '\\Kaspersky Lab\\'\n              - '\\avp.exe'\n        - FileNameBuffer|contains|all:\n              - '\\Kaspersky Lab\\'\n              - '\\antimalware_provider.dll'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Antivirus and other third party products are known to trigger this rule quite a lot. Initial filters and tuning is required before using this rule.\nlevel: low\n"},{"path":"builtin\\certificate_services_client_lifecycle_system\\win_certificateservicesclient_lifecycle_system_cert_exported.yml","content":"title: Certificate Exported From Local Certificate Store\nid: 58c0bff0-40a0-46e8-b5e8-b734b84d2017\nstatus: test\ndescription: Detects when an application exports a certificate (and potentially the private key as well) from the local Windows certificate store.\nreferences:\n    - https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html\nauthor: Zach Mathis\ndate: 2023-05-13\ntags:\n    - attack.credential-access\n    - attack.t1649\nlogsource:\n    product: windows\n    service: certificateservicesclient-lifecycle-system\ndetection:\n    selection:\n        EventID: 1007 # A certificate has been exported\n    condition: selection\nfalsepositives:\n    - Legitimate application requesting certificate exports will trigger this. Apply additional filters as needed\nlevel: medium\n"},{"path":"builtin\\capi2\\win_capi2_acquire_certificate_private_key.yml","content":"title: Certificate Private Key Acquired\nid: e2b5163d-7deb-4566-9af3-40afea6858c3\nstatus: test\ndescription: Detects when an application acquires a certificate private key\nreferences:\n    - https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html\nauthor: Zach Mathis\ndate: 2023-05-13\ntags:\n    - attack.credential-access\n    - attack.t1649\nlogsource:\n    product: windows\n    service: capi2\n    definition: 'Requirements: The CAPI2 Operational log needs to be enabled'\ndetection:\n    selection:\n        EventID: 70 # Acquire Certificate Private Key\n    condition: selection\nfalsepositives:\n    - Legitimate application requesting certificate exports will trigger this. Apply additional filters as needed\nlevel: medium\n"},{"path":"builtin\\bits_client\\win_bits_client_new_trasnfer_susp_local_folder.yml","content":"title: BITS Transfer Job Download To Potential Suspicious Folder\nid: f8a56cb7-a363-44ed-a82f-5926bb44cd05\nstatus: test\ndescription: Detects new BITS transfer job where the LocalName/Saved file is stored in a potentially suspicious location\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1197/T1197.md\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-06-28\nmodified: 2023-03-27\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1197\nlogsource:\n    product: windows\n    service: bits-client\ndetection:\n    selection:\n        EventID: 16403\n        LocalName|contains:\n            # TODO: Add more interesting suspicious paths\n            - '\\Desktop\\'\n            - 'C:\\Users\\Public\\'\n            - 'C:\\PerfLogs\\'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\bits_client\\win_bits_client_new_transfer_via_uncommon_tld.yml","content":"title: BITS Transfer Job With Uncommon Or Suspicious Remote TLD\nid: 6d44fb93-e7d2-475c-9d3d-54c9c1e33427\nstatus: test\ndescription: Detects a suspicious download using the BITS client from a FQDN that is unusual. Adversaries may abuse BITS jobs to persistently execute or clean up after malicious payloads.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1197/T1197.md\n    - https://twitter.com/malmoeb/status/1535142803075960832\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-06-10\nmodified: 2024-12-25\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1197\nlogsource:\n    product: windows\n    service: bits-client\ndetection:\n    selection:\n        EventID: 16403\n    filter_main_generic:\n        RemoteName|contains:\n            - '.azureedge.net/'\n            - '.com/'\n            - '.sfx.ms/'\n            - 'download.mozilla.org/' # https://download.mozilla.org/?product=firefox-101.0.1-partial-101.0&amp;os=win64&amp;lang=en-US\n            - 'cdn.onenote.net/'\n            - 'cdn.office.net/'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - This rule doesn't exclude other known TLDs such as \".org\" or \".net\". It's recommended to apply additional filters for software and scripts that leverage the BITS service\nlevel: medium\n"},{"path":"builtin\\bits_client\\win_bits_client_new_transfer_via_ip_address.yml","content":"title: BITS Transfer Job Download From Direct IP\nid: 90f138c1-f578-4ac3-8c49-eecfd847c8b7\nrelated:\n    - id: 99c840f2-2012-46fd-9141-c761987550ef\n      type: similar\nstatus: test\ndescription: Detects a BITS transfer job downloading file(s) from a direct IP address.\nreferences:\n    - https://blog.netspi.com/15-ways-to-download-a-file/#bitsadmin\n    - https://isc.sans.edu/diary/22264\n    - https://lolbas-project.github.io/lolbas/Binaries/Bitsadmin/\n    - https://blog.talosintelligence.com/breaking-the-silence-recent-truebot-activity/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-11\nmodified: 2023-03-27\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1197\nlogsource:\n    product: windows\n    service: bits-client\ndetection:\n    selection:\n        EventID: 16403\n        RemoteName|contains:\n            - 'http://1'\n            - 'http://2'\n            - 'http://3'\n            - 'http://4'\n            - 'http://5'\n            - 'http://6'\n            - 'http://7'\n            - 'http://8'\n            - 'http://9'\n            - 'https://1'\n            - 'https://2'\n            - 'https://3'\n            - 'https://4'\n            - 'https://5'\n            - 'https://6'\n            - 'https://7'\n            - 'https://8'\n            - 'https://9'\n    filter_optional_local_networks:\n        RemoteName|contains:\n            - '://10.' # 10.0.0.0/8\n            - '://192.168.' # 192.168.0.0/16\n            - '://172.16.' # 172.16.0.0/12\n            - '://172.17.'\n            - '://172.18.'\n            - '://172.19.'\n            - '://172.20.'\n            - '://172.21.'\n            - '://172.22.'\n            - '://172.23.'\n            - '://172.24.'\n            - '://172.25.'\n            - '://172.26.'\n            - '://172.27.'\n            - '://172.28.'\n            - '://172.29.'\n            - '://172.30.'\n            - '://172.31.'\n            - '://127.' # 127.0.0.0/8\n            - '://169.254.' # 169.254.0.0/16\n    filter_optional_seven_zip:\n        RemoteName|contains:\n            # For https://7-zip.org/\n            - 'https://7-'\n            - 'http://7-'\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\bits_client\\win_bits_client_new_transfer_via_file_sharing_domains.yml","content":"title: BITS Transfer Job Download From File Sharing Domains\nid: d635249d-86b5-4dad-a8c7-d7272b788586\nstatus: test\ndescription: Detects BITS transfer job downloading files from a file sharing domain.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1197/T1197.md\n    - https://twitter.com/malmoeb/status/1535142803075960832\n    - https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/ransomware-hive-conti-avoslocker\n    - https://www.microsoft.com/en-us/security/blog/2024/01/17/new-ttps-observed-in-mint-sandstorm-campaign-targeting-high-profile-individuals-at-universities-and-research-orgs/\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-06-28\nmodified: 2024-10-21\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1197\nlogsource:\n    product: windows\n    service: bits-client\ndetection:\n    selection:\n        EventID: 16403\n        RemoteName|contains:\n            - '.githubusercontent.com'       # Includes both gists and github repositories / Michael Haag (idea)\n            - 'anonfiles.com'\n            - 'cdn.discordapp.com'\n            - 'ddns.net'\n            - 'dl.dropboxusercontent.com'\n            - 'ghostbin.co'\n            - 'glitch.me'\n            - 'gofile.io'\n            - 'hastebin.com'\n            - 'mediafire.com'\n            - 'mega.nz'\n            - 'onrender.com'\n            - 'pages.dev'\n            - 'paste.ee'\n            - 'pastebin.com'\n            - 'pastebin.pl'\n            - 'pastetext.net'\n            - 'pixeldrain.com'\n            - 'privatlab.com'\n            - 'privatlab.net'\n            - 'send.exploit.in'\n            - 'sendspace.com'\n            - 'storage.googleapis.com'\n            - 'storjshare.io'\n            - 'supabase.co'\n            - 'temp.sh'\n            - 'transfer.sh'\n            - 'trycloudflare.com'\n            - 'ufile.io'\n            - 'w3spaces.com'\n            - 'workers.dev'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\bits_client\\win_bits_client_new_transfer_saving_susp_extensions.yml","content":"title: BITS Transfer Job Downloading File Potential Suspicious Extension\nid: b85e5894-9b19-4d86-8c87-a2f3b81f0521\nstatus: test\ndescription: Detects new BITS transfer job saving local files with potential suspicious extensions\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1197/T1197.md\nauthor: frack113\ndate: 2022-03-01\nmodified: 2023-03-27\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1197\nlogsource:\n    product: windows\n    service: bits-client\ndetection:\n    selection:\n        EventID: 16403\n        LocalName|endswith:\n            # TODO: Extend this list with more interesting file extensions\n            - '.bat'\n            - '.dll'\n            - '.exe' # TODO: Might wanna comment this if it generates tons of FPs\n            - '.hta'\n            - '.ps1'\n            - '.psd1'\n            - '.sh'\n            - '.vbe'\n            - '.vbs'\n    filter_optional_generic:\n        # Typical updates: Chrome, Dropbox etc.\n        LocalName|contains: '\\AppData\\'\n        RemoteName|contains: '.com'\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - While the file extensions in question can be suspicious at times. It's best to add filters according to your environment to avoid large amount false positives\nlevel: medium\n"},{"path":"builtin\\bits_client\\win_bits_client_new_job_via_powershell.yml","content":"title: New BITS Job Created Via PowerShell\nid: fe3a2d49-f255-4d10-935c-bda7391108eb\nstatus: test\ndescription: Detects the creation of a new bits job by PowerShell\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1197/T1197.md\nauthor: frack113\ndate: 2022-03-01\nmodified: 2023-03-27\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1197\nlogsource:\n    product: windows\n    service: bits-client\ndetection:\n    selection:\n        EventID: 3\n        processPath|endswith:\n            - '\\powershell.exe'\n            - '\\pwsh.exe'\n    condition: selection\nfalsepositives:\n    - Administrator PowerShell scripts\nlevel: low\n"},{"path":"builtin\\bits_client\\win_bits_client_new_job_via_bitsadmin.yml","content":"title: New BITS Job Created Via Bitsadmin\nid: 1ff315dc-2a3a-4b71-8dde-873818d25d39\nstatus: test\ndescription: Detects the creation of a new bits job by Bitsadmin\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1197/T1197.md\nauthor: frack113\ndate: 2022-03-01\nmodified: 2023-03-27\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1197\nlogsource:\n    product: windows\n    service: bits-client\ndetection:\n    selection:\n        EventID: 3\n        processPath|endswith: '\\bitsadmin.exe'\n    condition: selection\nfalsepositives:\n    - Many legitimate applications or scripts could leverage \"bitsadmin\". This event is best correlated with EID 16403 via the JobID field\nlevel: low\n"},{"path":"builtin\\appxpackaging_om\\win_appxpackaging_om_sups_appx_signature.yml","content":"title: Suspicious Digital Signature Of AppX Package\nid: b5aa7d60-c17e-4538-97de-09029d6cd76b\nstatus: test\ndescription: Detects execution of AppX packages with known suspicious or malicious signature\nreferences:\n    - Internal Research\n    - https://www.sentinelone.com/labs/inside-malicious-windows-apps-for-malware-deployment/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-16\ntags:\n    - attack.defense-evasion\n    - attack.execution\nlogsource:\n    product: windows\n    service: appxpackaging-om\ndetection:\n    selection:\n        EventID: 157\n        # Add more known suspicious/malicious certificates used in different attacks\n        subjectName: 'CN=Foresee Consulting Inc., O=Foresee Consulting Inc., L=North York, S=Ontario, C=CA, SERIALNUMBER=1004913-1, OID.1.3.6.1.4.1.311.60.2.1.3=CA, OID.2.5.4.15=Private Organization'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\appxdeployment_server\\win_appxdeployment_server_uncommon_package_locations.yml","content":"title: Uncommon AppX Package Locations\nid: c977cb50-3dff-4a9f-b873-9290f56132f1\nstatus: test\ndescription: Detects an appx package added the pipeline of the \"to be processed\" packages which is located in uncommon locations\nreferences:\n    - Internal Research\n    - https://www.sentinelone.com/labs/inside-malicious-windows-apps-for-malware-deployment/\n    - https://learn.microsoft.com/en-us/windows/win32/appxpkg/troubleshooting\n    - https://news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-11\nmodified: 2025-10-17\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: appxdeployment-server\ndetection:\n    selection:\n        EventID: 854\n    filter_main_generic:\n        Path|contains:\n            # Paths can be written using forward slash if the \"file://\" protocol is used\n            - 'C:\\Program Files\\WindowsApps\\'\n            - 'C:\\Program Files (x86)\\'\n            - 'C:\\Windows\\SystemApps\\'\n            - 'C:\\Windows\\PrintDialog\\'\n            - 'C:\\Windows\\ImmersiveControlPanel\\'\n            - 'x-windowsupdate://'\n            - 'file:///C:/Program%20Files' # Also covers 'file:///C:/Program%20Files%20(x86)/'\n            - 'AppData/Local/Temp/WinGet/Microsoft.Winget.Source'\n    filter_main_specific:\n        Path|contains:\n            - 'https://statics.teams.cdn.live.net/'\n            - 'https://statics.teams.cdn.office.net/'\n            - 'microsoft.com' # Example: https://go.microsoft.com/fwlink/?linkid=2160968\n            - 'https://installer.teams.static.microsoft/'\n            - 'https://res.cdn.office.net' # Example https://res.cdn.office.net/nativehost/5mttl/installer/v2/1.2025.617.100/Microsoft.OutlookForWindows_x64.msix\n    filter_optional_onedrive:\n        Path|contains: 'AppData\\Local\\Microsoft\\OneDrive\\'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\appxdeployment_server\\win_appxdeployment_server_susp_package_locations.yml","content":"title: Suspicious AppX Package Locations\nid: 5cdeaf3d-1489-477c-95ab-c318559fc051\nstatus: test\ndescription: Detects an appx package added the pipeline of the \"to be processed\" packages which is located in suspicious locations\nreferences:\n    - Internal Research\n    - https://www.sentinelone.com/labs/inside-malicious-windows-apps-for-malware-deployment/\n    - https://learn.microsoft.com/en-us/windows/win32/appxpkg/troubleshooting\n    - https://news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-11\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: appxdeployment-server\ndetection:\n    selection:\n        EventID: 854\n        Path|contains:\n            # Paths can be written using forward slash if the \"file://\" protocol is used\n            - 'C:\\Users\\Public\\'\n            - '/users/public/'\n            - 'C:\\PerfLogs\\'\n            - 'C:/perflogs/'\n            - '\\Desktop\\'\n            - '/desktop/'\n            - '\\Downloads\\'\n            - '/Downloads/'\n            - 'C:\\Windows\\Temp\\'\n            - 'C:/Windows/Temp/'\n            - '\\AppdData\\Local\\Temp\\'\n            - '/AppdData/Local/Temp/'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\appxdeployment_server\\win_appxdeployment_server_susp_domains.yml","content":"title: Suspicious Remote AppX Package Locations\nid: 8b48ad89-10d8-4382-a546-50588c410f0d\nstatus: test\ndescription: |\n    Detects an appx package added to the pipeline of the \"to be processed\" packages which was downloaded from a suspicious domain.\nreferences:\n    - Internal Research\n    - https://www.sentinelone.com/labs/inside-malicious-windows-apps-for-malware-deployment/\n    - https://learn.microsoft.com/en-us/windows/win32/appxpkg/troubleshooting\n    - https://news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-11\nmodified: 2024-08-22\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: appxdeployment-server\ndetection:\n    selection:\n        EventID: 854\n        Path|contains:\n            - '.githubusercontent.com'       # Includes both gists and github repositories / Michael Haag (idea)\n            - 'anonfiles.com'\n            - 'cdn.discordapp.com'\n            - 'ddns.net'\n            - 'dl.dropboxusercontent.com'\n            - 'ghostbin.co'\n            - 'glitch.me'\n            - 'gofile.io'\n            - 'hastebin.com'\n            - 'mediafire.com'\n            - 'mega.nz'\n            - 'onrender.com'\n            - 'pages.dev'\n            - 'paste.ee'\n            - 'pastebin.com'\n            - 'pastebin.pl'\n            - 'pastetext.net'\n            - 'privatlab.com'\n            - 'privatlab.net'\n            - 'send.exploit.in'\n            - 'sendspace.com'\n            - 'storage.googleapis.com'\n            - 'storjshare.io'\n            - 'supabase.co'\n            - 'temp.sh'\n            - 'transfer.sh'\n            - 'trycloudflare.com'\n            - 'ufile.io'\n            - 'w3spaces.com'\n            - 'workers.dev'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\appxdeployment_server\\win_appxdeployment_server_susp_appx_package_installation.yml","content":"title: Suspicious AppX Package Installation Attempt\nid: 898d5fc9-fbc3-43de-93ad-38e97237c344\nstatus: test\ndescription: Detects an appx package installation with the error code \"0x80073cff\" which indicates that the package didn't meet the signing requirements and could be suspicious\nreferences:\n    - Internal Research\n    - https://www.sentinelone.com/labs/inside-malicious-windows-apps-for-malware-deployment/\n    - https://learn.microsoft.com/en-us/windows/win32/appxpkg/troubleshooting\n    - https://news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-11\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: appxdeployment-server\ndetection:\n    selection:\n        EventID: 401\n        ErrorCode: '0x80073cff' # Check ref section to learn more about this error code\n    condition: selection\nfalsepositives:\n    - Legitimate AppX packages not signed by MS used part of an enterprise\nlevel: medium\n"},{"path":"builtin\\appxdeployment_server\\win_appxdeployment_server_policy_block.yml","content":"title: Deployment Of The AppX Package Was Blocked By The Policy\nid: e021bbb5-407f-41f5-9dc9-1864c45a7a51\nstatus: test\ndescription: Detects an appx package deployment that was blocked by the local computer policy\nreferences:\n    - https://learn.microsoft.com/en-us/windows/win32/appxpkg/troubleshooting\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/7a806a148b3d9d381193d4a80356016e6e8b1ee8/ETWEventsList/CSV/Windows11/22H2/W11_22H2_Pro_20220920_22621.382/Providers/Microsoft-Windows-AppXDeployment-Server.csv\nauthor: frack113\ndate: 2023-01-11\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: appxdeployment-server\ndetection:\n    selection:\n        EventID:\n            - 441\n            - 442\n            - 453\n            - 454\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\appxdeployment_server\\win_appxdeployment_server_mal_appx_names.yml","content":"title: Potential Malicious AppX Package Installation Attempts\nid: 09d3b48b-be17-47f5-bf4e-94e7e75d09ce\nstatus: test\ndescription: Detects potential installation or installation attempts of known malicious appx packages\nreferences:\n    - https://www.sentinelone.com/labs/inside-malicious-windows-apps-for-malware-deployment/\n    - https://news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/\n    - https://forensicitguy.github.io/analyzing-magnitude-magniber-appx/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-11\nmodified: 2023-01-12\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: appxdeployment-server\ndetection:\n    selection:\n        EventID:\n            - 400\n            - 401\n        # Add more malicious package names\n        # TODO: Investigate the packages here https://github.com/sophoslabs/IoCs/blob/master/Troj-BazarBackdoor.csv based on this report https://news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/\n        PackageFullName|contains: '3669e262-ec02-4e9d-bcb4-3d008b4afac9'\n    condition: selection\nfalsepositives:\n    - Rare occasions where a malicious package uses the exact same name and version as a legtimate application\nlevel: medium\n"},{"path":"builtin\\appxdeployment_server\\win_appxdeployment_server_applocker_block.yml","content":"title: Deployment AppX Package Was Blocked By AppLocker\nid: 6ae53108-c3a0-4bee-8f45-c7591a2c337f\nstatus: test\ndescription: Detects an appx package deployment that was blocked by AppLocker policy\nreferences:\n    - https://learn.microsoft.com/en-us/windows/win32/appxpkg/troubleshooting\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/7a806a148b3d9d381193d4a80356016e6e8b1ee8/ETWEventsList/CSV/Windows11/22H2/W11_22H2_Pro_20220920_22621.382/Providers/Microsoft-Windows-AppXDeployment-Server.csv\nauthor: frack113\ndate: 2023-01-11\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: appxdeployment-server\ndetection:\n    selection:\n        EventID: 412\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\appmodel_runtime\\win_appmodel_runtime_sysinternals_tools_appx_execution.yml","content":"title: Sysinternals Tools AppX Versions Execution\nid: d29a20b2-be4b-4827-81f2-3d8a59eab5fc\nstatus: test\ndescription: Detects execution of Sysinternals tools via an AppX package. Attackers could install the Sysinternals Suite to get access to tools such as psexec and procdump to avoid detection based on System paths\nreferences:\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-16\nmodified: 2023-09-12\ntags:\n    - attack.defense-evasion\n    - attack.execution\nlogsource:\n    product: windows\n    service: appmodel-runtime\ndetection:\n    selection:\n        EventID: 201\n        ImageName:\n            - 'procdump.exe'\n            - 'psloglist.exe'\n            - 'psexec.exe'\n            - 'livekd.exe'\n            - 'ADExplorer.exe'\n    condition: selection\nfalsepositives:\n    - Legitimate usage of the applications from the Windows Store\nlevel: low\n"},{"path":"builtin\\applocker\\win_applocker_file_was_not_allowed_to_run.yml","content":"title: File Was Not Allowed To Run\nid: 401e5d00-b944-11ea-8f9a-00163ecd60ae\nstatus: test\ndescription: Detect run not allowed files. Applocker is a very useful tool, especially on servers where unprivileged users have access. For example terminal servers. You need configure applocker and log collect to receive these events.\nreferences:\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/applocker/what-is-applocker\n    - https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/applocker/using-event-viewer-with-applocker\n    - https://nxlog.co/documentation/nxlog-user-guide/applocker.html\nauthor: Pushkarev Dmitry\ndate: 2020-06-28\nmodified: 2021-11-27\ntags:\n    - attack.execution\n    - attack.t1204.002\n    - attack.t1059.001\n    - attack.t1059.003\n    - attack.t1059.005\n    - attack.t1059.006\n    - attack.t1059.007\nlogsource:\n    product: windows\n    service: applocker\ndetection:\n    selection:\n        EventID:\n            - 8004\n            - 8007\n            - 8022\n            - 8025\n    condition: selection\nfields:\n    - PolicyName\n    - RuleId\n    - RuleName\n    - TargetUser\n    - TargetProcessId\n    - FilePath\n    - FileHash\n    - Fqbn\nfalsepositives:\n    - Need tuning applocker or add exceptions in SIEM\nlevel: medium\n"},{"path":"builtin\\application\\windows_error_reporting\\win_application_msmpeng_crash_wer.yml","content":"title: Microsoft Malware Protection Engine Crash - WER\nid: 6c82cf5c-090d-4d57-9188-533577631108\nstatus: test\ndescription: This rule detects a suspicious crash of the Microsoft Malware Protection Engine\nreferences:\n    - https://bugs.chromium.org/p/project-zero/issues/detail?id=1252&desc=5\n    - https://technet.microsoft.com/en-us/library/security/4022344\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-05-09\nmodified: 2023-04-14\ntags:\n    - attack.defense-evasion\n    - attack.t1211\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: application\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name: 'Windows Error Reporting'\n        EventID: 1001\n        Data|contains|all:\n            - 'MsMpEng.exe'\n            - 'mpengine.dll'\n    condition: selection\nfalsepositives:\n    - MsMpEng might crash if the \"C:\\\" partition is full\nlevel: high\n"},{"path":"builtin\\application\\screenconnect\\win_app_remote_access_tools_screenconnect_file_transfer.yml","content":"title: Remote Access Tool - ScreenConnect File Transfer\nid: 5d19eb78-5b5b-4ef2-a9f0-4bfa94d58a13\nrelated:\n    - id: b1f73849-6329-4069-bc8f-78a604bb8b23\n      type: similar\nstatus: test\ndescription: Detects file being transferred via ScreenConnect RMM\nreferences:\n    - https://www.huntandhackett.com/blog/revil-the-usage-of-legitimate-remote-admin-tooling\n    - https://github.com/SigmaHQ/sigma/pull/4467\nauthor: Ali Alwashali\ndate: 2023-10-10\ntags:\n    - attack.execution\n    - attack.t1059.003\nlogsource:\n    service: application\n    product: windows\ndetection:\n    selection:\n        Provider_Name: 'ScreenConnect'\n        EventID: 201\n        Data|contains: 'Transferred files with action'\n    condition: selection\nfalsepositives:\n    - Legitimate use of ScreenConnect\nlevel: low\n"},{"path":"builtin\\application\\screenconnect\\win_app_remote_access_tools_screenconnect_command_exec.yml","content":"title: Remote Access Tool - ScreenConnect Command Execution\nid: 076ebe48-cc05-4d8f-9d41-89245cd93a14\nrelated:\n    - id: b1f73849-6329-4069-bc8f-78a604bb8b23\n      type: similar\nstatus: test\ndescription: Detects command execution via ScreenConnect RMM\nreferences:\n    - https://www.huntandhackett.com/blog/revil-the-usage-of-legitimate-remote-admin-tooling\n    - https://github.com/SigmaHQ/sigma/pull/4467\nauthor: Ali Alwashali\ndate: 2023-10-10\ntags:\n    - attack.execution\n    - attack.t1059.003\nlogsource:\n    service: application\n    product: windows\ndetection:\n    selection:\n        Provider_Name: 'ScreenConnect'\n        EventID: 200\n        Data|contains: 'Executed command of length'\n    condition: selection\nfalsepositives:\n    - Legitimate use of ScreenConnect\nlevel: low\n"},{"path":"builtin\\application\\Other\\win_av_relevant_match.yml","content":"title: Relevant Anti-Virus Signature Keywords In Application Log\nid: 78bc5783-81d9-4d73-ac97-59f6db4f72a8\nstatus: test\ndescription: |\n    Detects potentially highly relevant antivirus events in the application log based on known virus signature names and malware keywords.\nreferences:\n    - https://www.virustotal.com/gui/file/13828b390d5f58b002e808c2c4f02fdd920e236cc8015480fa33b6c1a9300e31\n    - https://www.virustotal.com/gui/file/15b57c1b68cd6ce3c161042e0f3be9f32d78151fe95461eedc59a79fc222c7ed\n    - https://www.virustotal.com/gui/file/5092b2672b4cb87a8dd1c2e6047b487b95995ad8ed5e9fc217f46b8bfb1b8c01\n    - https://www.nextron-systems.com/?s=antivirus\nauthor: Florian Roth (Nextron Systems), Arnim Rupp\ndate: 2017-02-19\nmodified: 2024-12-25\ntags:\n    - attack.resource-development\n    - attack.t1588\nlogsource:\n    product: windows\n    service: application\ndetection:\n    keywords:\n        - 'Adfind'\n        - 'ASP/BackDoor '\n        - 'ATK/'\n        - 'Backdoor.ASP'\n        - 'Backdoor.Cobalt'\n        - 'Backdoor.JSP'\n        - 'Backdoor.PHP'\n        - 'Blackworm'\n        - 'Brutel'\n        - 'BruteR'\n        - 'Chopper'\n        - 'Cobalt'\n        - 'COBEACON'\n        - 'Cometer'\n        - 'CRYPTES'\n        - 'Cryptor'\n        - 'Destructor'\n        - 'DumpCreds'\n        - 'Exploit.Script.CVE'\n        - 'FastReverseProxy'\n        - 'Filecoder'\n        - 'GrandCrab '\n        - 'HackTool'\n        - 'HKTL'\n        - 'HTool-'\n        - '/HTool'\n        - '.HTool'\n        - 'IISExchgSpawnCMD'\n        - 'Impacket'\n        - 'JSP/BackDoor '\n        - 'Keylogger'\n        - 'Koadic'\n        - 'Krypt'\n        - 'Lazagne'\n        - 'Metasploit'\n        - 'Meterpreter'\n        - 'MeteTool'\n        - 'mikatz'\n        - 'Mimikatz'\n        - 'Mpreter'\n        - 'MsfShell'\n        - 'Nighthawk'\n        - 'Packed.Generic.347'\n        - 'PentestPowerShell'\n        - 'Phobos'\n        - 'PHP/BackDoor '\n        - 'Potato'\n        - 'PowerSploit'\n        - 'PowerSSH'\n        - 'PshlSpy'\n        - 'PSWTool'\n        - 'PWCrack'\n        - 'PWDump'\n        - 'Ransom'\n        - 'Rozena'\n        - 'Ryzerlo'\n        - 'Sbelt'\n        - 'Seatbelt'\n        - 'SecurityTool '\n        - 'SharpDump'\n        - 'Shellcode'\n        - 'Sliver'\n        - 'Splinter'\n        - 'Swrort'\n        - 'Tescrypt'\n        - 'TeslaCrypt'\n        - 'TurtleLoader'\n        - 'Valyria'\n        - 'Webshell'\n        # - 'FRP.'\n        # - 'Locker'\n        # - 'PWS.'\n        # - 'PWSX'\n        # - 'Razy'\n        # - 'Ryuk'\n    filter_optional_generic:\n        - 'anti_ransomware_service.exe'\n        - 'Anti-Ransomware'\n        - 'Crack'\n        - 'cyber-protect-service.exe'\n        - 'encryptor'\n        - 'Keygen'\n    filter_optional_information:\n        Level: 4  # Information level\n    filter_optional_restartmanager:\n        Provider_Name: 'Microsoft-Windows-RestartManager'\n    condition: keywords and not 1 of filter_optional_*\nfalsepositives:\n    - Some software piracy tools (key generators, cracks) are classified as hack tools\nlevel: high\n"},{"path":"builtin\\application\\mssqlserver\\win_mssql_xp_cmdshell_change.yml","content":"title: MSSQL XPCmdshell Option Change\nid: d08dd86f-681e-4a00-a92c-1db218754417\nstatus: test\ndescription: |\n    Detects when the MSSQL \"xp_cmdshell\" stored procedure setting is changed.\nreferences:\n    - https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-persistence-part-1-startup-stored-procedures/\n    - https://thedfirreport.com/2022/07/11/select-xmrig-from-sqlserver/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-12\nmodified: 2024-06-26\ntags:\n    - attack.execution\nlogsource:\n    product: windows\n    service: application\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name|contains: 'MSSQL' # Note: We use contains to account for other third party providers - See https://github.com/SigmaHQ/sigma/issues/4876\n        EventID: 15457\n        Data|contains: 'xp_cmdshell'\n    condition: selection\nfalsepositives:\n    - Legitimate enable/disable of the setting\n    - Note that since the event contain the change for both values. This means that this will trigger on both enable and disable\nlevel: high\n"},{"path":"builtin\\application\\mssqlserver\\win_mssql_xp_cmdshell_audit_log.yml","content":"title: MSSQL XPCmdshell Suspicious Execution\nid: 7f103213-a04e-4d59-8261-213dddf22314\nstatus: test\ndescription: Detects when the MSSQL \"xp_cmdshell\" stored procedure is used to execute commands\nreferences:\n    - https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-persistence-part-1-startup-stored-procedures/\n    - https://thedfirreport.com/2022/07/11/select-xmrig-from-sqlserver/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-12\nmodified: 2024-06-26\ntags:\n    - attack.execution\nlogsource:\n    product: windows\n    service: application\n    definition: 'Requirements: MSSQL audit policy to monitor for \"xp_cmdshell\" must be enabled in order to receive this event in the application log (Follow this tutorial https://dba.stackexchange.com/questions/103183/is-there-any-way-to-monitor-execution-of-xp-cmdshell-in-sql-server-2012)'\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name|contains: 'MSSQL' # Note: We use contains to account for other third party providers - See https://github.com/SigmaHQ/sigma/issues/4876\n        EventID: 33205\n        Data|contains|all:\n            # You can modify this to include specific commands\n            - 'object_name:xp_cmdshell'\n            - 'statement:EXEC'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\application\\mssqlserver\\win_mssql_sp_procoption_set.yml","content":"title: MSSQL SPProcoption Set\nid: b3d57a5c-c92e-4b48-9a79-5f124b7cf964\nstatus: test\ndescription: Detects when the a stored procedure is set or cleared for automatic execution in MSSQL. A stored procedure that is set to automatic execution runs every time an instance of SQL Server is started\nreferences:\n    - https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-persistence-part-1-startup-stored-procedures/\n    - https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-procoption-transact-sql?view=sql-server-ver16\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-13\nmodified: 2024-06-26\ntags:\n    - attack.persistence\nlogsource:\n    product: windows\n    service: application\n    definition: 'Requirements: MSSQL audit policy to monitor for \"sp_procoption\" must be enabled in order to receive this event in the application log'\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name|contains: 'MSSQL' # Note: We use contains to account for other third party providers - See https://github.com/SigmaHQ/sigma/issues/4876\n        EventID: 33205\n        Data|contains|all:\n            - 'object_name:sp_procoption'\n            - 'statement:EXEC'\n    condition: selection\nfalsepositives:\n    - Legitimate use of the feature by administrators (rare)\nlevel: high\n"},{"path":"builtin\\application\\mssqlserver\\win_mssql_failed_logon_from_external_network.yml","content":"title: MSSQL Server Failed Logon From External Network\nid: ebfe73c2-5bc9-4ed9-aaa8-8b54b2b4777d\nrelated:\n    - id: 218d2855-2bba-4f61-9c85-81d0ea63ac71\n      type: similar\nstatus: test\ndescription: Detects failed logon attempts from clients with external network IP to an MSSQL server. This can be a sign of a bruteforce attack.\nreferences:\n    - https://cybersecthreat.com/2020/07/08/enable-mssql-authentication-log-to-eventlog/\n    - https://www.experts-exchange.com/questions/27800944/EventID-18456-Failed-to-open-the-explicitly-specified-database.html\nauthor: j4son\ndate: 2023-10-11\nmodified: 2025-05-28\ntags:\n    - attack.credential-access\n    - attack.t1110\nlogsource:\n    product: windows\n    service: application\n    definition: 'Requirements: Must enable MSSQL authentication.'\ndetection:\n    selection:\n        Provider_Name|contains: 'MSSQL' # Note: We use contains to account for other third party providers - See https://github.com/SigmaHQ/sigma/issues/4876\n        EventID: 18456\n    filter_main_local_ips:\n        Data|contains:\n            - 'CLIENT: 10.' # filter_range_IP: 10.0.0.0/8\n            - 'CLIENT: 172.16.' # filter_range_IP: 172.16.0.0/12\n            - 'CLIENT: 172.17.'\n            - 'CLIENT: 172.18.'\n            - 'CLIENT: 172.19.'\n            - 'CLIENT: 172.20.'\n            - 'CLIENT: 172.21.'\n            - 'CLIENT: 172.22.'\n            - 'CLIENT: 172.23.'\n            - 'CLIENT: 172.24.'\n            - 'CLIENT: 172.25.'\n            - 'CLIENT: 172.26.'\n            - 'CLIENT: 172.27.'\n            - 'CLIENT: 172.28.'\n            - 'CLIENT: 172.29.'\n            - 'CLIENT: 172.30.'\n            - 'CLIENT: 172.31.'\n            - 'CLIENT: 192.168.' # filter_range_IP: 192.168.0.0/16\n            - 'CLIENT: 127.' # filter_loop_back: 127.0.0.0/8\n            - 'CLIENT: 169.254.' # fileter_link-local_addressing: 169.254.0.0/16\n            - 'CLIENT: <local machine>'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\application\\mssqlserver\\win_mssql_failed_logon.yml","content":"title: MSSQL Server Failed Logon\nid: 218d2855-2bba-4f61-9c85-81d0ea63ac71\nrelated:\n    - id: ebfe73c2-5bc9-4ed9-aaa8-8b54b2b4777d\n      type: similar\nstatus: test\ndescription: Detects failed logon attempts from clients to MSSQL server.\nreferences:\n    - https://cybersecthreat.com/2020/07/08/enable-mssql-authentication-log-to-eventlog/\n    - https://www.experts-exchange.com/questions/27800944/EventID-18456-Failed-to-open-the-explicitly-specified-database.html\nauthor: Nasreddine Bencherchali (Nextron Systems), j4son\ndate: 2023-10-11\nmodified: 2024-06-26\ntags:\n    - attack.credential-access\n    - attack.t1110\nlogsource:\n    product: windows\n    service: application\n    definition: 'Requirements: Must enable MSSQL authentication.'\ndetection:\n    selection:\n        Provider_Name|contains: 'MSSQL' # Note: We use contains to account for other third party providers - See https://github.com/SigmaHQ/sigma/issues/4876\n        EventID: 18456\n    condition: selection\nfalsepositives:\n    - This event could stem from users changing an account's password that's used to authenticate via a job or an automated process. Investigate the source of such events and mitigate them\nlevel: low\n"},{"path":"builtin\\application\\mssqlserver\\win_mssql_disable_audit_settings.yml","content":"title: MSSQL Disable Audit Settings\nid: 350dfb37-3706-4cdc-9e2e-5e24bc3a46df\nstatus: test\ndescription: Detects when an attacker calls the \"ALTER SERVER AUDIT\" or \"DROP SERVER AUDIT\" transaction in order to delete or disable audit logs on the server\nreferences:\n    - https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-persistence-part-1-startup-stored-procedures/\n    - https://learn.microsoft.com/en-us/sql/t-sql/statements/drop-server-audit-transact-sql?view=sql-server-ver16\n    - https://learn.microsoft.com/en-us/sql/t-sql/statements/alter-server-audit-transact-sql?view=sql-server-ver16\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-13\nmodified: 2024-06-26\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    service: application\n    definition: 'Requirements: MSSQL audit policy must be enabled in order to receive this event in the application log'\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name|contains: 'MSSQL' # Note: We use contains to account for other third party providers - See https://github.com/SigmaHQ/sigma/issues/4876\n        EventID: 33205\n        Data|contains:\n            - 'statement:ALTER SERVER AUDIT'\n            - 'statement:DROP SERVER AUDIT'\n    condition: selection\nfalsepositives:\n    - This event should only fire when an administrator is modifying the audit policy. Which should be a rare occurrence once it's set up\nlevel: high\n"},{"path":"builtin\\application\\mssqlserver\\win_mssql_destructive_query.yml","content":"title: MSSQL Destructive Query\nid: 00321fee-ca72-4cce-b011-5415af3b9960\nstatus: experimental\ndescription: |\n    Detects the invocation of MS SQL transactions that are destructive towards table or database data, such as \"DROP TABLE\" or \"DROP DATABASE\".\nreferences:\n    - https://learn.microsoft.com/en-us/sql/t-sql/statements/drop-table-transact-sql?view=sql-server-ver16\n    - https://learn.microsoft.com/en-us/sql/t-sql/statements/drop-database-transact-sql?view=sql-server-ver16\n    - https://learn.microsoft.com/en-us/sql/t-sql/statements/truncate-table-transact-sql?view=sql-server-ver16\nauthor: Daniel Degasperi '@d4ns4n_'\ndate: 2025-06-04\ntags:\n    - attack.exfiltration\n    - attack.impact\n    - attack.t1485\nlogsource:\n    product: windows\n    service: application\n    definition: 'Requirements: MSSQL audit policy must be enabled in order to receive this event (event id 33205)'\ndetection:\n    selection:\n        Provider_Name: 'MSSQLSERVER$AUDIT'\n        EventID: 33205\n        Data|contains:\n            - 'statement:TRUNCATE TABLE'\n            - 'statement:DROP TABLE'\n            - 'statement:DROP DATABASE'\n    condition: selection\nfalsepositives:\n    - Legitimate transaction from a sysadmin.\nlevel: medium\n"},{"path":"builtin\\application\\mssqlserver\\win_mssql_add_sysadmin_account.yml","content":"title: MSSQL Add Account To Sysadmin Role\nid: 08200f85-2678-463e-9c32-88dce2f073d1\nstatus: test\ndescription: Detects when an attacker tries to backdoor the MSSQL server by adding a backdoor account to the sysadmin fixed server role\nreferences:\n    - https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-persistence-part-1-startup-stored-procedures/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-13\nmodified: 2024-06-26\ntags:\n    - attack.persistence\nlogsource:\n    product: windows\n    service: application\n    definition: 'Requirements: MSSQL audit policy must be enabled in order to receive this event in the application log'\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name|contains: 'MSSQL' # Note: We use contains to account for other third party providers - See https://github.com/SigmaHQ/sigma/issues/4876\n        EventID: 33205\n        Data|contains|all:\n            - 'object_name:sysadmin'\n            - 'statement:alter server role [sysadmin] add member '\n    condition: selection\nfalsepositives:\n    - Rare legitimate administrative activity\nlevel: high\n"},{"path":"builtin\\application\\msiinstaller\\win_software_atera_rmm_agent_install.yml","content":"title: Atera Agent Installation\nid: 87261fb2-69d0-42fe-b9de-88c6b5f65a43\nstatus: test\ndescription: Detects successful installation of Atera Remote Monitoring & Management (RMM) agent as recently found to be used by Conti operators\nreferences:\n    - https://www.advintel.io/post/secret-backdoor-behind-conti-ransomware-operation-introducing-atera-agent\nauthor: Bhabesh Raj\ndate: 2021-09-01\nmodified: 2022-12-25\ntags:\n    - attack.command-and-control\n    - attack.t1219.002\nlogsource:\n    service: application\n    product: windows\ndetection:\n    selection:\n        EventID: 1033\n        Provider_Name: MsiInstaller\n        Message|contains: AteraAgent\n    condition: selection\nfalsepositives:\n    - Legitimate Atera agent installation\nlevel: high\n"},{"path":"builtin\\application\\msiinstaller\\win_msi_install_from_web.yml","content":"title: MSI Installation From Web\nid: 5594e67a-7f92-4a04-b65d-1a42fd824a60\nstatus: test\ndescription: Detects installation of a remote msi file from web.\nreferences:\n    - https://twitter.com/_st0pp3r_/status/1583922009842802689\nauthor: Stamatis Chatzimangou\ndate: 2022-10-23\ntags:\n    - attack.defense-evasion\n    - attack.t1218\n    - attack.t1218.007\nlogsource:\n    product: windows\n    service: application\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name: 'MsiInstaller'\n        EventID:\n            - 1040\n            - 1042\n        Data|contains: '://'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\application\\msiinstaller\\win_msi_install_from_susp_locations.yml","content":"title: MSI Installation From Suspicious Locations\nid: c7c8aa1c-5aff-408e-828b-998e3620b341\nstatus: test\ndescription: Detects MSI package installation from suspicious locations\nreferences:\n    - https://www.trendmicro.com/en_us/research/22/h/ransomware-actor-abuses-genshin-impact-anti-cheat-driver-to-kill-antivirus.html\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-31\nmodified: 2023-10-23\ntags:\n    - attack.execution\nlogsource:\n    product: windows\n    service: application\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name: 'MsiInstaller'\n        EventID:\n            - 1040\n            - 1042\n        Data|contains:\n            # Add more suspicious paths\n            - ':\\Windows\\TEMP\\'\n            - '\\\\\\\\'\n            - '\\Desktop\\'\n            - '\\PerfLogs\\'\n            - '\\Users\\Public\\'\n            # - '\\AppData\\Local\\Temp\\'  # too many FPs\n            # - '\\Downloads\\'  # too many FPs, typical legitimate staging directory\n    filter_winget:\n        Data|contains: '\\AppData\\Local\\Temp\\WinGet\\'\n    filter_updhealthtools:\n        Data|contains: 'C:\\Windows\\TEMP\\UpdHealthTools.msi'\n    condition: selection and not 1 of filter_*\nfalsepositives:\n    - False positives may occur if you allow installation from folders such as the desktop, the public folder or remote shares. A baseline is required before production use.\nlevel: medium\n"},{"path":"builtin\\application\\msiinstaller\\win_builtin_remove_application.yml","content":"title: Application Uninstalled\nid: 570ae5ec-33dc-427c-b815-db86228ad43e\nstatus: test\ndescription: An application has been removed. Check if it is critical.\nreferences:\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/f1b010ce0ee1b71e3024180de1a3e67f99701fe4/ETWProvidersManifests/Windows11/22H2/W11_22H2_Pro_20221220_22621.963/WEPExplorer/Microsoft-Windows-MsiServer.xml\n    - https://learn.microsoft.com/en-us/windows/win32/msi/event-logging\nauthor: frack113\ndate: 2022-01-28\nmodified: 2022-09-17\ntags:\n    - attack.impact\n    - attack.t1489\nlogsource:\n    product: windows\n    service: application\ndetection:\n    selection:\n        Provider_Name: 'MsiInstaller'\n        EventID:\n            - 1034 # Windows Installer removed the product\n            - 11724 # Product Removal Successful\n    condition: selection\nfalsepositives:\n    - Unknown\n# Level is low as it can be very verbose, you can use the top or less 10 \"Product Name\" to have a quick overview\nlevel: low\n"},{"path":"builtin\\application\\microsoft_windows_software_restriction_policies\\win_software_restriction_policies_block.yml","content":"title: Restricted Software Access By SRP\nid: b4c8da4a-1c12-46b0-8a2b-0a8521d03442\nstatus: test\ndescription: Detects restricted access to applications by the Software Restriction Policies (SRP) policy\nreferences:\n    - https://learn.microsoft.com/en-us/windows-server/identity/software-restriction-policies/software-restriction-policies\n    - https://github.com/nasbench/EVTX-ETW-Resources/blob/7a806a148b3d9d381193d4a80356016e6e8b1ee8/ETWEventsList/CSV/Windows11/22H2/W11_22H2_Pro_20220920_22621.382/Providers/Microsoft-Windows-AppXDeployment-Server.csv\nauthor: frack113\ndate: 2023-01-12\ntags:\n    - attack.lateral-movement\n    - attack.execution\n    - attack.defense-evasion\n    - attack.t1072\nlogsource:\n    product: windows\n    service: application\ndetection:\n    selection:\n        Provider_Name: 'Microsoft-Windows-SoftwareRestrictionPolicies'\n        EventID:\n            - 865 # Access to %1 has been restricted by your Administrator by the default software restriction policy level\n            - 866 # Access to %1 has been restricted by your Administrator by location with policy rule %2 placed on path %3.\n            - 867 # Access to %1 has been restricted by your Administrator by software publisher policy.\n            - 868 # Access to %1 has been restricted by your Administrator by policy rule %2.\n            - 882 # Access to %1 has been restricted by your Administrator by policy rule %2.\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"builtin\\application\\microsoft_windows_backup\\win_susp_backup_delete.yml","content":"title: Backup Catalog Deleted\nid: 9703792d-fd9a-456d-a672-ff92efe4806a\nstatus: test\ndescription: Detects backup catalog deletions\nreferences:\n    - https://technet.microsoft.com/en-us/library/cc742154(v=ws.11).aspx\n    - https://www.hybrid-analysis.com/sample/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa?environmentId=100\nauthor: Florian Roth (Nextron Systems), Tom U. @c_APT_ure (collection)\ndate: 2017-05-12\nmodified: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.t1070.004\nlogsource:\n    product: windows\n    service: application\ndetection:\n    selection:\n        EventID: 524\n        Provider_Name: Microsoft-Windows-Backup\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"builtin\\application\\microsoft-windows_audit_cve\\win_audit_cve.yml","content":"title: Audit CVE Event\nid: 48d91a3a-2363-43ba-a456-ca71ac3da5c2\nstatus: test\ndescription: |\n    Detects events generated by user-mode applications when they call the CveEventWrite API when a known vulnerability is trying to be exploited.\n    MS started using this log in Jan. 2020 with CVE-2020-0601 (a Windows CryptoAPI vulnerability.\n    Unfortunately, that is about the only instance of CVEs being written to this log.\nreferences:\n    - https://twitter.com/VM_vivisector/status/1217190929330655232\n    - https://twitter.com/DidierStevens/status/1217533958096924676\n    - https://twitter.com/FlemmingRiis/status/1217147415482060800\n    - https://www.youtube.com/watch?v=ebmW42YYveI # \"CVEs in Windows Event Logs? What You Need to Know\" by 13Cubed.\n    - https://nullsec.us/windows-event-log-audit-cve/\nauthor: Florian Roth (Nextron Systems), Zach Mathis\ndate: 2020-01-15\nmodified: 2022-10-22\ntags:\n    - attack.execution\n    - attack.t1203\n    - attack.privilege-escalation\n    - attack.t1068\n    - attack.defense-evasion\n    - attack.t1211\n    - attack.credential-access\n    - attack.t1212\n    - attack.lateral-movement\n    - attack.t1210\n    - attack.impact\n    - attack.t1499.004\nlogsource:\n    product: windows\n    service: application\ndetection:\n    selection:\n        Provider_Name:\n            - 'Microsoft-Windows-Audit-CVE'\n            - 'Audit-CVE'\n        EventID: 1\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"builtin\\application\\esent\\win_esent_ntdsutil_abuse_susp_location.yml","content":"title: Dump Ntds.dit To Suspicious Location\nid: 94dc4390-6b7c-4784-8ffc-335334404650\nstatus: test\ndescription: Detects potential abuse of ntdsutil to dump ntds.dit database to a suspicious location\nreferences:\n    - https://twitter.com/mgreen27/status/1558223256704122882\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj574207(v=ws.11)\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-14\nmodified: 2023-10-23\ntags:\n    - attack.execution\nlogsource:\n    product: windows\n    service: application\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection_root:\n        Provider_Name: 'ESENT'\n        EventID: 325 # New Database Created\n        Data|contains: 'ntds.dit'\n    selection_paths:\n        Data|contains:\n            # Add more locations that you don't use in your env or that are just suspicious\n            - ':\\ntds.dit'\n            - '\\Appdata\\'\n            - '\\Desktop\\'\n            - '\\Downloads\\'\n            - '\\Perflogs\\'\n            - '\\Temp\\'\n            - '\\Users\\Public\\'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate backup operation/creating shadow copies\nlevel: medium\n"},{"path":"builtin\\application\\esent\\win_esent_ntdsutil_abuse.yml","content":"title: Ntdsutil Abuse\nid: e6e88853-5f20-4c4a-8d26-cd469fd8d31f\nstatus: test\ndescription: Detects potential abuse of ntdsutil to dump ntds.dit database\nreferences:\n    - https://twitter.com/mgreen27/status/1558223256704122882\n    - https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj574207(v=ws.11)\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-14\ntags:\n    - attack.credential-access\n    - attack.t1003.003\nlogsource:\n    product: windows\n    service: application\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name: 'ESENT'\n        EventID:\n            - 216\n            - 325\n            - 326\n            - 327\n        Data|contains: 'ntds.dit'\n    condition: selection\nfalsepositives:\n    - Legitimate backup operation/creating shadow copies\nlevel: medium\n"},{"path":"builtin\\application\\application_error\\win_werfault_susp_lsass_credential_dump.yml","content":"title: Potential Credential Dumping Via WER - Application\nid: a18e0862-127b-43ca-be12-1a542c75c7c5\nstatus: test\ndescription: Detects Windows error reporting event where the process that crashed is lsass. This could be the cause of an intentional crash by techniques such as Lsass-Shtinkering to dump credential\nreferences:\n    - https://github.com/deepinstinct/Lsass-Shtinkering\n    - https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Asaf%20Gilboa%20-%20LSASS%20Shtinkering%20Abusing%20Windows%20Error%20Reporting%20to%20Dump%20LSASS.pdf\n    - https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-12-07\ntags:\n    - attack.credential-access\n    - attack.t1003.001\nlogsource:\n    product: windows\n    service: application\ndetection:\n    selection:\n        Provider_Name: 'Application Error'\n        EventID: 1000\n        AppName: 'lsass.exe'\n        ExceptionCode: 'c0000001' # STATUS_UNSUCCESSFUL\n    condition: selection\nfalsepositives:\n    - Rare legitimate crashing of the lsass process\nlevel: high\n"},{"path":"builtin\\application\\application_error\\win_application_msmpeng_crash_error.yml","content":"title: Microsoft Malware Protection Engine Crash\nid: 545a5da6-f103-4919-a519-e9aec1026ee4\nrelated:\n    - id: 6c82cf5c-090d-4d57-9188-533577631108\n      type: similar\nstatus: test\ndescription: This rule detects a suspicious crash of the Microsoft Malware Protection Engine\nreferences:\n    - https://bugs.chromium.org/p/project-zero/issues/detail?id=1252&desc=5\n    - https://technet.microsoft.com/en-us/library/security/4022344\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-05-09\nmodified: 2023-04-14\ntags:\n    - attack.defense-evasion\n    - attack.t1211\n    - attack.t1562.001\nlogsource:\n    product: windows\n    service: application\n    # warning: The 'data' field used in the detection section is the container for the event data as a whole. You may have to adapt the rule for your backend accordingly\ndetection:\n    selection:\n        Provider_Name: 'Application Error'\n        EventID: 1000\n        Data|contains|all:\n            - 'MsMpEng.exe'\n            - 'mpengine.dll'\n    condition: selection\nfalsepositives:\n    - MsMpEng might crash if the \"C:\\\" partition is full\nlevel: high\n"}]