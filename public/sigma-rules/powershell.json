[{"path":"powershell\\powershell_script\\posh_ps_xml_iex.yml","content":"title: Powershell XML Execute Command\nid: 6c6c6282-7671-4fe9-a0ce-a2dcebdc342b\nstatus: test\ndescription: |\n    Adversaries may abuse PowerShell commands and scripts for execution.\n    PowerShell is a powerful interactive command-line interface and scripting environment included in the Windows operating system. (Citation: TechNet PowerShell)\n    Adversaries can use PowerShell to perform a number of actions, including discovery of information and execution of code\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1059.001/T1059.001.md#atomic-test-8---powershell-xml-requests\nauthor: frack113\ndate: 2022-01-19\nmodified: 2023-01-19\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_xml:\n        ScriptBlockText|contains|all:\n            - 'New-Object'\n            - 'System.Xml.XmlDocument'\n            - '.Load'\n    selection_exec:\n        ScriptBlockText|contains:\n            - 'IEX '\n            - 'Invoke-Expression '\n            - 'Invoke-Command '\n            - 'ICM -'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_x509enrollment.yml","content":"title: Suspicious X509Enrollment - Ps Script\nid: 504d63cb-0dba-4d02-8531-e72981aace2c\nrelated:\n    - id: 114de787-4eb2-48cc-abdb-c0b449f93ea4\n      type: similar\nstatus: test\ndescription: Detect use of X509Enrollment\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=42\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=41\n    - https://learn.microsoft.com/en-us/dotnet/api/microsoft.hpc.scheduler.store.cx509enrollmentwebclassfactoryclass?view=hpc-sdk-5.1.6115\nauthor: frack113\ndate: 2022-12-23\ntags:\n    - attack.defense-evasion\n    - attack.t1553.004\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'X509Enrollment.CBinaryConverter'\n            - '884e2002-217d-11da-b2a4-000e7bbb2b09'\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_wmi_unquoted_service_search.yml","content":"title: WMIC Unquoted Services Path Lookup - PowerShell\nid: 09658312-bc27-4a3b-91c5-e49ab9046d1b\nrelated:\n    - id: 68bcd73b-37ef-49cb-95fc-edc809730be6\n      type: similar\nstatus: test\ndescription: Detects known WMI recon method to look for unquoted service paths, often used by pentest inside of powershell scripts attackers enum scripts\nreferences:\n    - https://github.com/nccgroup/redsnarf/blob/35949b30106ae543dc6f2bc3f1be10c6d9a8d40e/redsnarf.py\n    - https://github.com/S3cur3Th1sSh1t/Creds/blob/eac23d67f7f90c7fc8e3130587d86158c22aa398/PowershellScripts/jaws-enum.ps1\n    - https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-06-20\nmodified: 2022-11-25\ntags:\n    - attack.execution\n    - attack.t1047\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Get-WmiObject '\n            - 'gwmi '\n        ScriptBlockText|contains|all:\n            - ' Win32_Service '\n            - 'Name'\n            - 'DisplayName'\n            - 'PathName'\n            - 'StartMode'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_wmi_persistence.yml","content":"title: Powershell WMI Persistence\nid: 9e07f6e7-83aa-45c6-998e-0af26efd0a85\nstatus: test\ndescription: Adversaries may establish persistence and elevate privileges by executing malicious content triggered by a Windows Management Instrumentation (WMI) event subscription.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1546.003/T1546.003.md\n    - https://github.com/EmpireProject/Empire/blob/08cbd274bef78243d7a8ed6443b8364acd1fc48b/data/module_source/persistence/Persistence.psm1#L545\nauthor: frack113\ndate: 2021-08-19\nmodified: 2022-12-25\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1546.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_ioc:\n        - ScriptBlockText|contains|all:\n              - 'New-CimInstance '\n              - '-Namespace root/subscription '\n              - '-ClassName __EventFilter '\n              - '-Property ' # is a variable name\n        - ScriptBlockText|contains|all:\n              - 'New-CimInstance '\n              - '-Namespace root/subscription '\n              - '-ClassName CommandLineEventConsumer '\n              - '-Property ' # is a variable name\n    condition: selection_ioc\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_wmimplant.yml","content":"title: WMImplant Hack Tool\nid: 8028c2c3-e25a-46e3-827f-bbb5abf181d7\nstatus: test\ndescription: Detects parameters used by WMImplant\nreferences:\n    - https://github.com/FortyNorthSecurity/WMImplant\nauthor: NVISO\ndate: 2020-03-26\nmodified: 2022-12-25\ntags:\n    - attack.execution\n    - attack.t1047\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'WMImplant'\n            - ' change_user '\n            - ' gen_cli '\n            - ' command_exec '\n            - ' disable_wdigest '\n            - ' disable_winrm '\n            - ' enable_wdigest '\n            - ' enable_winrm '\n            - ' registry_mod '\n            - ' remote_posh '\n            - ' sched_job '\n            - ' service_mod '\n            - ' process_kill '\n            # - ' process_start '\n            - ' active_users '\n            - ' basic_info '\n            # - ' drive_list '\n            # - ' installed_programs '\n            - ' power_off '\n            - ' vacant_system '\n            - ' logon_events '\n    condition: selection\nfalsepositives:\n    - Administrative scripts that use the same keywords.\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_win_defender_exclusions_added.yml","content":"title: Windows Defender Exclusions Added - PowerShell\nid: c1344fa2-323b-4d2e-9176-84b4d4821c88\nrelated:\n    - id: 17769c90-230e-488b-a463-e05c08e9d48f\n      type: similar\nstatus: test\ndescription: Detects modifications to the Windows Defender configuration settings using PowerShell to add exclusions\nreferences:\n    - https://www.elastic.co/guide/en/security/current/windows-defender-exclusions-added-via-powershell.html\nauthor: Tim Rauch, Elastic (idea)\ndate: 2022-09-16\nmodified: 2022-11-26\ntags:\n    - attack.defense-evasion\n    - attack.t1562\n    - attack.execution\n    - attack.t1059\nlogsource:\n    category: ps_script\n    product: windows\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_args_exc:\n        ScriptBlockText|contains:\n            - ' -ExclusionPath '\n            - ' -ExclusionExtension '\n            - ' -ExclusionProcess '\n            - ' -ExclusionIpAddress '\n    selection_args_pref:\n        ScriptBlockText|contains:\n            - 'Add-MpPreference '\n            - 'Set-MpPreference '\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_win_api_susp_access.yml","content":"title: Potential WinAPI Calls Via PowerShell Scripts\nid: 03d83090-8cba-44a0-b02f-0b756a050306\nrelated:\n    - id: ba3f5c1b-6272-4119-9dbd-0bc8d21c2702\n      type: similar\nstatus: test\ndescription: Detects use of WinAPI functions in PowerShell scripts\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse\nauthor: Nasreddine Bencherchali (Nextron Systems), Nikita Nazarov, oscd.community\ndate: 2020-10-06\nmodified: 2023-06-20\ntags:\n    - attack.execution\n    - attack.t1059.001\n    - attack.t1106\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    # Note: Add more suspicious combinations in the form of different selections\n    selection_injection:\n        ScriptBlockText|contains|all:\n            - 'VirtualAlloc'\n            - 'OpenProcess'\n            - 'WriteProcessMemory'\n            - 'CreateRemoteThread'\n    selection_token_steal:\n        ScriptBlockText|contains|all:\n            - 'OpenProcessToken'\n            - 'LookupPrivilegeValue'\n            - 'AdjustTokenPrivileges'\n    selection_duplicate_token:\n        ScriptBlockText|contains|all:\n            - 'OpenProcessToken'\n            - 'DuplicateTokenEx'\n            - 'CloseHandle'\n    selection_process_write_read:\n        ScriptBlockText|contains|all:\n            - 'WriteProcessMemory'\n            - 'VirtualAlloc'\n            - 'ReadProcessMemory'\n            - 'VirtualFree'\n    condition: 1 of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_winlogon_helper_dll.yml","content":"title: Winlogon Helper DLL\nid: 851c506b-6b7c-4ce2-8802-c703009d03c0\nstatus: test\ndescription: |\n    Winlogon.exe is a Windows component responsible for actions at logon/logoff as well as the secure attention sequence (SAS) triggered by Ctrl-Alt-Delete.\n    Registry entries in HKLM\\Software[Wow6432Node]Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\ and HKCU\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\ are\n    used to manage additional helper programs and functionalities that support Winlogon. Malicious modifications to these Registry keys may cause Winlogon to\n    load and execute malicious DLLs and/or executables.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1547.004/T1547.004.md\nauthor: Timur Zinniatullin, oscd.community\ndate: 2019-10-21\nmodified: 2022-07-07\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1547.004\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: 'CurrentVersion\\Winlogon'\n    selection2:\n        ScriptBlockText|contains:\n            - 'Set-ItemProperty'\n            - 'New-Item'\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_windows_firewall_profile_disabled.yml","content":"title: Windows Firewall Profile Disabled\nid: 488b44e7-3781-4a71-888d-c95abfacf44d\nrelated:\n    - id: 12f6b752-042d-483e-bf9c-915a6d06ad75\n      type: similar\nstatus: test\ndescription: Detects when a user disables the Windows Firewall via a Profile to help evade defense.\nreferences:\n    - https://learn.microsoft.com/en-us/powershell/module/netsecurity/set-netfirewallprofile?view=windowsserver2022-ps\n    - https://www.tutorialspoint.com/how-to-get-windows-firewall-profile-settings-using-powershell\n    - https://web.archive.org/web/20230929023836/http://powershellhelp.space/commands/set-netfirewallrule-psv5.php\n    - http://woshub.com/manage-windows-firewall-powershell/\n    - https://www.elastic.co/guide/en/security/current/windows-firewall-disabled-via-powershell.html\nauthor: Austin Songer @austinsonger\ndate: 2021-10-12\nmodified: 2022-12-30\ntags:\n    - attack.defense-evasion\n    - attack.t1562.004\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_args:\n        ScriptBlockText|contains|all:\n            - 'Set-NetFirewallProfile '\n            - ' -Enabled '\n            - ' False'\n    selection_opt:\n        ScriptBlockText|contains:\n            - ' -All '\n            - 'Public'\n            - 'Domain'\n            - 'Private'\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_win32_product_install_msi.yml","content":"title: PowerShell WMI Win32_Product Install MSI\nid: 91109523-17f0-4248-a800-f81d9e7c081d\nstatus: test\ndescription: Detects the execution of an MSI file using PowerShell and the WMI Win32_Product class\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1218.007/T1218.007.md\nauthor: frack113\ndate: 2022-04-24\ntags:\n    - attack.defense-evasion\n    - attack.t1218.007\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Invoke-CimMethod '\n            - '-ClassName '\n            - 'Win32_Product '\n            - '-MethodName '\n            - '.msi'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_win32_nteventlogfile_usage.yml","content":"title: Potentially Suspicious Call To Win32_NTEventlogFile Class - PSScript\nid: e2812b49-bae0-4b21-b366-7c142eafcde2\nstatus: test\ndescription: Detects usage of the WMI class \"Win32_NTEventlogFile\" in a potentially suspicious way (delete, backup, change permissions, etc.) from a PowerShell script\nreferences:\n    - https://learn.microsoft.com/en-us/previous-versions/windows/desktop/legacy/aa394225(v=vs.85)\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-07-13\ntags:\n    - attack.defense-evasion\nlogsource:\n    category: ps_script\n    product: windows\n    definition: bade5735-5ab0-4aa7-a642-a11be0e40872\ndetection:\n    selection_class:\n        ScriptBlockText|contains: 'Win32_NTEventlogFile'\n    selection_function:\n        ScriptBlockText|contains:\n            - '.BackupEventlog('\n            - '.ChangeSecurityPermissions('\n            - '.ChangeSecurityPermissionsEx('\n            - '.ClearEventLog('\n            - '.Delete('\n            - '.DeleteEx('\n            - '.Rename('\n            - '.TakeOwnerShip('\n            - '.TakeOwnerShipEx('\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate administration and backup scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_web_request_cmd_and_cmdlets.yml","content":"title: Usage Of Web Request Commands And Cmdlets - ScriptBlock\nid: 1139d2e2-84b1-4226-b445-354492eba8ba\nrelated:\n    - id: 9fc51a3c-81b3-4fa7-b35f-7c02cf10fd2d\n      type: derived\nstatus: test\ndescription: Detects the use of various web request commands with commandline tools and Windows PowerShell cmdlets (including aliases) via PowerShell scriptblock logs\nreferences:\n    - https://4sysops.com/archives/use-powershell-to-download-a-file-with-http-https-and-ftp/\n    - https://blog.jourdant.me/post/3-ways-to-download-files-with-powershell\nauthor: James Pemberton / @4A616D6573\ndate: 2019-10-24\nmodified: 2025-10-20\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - '[System.Net.WebRequest]::create'\n            - 'curl '\n            - 'Invoke-RestMethod'\n            - 'Invoke-WebRequest'\n            - ' irm ' # Space before and after to avoid false positives with 'irm' as a substring\n            - 'iwr '\n            # - 'Net.WebClient' # There are various other rules that cover this, so it is commented out\n            - 'Resume-BitsTransfer'\n            - 'Start-BitsTransfer'\n            - 'wget '\n            - 'WinHttp.WinHttpRequest'\n    filter:\n        Path|startswith: 'C:\\Packages\\Plugins\\Microsoft.GuestConfiguration.ConfigurationforWindows\\'\n    condition: selection and not filter\nfalsepositives:\n    - Use of Get-Command and Get-Help modules to reference Invoke-WebRequest and Start-BitsTransfer.\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_veeam_credential_dumping_script.yml","content":"title: Veeam Backup Servers Credential Dumping Script Execution\nid: 976d6e6f-a04b-4900-9713-0134a353e38b\nstatus: test\ndescription: Detects execution of a PowerShell script that contains calls to the \"Veeam.Backup\" class, in order to dump stored credentials.\nreferences:\n    - https://www.pwndefend.com/2021/02/15/retrieving-passwords-from-veeam-backup-servers/\n    - https://labs.withsecure.com/publications/fin7-target-veeam-servers\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-05-04\ntags:\n    - attack.credential-access\nlogsource:\n    product: windows\n    category: ps_script\n    definition: bade5735-5ab0-4aa7-a642-a11be0e40872\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - '[Credentials]'\n            - '[Veeam.Backup.Common.ProtectedStorage]::GetLocalString'\n            - 'Invoke-Sqlcmd'\n            - 'Veeam Backup and Replication'\n    condition: selection\nfalsepositives:\n    - Administrators backup scripts (must be investigated)\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_vbscript_registry_modification.yml","content":"title: Registry Modification Attempt Via VBScript - PowerShell\nid: 2a0a169d-cc66-43ce-9ae2-6e678e54e46a\nrelated:\n    - id: 921aa10f-2e74-4cca-9498-98f9ca4d6fdf\n      type: similar\n    - id: 7f4c43f9-b1a5-4c7d-b24a-b41bf3a3ebf2\n      type: similar\nstatus: experimental\ndescription: |\n    Detects attempts to modify the registry using VBScript's CreateObject(\"Wscript.shell\") and RegWrite methods embedded within PowerShell scripts or commands.\n    Threat actors commonly embed VBScript code within PowerShell to perform registry modifications, attempting to evade detection that monitors for direct registry access through traditional tools.\n    This technique can be used for persistence, defense evasion, and privilege escalation by modifying registry keys without using regedit.exe, reg.exe, or PowerShell's native registry cmdlets.\nreferences:\n    - https://www.linkedin.com/posts/mauricefielenbach_livingofftheland-redteam-persistence-activity-7344801774182051843-TE00/\n    - https://www.nextron-systems.com/2025/07/29/detecting-the-most-popular-mitre-persistence-method-registry-run-keys-startup-folder/\n    - https://detect.fyi/hunting-fileless-malware-in-the-windows-registry-1339ccde00ad\ndate: 2025-08-13\nauthor: Swachchhanda Shrawan Poudel (Nextron Systems)\ntags:\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.execution\n    - attack.t1112\n    - attack.t1059.005\nlogsource:\n    category: ps_script\n    product: windows\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'CreateObject'\n            - 'Wscript.shell'\n            - '.RegWrite'\n    condition: selection\nfalsepositives:\n    - Some legitimate admin or install scripts may use these processes for registry modifications.\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_using_set_service_to_hide_services.yml","content":"title: Abuse of Service Permissions to Hide Services Via Set-Service - PS\nid: 953945c5-22fe-4a92-9f8a-a9edc1e522da\nrelated:\n    - id: 514e4c3a-c77d-4cde-a00f-046425e2301e\n      type: similar\nstatus: test\ndescription: Detects usage of the \"Set-Service\" powershell cmdlet to configure a new SecurityDescriptor that allows a service to be hidden from other utilities such as \"sc.exe\", \"Get-Service\"...etc. (Works only in powershell 7)\nreferences:\n    - https://twitter.com/Alh4zr3d/status/1580925761996828672\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/set-service?view=powershell-7.2\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-10-17\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1574.011\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Set-Service '\n            - 'DCLCWPDTSD'\n        ScriptBlockText|contains:\n            - '-SecurityDescriptorSddl '\n            - '-sd '\n    condition: selection\nfalsepositives:\n    - Rare intended use of hidden services\n    - Rare FP could occur due to the non linearity of the ScriptBlockText log\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_user_profile_tampering.yml","content":"title: Potential Persistence Via PowerShell User Profile Using Add-Content\nid: 05b3e303-faf0-4f4a-9b30-46cc13e69152\nstatus: test\ndescription: Detects calls to \"Add-Content\" cmdlet in order to modify the content of the user profile and potentially adding suspicious commands for persistence\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1546.013/T1546.013.md\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2021-08-18\nmodified: 2023-05-04\ntags:\n    - attack.persistence\n    - attack.privilege-escalation\n    - attack.t1546.013\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_add:\n        ScriptBlockText|contains: 'Add-Content $profile'\n    selection_options:\n        ScriptBlockText|contains:\n            # Note: You can add more suspicious values\n            - '-Value \"IEX '\n            - '-Value \"Invoke-Expression'\n            - '-Value \"Invoke-WebRequest'\n            - '-Value \"Start-Process'\n            - \"-Value 'IEX \"\n            - \"-Value 'Invoke-Expression\"\n            - \"-Value 'Invoke-WebRequest\"\n            - \"-Value 'Start-Process\"\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate administration and tuning scripts that aim to add functionality to a user PowerShell session\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_user_discovery_get_aduser.yml","content":"title: User Discovery And Export Via Get-ADUser Cmdlet - PowerShell\nid: c2993223-6da8-4b1a-88ee-668b8bf315e9\nrelated:\n    - id: 1114e048-b69c-4f41-bc20-657245ae6e3f\n      type: similar\nstatus: test\ndescription: Detects usage of the Get-ADUser cmdlet to collect user information and output it to a file\nreferences:\n    - http://blog.talosintelligence.com/2022/09/lazarus-three-rats.html\n    - https://www.microsoft.com/en-us/security/blog/2022/10/18/defenders-beware-a-case-for-post-ransomware-investigations/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-11-17\ntags:\n    - attack.discovery\n    - attack.t1033\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Get-ADUser '\n            - ' -Filter \\*'\n        ScriptBlockText|contains:\n            - ' > '\n            - ' | Select '\n            - 'Out-File'\n            - 'Set-Content'\n            - 'Add-Content'\n    condition: selection\nfalsepositives:\n    - Legitimate admin scripts may use the same technique, it's better to exclude specific computers or users who execute these commands or scripts often\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_timestomp.yml","content":"title: Powershell Timestomp\nid: c6438007-e081-42ce-9483-b067fbef33c3\nstatus: test\ndescription: |\n    Adversaries may modify file time attributes to hide new or changes to existing files.\n    Timestomping is a technique that modifies the timestamps of a file (the modify, access, create, and change times), often to mimic files that are in the same folder.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.006/T1070.006.md\n    - https://www.offensive-security.com/metasploit-unleashed/timestomp/\nauthor: frack113\ndate: 2021-08-03\nmodified: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.t1070.006\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_ioc:\n        ScriptBlockText|contains:\n            - '.CreationTime ='\n            - '.LastWriteTime ='\n            - '.LastAccessTime ='\n            - '[IO.File]::SetCreationTime'\n            - '[IO.File]::SetLastAccessTime'\n            - '[IO.File]::SetLastWriteTime'\n    condition: selection_ioc\nfalsepositives:\n    - Legitimate admin script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_test_netconnection.yml","content":"title: Testing Usage of Uncommonly Used Port\nid: adf876b3-f1f8-4aa9-a4e4-a64106feec06\nstatus: test\ndescription: |\n    Adversaries may communicate using a protocol and port paring that are typically not associated.\n    For example, HTTPS over port 8088(Citation: Symantec Elfin Mar 2019) or port 587(Citation: Fortinet Agent Tesla April 2018) as opposed to the traditional port 443.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1571/T1571.md#atomic-test-1---testing-usage-of-uncommonly-used-port-with-powershell\n    - https://learn.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=windowsserver2022-ps\nauthor: frack113\ndate: 2022-01-23\ntags:\n    - attack.command-and-control\n    - attack.t1571\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - Test-NetConnection\n            - '-ComputerName '\n            - '-port '\n    filter:\n        ScriptBlockText|contains:\n            - ' 443 '\n            - ' 80 '\n    condition: selection and not filter\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_tamper_windows_defender_set_mp.yml","content":"title: Tamper Windows Defender - ScriptBlockLogging\nid: 14c71865-6cd3-44ae-adaa-1db923fae5f2\nrelated:\n    - id: ec19ebab-72dc-40e1-9728-4c0b805d722c\n      type: derived\nstatus: test\ndescription: Detects PowerShell scripts attempting to disable scheduled scanning and other parts of Windows Defender ATP or set default actions to allow.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md\n    - https://learn.microsoft.com/en-us/powershell/module/defender/set-mppreference?view=windowsserver2022-ps\n    - https://bidouillesecurity.com/disable-windows-defender-in-powershell/\nauthor: frack113, elhoim, Tim Shelton (fps, alias support), Swachchhanda Shrawan Poudel, Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-01-16\nmodified: 2024-01-02\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_options_disabling_preference:\n        ScriptBlockText|contains: 'Set-MpPreference'\n    selection_options_disabling_function:\n        ScriptBlockText|contains:\n            - '-dbaf $true'\n            - '-dbaf 1'\n            - '-dbm $true'\n            - '-dbm 1'\n            - '-dips $true'\n            - '-dips 1'\n            - '-DisableArchiveScanning $true'\n            - '-DisableArchiveScanning 1'\n            - '-DisableBehaviorMonitoring $true'\n            - '-DisableBehaviorMonitoring 1'\n            - '-DisableBlockAtFirstSeen $true'\n            - '-DisableBlockAtFirstSeen 1'\n            - '-DisableCatchupFullScan $true'\n            - '-DisableCatchupFullScan 1'\n            - '-DisableCatchupQuickScan $true'\n            - '-DisableCatchupQuickScan 1'\n            - '-DisableIntrusionPreventionSystem $true'\n            - '-DisableIntrusionPreventionSystem 1'\n            - '-DisableIOAVProtection $true'\n            - '-DisableIOAVProtection 1'\n            - '-DisableRealtimeMonitoring $true'\n            - '-DisableRealtimeMonitoring 1'\n            - '-DisableRemovableDriveScanning $true'\n            - '-DisableRemovableDriveScanning 1'\n            - '-DisableScanningMappedNetworkDrivesForFullScan $true'\n            - '-DisableScanningMappedNetworkDrivesForFullScan 1'\n            - '-DisableScanningNetworkFiles $true'\n            - '-DisableScanningNetworkFiles 1'\n            - '-DisableScriptScanning $true'\n            - '-DisableScriptScanning 1'\n            - '-MAPSReporting $false'\n            - '-MAPSReporting 0'\n            - '-drdsc $true'\n            - '-drdsc 1'\n            - '-drtm $true'\n            - '-drtm 1'\n            - '-dscrptsc $true'\n            - '-dscrptsc 1'\n            - '-dsmndf $true'\n            - '-dsmndf 1'\n            - '-dsnf $true'\n            - '-dsnf 1'\n            - '-dss $true'\n            - '-dss 1'\n    selection_other_default_actions_allow:\n        ScriptBlockText|contains: 'Set-MpPreference'\n    selection_other_default_actions_func:\n        ScriptBlockText|contains:\n            - 'HighThreatDefaultAction Allow'\n            - 'htdefac Allow'\n            - 'LowThreatDefaultAction Allow'\n            - 'ltdefac Allow'\n            - 'ModerateThreatDefaultAction Allow'\n            - 'mtdefac Allow'\n            - 'SevereThreatDefaultAction Allow'\n            - 'stdefac Allow'\n    condition: all of selection_options_disabling_* or all of selection_other_default_actions_*\nfalsepositives:\n    - Legitimate PowerShell scripts that disable Windows Defender for troubleshooting purposes. Must be investigated.\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_tamper_windows_defender_rem_mp.yml","content":"title: Tamper Windows Defender Remove-MpPreference - ScriptBlockLogging\nid: ae2bdd58-0681-48ac-be7f-58ab4e593458\nrelated:\n    - id: 07e3cb2c-0608-410d-be4b-1511cb1a0448\n      type: similar\nstatus: test\ndescription: Detects attempts to remove Windows Defender configuration using the 'MpPreference' cmdlet\nreferences:\n    - https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/windows-10-controlled-folder-access-event-search/ba-p/2326088\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-05\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_remove:\n        ScriptBlockText|contains: 'Remove-MpPreference'\n    selection_tamper:\n        ScriptBlockText|contains:\n            - '-ControlledFolderAccessProtectedFolders '\n            - '-AttackSurfaceReductionRules_Ids '\n            - '-AttackSurfaceReductionRules_Actions '\n            - '-CheckForSignaturesBeforeRunningScan '\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_syncappvpublishingserver_exe.yml","content":"title: SyncAppvPublishingServer Execution to Bypass Powershell Restriction\nid: dddfebae-c46f-439c-af7a-fdb6bde90218\nrelated:\n    - id: fde7929d-8beb-4a4c-b922-be9974671667\n      type: derived\n    - id: 9f7aa113-9da6-4a8d-907c-5f1a4b908299\n      type: derived\nstatus: test\ndescription: Detects SyncAppvPublishingServer process execution which usually utilized by adversaries to bypass PowerShell execution restrictions.\nreferences:\n    - https://lolbas-project.github.io/lolbas/Binaries/Syncappvpublishingserver/\nauthor: 'Ensar Åžamil, @sblmsrsn, OSCD Community'\ndate: 2020-10-05\nmodified: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.t1218\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: 'SyncAppvPublishingServer.exe'\n    condition: selection\nfalsepositives:\n    - App-V clients\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_zip_compress.yml","content":"title: Zip A Folder With PowerShell For Staging In Temp - PowerShell Script\nid: b7a3c9a3-09ea-4934-8864-6a32cacd98d9 # PowerShell Script\nrelated:\n    - id: 71ff406e-b633-4989-96ec-bc49d825a412 # PowerShell Classic\n      type: similar\n    - id: daf7eb81-35fd-410d-9d7a-657837e602bb # PowerShell Module\n      type: similar\n    - id: 85a8e5ba-bd03-4bfb-bbfa-a4409a8f8b98 # Process Creation\n      type: similar\nstatus: test\ndescription: |\n    Detects PowerShell scripts that make use of the \"Compress-Archive\" Cmdlet in order to compress folders and files where the output is stored in a potentially suspicious location that is used often by malware for exfiltration.\n    An adversary might compress data (e.g., sensitive documents) that is collected prior to exfiltration in order to make it portable and minimize the amount of data sent over the network.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1074.001/T1074.001.md\n    - https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-347a\nauthor: Nasreddine Bencherchali (Nextron Systems), frack113\ndate: 2021-07-20\nmodified: 2023-12-18\ntags:\n    - attack.collection\n    - attack.t1074.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Compress-Archive -Path*-DestinationPath $env:TEMP'\n            - 'Compress-Archive -Path*-DestinationPath*\\AppData\\Local\\Temp\\'\n            - 'Compress-Archive -Path*-DestinationPath*:\\Windows\\Temp\\'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_write_eventlog.yml","content":"title: PowerShell Write-EventLog Usage\nid: 35f41cd7-c98e-469f-8a02-ec4ba0cc7a7e\nstatus: test\ndescription: Detects usage of the \"Write-EventLog\" cmdlet with 'RawData' flag. The cmdlet can be levreage to write malicious payloads to the EventLog and then retrieve them later for later use\nreferences:\n    - https://www.blackhillsinfosec.com/windows-event-logs-for-red-teams/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-08-16\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Write-EventLog'\n            - '-RawData '\n    condition: selection\nfalsepositives:\n    - Legitimate applications writing events via this cmdlet. Investigate alerts to determine if the action is benign\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_windowstyle.yml","content":"title: Suspicious PowerShell WindowStyle Option\nid: 313fbb0a-a341-4682-848d-6d6f8c4fab7c\nstatus: test\ndescription: |\n    Adversaries may use hidden windows to conceal malicious activity from the plain sight of users.\n    In some cases, windows that would typically be displayed when an application carries out an operation can be hidden\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1564.003/T1564.003.md\nauthor: frack113, Tim Shelton (fp AWS)\ndate: 2021-10-20\nmodified: 2023-01-03\ntags:\n    - attack.defense-evasion\n    - attack.t1564.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'powershell'\n            - 'WindowStyle'\n            - 'Hidden'\n    filter:\n        ScriptBlockText|contains|all:\n            - ':\\Program Files\\Amazon\\WorkSpacesConfig\\Scripts\\'\n            - '$PSScriptRoot\\Module\\WorkspaceScriptModule\\WorkspaceScriptModule'\n    condition: selection and not filter\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_win32_shadowcopy_deletion.yml","content":"title: Deletion of Volume Shadow Copies via WMI with PowerShell - PS Script\nid: c1337eb8-921a-4b59-855b-4ba188ddcc42\nrelated:\n    - id: e17121b4-ef2a-4418-8a59-12fb1631fa9e\n      type: derived\n    - id: 21ff4ca9-f13a-41ad-b828-0077b2af2e40\n      type: similar\nstatus: test\ndescription: Detects deletion of Windows Volume Shadow Copies with PowerShell code and Get-WMIObject. This technique is used by numerous ransomware families such as Sodinokibi/REvil\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1490/T1490.md#atomic-test-5---windows---delete-volume-shadow-copies-via-wmi-with-powershell\n    - https://www.elastic.co/guide/en/security/current/volume-shadow-copy-deletion-via-powershell.html\nauthor: Tim Rauch, frack113\ndate: 2022-09-20\nmodified: 2022-12-02\ntags:\n    - attack.impact\n    - attack.t1490\nlogsource:\n    category: ps_script\n    product: windows\ndetection:\n    selection_get:\n        ScriptBlockText|contains:\n            - 'Get-WmiObject'\n            - 'gwmi'\n            - 'Get-CimInstance'\n            - 'gcim'\n    selection_shadowcopy:\n        ScriptBlockText|contains: 'Win32_ShadowCopy'\n    selection_delete:\n        ScriptBlockText|contains:\n            - '.Delete()'\n            - 'Remove-WmiObject'\n            - 'rwmi'\n            - 'Remove-CimInstance'\n            - 'rcim'\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_win32_pnpentity.yml","content":"title: Powershell Suspicious Win32_PnPEntity\nid: b26647de-4feb-4283-af6b-6117661283c5\nstatus: test\ndescription: Adversaries may attempt to gather information about attached peripheral devices and components connected to a computer system.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1120/T1120.md\nauthor: frack113\ndate: 2021-08-23\nmodified: 2022-12-25\ntags:\n    - attack.discovery\n    - attack.t1120\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: Win32_PnPEntity\n    condition: selection\nfalsepositives:\n    - Admin script\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_wallpaper.yml","content":"title: Replace Desktop Wallpaper by Powershell\nid: c5ac6a1e-9407-45f5-a0ce-ca9a0806a287\nstatus: test\ndescription: |\n    An adversary may deface systems internal to an organization in an attempt to intimidate or mislead users.\n    This may take the form of modifications to internal websites, or directly to user systems with the replacement of the desktop wallpaper\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1491.001/T1491.001.md\nauthor: frack113\ndate: 2021-12-26\ntags:\n    - attack.impact\n    - attack.t1491.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_1:\n        ScriptBlockText|contains|all:\n            - 'Get-ItemProperty'\n            - 'Registry::'\n            - 'HKEY_CURRENT_USER\\Control Panel\\Desktop\\'\n            - 'WallPaper'\n    selection_2:\n        ScriptBlockText|contains: SystemParametersInfo(20,0,*,3)\n    condition: 1 of selection_*\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_unblock_file.yml","content":"title: Suspicious Unblock-File\nid: 5947497f-1aa4-41dd-9693-c9848d58727d\nstatus: test\ndescription: Remove the Zone.Identifier alternate data stream which identifies the file as downloaded from the internet.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.005/T1553.005.md#atomic-test-3---remove-the-zoneidentifier-alternate-data-stream\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/unblock-file?view=powershell-7.2\nauthor: frack113\ndate: 2022-02-01\ntags:\n    - attack.defense-evasion\n    - attack.t1553.005\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Unblock-File '\n            - '-Path '\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_start_process.yml","content":"title: Suspicious Start-Process PassThru\nid: 0718cd72-f316-4aa2-988f-838ea8533277\nstatus: test\ndescription: Powershell use PassThru option to start in background\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1036.003/T1036.003.md\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/Start-Process?view=powershell-5.1&viewFallbackFrom=powershell-7\nauthor: frack113\ndate: 2022-01-15\ntags:\n    - attack.defense-evasion\n    - attack.t1036.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - Start-Process\n            - '-PassThru '\n            - '-FilePath '\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_ssl_keyword.yml","content":"title: Suspicious SSL Connection\nid: 195626f3-5f1b-4403-93b7-e6cfd4d6a078\nstatus: test\ndescription: Adversaries may employ a known encryption algorithm to conceal command and control traffic rather than relying on any inherent protections provided by a communication protocol.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1573/T1573.md#atomic-test-1---openssl-c2\n    - https://medium.com/walmartglobaltech/openssl-server-reverse-shell-from-windows-client-aee2dbfa0926\nauthor: frack113\ndate: 2022-01-23\ntags:\n    - attack.command-and-control\n    - attack.t1573\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - System.Net.Security.SslStream\n            - Net.Security.RemoteCertificateValidationCallback\n            - '.AuthenticateAsClient'\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_smb_share_reco.yml","content":"title: Suspicious Get Information for SMB Share\nid: 95f0643a-ed40-467c-806b-aac9542ec5ab\nstatus: test\ndescription: |\n    Adversaries may look for folders and drives shared on remote systems as a means of identifying sources of information to gather as\n    a precursor for Collection and to identify potential systems of interest for Lateral Movement.\n    Networks often contain shared network drives and folders that enable users to access file directories on various systems across a network.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1069.002/T1069.002.md\nauthor: frack113\ndate: 2021-12-15\nmodified: 2022-12-25\ntags:\n    - attack.discovery\n    - attack.t1069.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: get-smbshare\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_set_alias.yml","content":"title: Potential PowerShell Obfuscation Using Alias Cmdlets\nid: 96cd126d-f970-49c4-848a-da3a09f55c55\nrelated:\n    - id: e8314f79-564d-4f79-bc13-fbc0bf2660d8\n      type: derived\nstatus: test\ndescription: Detects Set-Alias or New-Alias cmdlet usage. Which can be use as a mean to obfuscate PowerShell scripts\nreferences:\n    - https://github.com/1337Rin/Swag-PSO\nauthor: frack113\ndate: 2023-01-08\nmodified: 2025-10-22\ntags:\n    - attack.defense-evasion\n    - attack.execution\n    - attack.t1027\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Set-Alias '\n            - 'New-Alias '\n    filter_main_cim:\n        ScriptBlockText:\n            - 'Set-Alias -Name ncms -Value New-CimSession -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name gcls -Value Get-CimClass -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name ncso -Value New-CimSessionOption -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name gcms -Value Get-CimSession -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name rcms -Value Remove-cimSession -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name rcie -Value Register-CimIndicationEvent -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name gcai -Value Get-CimAssociatedInstance -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name gcim -Value Get-CimInstance -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name scim -Value Set-CimInstance -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name ncim -Value New-CimInstance -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name rcim -Value Remove-cimInstance -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n            - 'Set-Alias -Name icim -Value Invoke-CimMethod -Option ReadOnly, AllScope -ErrorAction SilentlyContinue'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_service_dacl_modification_set_service.yml","content":"title: Suspicious Service DACL Modification Via Set-Service Cmdlet - PS\nid: 22d80745-6f2c-46da-826b-77adaededd74\nrelated:\n    - id: a95b9b42-1308-4735-a1af-abb1c5e6f5ac\n      type: similar\nstatus: test\ndescription: Detects usage of the \"Set-Service\" powershell cmdlet to configure a new SecurityDescriptor that allows a service to be hidden from other utilities such as \"sc.exe\", \"Get-Service\"...etc. (Works only in powershell 7)\nreferences:\n    - https://twitter.com/Alh4zr3d/status/1580925761996828672\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/set-service?view=powershell-7.2\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-10-24\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1574.011\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_sddl_flag:\n        ScriptBlockText|contains:\n            - '-SecurityDescriptorSddl '\n            - '-sd '\n    selection_set_service:\n        ScriptBlockText|contains|all:\n            - 'Set-Service '\n            - 'D;;'\n        ScriptBlockText|contains:\n            - ';;;IU'\n            - ';;;SU'\n            - ';;;BA'\n            - ';;;SY'\n            - ';;;WD'\n    condition: all of selection_*\nfalsepositives:\n    - Rare intended use of hidden services\n    - Rare FP could occur due to the non linearity of the ScriptBlockText log\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_remove_adgroupmember.yml","content":"title: Remove Account From Domain Admin Group\nid: 48a45d45-8112-416b-8a67-46e03a4b2107\nstatus: test\ndescription: |\n    Adversaries may interrupt availability of system and network resources by inhibiting access to accounts utilized by legitimate users.\n    Accounts may be deleted, locked, or manipulated (ex: changed credentials) to remove access to accounts.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1531/T1531.md#atomic-test-3---remove-account-from-domain-admin-group\nauthor: frack113\ndate: 2021-12-26\ntags:\n    - attack.impact\n    - attack.t1531\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Remove-ADGroupMember'\n            - '-Identity '\n            - '-Members '\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_recon_export.yml","content":"title: Recon Information for Export with PowerShell\nid: a9723fcc-881c-424c-8709-fd61442ab3c3\nstatus: test\ndescription: Once established within a system or network, an adversary may use automated techniques for collecting internal data\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1119/T1119.md\nauthor: frack113\ndate: 2021-07-30\nmodified: 2022-12-25\ntags:\n    - attack.collection\n    - attack.t1119\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_action:\n        ScriptBlockText|contains:\n            - 'Get-Service '\n            - 'Get-ChildItem '\n            - 'Get-Process '\n    selection_redirect:\n        ScriptBlockText|contains: '> $env:TEMP\\'\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_proxy_scripts.yml","content":"title: Suspicious TCP Tunnel Via PowerShell Script\nid: bd33d2aa-497e-4651-9893-5c5364646595\nstatus: test\ndescription: Detects powershell scripts that creates sockets/listeners which could be indicative of tunneling activity\nreferences:\n    - https://github.com/Arno0x/PowerShellScripts/blob/a6b7d5490fbf0b20f91195838f3a11156724b4f7/proxyTunnel.ps1\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-08\ntags:\n    - attack.command-and-control\n    - attack.t1090\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - '[System.Net.HttpWebRequest]'\n            - 'System.Net.Sockets.TcpListener'\n            - 'AcceptTcpClient'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_new_psdrive.yml","content":"title: Suspicious New-PSDrive to Admin Share\nid: 1c563233-030e-4a07-af8c-ee0490a66d3a\nstatus: test\ndescription: Adversaries may use to interact with a remote network share using Server Message Block (SMB). The adversary may then perform actions as the logged-on user.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.002/T1021.002.md#atomic-test-2---map-admin-share-powershell\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/new-psdrive?view=powershell-7.2\nauthor: frack113\ndate: 2022-08-13\ntags:\n    - attack.lateral-movement\n    - attack.t1021.002\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'New-PSDrive'\n            - '-psprovider '\n            - 'filesystem'\n            - '-root '\n            - '\\\\\\\\'\n            - '$'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_networkcredential.yml","content":"title: Suspicious Connection to Remote Account\nid: 1883444f-084b-419b-ac62-e0d0c5b3693f\nstatus: test\ndescription: |\n    Adversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts.\n    Without knowledge of the password for an account, an adversary may opt to systematically guess the password using a repetitive or iterative mechanism\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1110.001/T1110.001.md#atomic-test-2---brute-force-credentials-of-single-active-directory-domain-user-via-ldap-against-domain-controller-ntlm-or-kerberos\nauthor: frack113\ndate: 2021-12-27\ntags:\n    - attack.credential-access\n    - attack.t1110.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'System.DirectoryServices.Protocols.LdapDirectoryIdentifier'\n            - 'System.Net.NetworkCredential'\n            - 'System.DirectoryServices.Protocols.LdapConnection'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_mount_diskimage.yml","content":"title: Suspicious Mount-DiskImage\nid: 29e1c216-6408-489d-8a06-ee9d151ef819\nstatus: test\ndescription: Adversaries may abuse container files such as disk image (.iso, .vhd) file formats to deliver malicious payloads that may not be tagged with MOTW.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.005/T1553.005.md#atomic-test-1---mount-iso-image\n    - https://learn.microsoft.com/en-us/powershell/module/storage/mount-diskimage?view=windowsserver2022-ps\nauthor: frack113\ndate: 2022-02-01\ntags:\n    - attack.defense-evasion\n    - attack.t1553.005\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Mount-DiskImage '\n            - '-ImagePath '\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_mounted_share_deletion.yml","content":"title: PowerShell Deleted Mounted Share\nid: 66a4d409-451b-4151-94f4-a55d559c49b0\nstatus: test\ndescription: Detects when when a mounted share is removed. Adversaries may remove share connections that are no longer useful in order to clean up traces of their operation\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.005/T1070.005.md\nauthor: 'oscd.community, @redcanary, Zach Stanford @svch0st'\ndate: 2020-10-08\nmodified: 2025-10-07\ntags:\n    - attack.defense-evasion\n    - attack.t1070.005\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Remove-SmbShare'\n            - 'Remove-FileShare'\n    filter_main_module_load:\n        ScriptBlockText|contains|all:\n            - 'FileShare.cdxml'\n            - 'Microsoft.PowerShell.Core\\Export-ModuleMember'\n            - 'ROOT/Microsoft/Windows/Storage/MSFT_FileShare'\n            - 'ObjectModelWrapper'\n            - 'Cmdletization.MethodParameter'\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Administrators or Power users may remove their shares via cmd line\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_mail_acces.yml","content":"title: Powershell Local Email Collection\nid: 2837e152-93c8-43d2-85ba-c3cd3c2ae614\nstatus: test\ndescription: |\n    Adversaries may target user email on local systems to collect sensitive information.\n    Files containing email data can be acquired from a users local system, such as Outlook storage or cache files.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1114.001/T1114.001.md\nauthor: frack113\ndate: 2021-07-21\nmodified: 2022-12-25\ntags:\n    - attack.collection\n    - attack.t1114.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Get-Inbox.ps1'\n            - 'Microsoft.Office.Interop.Outlook'\n            - 'Microsoft.Office.Interop.Outlook.olDefaultFolders'\n            - '-comobject outlook.application'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_local_group_reco.yml","content":"title: Suspicious Get Local Groups Information - PowerShell\nid: fa6a5a45-3ee2-4529-aa14-ee5edc9e29cb\nrelated:\n    - id: cef24b90-dddc-4ae1-a09a-8764872f69fc\n      type: similar\nstatus: test\ndescription: |\n    Detects the use of PowerShell modules and cmdlets to gather local group information.\n    Adversaries may use local system permission groups to determine which groups exist and which users belong to a particular group such as the local administrators group.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1069.001/T1069.001.md\nauthor: frack113\ndate: 2021-12-12\nmodified: 2025-08-22\ntags:\n    - attack.discovery\n    - attack.t1069.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_localgroup:\n        ScriptBlockText|contains:\n            - 'get-localgroup '\n            - 'get-localgroupmember '\n    selection_wmi_module:\n        ScriptBlockText|contains:\n            - 'get-wmiobject '\n            - 'gwmi '\n            - 'get-ciminstance '\n            - 'gcim '\n    selection_wmi_class:\n        ScriptBlockText|contains: 'win32_group' # Covers both win32_group and win32_groupuser\n    condition: selection_localgroup or all of selection_wmi_*\nfalsepositives:\n    - Inventory scripts or admin tasks\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_keywords.yml","content":"title: Potential Suspicious PowerShell Keywords\nid: 1f49f2ab-26bc-48b3-96cc-dcffbc93eadf\nstatus: test\ndescription: Detects potentially suspicious keywords that could indicate the use of a PowerShell exploitation framework\nreferences:\n    - https://posts.specterops.io/entering-a-covenant-net-command-and-control-e11038bcf462\n    - https://github.com/PowerShellMafia/PowerSploit/blob/d943001a7defb5e0d1657085a77a0e78609be58f/CodeExecution/Invoke-ReflectivePEInjection.ps1\n    - https://github.com/hlldz/Phant0m/blob/30c2935d8cf4aafda17ee2fab7cd0c4aa9a607c2/old/Invoke-Phant0m.ps1\n    - https://gist.github.com/MHaggis/0dbe00ad401daa7137c81c99c268cfb7\nauthor: Florian Roth (Nextron Systems), Perez Diego (@darkquassar), Tuan Le (NCSGroup)\ndate: 2019-02-11\nmodified: 2023-04-21\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'System.Reflection.Assembly.Load($'\n            - '[System.Reflection.Assembly]::Load($'\n            - '[Reflection.Assembly]::Load($'\n            - 'System.Reflection.AssemblyName'\n            - 'Reflection.Emit.AssemblyBuilderAccess'\n            - 'Reflection.Emit.CustomAttributeBuilder'\n            - 'Runtime.InteropServices.UnmanagedType'\n            - 'Runtime.InteropServices.DllImportAttribute'\n            - 'SuspendThread'\n            - 'rundll32'\n            # - 'FromBase64'\n            # - 'Invoke-WMIMethod' # Prone to FP\n            # - 'http://127.0.0.1' # Prone to FP\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_keylogger_activity.yml","content":"title: Potential Keylogger Activity\nid: 965e2db9-eddb-4cf6-a986-7a967df651e4\nstatus: test\ndescription: Detects PowerShell scripts that contains reference to keystroke capturing functions\nreferences:\n    - https://twitter.com/ScumBots/status/1610626724257046529\n    - https://www.virustotal.com/gui/file/d4486b63512755316625230e0c9c81655093be93876e0d80732e7eeaf7d83476/content\n    - https://www.virustotal.com/gui/file/720a7ee9f2178c70501d7e3f4bcc28a4f456e200486dbd401b25af6da3b4da62/content\n    - https://learn.microsoft.com/en-us/dotnet/api/system.windows.input.keyboard.iskeydown?view=windowsdesktop-7.0\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-04\ntags:\n    - attack.collection\n    - attack.credential-access\n    - attack.t1056.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: '[Windows.Input.Keyboard]::IsKeyDown([System.Windows.Input.Key]::'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_iofilestream.yml","content":"title: Suspicious IO.FileStream\nid: 70ad982f-67c8-40e0-a955-b920c2fa05cb\nstatus: test\ndescription: Open a handle on the drive volume via the \\\\.\\ DOS device path specifier and perform direct access read of the first few bytes of the volume.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1006/T1006.md\nauthor: frack113\ndate: 2022-01-09\nmodified: 2022-03-05\ntags:\n    - attack.defense-evasion\n    - attack.t1070.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - New-Object\n            - IO.FileStream\n            - '\\\\\\\\.\\\\'\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_invoke_webrequest_useragent.yml","content":"title: Change User Agents with WebRequest\nid: d4488827-73af-4f8d-9244-7b7662ef046e\nstatus: test\ndescription: |\n    Adversaries may communicate using application layer protocols associated with web traffic to avoid detection/network filtering by blending in with existing traffic.\n    Commands to the remote system, and often the results of those commands, will be embedded within the protocol traffic between the client and server.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1071.001/T1071.001.md#t1071001---web-protocols\nauthor: frack113\ndate: 2022-01-23\nmodified: 2025-07-18\ntags:\n    - attack.command-and-control\n    - attack.t1071.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_webrequest:\n        ScriptBlockText|contains:\n            - 'Invoke-WebRequest'\n            - 'Invoke-RestMethod'\n            - ' irm ' # Space before and after to avoid false positives with 'irm' as a variable\n            - 'iwr '\n    selection_useragent:\n        ScriptBlockText|contains: '-UserAgent '\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_invocation_specific.yml","content":"title: Suspicious PowerShell Invocations - Specific\nid: ae7fbf8e-f3cb-49fd-8db4-5f3bed522c71\nrelated:\n    - id: fce5f582-cc00-41e1-941a-c6fabf0fdb8c\n      type: obsolete\n    - id: 8ff28fdd-e2fa-4dfa-aeda-ef3d61c62090\n      type: similar\n    - id: 536e2947-3729-478c-9903-745aaffe60d2\n      type: similar\nstatus: test\ndescription: Detects suspicious PowerShell invocation command parameters\nreferences:\n    - Internal Research\n    - https://github.com/HackTricks-wiki/hacktricks/blob/e4c7b21b8f36c97c35b7c622732b38a189ce18f7/src/windows-hardening/windows-local-privilege-escalation/privilege-escalation-with-autorun-binaries.md\nauthor: Florian Roth (Nextron Systems), Jonhnathan Ribeiro\ndate: 2017-03-05\nmodified: 2025-02-17\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_convert_b64:\n        ScriptBlockText|contains|all:\n            - '-nop'\n            - ' -w '\n            - 'hidden'\n            - ' -c '\n            - '[Convert]::FromBase64String'\n    selection_iex_selection:\n        ScriptBlockText|contains|all:\n            - ' -w '\n            - 'hidden'\n            - '-noni'\n            - '-nop'\n            - ' -c '\n            - 'iex'\n            - 'New-Object'\n    selection_enc_selection:\n        ScriptBlockText|contains|all:\n            - ' -w '\n            - 'hidden'\n            - '-ep'\n            - 'bypass'\n            - '-Enc'\n    selection_reg_selection:\n        ScriptBlockText|contains|all:\n            - 'powershell'\n            - 'reg'\n            - 'add'\n        ScriptBlockText|contains:\n            - '\\software\\microsoft\\windows\\currentversion\\run'\n            - '\\software\\wow6432node\\microsoft\\windows\\currentversion\\run'\n            - '\\software\\microsoft\\windows\\currentversion\\policies\\explorer\\run'\n    selection_webclient_selection:\n        ScriptBlockText|contains|all:\n            - 'bypass'\n            - '-noprofile'\n            - '-windowstyle'\n            - 'hidden'\n            - 'new-object'\n            - 'system.net.webclient'\n            - '.download'\n    selection_iex_webclient:\n        ScriptBlockText|contains|all:\n            - 'iex'\n            - 'New-Object'\n            - 'Net.WebClient'\n            - '.Download'\n    filter_chocolatey:\n        ScriptBlockText|contains:\n            - \"(New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1\"\n            - \"(New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')\"\n            - 'Write-ChocolateyWarning'\n    condition: 1 of selection_* and not 1 of filter_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_invocation_generic.yml","content":"title: Suspicious PowerShell Invocations - Generic\nid: ed965133-513f-41d9-a441-e38076a0798f\nrelated:\n    - id: 3d304fda-78aa-43ed-975c-d740798a49c1\n      type: derived\n    - id: bbb80e91-5746-4fbe-8898-122e2cafdbf4\n      type: similar\nstatus: test\ndescription: Detects suspicious PowerShell invocation command parameters\nreferences:\n    - Internal Research\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-03-12\nmodified: 2023-01-03\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_encoded:\n        ScriptBlockText|contains:\n            - ' -enc '\n            - ' -EncodedCommand '\n            - ' -ec '\n    selection_hidden:\n        ScriptBlockText|contains:\n            - ' -w hidden '\n            - ' -window hidden '\n            - ' -windowstyle hidden '\n            - ' -w 1 '\n    selection_noninteractive:\n        ScriptBlockText|contains:\n            - ' -noni '\n            - ' -noninteractive '\n    condition: all of selection*\nfalsepositives:\n    - Very special / sneaky PowerShell scripts\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_hyper_v_condlet.yml","content":"title: Suspicious Hyper-V Cmdlets\nid: 42d36aa1-3240-4db0-8257-e0118dcdd9cd\nstatus: test\ndescription: Adversaries may carry out malicious operations using a virtual instance to avoid detection\nreferences:\n    - https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1564.006/T1564.006.md#atomic-test-3---create-and-start-hyper-v-virtual-machine\nauthor: frack113\ndate: 2022-04-09\ntags:\n    - attack.defense-evasion\n    - attack.t1564.006\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - New-VM\n            - Set-VMFirmware\n            - Start-VM\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_get_process.yml","content":"title: Suspicious Process Discovery With Get-Process\nid: af4c87ce-bdda-4215-b998-15220772e993\nstatus: test\ndescription: Get the processes that are running on the local computer.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1057/T1057.md#atomic-test-3---process-discovery---get-process\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-process?view=powershell-7.4\nauthor: frack113\ndate: 2022-03-17\ntags:\n    - attack.discovery\n    - attack.t1057\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: Get-Process\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_get_gpo.yml","content":"title: Suspicious GPO Discovery With Get-GPO\nid: eb2fd349-ec67-4caa-9143-d79c7fb34441\nstatus: test\ndescription: Detect use of Get-GPO to get one GPO or all the GPOs in a domain.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1615/T1615.md\n    - https://learn.microsoft.com/en-us/powershell/module/grouppolicy/get-gpo?view=windowsserver2022-ps\nauthor: frack113\ndate: 2022-06-04\ntags:\n    - attack.discovery\n    - attack.t1615\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: Get-GPO\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_get_current_user.yml","content":"title: Suspicious PowerShell Get Current User\nid: 4096a49c-7de4-4da0-a230-c66ccd56ea5a\nstatus: test\ndescription: Detects the use of PowerShell to identify the current logged user.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1033/T1033.md#atomic-test-4---user-discovery-with-env-vars-powershell-script\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1033/T1033.md#atomic-test-5---getcurrent-user-with-powershell-script\nauthor: frack113\ndate: 2022-04-04\ntags:\n    - attack.discovery\n    - attack.t1033\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - '[System.Environment]::UserName'\n            - '$env:UserName'\n            - '[System.Security.Principal.WindowsIdentity]::GetCurrent()'\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_get_addefaultdomainpasswordpolicy.yml","content":"title: Password Policy Discovery With Get-AdDefaultDomainPasswordPolicy\nid: bbb9495b-58fc-4016-b9df-9a3a1b67ca82\nstatus: test\ndescription: Detetcts PowerShell activity in which Get-Addefaultdomainpasswordpolicy is used to get the default password policy for an Active Directory domain.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1201/T1201.md#atomic-test-9---enumerate-active-directory-password-policy-with-get-addefaultdomainpasswordpolicy\n    - https://learn.microsoft.com/en-us/powershell/module/activedirectory/get-addefaultdomainpasswordpolicy?view=windowsserver2022-ps\nauthor: frack113\ndate: 2022-03-17\ntags:\n    - attack.discovery\n    - attack.t1201\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: Get-AdDefaultDomainPasswordPolicy\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_gettypefromclsid.yml","content":"title: Suspicious GetTypeFromCLSID ShellExecute\nid: 8bc063d5-3a3a-4f01-a140-bc15e55e8437\nstatus: test\ndescription: Detects suspicious Powershell code that execute COM Objects\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1546.015/T1546.015.md#atomic-test-2---powershell-execute-com-object\nauthor: frack113\ndate: 2022-04-02\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1546.015\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - '::GetTypeFromCLSID('\n            - '.ShellExecute('\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_getprocess_lsass.yml","content":"title: PowerShell Get-Process LSASS in ScriptBlock\nid: 84c174ab-d3ef-481f-9c86-a50d0b8e3edb\nstatus: test\ndescription: Detects a Get-Process command on lsass process, which is in almost all cases a sign of malicious activity\nreferences:\n    - https://web.archive.org/web/20220205033028/https://twitter.com/PythonResponder/status/1385064506049630211\nauthor: Florian Roth (Nextron Systems)\ndate: 2021-04-23\nmodified: 2022-12-25\ntags:\n    - attack.credential-access\n    - attack.t1003.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: 'Get-Process lsass'\n    condition: selection\nfalsepositives:\n    - Legitimate certificate exports invoked by administrators or users (depends on processes in the environment - filter if unusable)\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_follina_execution.yml","content":"title: Troubleshooting Pack Cmdlet Execution\nid: 03409c93-a7c7-49ba-9a4c-a00badf2a153\nstatus: test\ndescription: Detects execution of \"TroubleshootingPack\" cmdlets to leverage CVE-2022-30190 or action similar to \"msdt\" lolbin (as described in LOLBAS)\nreferences:\n    - https://twitter.com/nas_bench/status/1537919885031772161\n    - https://lolbas-project.github.io/lolbas/Binaries/Msdt/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-06-21\ntags:\n    - attack.defense-evasion\n    - attack.t1202\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Invoke-TroubleshootingPack'\n            - 'C:\\Windows\\Diagnostics\\System\\PCW'\n            - '-AnswerFile'\n            - '-Unattended'\n    condition: selection\nfalsepositives:\n    - Legitimate usage of \"TroubleshootingPack\" cmdlet for troubleshooting purposes\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_extracting.yml","content":"title: Extracting Information with PowerShell\nid: bd5971a7-626d-46ab-8176-ed643f694f68\nstatus: test\ndescription: |\n    Adversaries may search local file systems and remote file shares for files containing insecurely stored credentials.\n    These can be files created by users to store their own credentials, shared credential stores for a group of individuals,\n    configuration files containing passwords for a system or service, or source code/binary files containing embedded passwords.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1552.001/T1552.001.md\nauthor: frack113\ndate: 2021-12-19\nmodified: 2022-12-25\ntags:\n    - attack.credential-access\n    - attack.t1552.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - ls\n            - ' -R'\n            - 'select-string '\n            - '-Pattern '\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_execute_batch_script.yml","content":"title: Powershell Execute Batch Script\nid: b5522a23-82da-44e5-9c8b-e10ed8955f88\nstatus: test\ndescription: |\n    Adversaries may abuse the Windows command shell for execution.\n    The Windows command shell ([cmd](https://attack.mitre.org/software/S0106)) is the primary command prompt on Windows systems.\n    The Windows command prompt can be used to control almost any aspect of a system, with various permission levels required for different subsets of commands.\n    Batch files (ex: .bat or .cmd) also provide the shell with a list of sequential commands to run, as well as normal scripting operations such as conditionals and loops.\n    Common uses of batch files include long or repetitive tasks, or the need to run the same set of commands on multiple system\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1059.003/T1059.003.md#atomic-test-1---create-and-execute-batch-script\nauthor: frack113\ndate: 2022-01-02\ntags:\n    - attack.execution\n    - attack.t1059.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_start:\n        ScriptBlockText|contains: Start-Process\n    selection_batch:\n        ScriptBlockText|contains:\n            - '.cmd'\n            - '.bat'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate administration script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_download.yml","content":"title: Suspicious PowerShell Download - Powershell Script\nid: 403c2cc0-7f6b-4925-9423-bfa573bed7eb\nrelated:\n    - id: 65531a81-a694-4e31-ae04-f8ba5bc33759\n      type: derived\nstatus: test\ndescription: Detects suspicious PowerShell download command\nreferences:\n    - https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-8.0\n    - https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-8.0\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-03-05\nmodified: 2022-12-02\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    webclient:\n        ScriptBlockText|contains: 'System.Net.WebClient'\n    download:\n        ScriptBlockText|contains:\n            - '.DownloadFile('\n            - '.DownloadFileAsync('\n            - '.DownloadString('\n            - '.DownloadStringAsync('\n    condition: webclient and download\nfalsepositives:\n    - PowerShell scripts that download content from the Internet\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_directory_enum.yml","content":"title: Powershell Directory Enumeration\nid: 162e69a7-7981-4344-84a9-0f1c9a217a52\nstatus: test\ndescription: Detects technique used by MAZE ransomware to enumerate directories using Powershell\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1083/T1083.md\n    - https://www.mandiant.com/resources/tactics-techniques-procedures-associated-with-maze-ransomware-incidents\nauthor: frack113\ndate: 2022-03-17\ntags:\n    - attack.discovery\n    - attack.t1083\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - foreach\n            - Get-ChildItem\n            - '-Path '\n            - '-ErrorAction '\n            - SilentlyContinue\n            - 'Out-File '\n            - '-append'\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_clear_eventlog.yml","content":"title: Suspicious Eventlog Clear\nid: 0f017df3-8f5a-414f-ad6b-24aff1128278\nrelated:\n    - id: cc36992a-4671-4f21-a91d-6c2b72a2edf5\n      type: derived\nstatus: test\ndescription: Detects usage of known powershell cmdlets such as \"Clear-EventLog\" to clear the Windows event logs\nreferences:\n    - https://twitter.com/oroneequalsone/status/1568432028361830402\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.001/T1070.001.md\n    - https://eqllib.readthedocs.io/en/latest/analytics/5b223758-07d6-4100-9e11-238cfdd0fe97.html\n    - https://stackoverflow.com/questions/66011412/how-to-clear-a-event-log-in-powershell-7\n    - https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventing.reader.eventlogsession.clearlog?view=windowsdesktop-9.0&viewFallbackFrom=dotnet-plat-ext-5.0#System_Diagnostics_Eventing_Reader_EventLogSession_ClearLog_System_String_\n    - https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventlog.clear\nauthor: Nasreddine Bencherchali (Nextron Systems), Swachchhanda Shrawan Poudel (Nextron Systems)\ndate: 2022-09-12\nmodified: 2025-10-06\ntags:\n    - attack.defense-evasion\n    - attack.t1070.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        - ScriptBlockText|contains:\n              - 'Clear-EventLog '\n              - 'Remove-EventLog '\n              - 'Limit-EventLog '\n              - 'Clear-WinEvent '\n        - ScriptBlockText|contains|all:\n              - 'Eventing.Reader.EventLogSession' # [System.Diagnostics.Eventing.Reader.EventLogSession]::GlobalSession.ClearLog($_.LogName)\n              - 'ClearLog'\n        - ScriptBlockText|contains|all:\n              - 'Diagnostics.EventLog'\n              - 'Clear'\n    condition: selection\nfalsepositives:\n    - Rare need to clear logs before doing something. Sometimes used by installers or cleaner scripts. The script should be investigated to determine if it's legitimate\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_alias_obfscuation.yml","content":"title: Potential PowerShell Obfuscation Using Character Join\nid: e8314f79-564d-4f79-bc13-fbc0bf2660d8\nrelated:\n    - id: 96cd126d-f970-49c4-848a-da3a09f55c55\n      type: derived\nstatus: test\ndescription: Detects specific techniques often seen used inside of PowerShell scripts to obfscuate Alias creation\nreferences:\n    - Internal Research\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-09\ntags:\n    - attack.defense-evasion\n    - attack.execution\n    - attack.t1027\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        # Example:\n        #   Set-Alias -Name Y -Value (-join(\"Ne\",\"w-O\",\"bje\",\"ct\"))\n        #   Set-Alias -Name X -Value (-join(\"Inv\",\"oke\",\"-\",\"Exp\",\"ression\"))\n        ScriptBlockText|contains|all:\n            - '-Alias' # For both \"New-Alias\" and \"Set-Alias\"\n            - ' -Value (-join('\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_ad_group_reco.yml","content":"title: AD Groups Or Users Enumeration Using PowerShell - ScriptBlock\nid: 88f0884b-331d-403d-a3a1-b668cf035603\nstatus: test\ndescription: |\n    Adversaries may attempt to find domain-level groups and permission settings.\n    The knowledge of domain-level permission groups can help adversaries determine which groups exist and which users belong to a particular group.\n    Adversaries may use this information to determine which users have elevated permissions, such as domain administrators.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1069.002/T1069.002.md\nauthor: frack113\ndate: 2021-12-15\nmodified: 2022-12-25\ntags:\n    - attack.discovery\n    - attack.t1069.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    test_2:\n        ScriptBlockText|contains: get-ADPrincipalGroupMembership\n    test_7:\n        ScriptBlockText|contains|all:\n            - get-aduser\n            - '-f '\n            - '-pr '\n            - DoesNotRequirePreAuth\n    condition: 1 of test_*\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_susp_ace_tampering.yml","content":"title: Potential Persistence Via Security Descriptors - ScriptBlock\nid: 2f77047c-e6e9-4c11-b088-a3de399524cd\nstatus: test\ndescription: Detects usage of certain functions and keywords that are used to manipulate security descriptors in order to potentially set a backdoor. As seen used in the DAMP project.\nreferences:\n    - https://github.com/HarmJ0y/DAMP\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-05\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.privilege-escalation\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'win32_Trustee'\n            - 'win32_Ace'\n            - '.AccessMask'\n            - '.AceType'\n            - '.SetSecurityDescriptor'\n        ScriptBlockText|contains:\n            - '\\Lsa\\JD'\n            - '\\Lsa\\Skew1'\n            - '\\Lsa\\Data'\n            - '\\Lsa\\GBG'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_store_file_in_alternate_data_stream.yml","content":"title: Powershell Store File In Alternate Data Stream\nid: a699b30e-d010-46c8-bbd1-ee2e26765fe9\nstatus: test\ndescription: Storing files in Alternate Data Stream (ADS) similar to Astaroth malware.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1564.004/T1564.004.md\nauthor: frack113\ndate: 2021-09-02\nmodified: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.t1564.004\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_compspec:\n        ScriptBlockText|contains|all:\n            - 'Start-Process'\n            - '-FilePath \"$env:comspec\" '\n            - '-ArgumentList '\n            - '>'\n    condition: selection_compspec\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_software_discovery.yml","content":"title: Detected Windows Software Discovery - PowerShell\nid: 2650dd1a-eb2a-412d-ac36-83f06c4f2282\nstatus: test\ndescription: Adversaries may attempt to enumerate software for a variety of reasons, such as figuring out what security measures are present or if the compromised system has a version of software that is vulnerable.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1518/T1518.md\n    - https://github.com/harleyQu1nn/AggressorScripts # AVQuery.cna\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-16\nmodified: 2022-12-02\ntags:\n    - attack.discovery\n    - attack.t1518\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            # Example: Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* | Select-Object DisplayName, DisplayVersion, Publisher, InstallDate | Format-Table -Autosize\n            - 'get-itemProperty'\n            - '\\software\\'\n            - 'select-object'\n            - 'format-table'\n    condition: selection\nfalsepositives:\n    - Legitimate administration activities\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_shellintel_malicious_commandlets.yml","content":"title: Malicious ShellIntel PowerShell Commandlets\nid: 402e1e1d-ad59-47b6-bf80-1ee44985b3a7\nstatus: test\ndescription: Detects Commandlet names from ShellIntel exploitation scripts.\nreferences:\n    - https://github.com/Shellntel/scripts/\nauthor: Max Altgelt (Nextron Systems), Tobias Michalski (Nextron Systems)\ndate: 2021-08-09\nmodified: 2023-01-02\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Invoke-SMBAutoBrute'\n            - 'Invoke-GPOLinks'\n            # - 'Out-Minidump' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            - 'Invoke-Potato'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_shellcode_b64.yml","content":"title: PowerShell ShellCode\nid: 16b37b70-6fcf-4814-a092-c36bd3aafcbd\nstatus: test\ndescription: Detects Base64 encoded Shellcode\nreferences:\n    - https://twitter.com/cyb3rops/status/1063072865992523776\nauthor: David Ledbetter (shellcode), Florian Roth (Nextron Systems)\ndate: 2018-11-17\nmodified: 2024-01-25\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1055\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'OiCAAAAYInlM'\n            - 'OiJAAAAYInlM'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_set_policies_to_unsecure_level.yml","content":"title: Change PowerShell Policies to an Insecure Level - PowerShell\nid: 61d0475c-173f-4844-86f7-f3eebae1c66b\nrelated:\n    - id: cf2e938e-9a3e-4fe8-a347-411642b28a9f # ProcCreation Registry\n      type: similar\n    - id: 87e3c4e8-a6a8-4ad9-bb4f-46e7ff99a180 # ProcCreation Cmdlet\n      type: similar\n    - id: fad91067-08c5-4d1a-8d8c-d96a21b37814 # Registry\n      type: similar\nstatus: test\ndescription: Detects changing the PowerShell script execution policy to a potentially insecure level using the \"Set-ExecutionPolicy\" cmdlet.\nreferences:\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7.4\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.4\n    - https://adsecurity.org/?p=2604\nauthor: frack113\ndate: 2021-10-20\nmodified: 2023-12-14\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains: 'Set-ExecutionPolicy'\n    selection_option:\n        ScriptBlockText|contains:\n            - 'Unrestricted'\n            - 'bypass'\n    filter_optional_chocolatey:\n        ScriptBlockText|contains:\n            - \"(New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1')\"\n            - \"(New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')\"\n    condition: all of selection_* and not 1 of filter_optional_*\nfalsepositives:\n    - Administrator script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_set_acl_susp_location.yml","content":"title: PowerShell Set-Acl On Windows Folder - PsScript\nid: 3bf1d859-3a7e-44cb-8809-a99e066d3478\nrelated:\n    - id: cae80281-ef23-44c5-873b-fd48d2666f49 # PsScript Low\n      type: derived\n    - id: 0944e002-e3f6-4eb5-bf69-3a3067b53d73 # ProcCreation Susp\n      type: derived\n    - id: bdeb2cff-af74-4094-8426-724dc937f20a # ProcCreation Low\n      type: derived\nstatus: test\ndescription: Detects PowerShell scripts to set the ACL to a file in the Windows folder\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/74438b0237d141ee9c99747976447dc884cb1a39/atomics/T1505.005/T1505.005.md\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-acl?view=powershell-5.1\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-07-18\ntags:\n    - attack.defense-evasion\n    - attack.t1222\nlogsource:\n    product: windows\n    category: ps_script\n    definition: bade5735-5ab0-4aa7-a642-a11be0e40872\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains|all:\n            - 'Set-Acl '\n            - '-AclObject '\n    selection_paths:\n        # Note: Add more suspicious paths\n        ScriptBlockText|contains:\n            - '-Path \"C:\\Windows'\n            - '-Path \"C:/Windows'\n            - \"-Path 'C:\\\\Windows\"\n            - \"-Path 'C:/Windows\"\n            - '-Path C:\\\\Windows'\n            - '-Path C:/Windows'\n            - '-Path $env:windir'\n            - '-Path \"$env:windir'\n            - \"-Path '$env:windir\"\n    selection_permissions:\n        # Note: Add more suspicious permissions\n        ScriptBlockText|contains:\n            - 'FullControl'\n            - 'Allow'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_set_acl.yml","content":"title: PowerShell Script Change Permission Via Set-Acl - PsScript\nid: cae80281-ef23-44c5-873b-fd48d2666f49\nrelated:\n    - id: 0944e002-e3f6-4eb5-bf69-3a3067b53d73 # ProcCreation Susp\n      type: derived\n    - id: bdeb2cff-af74-4094-8426-724dc937f20a # ProcCreation Low\n      type: derived\n    - id: 3bf1d859-3a7e-44cb-8809-a99e066d3478 # PsScript High\n      type: derived\nstatus: test\ndescription: Detects PowerShell scripts set ACL to of a file or a folder\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/74438b0237d141ee9c99747976447dc884cb1a39/atomics/T1505.005/T1505.005.md\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-07-18\ntags:\n    - attack.defense-evasion\n    - attack.t1222\nlogsource:\n    product: windows\n    category: ps_script\n    definition: bade5735-5ab0-4aa7-a642-a11be0e40872\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Set-Acl '\n            - '-AclObject '\n            - '-Path '\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_sensitive_file_discovery.yml","content":"title: Powershell Sensitive File Discovery\nid: 7d416556-6502-45b2-9bad-9d2f05f38997\nrelated:\n    - id: d23f2ba5-9da0-4463-8908-8ee47f614bb9\n      type: derived\nstatus: test\ndescription: Detect adversaries enumerate sensitive files\nreferences:\n    - https://twitter.com/malmoeb/status/1570814999370801158\nauthor: frack113\ndate: 2022-09-16\ntags:\n    - attack.discovery\n    - attack.t1083\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_action:\n        ScriptBlockText|contains:\n            - ls\n            - get-childitem\n            - gci\n    selection_recurse:\n        ScriptBlockText|contains: '-recurse'\n    selection_file:\n        ScriptBlockText|contains:\n            - '.pass'\n            - '.kdbx'\n            - '.kdb'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_script_with_upload_capabilities.yml","content":"title: PowerShell Script With File Upload Capabilities\nid: d2e3f2f6-7e09-4bf2-bc5d-90186809e7fb\nstatus: test\ndescription: Detects PowerShell scripts leveraging the \"Invoke-WebRequest\" cmdlet to send data via either \"PUT\" or \"POST\" method.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1020/T1020.md\n    - https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-webrequest?view=powershell-7.4\nauthor: frack113\ndate: 2022-01-07\nmodified: 2025-07-18\ntags:\n    - attack.exfiltration\n    - attack.t1020\nlogsource:\n    product: windows\n    category: ps_script\n    definition: bade5735-5ab0-4aa7-a642-a11be0e40872\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains:\n            - 'Invoke-RestMethod'\n            - 'Invoke-WebRequest'\n            - 'irm '\n            - 'iwr '\n    selection_flag:\n        ScriptBlockText|contains:\n            - '-Method \"POST\"'\n            - '-Method \"PUT\"'\n            - '-Method POST'\n            - '-Method PUT'\n            - \"-Method 'POST'\"\n            - \"-Method 'PUT'\"\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_run_from_mount_diskimage.yml","content":"title: Suspicious Invoke-Item From Mount-DiskImage\nid: 902cedee-0398-4e3a-8183-6f3a89773a96\nstatus: test\ndescription: Adversaries may abuse container files such as disk image (.iso, .vhd) file formats to deliver malicious payloads that may not be tagged with MOTW.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.005/T1553.005.md#atomic-test-2---mount-an-iso-image-and-run-executable-from-the-iso\n    - https://learn.microsoft.com/en-us/powershell/module/storage/mount-diskimage?view=windowsserver2022-ps\nauthor: frack113\ndate: 2022-02-01\ntags:\n    - attack.defense-evasion\n    - attack.t1553.005\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Mount-DiskImage '\n            - '-ImagePath '\n            - Get-Volume\n            - '.DriveLetter'\n            - 'invoke-item '\n            - '):\\'\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_root_certificate_installed.yml","content":"title: Root Certificate Installed - PowerShell\nid: 42821614-9264-4761-acfc-5772c3286f76\nstatus: test\ndescription: Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to adversary controlled web servers.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.004/T1553.004.md\nauthor: 'oscd.community, @redcanary, Zach Stanford @svch0st'\ndate: 2020-10-10\nmodified: 2022-12-02\ntags:\n    - attack.defense-evasion\n    - attack.t1553.004\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection1:\n        ScriptBlockText|contains|all:\n            - 'Move-Item'\n            - 'Cert:\\LocalMachine\\Root'\n    selection2:\n        ScriptBlockText|contains|all:\n            - 'Import-Certificate'\n            - 'Cert:\\LocalMachine\\Root'\n    condition: 1 of selection*\nfalsepositives:\n    - Help Desk or IT may need to manually add a corporate Root CA on occasion. Need to test if GPO push doesn't trigger FP\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_resolve_list_of_ip_from_file.yml","content":"title: PowerShell Script With File Hostname Resolving Capabilities\nid: fbc5e92f-3044-4e73-a5c6-1c4359b539de\nstatus: test\ndescription: Detects PowerShell scripts that have capabilities to read files, loop through them and resolve DNS host entries.\nreferences:\n    - https://www.fortypoundhead.com/showcontent.asp?artid=24022\n    - https://labs.withsecure.com/publications/fin7-target-veeam-servers\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-05-05\ntags:\n    - attack.exfiltration\n    - attack.t1020\nlogsource:\n    product: windows\n    category: ps_script\n    definition: bade5735-5ab0-4aa7-a642-a11be0e40872\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Get-content '\n            - 'foreach'\n            - '[System.Net.Dns]::GetHostEntry'\n            - 'Out-File'\n    condition: selection\nfalsepositives:\n    - The same functionality can be implemented by admin scripts, correlate with name and creator\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_request_kerberos_ticket.yml","content":"title: Request A Single Ticket via PowerShell\nid: a861d835-af37-4930-bcd6-5b178bfb54df\nstatus: test\ndescription: |\n    utilize native PowerShell Identity modules to query the domain to extract the Service Principal Names for a single computer.\n    This behavior is typically used during a kerberos or silver ticket attack.\n    A successful execution will output the SPNs for the endpoint in question.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1558.003/T1558.003.md#atomic-test-4---request-a-single-ticket-via-powershell\nauthor: frack113\ndate: 2021-12-28\ntags:\n    - attack.credential-access\n    - attack.t1558.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: System.IdentityModel.Tokens.KerberosRequestorSecurityToken\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_remote_session_creation.yml","content":"title: PowerShell Remote Session Creation\nid: a0edd39f-a0c6-4c17-8141-261f958e8d8f\nstatus: test\ndescription: |\n    Adversaries may abuse PowerShell commands and scripts for execution.\n    PowerShell is a powerful interactive command-line interface and scripting environment included in the Windows operating system\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1059.001/T1059.001.md#atomic-test-10---powershell-invoke-downloadcradle\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssession?view=powershell-7.4\nauthor: frack113\ndate: 2022-01-06\nmodified: 2023-01-02\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'New-PSSession'\n            - '-ComputerName '\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_remotefxvgpudisablement_abuse.yml","content":"title: Potential RemoteFXvGPUDisablement.EXE Abuse - PowerShell ScriptBlock\nid: cacef8fc-9d3d-41f7-956d-455c6e881bc5\nrelated:\n    - id: a6fc3c46-23b8-4996-9ea2-573f4c4d88c5 # ProcCreation\n      type: similar\n    - id: f65e22f9-819e-4f96-9c7b-498364ae7a25 # PS Classic\n      type: similar\n    - id: 38a7625e-b2cb-485d-b83d-aff137d859f4 # PS Module\n      type: similar\nstatus: test\ndescription: Detects PowerShell module creation where the module Contents are set to \"function Get-VMRemoteFXPhysicalVideoAdapter\". This could be a sign of potential abuse of the \"RemoteFXvGPUDisablement.exe\" binary which is known to be vulnerable to module load-order hijacking.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1218/T1218.md\n    - https://github.com/redcanaryco/AtomicTestHarnesses/blob/7e1e4da116801e3d6fcc6bedb207064577e40572/TestHarnesses/T1218_SignedBinaryProxyExecution/InvokeRemoteFXvGPUDisablementCommand.ps1\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-05-09\ntags:\n    - attack.defense-evasion\n    - attack.t1218\nlogsource:\n    product: windows\n    category: ps_script\n    definition: bade5735-5ab0-4aa7-a642-a11be0e40872\ndetection:\n    selection:\n        ScriptBlockText|startswith: 'function Get-VMRemoteFXPhysicalVideoAdapter {'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_psattack.yml","content":"title: PowerShell PSAttack\nid: b7ec41a4-042c-4f31-a5db-d0fcde9fa5c5\nstatus: test\ndescription: Detects the use of PSAttack PowerShell hack tool\nreferences:\n    - https://adsecurity.org/?p=2921\nauthor: Sean Metcalf (source), Florian Roth (Nextron Systems)\ndate: 2017-03-05\nmodified: 2022-12-25\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: 'PS ATTACK!!!'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_psasyncshell.yml","content":"title: PSAsyncShell - Asynchronous TCP Reverse Shell\nid: afd3df04-948d-46f6-ae44-25966c44b97f\nstatus: test\ndescription: Detects the use of PSAsyncShell an Asynchronous TCP Reverse Shell written in powershell\nreferences:\n    - https://github.com/JoelGMSec/PSAsyncShell\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-10-04\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: 'PSAsyncShell'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_prompt_credentials.yml","content":"title: PowerShell Credential Prompt\nid: ca8b77a9-d499-4095-b793-5d5f330d450e\nstatus: test\ndescription: Detects PowerShell calling a credential prompt\nreferences:\n    - https://twitter.com/JohnLaTwC/status/850381440629981184\n    - https://t.co/ezOTGy1a1G\nauthor: John Lambert (idea), Florian Roth (Nextron Systems)\ndate: 2017-04-09\nmodified: 2022-12-25\ntags:\n    - attack.credential-access\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: 'PromptForCredential'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_powerview_malicious_commandlets.yml","content":"title: PowerView PowerShell Cmdlets - ScriptBlock\nid: dcd74b95-3f36-4ed9-9598-0490951643aa\nrelated:\n    - id: b2317cfa-4a47-4ead-b3ff-297438c0bc2d\n      type: similar\nstatus: test\ndescription: Detects Cmdlet names from PowerView of the PowerSploit exploitation framework.\nreferences:\n    - https://powersploit.readthedocs.io/en/stable/Recon/README\n    - https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon\n    - https://thedfirreport.com/2020/10/08/ryuks-return\n    - https://adsecurity.org/?p=2277\nauthor: Bhabesh Raj\ndate: 2021-05-18\nmodified: 2023-11-22\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Export-PowerViewCSV'\n            - 'Find-DomainLocalGroupMember'\n            - 'Find-DomainObjectPropertyOutlier'\n            - 'Find-DomainProcess'\n            - 'Find-DomainShare'\n            - 'Find-DomainUserEvent'\n            - 'Find-DomainUserLocation'\n            - 'Find-ForeignGroup'\n            - 'Find-ForeignUser'\n            - 'Find-GPOComputerAdmin'\n            - 'Find-GPOLocation'\n            - 'Find-InterestingDomain' # Covers: Find-InterestingDomainAcl, Find-InterestingDomainShareFile\n            - 'Find-InterestingFile'\n            - 'Find-LocalAdminAccess'\n            - 'Find-ManagedSecurityGroups'\n            - 'Get-CachedRDPConnection'\n            - 'Get-DFSshare'\n            - 'Get-DomainDFSShare'\n            - 'Get-DomainDNSRecord'\n            - 'Get-DomainDNSZone'\n            - 'Get-DomainFileServer'\n            - 'Get-DomainGPOComputerLocalGroupMapping'\n            - 'Get-DomainGPOLocalGroup'\n            - 'Get-DomainGPOUserLocalGroupMapping'\n            - 'Get-LastLoggedOn'\n            - 'Get-LoggedOnLocal'\n            - 'Get-NetFileServer'\n            - 'Get-NetForest' # Covers: Get-NetForestCatalog, Get-NetForestDomain, Get-NetForestTrust\n            - 'Get-NetGPOGroup'\n            - 'Get-NetProcess'\n            - 'Get-NetRDPSession'\n            - 'Get-RegistryMountedDrive'\n            - 'Get-RegLoggedOn'\n            - 'Get-WMIRegCachedRDPConnection'\n            - 'Get-WMIRegLastLoggedOn'\n            - 'Get-WMIRegMountedDrive'\n            - 'Get-WMIRegProxy'\n            - 'Invoke-ACLScanner'\n            - 'Invoke-CheckLocalAdminAccess'\n            - 'Invoke-EnumerateLocalAdmin'\n            - 'Invoke-EventHunter'\n            - 'Invoke-FileFinder'\n            - 'Invoke-Kerberoast'\n            - 'Invoke-MapDomainTrust'\n            - 'Invoke-ProcessHunter'\n            - 'Invoke-RevertToSelf'\n            - 'Invoke-ShareFinder'\n            - 'Invoke-UserHunter'\n            - 'Invoke-UserImpersonation'\n            - 'Remove-RemoteConnection'\n            - 'Request-SPNTicket'\n            - 'Resolve-IPAddress'\n            # - 'Get-ADObject'  # prone to FPs\n            # - 'Get-Domain'  # too many FPs  # Covers Cmdlets like: DomainComputer, DomainController, DomainDFSShare, DomainDNSRecord, DomainGPO, etc.\n            # - 'Add-DomainGroupMember'\n            # - 'Add-DomainObjectAcl'\n            # - 'Add-ObjectAcl'\n            # - 'Add-RemoteConnection'\n            # - 'Convert-ADName'\n            # - 'Convert-NameToSid'\n            # - 'ConvertFrom-UACValue'\n            # - 'ConvertTo-SID'\n            # - 'Get-DNSRecord'\n            # - 'Get-DNSZone'\n            # - 'Get-DomainComputer'\n            # - 'Get-DomainController'\n            # - 'Get-DomainGroup'\n            # - 'Get-DomainGroupMember'\n            # - 'Get-DomainManagedSecurityGroup'\n            # - 'Get-DomainObject'\n            # - 'Get-DomainObjectAcl'\n            # - 'Get-DomainOU'\n            # - 'Get-DomainPolicy'\n            # - 'Get-DomainSID'\n            # - 'Get-DomainSite'\n            # - 'Get-DomainSPNTicket'\n            # - 'Get-DomainSubnet'\n            # - 'Get-DomainUser'\n            # - 'Get-DomainUserEvent'\n            # - 'Get-Forest' # Covers: Get-ForestDomain, Get-ForestGlobalCatalog, Get-ForestTrust\n            # - 'Get-IPAddress'\n            # - 'Get-NetComputer' # Covers: Get-NetComputerSiteName\n            # - 'Get-NetDomain' # Covers: Get-NetDomainController, Get-NetDomainTrust\n            # - 'Get-NetGroup' # Covers: Get-NetGroupMember\n            # - 'Get-NetLocalGroup' # Covers: NetLocalGroupMember\n            # - 'Get-NetLoggedon'\n            # - 'Get-NetOU'\n            # - 'Get-NetSession'\n            # - 'Get-NetShare'\n            # - 'Get-NetSite'\n            # - 'Get-NetSubnet'\n            # - 'Get-NetUser'\n            # - 'Get-ObjectAcl'\n            # - 'Get-PathAcl'\n            # - 'Get-Proxy'\n            # - 'Get-SiteName'\n            # - 'Get-UserEvent'\n            # - 'Get-WMIProcess'\n            # - 'New-DomainGroup'\n            # - 'New-DomainUser'\n            # - 'Set-ADObject'\n            # - 'Set-DomainObject'\n            # - 'Set-DomainUserPassword'\n            # - 'Test-AdminAccess'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_powershell_web_access_installation.yml","content":"title: PowerShell Web Access Installation - PsScript\nid: 5f9c7f1a-7c21-4c39-b2f3-8d8006e0e51f\nstatus: test\ndescription: Detects the installation and configuration of PowerShell Web Access, which could be used for remote access and potential abuse\nreferences:\n    - https://docs.microsoft.com/en-us/powershell/module/powershellwebaccess/install-pswawebapplication\n    - https://www.cisa.gov/news-events/cybersecurity-advisories/aa24-241a\n    - https://gist.github.com/MHaggis/7e67b659af9148fa593cf2402edebb41\nauthor: Michael Haag\ndate: 2024-09-03\ntags:\n    - attack.persistence\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_install:\n        ScriptBlockText|contains: 'Install-WindowsFeature WindowsPowerShellWebAccess'\n    selection_config:\n        ScriptBlockText|contains: 'Install-PswaWebApplication'\n    selection_auth:\n        ScriptBlockText|contains|all:\n            - 'Add-PswaAuthorizationRule'\n            - '-UserName *'\n            - '-ComputerName *'\n    condition: 1 of selection_*\nfalsepositives:\n    - Legitimate PowerShell Web Access installations by administrators\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_potential_unconstrained_delegation_discovery.yml","content":"title: Potential Unconstrained Delegation Discovery Via Get-ADComputer - ScriptBlock\nid: cdfa73b6-3c9d-4bb8-97f8-ddbd8921f5c5\nstatus: experimental\ndescription: Detects the use of the \"Get-ADComputer\" cmdlet in order to identify systems which are configured for unconstrained delegation.\nreferences:\n    - https://pentestlab.blog/2022/03/21/unconstrained-delegation/\n    - https://learn.microsoft.com/en-us/powershell/module/activedirectory/get-adcomputer?view=windowsserver2022-ps\nauthor: frack113\ndate: 2025-03-05\ntags:\n    - attack.reconnaissance\n    - attack.discovery\n    - attack.credential-access\n    - attack.t1018\n    - attack.t1558\n    - attack.t1589.002\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enable'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - '-Properties*TrustedForDelegation'\n            - '-Properties*TrustedToAuthForDelegation'\n            - '-Properties*msDS-AllowedToDelegateTo'\n            - '-Properties*PrincipalsAllowedToDelegateToAccount'\n            - '-LDAPFilter*(userAccountControl:1.2.840.113556.1.4.803:=524288)'\n    condition: selection\nfalsepositives:\n    - Legitimate use of the library for administrative activity\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_potential_invoke_mimikatz.yml","content":"title: Potential Invoke-Mimikatz PowerShell Script\nid: 189e3b02-82b2-4b90-9662-411eb64486d4\nstatus: test\ndescription: Detects Invoke-Mimikatz PowerShell script and alike. Mimikatz is a credential dumper capable of obtaining plaintext Windows account logins and passwords.\nreferences:\n    - https://www.elastic.co/guide/en/security/current/potential-invoke-mimikatz-powershell-script.html#potential-invoke-mimikatz-powershell-script\nauthor: Tim Rauch, Elastic (idea)\ndate: 2022-09-28\ntags:\n    - attack.credential-access\n    - attack.t1003\nlogsource:\n    category: ps_script\n    product: windows\ndetection:\n    selection_1:\n        ScriptBlockText|contains|all:\n            - 'DumpCreds'\n            - 'DumpCerts'\n    selection_2:\n        ScriptBlockText|contains: 'sekurlsa::logonpasswords'\n    selection_3:\n        ScriptBlockText|contains|all:\n            - 'crypto::certificates'\n            - 'CERT_SYSTEM_STORE_LOCAL_MACHINE'\n    condition: 1 of selection*\nfalsepositives:\n    - Mimikatz can be useful for testing the security of networks\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_packet_capture.yml","content":"title: Potential Packet Capture Activity Via Start-NetEventSession - ScriptBlock\nid: da34e323-1e65-42db-83be-a6725ac2caa3\nstatus: test\ndescription: |\n    Detects the execution of powershell scripts with calls to the \"Start-NetEventSession\" cmdlet. Which allows an attacker to start event and packet capture for a network event session.\n    Adversaries may attempt to capture network to gather information over the course of an operation.\n    Data captured via this technique may include user credentials, especially those sent over an insecure, unencrypted protocol.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/5f866ca4517e837c4ea576e7309d0891e78080a8/atomics/T1040/T1040.md#atomic-test-16---powershell-network-sniffing\n    - https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/7b8935fe4c82cb64d61343de1a8b2e38dd968534/handbooks/10_post_exploitation.md\n    - https://github.com/forgottentq/powershell/blob/9e616363d497143dc955c4fdce68e5c18d28a6cb/captureWindows-Endpoint.ps1#L13\nauthor: frack113\ndate: 2024-05-12\ntags:\n    - attack.credential-access\n    - attack.discovery\n    - attack.t1040\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: 'Start-NetEventSession'\n    condition: selection\nfalsepositives:\n    - Legitimate network diagnostic scripts.\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_office_comobject_registerxll.yml","content":"title: Code Executed Via Office Add-in XLL File\nid: 36fbec91-fa1b-4d5d-8df1-8d8edcb632ad\nstatus: test\ndescription: |\n    Adversaries may abuse Microsoft Office add-ins to obtain persistence on a compromised system.\n    Office add-ins can be used to add functionality to Office programs\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1137.006/T1137.006.md\nauthor: frack113\ndate: 2021-12-28\ntags:\n    - attack.persistence\n    - attack.t1137.006\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'new-object '\n            - '-ComObject '\n            - '.application'\n            - '.RegisterXLL'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_ntfs_ads_access.yml","content":"title: NTFS Alternate Data Stream\nid: 8c521530-5169-495d-a199-0a3a881ad24e\nstatus: test\ndescription: Detects writing data into NTFS alternate data streams from powershell. Needs Script Block Logging.\nreferences:\n    - https://web.archive.org/web/20220614030603/http://www.powertheshell.com/ntfsstreams/\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1564.004/T1564.004.md\nauthor: Sami Ruohonen\ndate: 2018-07-24\nmodified: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.t1564.004\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_content:\n        ScriptBlockText|contains:\n            - set-content\n            - add-content\n    selection_stream:\n        ScriptBlockText|contains: '-stream'\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_nishang_malicious_commandlets.yml","content":"title: Malicious Nishang PowerShell Commandlets\nid: f772cee9-b7c2-4cb2-8f07-49870adc02e0\nstatus: test\ndescription: Detects Commandlet names and arguments from the Nishang exploitation framework\nreferences:\n    - https://github.com/samratashok/nishang\nauthor: Alec Costello\ndate: 2019-05-16\nmodified: 2023-01-16\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Add-ConstrainedDelegationBackdoor'\n            # - 'Add-Persistence' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            # - 'Add-RegBackdoor' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            # - 'Add-ScrnSaveBackdoor' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            - 'Copy-VSS'\n            - 'Create-MultipleSessions'\n            - 'DataToEncode'\n            - 'DNS_TXT_Pwnage'\n            - 'Do-Exfiltration-Dns'\n            - 'Download_Execute'\n            - 'Download-Execute-PS'\n            - 'DownloadAndExtractFromRemoteRegistry'\n            - 'DumpCerts'\n            - 'DumpCreds'\n            - 'DumpHashes'\n            - 'Enable-DuplicateToken'\n            - 'Enable-Duplication'\n            - 'Execute-Command-MSSQL'\n            - 'Execute-DNSTXT-Code'\n            - 'Execute-OnTime'\n            - 'ExetoText'\n            - 'exfill'\n            - 'ExfilOption'\n            - 'FakeDC'\n            - 'FireBuster'\n            - 'FireListener'\n            - 'Get-Information ' # Space at the end is required. Otherwise, we get FP with Get-InformationBarrierReportDetails or Get-InformationBarrierReportSummary\n            # - 'Get-PassHashes' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            - 'Get-PassHints'\n            - 'Get-Web-Credentials'\n            - 'Get-WebCredentials'\n            - 'Get-WLAN-Keys'\n            # - 'Gupt-Backdoor' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            - 'HTTP-Backdoor'\n            # - 'Invoke-ADSBackdoor' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            - 'Invoke-AmsiBypass'\n            - 'Invoke-BruteForce'\n            - 'Invoke-CredentialsPhish'\n            - 'Invoke-Decode'\n            - 'Invoke-Encode'\n            - 'Invoke-Interceptor'\n            - 'Invoke-JSRatRegsvr'\n            - 'Invoke-JSRatRundll'\n            - 'Invoke-MimikatzWDigestDowngrade'\n            - 'Invoke-NetworkRelay'\n            # - 'Invoke-PortScan' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            # - 'Invoke-PoshRatHttp' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            - 'Invoke-PowerShellIcmp'\n            - 'Invoke-PowerShellUdp'\n            - 'Invoke-Prasadhak'\n            - 'Invoke-PSGcat'\n            - 'Invoke-PsGcatAgent'\n            # - 'Invoke-PsUACme' # Covered in 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n            - 'Invoke-SessionGopher'\n            - 'Invoke-SSIDExfil'\n            # - Jitter  # Prone to FPs\n            # - 'Keylogger' # Too generic to be linked to Nishang\n            - 'LoggedKeys'\n            - 'Nishang'\n            - 'NotAllNameSpaces' # This is param to \"Set-RemoteWMI\"\n            - 'Out-CHM'\n            - 'OUT-DNSTXT'\n            - 'Out-HTA'\n            - 'Out-RundllCommand'\n            - 'Out-SCF'\n            - 'Out-SCT'\n            - 'Out-Shortcut'\n            - 'Out-WebQuery'\n            - 'Out-Word'\n            - 'Parse_Keys'\n            - 'Password-List'\n            - 'Powerpreter'\n            - 'Remove-Persistence'\n            - 'Remove-PoshRat'\n            - 'Remove-Update'\n            - 'Run-EXEonRemote'\n            - 'Set-DCShadowPermissions'\n            - 'Set-RemotePSRemoting'\n            - 'Set-RemoteWMI'\n            - 'Shellcode32'\n            - 'Shellcode64'\n            - 'StringtoBase64'\n            - 'TexttoExe'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_msxml_com.yml","content":"title: Powershell MsXml COM Object\nid: 78aa1347-1517-4454-9982-b338d6df8343\nstatus: test\ndescription: |\n    Adversaries may abuse PowerShell commands and scripts for execution.\n    PowerShell is a powerful interactive command-line interface and scripting environment included in the Windows operating system. (Citation: TechNet PowerShell)\n    Adversaries can use PowerShell to perform a number of actions, including discovery of information and execution of code\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1059.001/T1059.001.md#atomic-test-7---powershell-msxml-com-object---with-prompt\n    - https://learn.microsoft.com/en-us/previous-versions/windows/desktop/ms766431(v=vs.85)\n    - https://www.trendmicro.com/en_id/research/22/e/uncovering-a-kingminer-botnet-attack-using-trend-micro-managed-x.html\nauthor: frack113, MatilJ\ndate: 2022-01-19\nmodified: 2022-05-19\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'New-Object'\n            - '-ComObject'\n            - 'MsXml2.'\n            - 'XmlHttp'\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_modify_group_policy_settings.yml","content":"title: Modify Group Policy Settings - ScriptBlockLogging\nid: b7216a7d-687e-4c8d-82b1-3080b2ad961f\nrelated:\n    - id: ada4b0c4-758b-46ac-9033-9004613a150d\n      type: similar\nstatus: test\ndescription: Detect malicious GPO modifications can be used to implement many other malicious behaviors.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/40b77d63808dd4f4eafb83949805636735a1fd15/atomics/T1484.001/T1484.001.md\nauthor: frack113\ndate: 2022-08-19\ntags:\n    - attack.defense-evasion\n    - attack.privilege-escalation\n    - attack.t1484.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_path:\n        ScriptBlockText|contains: \\SOFTWARE\\Policies\\Microsoft\\Windows\\System\n    selection_key:\n        ScriptBlockText|contains:\n            - GroupPolicyRefreshTimeDC\n            - GroupPolicyRefreshTimeOffsetDC\n            - GroupPolicyRefreshTime\n            - GroupPolicyRefreshTimeOffset\n            - EnableSmartScreen\n            - ShellSmartScreenLevel\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_memorydump_getstoragediagnosticinfo.yml","content":"title: Live Memory Dump Using Powershell\nid: cd185561-4760-45d6-a63e-a51325112cae\nstatus: test\ndescription: Detects usage of a PowerShell command to dump the live memory of a Windows machine\nreferences:\n    - https://learn.microsoft.com/en-us/powershell/module/storage/get-storagediagnosticinfo?view=windowsserver2022-ps\nauthor: Max Altgelt (Nextron Systems)\ndate: 2021-09-21\nmodified: 2022-12-25\ntags:\n    - attack.credential-access\n    - attack.t1003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Get-StorageDiagnosticInfo'\n            - '-IncludeLiveDump'\n    condition: selection\nfalsepositives:\n    - Diagnostics\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_malicious_keywords.yml","content":"title: Malicious PowerShell Keywords\nid: f62176f3-8128-4faa-bf6c-83261322e5eb\nstatus: test\ndescription: Detects keywords from well-known PowerShell exploitation frameworks\nreferences:\n    - https://adsecurity.org/?p=2921\nauthor: Sean Metcalf (source), Florian Roth (Nextron Systems)\ndate: 2017-03-05\nmodified: 2023-06-20\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'AdjustTokenPrivileges'\n            - 'IMAGE_NT_OPTIONAL_HDR64_MAGIC'\n            # - 'LSA_UNICODE_STRING'\n            - 'Metasploit'\n            - 'Microsoft.Win32.UnsafeNativeMethods'\n            - 'Mimikatz'\n            - 'MiniDumpWriteDump'\n            - 'PAGE_EXECUTE_READ'\n            - 'ReadProcessMemory.Invoke'\n            - 'SE_PRIVILEGE_ENABLED'\n            - 'SECURITY_DELEGATION'\n            - 'TOKEN_ADJUST_PRIVILEGES'\n            - 'TOKEN_ALL_ACCESS'\n            - 'TOKEN_ASSIGN_PRIMARY'\n            - 'TOKEN_DUPLICATE'\n            - 'TOKEN_ELEVATION'\n            - 'TOKEN_IMPERSONATE'\n            - 'TOKEN_INFORMATION_CLASS'\n            - 'TOKEN_PRIVILEGES'\n            - 'TOKEN_QUERY'\n    condition: selection\nfalsepositives:\n    - Depending on the scripts, this rule might require some initial tuning to fit the environment\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_malicious_commandlets.yml","content":"title: Malicious PowerShell Commandlets - ScriptBlock\nid: 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\nrelated:\n    - id: 7d0d0329-0ef1-4e84-a9f5-49500f9d7c6c\n      type: similar\n    - id: 02030f2f-6199-49ec-b258-ea71b07e03dc\n      type: similar\n    - id: 6d3f1399-a81c-4409-aff3-1ecfe9330baf\n      type: obsolete\n    - id: 83083ac6-1816-4e76-97d7-59af9a9ae46e\n      type: obsolete\nstatus: test\ndescription: Detects Commandlet names from well-known PowerShell exploitation frameworks\nreferences:\n    - https://adsecurity.org/?p=2921\n    - https://github.com/S3cur3Th1sSh1t/PowerSharpPack/tree/master/PowerSharpBinaries\n    - https://github.com/BC-SECURITY/Invoke-ZeroLogon/blob/111d17c7fec486d9bb23387e2e828b09a26075e4/Invoke-ZeroLogon.ps1\n    - https://github.com/xorrior/RandomPS-Scripts/blob/848c919bfce4e2d67b626cbcf4404341cfe3d3b6/Get-DXWebcamVideo.ps1\n    - https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/6f23bb41f9675d7e2d32bacccff75e931ae00554/OfficeMemScraper.ps1\n    - https://github.com/dafthack/DomainPasswordSpray/blob/b13d64a5834694aa73fd2aea9911a83027c465a7/DomainPasswordSpray.ps1\n    - https://unit42.paloaltonetworks.com/threat-assessment-black-basta-ransomware/ # Invoke-TotalExec\n    - https://research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/ # Invoke-TotalExec\n    - https://github.com/calebstewart/CVE-2021-1675 # Invoke-Nightmare\n    - https://github.com/BloodHoundAD/BloodHound/blob/0927441f67161cc6dc08a53c63ceb8e333f55874/Collectors/AzureHound.ps1\n    - https://bloodhound.readthedocs.io/en/latest/data-collection/azurehound.html\n    - https://github.com/HarmJ0y/DAMP\n    - https://github.com/samratashok/nishang\n    - https://github.com/DarkCoderSc/PowerRunAsSystem/\n    - https://github.com/besimorhino/powercat\n    - https://github.com/Kevin-Robertson/Powermad\n    - https://github.com/adrecon/ADRecon\n    - https://github.com/adrecon/AzureADRecon\n    - https://github.com/The-Viper-One/Invoke-PowerDPAPI/\nauthor: Sean Metcalf, Florian Roth, Bartlomiej Czyz @bczyz1, oscd.community, Nasreddine Bencherchali, Tim Shelton, Mustafa Kaan Demir, Georg Lauenstein, Max Altgelt, Tobias Michalski, Austin Songer\ndate: 2017-03-05\nmodified: 2025-07-06\ntags:\n    - attack.execution\n    - attack.discovery\n    - attack.t1482\n    - attack.t1087\n    - attack.t1087.001\n    - attack.t1087.002\n    - attack.t1069.001\n    - attack.t1069.002\n    - attack.t1069\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            # Note: Please ensure alphabetical order when adding new entries\n            - 'Add-Exfiltration'\n            - 'Add-Persistence'\n            - 'Add-RegBackdoor'\n            - 'Add-RemoteRegBackdoor'\n            - 'Add-ScrnSaveBackdoor'\n            - 'ConvertTo-Rc4ByteStream'\n            - 'Decrypt-Hash'\n            - 'Disable-ADIDNSNode'\n            - 'Do-Exfiltration'\n            - 'Enable-ADIDNSNode'\n            - 'Enabled-DuplicateToken'\n            - 'Exploit-Jboss'\n            - 'Export-ADRCSV'\n            - 'Export-ADRExcel'\n            - 'Export-ADRHTML'\n            - 'Export-ADRJSON'\n            - 'Export-ADRXML'\n            - 'Find-Fruit'\n            - 'Find-GPOLocation'\n            - 'Find-TrustedDocuments'\n            - 'Get-ADIDNSNodeAttribute'\n            - 'Get-ADIDNSNodeOwner'\n            - 'Get-ADIDNSNodeTombstoned'\n            - 'Get-ADIDNSPermission'\n            - 'Get-ADIDNSZone'\n            - 'Get-ChromeDump'\n            - 'Get-ClipboardContents'\n            - 'Get-FoxDump'\n            - 'Get-GPPPassword'\n            - 'Get-IndexedItem'\n            - 'Get-KerberosAESKey'\n            - 'Get-Keystrokes'\n            - 'Get-LSASecret'\n            - 'Get-PassHashes'\n            - 'Get-RegAlwaysInstallElevated'\n            - 'Get-RegAutoLogon'\n            - 'Get-RemoteBootKey'\n            - 'Get-RemoteCachedCredential'\n            - 'Get-RemoteLocalAccountHash'\n            - 'Get-RemoteLSAKey'\n            - 'Get-RemoteMachineAccountHash'\n            - 'Get-RemoteNLKMKey'\n            - 'Get-RickAstley'\n            - 'Get-SecurityPackages'\n            - 'Get-ServiceFilePermission'\n            - 'Get-ServicePermission'\n            - 'Get-ServiceUnquoted'\n            - 'Get-SiteListPassword'\n            - 'Get-System'\n            - 'Get-TimedScreenshot'\n            - 'Get-UnattendedInstallFile'\n            - 'Get-Unconstrained'\n            - 'Get-USBKeystrokes'\n            - 'Get-VaultCredential'\n            - 'Get-VulnAutoRun'\n            - 'Get-VulnSchTask'\n            - 'Grant-ADIDNSPermission'\n            - 'Gupt-Backdoor'\n            - 'Invoke-ACLScanner'\n            - 'Invoke-ADRecon'\n            - 'Invoke-ADSBackdoor'\n            - 'Invoke-AgentSmith'\n            - 'Invoke-AllChecks'\n            - 'Invoke-ARPScan'\n            - 'Invoke-AzureHound'\n            - 'Invoke-BackdoorLNK'\n            - 'Invoke-BadPotato'\n            - 'Invoke-BetterSafetyKatz'\n            - 'Invoke-BypassUAC'\n            - 'Invoke-Carbuncle'\n            - 'Invoke-Certify'\n            - 'Invoke-ConPtyShell'\n            - 'Invoke-CredentialInjection'\n            - 'Invoke-DAFT'\n            - 'Invoke-DCSync'\n            - 'Invoke-DinvokeKatz'\n            - 'Invoke-DllInjection'\n            - 'Invoke-DNSUpdate'\n            - 'Invoke-DomainPasswordSpray'\n            - 'Invoke-DowngradeAccount'\n            - 'Invoke-EgressCheck'\n            - 'Invoke-Eyewitness'\n            - 'Invoke-FakeLogonScreen'\n            - 'Invoke-Farmer'\n            - 'Invoke-Get-RBCD-Threaded'\n            - 'Invoke-Gopher'\n            - 'Invoke-Grouper' # Also Covers Invoke-GrouperX\n            - 'Invoke-HandleKatz'\n            - 'Invoke-ImpersonatedProcess'\n            - 'Invoke-ImpersonateSystem'\n            - 'Invoke-InteractiveSystemPowerShell'\n            - 'Invoke-Internalmonologue'\n            - 'Invoke-Inveigh'\n            - 'Invoke-InveighRelay'\n            - 'Invoke-KrbRelay'\n            - 'Invoke-LdapSignCheck'\n            - 'Invoke-Lockless'\n            - 'Invoke-MalSCCM'\n            - 'Invoke-Mimikatz'\n            - 'Invoke-Mimikittenz'\n            - 'Invoke-MITM6'\n            - 'Invoke-NanoDump'\n            - 'Invoke-NetRipper'\n            - 'Invoke-Nightmare'\n            - 'Invoke-NinjaCopy'\n            - 'Invoke-OfficeScrape'\n            - 'Invoke-OxidResolver'\n            - 'Invoke-P0wnedshell'\n            - 'Invoke-Paranoia'\n            - 'Invoke-PortScan'\n            - 'Invoke-PoshRatHttp' # Also Covers Invoke-PoshRatHttps\n            - 'Invoke-PostExfil'\n            - 'Invoke-PowerDump'\n            - 'Invoke-PowerDPAPI'\n            - 'Invoke-PowerShellTCP'\n            - 'Invoke-PowerShellWMI'\n            - 'Invoke-PPLDump'\n            - 'Invoke-PsExec'\n            - 'Invoke-PSInject'\n            - 'Invoke-PsUaCme'\n            - 'Invoke-ReflectivePEInjection'\n            - 'Invoke-ReverseDNSLookup'\n            - 'Invoke-Rubeus'\n            - 'Invoke-RunAs'\n            - 'Invoke-SafetyKatz'\n            - 'Invoke-SauronEye'\n            - 'Invoke-SCShell'\n            - 'Invoke-Seatbelt'\n            - 'Invoke-ServiceAbuse'\n            - 'Invoke-ShadowSpray'\n            - 'Invoke-Sharp' # Covers all \"Invoke-Sharp\" variants\n            - 'Invoke-Shellcode'\n            - 'Invoke-SMBScanner'\n            - 'Invoke-Snaffler'\n            - 'Invoke-Spoolsample'\n            - 'Invoke-SpraySinglePassword'\n            - 'Invoke-SSHCommand'\n            - 'Invoke-StandIn'\n            - 'Invoke-StickyNotesExtract'\n            - 'Invoke-SystemCommand'\n            - 'Invoke-Tasksbackdoor'\n            - 'Invoke-Tater'\n            - 'Invoke-Thunderfox'\n            - 'Invoke-ThunderStruck'\n            - 'Invoke-TokenManipulation'\n            - 'Invoke-Tokenvator'\n            - 'Invoke-TotalExec'\n            - 'Invoke-UrbanBishop'\n            - 'Invoke-UserHunter'\n            - 'Invoke-VoiceTroll'\n            - 'Invoke-Whisker'\n            - 'Invoke-WinEnum'\n            - 'Invoke-winPEAS'\n            - 'Invoke-WireTap'\n            - 'Invoke-WmiCommand'\n            - 'Invoke-WMIExec'\n            - 'Invoke-WScriptBypassUAC'\n            - 'Invoke-Zerologon'\n            - 'MailRaider'\n            - 'New-ADIDNSNode'\n            - 'New-HoneyHash'\n            - 'New-InMemoryModule'\n            - 'New-SOASerialNumberArray'\n            - 'Out-Minidump'\n            - 'PowerBreach'\n            - 'powercat '\n            - 'PowerUp'\n            - 'PowerView'\n            - 'Remove-ADIDNSNode'\n            - 'Remove-Update'\n            - 'Rename-ADIDNSNode'\n            - 'Revoke-ADIDNSPermission'\n            - 'Set-ADIDNSNode' # Covers: Set-ADIDNSNodeAttribute, Set-ADIDNSNodeOwner\n            - 'Show-TargetScreen'\n            - 'Start-CaptureServer'\n            - 'Start-Dnscat2'\n            - 'Start-WebcamRecorder'\n            - 'VolumeShadowCopyTools'\n            # - 'Check-VM'\n            # - 'Disable-MachineAccount'\n            # - 'Enable-MachineAccount'\n            # - 'Get-ApplicationHost'\n            # - 'Get-MachineAccountAttribute'\n            # - 'Get-MachineAccountCreator'\n            # - 'Get-Screenshot'\n            # - 'HTTP-Login'\n            # - 'Install-ServiceBinary'\n            # - 'Install-SSP'\n            # - 'New-DNSRecordArray'\n            # - 'New-MachineAccount'\n            # - 'Port-Scan'\n            # - 'Remove-MachineAccount'\n            # - 'Set-MacAttribute'\n            # - 'Set-MachineAccountAttribute'\n            # - 'Set-Wallpaper'\n    filter_optional_amazon_ec2:\n        ScriptBlockText|contains:\n            - Get-SystemDriveInfo  # http://bheltborg.dk/Windows/WinSxS/amd64_microsoft-windows-maintenancediagnostic_31bf3856ad364e35_10.0.10240.16384_none_91ef7543a4514b5e/CL_Utility.ps1\n            - C:\\ProgramData\\Amazon\\EC2-Windows\\Launch\\Module\\  # false positive form Amazon EC2\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_mailboxexport_share.yml","content":"title: Suspicious PowerShell Mailbox Export to Share - PS\nid: 4a241dea-235b-4a7e-8d76-50d817b146c4\nrelated:\n    - id: 889719ef-dd62-43df-86c3-768fb08dc7c0\n      type: derived\nstatus: test\ndescription: Detects usage of the powerShell New-MailboxExportRequest Cmdlet to exports a mailbox to a remote or local share, as used in ProxyShell exploitations\nreferences:\n    - https://youtu.be/5mqid-7zp8k?t=2481\n    - https://blog.orange.tw/2021/08/proxylogon-a-new-attack-surface-on-ms-exchange-part-1.html\n    - https://peterjson.medium.com/reproducing-the-proxyshell-pwn2own-exploit-49743a4ea9a1\n    - https://m365internals.com/2022/10/07/hunting-in-on-premises-exchange-server-logs/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-10-26\ntags:\n    - attack.exfiltration\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'New-MailboxExportRequest'\n            - ' -Mailbox '\n            - ' -FilePath \\\\\\\\'\n    condition: selection\nfields:\n    - CommandLine\n    - ParentCommandLine\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"powershell\\powershell_script\\posh_ps_localuser.yml","content":"title: Powershell LocalAccount Manipulation\nid: 4fdc44df-bfe9-4fcc-b041-68f5a2d3031c\nstatus: test\ndescription: |\n    Adversaries may manipulate accounts to maintain access to victim systems.\n    Account manipulation may consist of any action that preserves adversary access to a compromised account, such as modifying credentials or permission groups\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1098/T1098.md#atomic-test-1---admin-account-manipulate\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/?view=powershell-5.1\nauthor: frack113\ndate: 2021-12-28\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.t1098\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Disable-LocalUser'\n            - 'Enable-LocalUser'\n            - 'Get-LocalUser'\n            - 'Set-LocalUser'\n            - 'New-LocalUser'\n            - 'Rename-LocalUser'\n            - 'Remove-LocalUser'\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_keylogging.yml","content":"title: Powershell Keylogging\nid: 34f90d3c-c297-49e9-b26d-911b05a4866c\nstatus: test\ndescription: Adversaries may log user keystrokes to intercept credentials as the user types them.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1218/T1218.md\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1056.001/src/Get-Keystrokes.ps1\nauthor: frack113\ndate: 2021-07-30\nmodified: 2022-07-11\ntags:\n    - attack.credential-access\n    - attack.collection\n    - attack.t1056.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_basic:\n        ScriptBlockText|contains: 'Get-Keystrokes'\n    selection_high: # want to run in background and keyboard\n        ScriptBlockText|contains|all:\n            - 'Get-ProcAddress user32.dll GetAsyncKeyState'\n            - 'Get-ProcAddress user32.dll GetForegroundWindow'\n    condition: 1 of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_via_var.yml","content":"title: Invoke-Obfuscation VAR++ LAUNCHER OBFUSCATION - PowerShell\nid: e54f5149-6ba3-49cf-b153-070d24679126\nstatus: test\ndescription: Detects Obfuscated Powershell via VAR++ LAUNCHER\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task27)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-13\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|re: '(?i)&&set.*(\\{\\d\\}){2,}\\\\\"\\s+?-f.*&&.*cmd.*/c' # FPs with |\\/r\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_via_use_rundll32.yml","content":"title: Invoke-Obfuscation Via Use Rundll32 - PowerShell\nid: a5a30a6e-75ca-4233-8b8c-42e0f2037d3b\nstatus: test\ndescription: Detects Obfuscated Powershell via use Rundll32 in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009\nauthor: Nikita Nazarov, oscd.community\ndate: 2019-10-08\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|contains|all:\n            - '&&'\n            - 'rundll32'\n            - 'shell32.dll'\n            - 'shellexec_rundll'\n        ScriptBlockText|contains:\n            - 'value'\n            - 'invoke'\n            - 'comspec'\n            - 'iex'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_via_use_mhsta.yml","content":"title: Invoke-Obfuscation Via Use MSHTA - PowerShell\nid: e55a5195-4724-480e-a77e-3ebe64bd3759\nstatus: test\ndescription: Detects Obfuscated Powershell via use MSHTA in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task31)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-08\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|contains|all:\n            - 'set'\n            - '&&'\n            - 'mshta'\n            - 'vbscript:createobject'\n            - '.run'\n            - '(window.close)'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_via_use_clip.yml","content":"title: Invoke-Obfuscation Via Use Clip - Powershell\nid: db92dd33-a3ad-49cf-8c2c-608c3e30ace0\nstatus: test\ndescription: Detects Obfuscated Powershell via use Clip.exe in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task29)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-09\nmodified: 2024-04-15\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|re: '(?i)echo.*clip.*&&.*(Clipboard|i`?n`?v`?o`?k`?e`?)'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_via_stdin.yml","content":"title: Invoke-Obfuscation Via Stdin - Powershell\nid: 86b896ba-ffa1-4fea-83e3-ee28a4c915c7\nstatus: test\ndescription: Detects Obfuscated Powershell via Stdin in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task28)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-12\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|re: '(?i)(set).*&&\\s?set.*(environment|invoke|\\$\\{?input).*&&.*\"'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_via_rundll.yml","content":"title: Invoke-Obfuscation RUNDLL LAUNCHER - PowerShell\nid: e6cb92b4-b470-4eb8-8a9d-d63e8583aae0\nstatus: test\ndescription: Detects Obfuscated Powershell via RUNDLL LAUNCHER\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task 23)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-18\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|contains|all:\n            - 'rundll32.exe'\n            - 'shell32.dll'\n            - 'shellexec_rundll'\n            - 'powershell'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_via_compress.yml","content":"title: Invoke-Obfuscation COMPRESS OBFUSCATION - PowerShell\nid: 20e5497e-331c-4cd5-8d36-935f6e2a9a07\nstatus: test\ndescription: Detects Obfuscated Powershell via COMPRESS OBFUSCATION\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task 19)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-18\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|contains|all:\n            - 'new-object'\n            - 'text.encoding]::ascii'\n        ScriptBlockText|contains:\n            - 'system.io.compression.deflatestream'\n            - 'system.io.streamreader'\n        ScriptBlockText|endswith: 'readtoend'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_var.yml","content":"title: Invoke-Obfuscation VAR+ Launcher - PowerShell\nid: 0adfbc14-0ed1-11eb-adc1-0242ac120002\nstatus: test\ndescription: Detects Obfuscated use of Environment Variables to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 24)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-15\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|re: 'cmd.{0,5}(?:/c|/r)(?:\\s|)\"set\\s[a-zA-Z]{3,6}.*(?:\\{\\d\\}){1,}\\\\\"\\s+?-f(?:.*\\)){1,}.*\"'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_stdin.yml","content":"title: Invoke-Obfuscation STDIN+ Launcher - Powershell\nid: 779c8c12-0eb1-11eb-adc1-0242ac120002\nstatus: test\ndescription: Detects Obfuscated use of stdin to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 25)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-15\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|re: 'cmd.{0,5}(?:/c|/r).+powershell.+(?:\\$?\\{?input\\}?|noexit).+\"'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_obfuscated_iex.yml","content":"title: Invoke-Obfuscation Obfuscated IEX Invocation - PowerShell\nid: 1b9dc62e-6e9e-42a3-8990-94d7a10007f7\nstatus: test\ndescription: Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the following code block \\u2014\nreferences:\n    - https://github.com/danielbohannon/Invoke-Obfuscation/blob/f20e7f843edd0a3a7716736e9eddfa423395dd26/Out-ObfuscatedStringCommand.ps1#L873-L888\nauthor: 'Daniel Bohannon (@Mandiant/@FireEye), oscd.community'\ndate: 2019-11-08\nmodified: 2022-12-31\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_iex:\n        - ScriptBlockText|re: '\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\['\n        - ScriptBlockText|re: '\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\['\n        - ScriptBlockText|re: '\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\['\n        - ScriptBlockText|re: '\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}'\n        - ScriptBlockText|re: '\\*mdr\\*\\W\\s*\\)\\.Name'\n        - ScriptBlockText|re: '\\$VerbosePreference\\.ToString\\('\n    condition: selection_iex\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_obfuscation_clip.yml","content":"title: Invoke-Obfuscation CLIP+ Launcher - PowerShell\nid: 73e67340-0d25-11eb-adc1-0242ac120002\nstatus: test\ndescription: Detects Obfuscated use of Clip.exe to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 26)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-13\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_4104:\n        ScriptBlockText|re: 'cmd.{0,5}(?:/c|/r).+clip(?:\\.exe)?.{0,4}&&.+clipboard]::\\(\\s\\\\\"\\{\\d\\}.+-f.+\"'\n    condition: selection_4104\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_dnsexfiltration.yml","content":"title: Powershell DNSExfiltration\nid: d59d7842-9a21-4bc6-ba98-64bfe0091355\nstatus: test\ndescription: DNSExfiltrator allows for transferring (exfiltrate) a file over a DNS request covert channel\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1048/T1048.md#atomic-test-3---dnsexfiltration-doh\n    - https://github.com/Arno0x/DNSExfiltrator\nauthor: frack113\ndate: 2022-01-07\ntags:\n    - attack.exfiltration\n    - attack.t1048\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmdlet:\n        - ScriptBlockText|contains: 'Invoke-DNSExfiltrator'\n        - ScriptBlockText|contains|all:\n              - ' -i '\n              - ' -d '\n              - ' -p '\n              - ' -doh '\n              - ' -t '\n    condition: selection_cmdlet\nfalsepositives:\n    - Legitimate script\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_invoke_command_remote.yml","content":"title: Execute Invoke-command on Remote Host\nid: 7b836d7f-179c-4ba4-90a7-a7e60afb48e6\nstatus: test\ndescription: Adversaries may use Valid Accounts to interact with remote systems using Windows Remote Management (WinRM). The adversary may then perform actions as the logged-on user.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.006/T1021.006.md#atomic-test-2---invoke-command\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/invoke-command?view=powershell-7.4\nauthor: frack113\ndate: 2022-01-07\ntags:\n    - attack.lateral-movement\n    - attack.t1021.006\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains|all:\n            - 'invoke-command '\n            - ' -ComputerName '\n    condition: selection_cmdlet\nfalsepositives:\n    - Legitimate script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_install_unsigned_appx_packages.yml","content":"title: Unsigned AppX Installation Attempt Using Add-AppxPackage - PsScript\nid: 975b2262-9a49-439d-92a6-0709cccdf0b2\nrelated:\n    - id: 37651c2a-42cd-4a69-ae0d-22a4349aa04a\n      type: similar\nstatus: test\ndescription: Detects usage of the \"Add-AppxPackage\" or it's alias \"Add-AppPackage\" to install unsigned AppX packages\nreferences:\n    - https://learn.microsoft.com/en-us/windows/msix/package/unsigned-package\n    - https://twitter.com/WindowsDocs/status/1620078135080325122\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-31\ntags:\n    - attack.persistence\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    category: ps_script\n    definition: Script Block Logging must be enable\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains:\n            - 'Add-AppPackage '\n            - 'Add-AppxPackage '\n    selection_flag:\n        ScriptBlockText|contains: ' -AllowUnsigned'\n    condition: all of selection_*\nfalsepositives:\n    - Installation of unsigned packages for testing purposes\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_import_module_susp_dirs.yml","content":"title: Import PowerShell Modules From Suspicious Directories\nid: 21f9162c-5f5d-4b01-89a8-b705bd7d10ab\nrelated:\n    - id: c31364f7-8be6-4b77-8483-dd2b5a7b69a3\n      type: similar\nstatus: test\ndescription: Detects powershell scripts that import modules from suspicious directories\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1003.002/T1003.002.md\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-07-07\nmodified: 2023-01-10\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Import-Module \"$Env:Temp\\'\n            - Import-Module '$Env:Temp\\\n            - 'Import-Module $Env:Temp\\'\n            - 'Import-Module \"$Env:Appdata\\'\n            - Import-Module '$Env:Appdata\\\n            - 'Import-Module $Env:Appdata\\'\n            - 'Import-Module C:\\Users\\Public\\'\n            # Import-Module alias is \"ipmo\"\n            - 'ipmo \"$Env:Temp\\'\n            - ipmo '$Env:Temp\\\n            - 'ipmo $Env:Temp\\'\n            - 'ipmo \"$Env:Appdata\\'\n            - ipmo '$Env:Appdata\\\n            - 'ipmo $Env:Appdata\\'\n            - 'ipmo C:\\Users\\Public\\'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_icmp_exfiltration.yml","content":"title: PowerShell ICMP Exfiltration\nid: 4c4af3cd-2115-479c-8193-6b8bfce9001c\nstatus: test\ndescription: Detects Exfiltration Over Alternative Protocol - ICMP. Adversaries may steal data by exfiltrating it over an un-encrypted network protocol other than that of the existing command and control channel.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1048.003/T1048.003.md#atomic-test-2---exfiltration-over-alternative-protocol---icmp\nauthor: 'Bartlomiej Czyz @bczyz1, oscd.community'\ndate: 2020-10-10\nmodified: 2022-12-25\ntags:\n    - attack.exfiltration\n    - attack.t1048.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'New-Object'\n            - 'System.Net.NetworkInformation.Ping'\n            - '.Send('\n    condition: selection\nfalsepositives:\n    - Legitimate usage of System.Net.NetworkInformation.Ping class\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_hotfix_enum.yml","content":"title: PowerShell Hotfix Enumeration\nid: f5d1def8-1de0-4a0e-9794-1f6f27dd605c\nstatus: test\ndescription: Detects call to \"Win32_QuickFixEngineering\" in order to enumerate installed hotfixes often used in \"enum\" scripts by attackers\nreferences:\n    - https://github.com/411Hall/JAWS/blob/233f142fcb1488172aa74228a666f6b3c5c48f1d/jaws-enum.ps1\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-06-21\ntags:\n    - attack.discovery\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Win32_QuickFixEngineering'\n            - 'HotFixID'\n    condition: selection\nfalsepositives:\n    - Legitimate administration scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_hktl_winpwn.yml","content":"title: HackTool - WinPwn Execution - ScriptBlock\nid: 851fd622-b675-4d26-b803-14bc7baa517a\nrelated:\n    - id: d557dc06-62e8-4468-a8e8-7984124908ce\n      type: similar\nstatus: test\ndescription: |\n    Detects scriptblock text keywords indicative of potential usge of the tool WinPwn. A tool for Windows and Active Directory reconnaissance and exploitation.\nauthor: Swachchhanda Shrawan Poudel\ndate: 2023-12-04\nreferences:\n    - https://github.com/S3cur3Th1sSh1t/WinPwn\n    - https://www.publicnow.com/view/EB87DB49C654D9B63995FAD4C9DE3D3CC4F6C3ED?1671634841\n    - https://reconshell.com/winpwn-tool-for-internal-windows-pentesting-and-ad-security/\n    - https://github.com/redcanaryco/atomic-red-team/blob/4d6c4e8e23d465af7a2388620cfe3f8c76e16cf0/atomics/T1082/T1082.md\n    - https://grep.app/search?q=winpwn&filter[repo][0]=redcanaryco/atomic-red-team\ntags:\n    - attack.credential-access\n    - attack.defense-evasion\n    - attack.discovery\n    - attack.execution\n    - attack.privilege-escalation\n    - attack.t1046\n    - attack.t1082\n    - attack.t1106\n    - attack.t1518\n    - attack.t1548.002\n    - attack.t1552.001\n    - attack.t1555\n    - attack.t1555.003\nlogsource:\n    category: ps_script\n    product: windows\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Offline_Winpwn'\n            - 'WinPwn '\n            - 'WinPwn.exe'\n            - 'WinPwn.ps1'\n    condition: selection\nfalsepositives:\n    - As the script block is a blob of text. False positive may occur with scripts that contain the keyword as a reference or simply use it for detection.\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_hktl_rubeus.yml","content":"title: HackTool - Rubeus Execution - ScriptBlock\nid: 3245cd30-e015-40ff-a31d-5cadd5f377ec\nrelated:\n    - id: 7ec2c172-dceb-4c10-92c9-87c1881b7e18\n      type: similar\nstatus: test\ndescription: Detects the execution of the hacktool Rubeus using specific command line flags\nreferences:\n    - https://blog.harmj0y.net/redteaming/from-kekeo-to-rubeus\n    - https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html\n    - https://github.com/GhostPack/Rubeus\nauthor: Christian Burkard (Nextron Systems), Florian Roth (Nextron Systems)\ndate: 2023-04-27\ntags:\n    - attack.defense-evasion\n    - attack.credential-access\n    - attack.t1003\n    - attack.t1558.003\n    - attack.lateral-movement\n    - attack.t1550.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'asreproast '\n            - 'dump /service:krbtgt '\n            - 'dump /luid:0x'\n            - 'kerberoast '\n            - 'createnetonly /program:'\n            - 'ptt /ticket:'\n            - '/impersonateuser:'\n            - 'renew /ticket:'\n            - 'asktgt /user:'\n            - 'harvest /interval:'\n            - 's4u /user:'\n            - 's4u /ticket:'\n            - 'hash /password:'\n            - 'golden /aes256:'\n            - 'silver /user:'\n    condition: selection\nfalsepositives:\n    - Unlikely\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_get_process_security_software_discovery.yml","content":"title: Security Software Discovery Via Powershell Script\nid: 904e8e61-8edf-4350-b59c-b905fc8e810c\nstatus: test\ndescription: |\n    Detects calls to \"get-process\" where the output is piped to a \"where-object\" filter to search for security solution processes.\n    Adversaries may attempt to get a listing of security software, configurations, defensive tools, and sensors that are installed on a system or in a cloud environment. This may include things such as firewall rules and anti-virus\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1518.001/T1518.001.md#atomic-test-2---security-software-discovery---powershell\nauthor: frack113, Anish Bogati, Nasreddine Bencherchali (Nextron Systems)\ndate: 2021-12-16\nmodified: 2023-10-24\ntags:\n    - attack.discovery\n    - attack.t1518.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains:\n            - 'get-process | \\?'\n            - 'get-process | where'\n            - 'gps | \\?'\n            - 'gps | where'\n    selection_field:\n        ScriptBlockText|contains:\n            - 'Company -like'\n            - 'Description -like'\n            - 'Name -like'\n            - 'Path -like'\n            - 'Product -like'\n    selection_keywords:\n        ScriptBlockText|contains:\n            # Note: These strings are using wildcard assuming the search is using the \"-like\" operator.\n            #       You can add specific variant with the actual process names to increase coverage\n            - '\\*avira\\*'\n            - '\\*carbonblack\\*'\n            - '\\*cylance\\*'\n            - '\\*defender\\*'\n            - '\\*kaspersky\\*'\n            - '\\*malware\\*'\n            - '\\*sentinel\\*'\n            - '\\*symantec\\*'\n            - '\\*virus\\*'\n    condition: all of selection_*\nfalsepositives:\n    - False positives might occur due to the nature of the ScriptBlock being ingested as a big blob. Initial tuning is required.\n    - As the \"selection_cmdlet\" is common in scripts the matching engine might slow down the search. Change into regex or a more accurate string to avoid heavy resource consumption if experienced\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_get_childitem_bookmarks.yml","content":"title: Automated Collection Bookmarks Using Get-ChildItem PowerShell\nid: e0565f5d-d420-4e02-8a68-ac00d864f9cf\nstatus: test\ndescription: |\n    Adversaries may enumerate browser bookmarks to learn more about compromised hosts.\n    Browser bookmarks may reveal personal information about users (ex: banking sites, interests, social media, etc.) as well as details about\n    internal network resources such as servers, tools/dashboards, or other related infrastructure.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1217/T1217.md\nauthor: frack113\ndate: 2021-12-13\nmodified: 2022-12-25\ntags:\n    - attack.discovery\n    - attack.t1217\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Get-ChildItem'\n            - ' -Recurse '\n            - ' -Path '\n            - ' -Filter Bookmarks'\n            - ' -ErrorAction SilentlyContinue'\n            - ' -Force'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_get_adreplaccount.yml","content":"title: Suspicious Get-ADReplAccount\nid: 060c3ef1-fd0a-4091-bf46-e7d625f60b73\nstatus: test\ndescription: |\n    The DSInternals PowerShell Module exposes several internal features of Active Directory and Azure Active Directory.\n    These include FIDO2 and NGC key auditing, offline ntds.dit file manipulation, password auditing, DC recovery from IFM backups and password hash calculation.\nreferences:\n    - https://www.powershellgallery.com/packages/DSInternals\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1003.006/T1003.006.md#atomic-test-2---run-dsinternals-get-adreplaccount\nauthor: frack113\ndate: 2022-02-06\ntags:\n    - attack.credential-access\n    - attack.t1003.006\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - Get-ADReplAccount\n            - '-All '\n            - '-Server '\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_get_adgroup.yml","content":"title: Active Directory Group Enumeration With Get-AdGroup\nid: 8c3a6607-b7dc-4f0d-a646-ef38c00b76ee\nstatus: test\ndescription: Detects usage of the \"Get-AdGroup\" cmdlet to enumerate Groups within Active Directory\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1018/T1018.md\nauthor: frack113\ndate: 2022-03-17\nmodified: 2022-11-17\ntags:\n    - attack.discovery\n    - attack.t1069.002\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Get-AdGroup '\n            - '-Filter'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_get_adcomputer.yml","content":"title: Active Directory Computers Enumeration With Get-AdComputer\nid: 36bed6b2-e9a0-4fff-beeb-413a92b86138\nstatus: test\ndescription: Detects usage of the \"Get-AdComputer\" to enumerate Computers or properties within Active Directory.\nreferences:\n    - https://learn.microsoft.com/en-us/powershell/module/activedirectory/get-adcomputer\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1018/T1018.md\n    - https://github.com/redcanaryco/atomic-red-team/blob/02cb591f75064ffe1e0df9ac3ed5972a2e491c97/atomics/T1087.002/T1087.002.md\nauthor: frack113\ndate: 2022-03-17\nmodified: 2023-07-08\ntags:\n    - attack.discovery\n    - attack.t1018\n    - attack.t1087.002\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains: 'Get-AdComputer '\n    selection_option:\n        ScriptBlockText|contains:\n            - '-Filter '\n            - '-LDAPFilter '\n            - '-Properties '\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_script\\posh_ps_get_acl_service.yml","content":"title: Service Registry Permissions Weakness Check\nid: 95afc12e-3cbb-40c3-9340-84a032e596a3\nstatus: test\ndescription: |\n    Adversaries may execute their own malicious payloads by hijacking the Registry entries used by services.\n    Adversaries may use flaws in the permissions for registry to redirect from the originally specified executable to one that they control, in order to launch their own code at Service start.\n    Windows stores local service configuration information in the Registry under HKLM\\SYSTEM\\CurrentControlSet\\Services\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1574.011/T1574.011.md#atomic-test-1---service-registry-permissions-weakness\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/get-acl?view=powershell-7.4\nauthor: frack113\ndate: 2021-12-30\ntags:\n    - attack.privilege-escalation\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1574.011\n    - stp.2a\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'get-acl'\n            - 'REGISTRY::HKLM\\SYSTEM\\CurrentControlSet\\Services\\'\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_frombase64string_archive.yml","content":"title: Suspicious FromBase64String Usage On Gzip Archive - Ps Script\nid: df69cb1d-b891-4cd9-90c7-d617d90100ce\nrelated:\n    - id: d75d6b6b-adb9-48f7-824b-ac2e786efe1f\n      type: similar\nstatus: test\ndescription: Detects attempts of decoding a base64 Gzip archive in a PowerShell script. This technique is often used as a method to load malicious content into memory afterward.\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=43\nauthor: frack113\ndate: 2022-12-23\ntags:\n    - attack.command-and-control\n    - attack.t1132.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'FromBase64String'\n            - 'MemoryStream'\n            - 'H4sI'\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_export_certificate.yml","content":"title: Certificate Exported Via PowerShell - ScriptBlock\nid: aa7a3fce-bef5-4311-9cc1-5f04bb8c308c\nrelated:\n    - id: 9e716b33-63b2-46da-86a4-bd3c3b9b5dfb\n      type: similar\nstatus: test\ndescription: Detects calls to cmdlets inside of PowerShell scripts that are used to export certificates from the local certificate store. Threat actors were seen abusing this to steal private keys from compromised machines.\nreferences:\n    - https://us-cert.cisa.gov/ncas/analysis-reports/ar21-112a\n    - https://learn.microsoft.com/en-us/powershell/module/pki/export-pfxcertificate?view=windowsserver2022-ps\n    - https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html\nauthor: Florian Roth (Nextron Systems)\ndate: 2021-04-23\nmodified: 2023-05-18\ntags:\n    - attack.credential-access\n    - attack.t1552.004\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Export-PfxCertificate'\n            - 'Export-Certificate'\n    filter_optional_module_export:\n        ScriptBlockText|contains: 'CmdletsToExport = @('\n    condition: selection and not 1 of filter_optional_*\nfalsepositives:\n    - Legitimate certificate exports by administrators. Additional filters might be required.\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_exchange_mailbox_smpt_forwarding_rule.yml","content":"title: Suspicious PowerShell Mailbox SMTP Forward Rule\nid: 15b7abbb-8b40-4d01-9ee2-b51994b1d474\nstatus: test\ndescription: Detects usage of the powerShell Set-Mailbox Cmdlet to set-up an SMTP forwarding rule.\nreferences:\n    - https://m365internals.com/2022/10/07/hunting-in-on-premises-exchange-server-logs/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-10-26\ntags:\n    - attack.exfiltration\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Set-Mailbox '\n            - ' -DeliverToMailboxAndForward '\n            - ' -ForwardingSmtpAddress '\n    condition: selection\nfalsepositives:\n    - Legitimate usage of the cmdlet to forward emails\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_etw_trace_evasion.yml","content":"title: Disable of ETW Trace - Powershell\nid: 115fdba9-f017-42e6-84cf-d5573bf2ddf8\nrelated:\n    - id: a238b5d0-ce2d-4414-a676-7a531b3d13d6\n      type: derived\nstatus: test\ndescription: Detects usage of powershell cmdlets to disable or remove ETW trace sessions\nreferences:\n    - https://medium.com/palantir/tampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-06-28\nmodified: 2022-11-25\ntags:\n    - attack.defense-evasion\n    - attack.t1070\n    - attack.t1562.006\n    - car.2016-04-002\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_pwsh_remove:   # Autologger provider removal\n        ScriptBlockText|contains: 'Remove-EtwTraceProvider '\n    selection_pwsh_set:   # Provider â€œEnableâ€ property modification\n        ScriptBlockText|contains|all:\n            - 'Set-EtwTraceProvider '\n            - '0x11'\n    condition: 1 of selection*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_enumerate_password_windows_credential_manager.yml","content":"title: Enumerate Credentials from Windows Credential Manager With PowerShell\nid: 603c6630-5225-49c1-8047-26c964553e0e\nstatus: test\ndescription: |\n    Adversaries may search for common password storage locations to obtain user credentials.\n    Passwords are stored in several places on a system, depending on the operating system or application holding the credentials.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1555/T1555.md\nauthor: frack113\ndate: 2021-12-20\nmodified: 2022-12-25\ntags:\n    - attack.credential-access\n    - attack.t1555\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmd:\n        ScriptBlockText|contains|all:\n            - vaultcmd\n            - '/listcreds:'\n    selection_option:\n        ScriptBlockText|contains:\n            - 'Windows Credentials'\n            - 'Web Credentials'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_enable_susp_windows_optional_feature.yml","content":"title: Potential Suspicious Windows Feature Enabled\nid: 55c925c1-7195-426b-a136-a9396800e29b\nrelated:\n    - id: c740d4cf-a1e9-41de-bb16-8a46a4f57918\n      type: similar\nstatus: test\ndescription: |\n    Detects usage of the built-in PowerShell cmdlet \"Enable-WindowsOptionalFeature\" used as a Deployment Image Servicing and Management tool.\n    Similar to DISM.exe, this cmdlet is used to enumerate, install, uninstall, configure, and update features and packages in Windows images\nreferences:\n    - https://learn.microsoft.com/en-us/powershell/module/dism/enable-windowsoptionalfeature?view=windowsserver2022-ps\n    - https://learn.microsoft.com/en-us/windows/win32/projfs/enabling-windows-projected-file-system\n    - https://learn.microsoft.com/en-us/windows/wsl/install-on-server\nauthor: frack113\ndate: 2022-09-10\nmodified: 2022-12-29\ntags:\n    - attack.defense-evasion\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmd:\n        ScriptBlockText|contains|all:\n            - 'Enable-WindowsOptionalFeature'\n            - '-Online'\n            - '-FeatureName'\n    selection_feature:\n        # Add any insecure/unusual windows features to your env\n        ScriptBlockText|contains:\n            - 'TelnetServer'\n            - 'Internet-Explorer-Optional-amd64'\n            - 'TFTP'\n            - 'SMB1Protocol'\n            - 'Client-ProjFS'\n            - 'Microsoft-Windows-Subsystem-Linux'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate usage of the features listed in the rule.\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_enable_psremoting.yml","content":"title: Enable Windows Remote Management\nid: 991a9744-f2f0-44f2-bd33-9092eba17dc3\nstatus: test\ndescription: Adversaries may use Valid Accounts to interact with remote systems using Windows Remote Management (WinRM). The adversary may then perform actions as the logged-on user.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.006/T1021.006.md#atomic-test-1---enable-windows-remote-management\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enable-psremoting?view=powershell-7.2\nauthor: frack113\ndate: 2022-01-07\ntags:\n    - attack.lateral-movement\n    - attack.t1021.006\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains: 'Enable-PSRemoting '\n    condition: selection_cmdlet\nfalsepositives:\n    - Legitimate script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_dump_password_windows_credential_manager.yml","content":"title: Dump Credentials from Windows Credential Manager With PowerShell\nid: 99c49d9c-34ea-45f7-84a7-4751ae6b2cbc\nstatus: test\ndescription: |\n    Adversaries may search for common password storage locations to obtain user credentials.\n    Passwords are stored in several places on a system, depending on the operating system or application holding the credentials.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1555/T1555.md\nauthor: frack113\ndate: 2021-12-20\nmodified: 2022-12-25\ntags:\n    - attack.credential-access\n    - attack.t1555\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_kiddie:\n        ScriptBlockText|contains:\n            - 'Get-PasswordVaultCredentials'\n            - 'Get-CredManCreds'\n    selection_rename_Password:\n        ScriptBlockText|contains|all:\n            - 'New-Object'\n            - 'Windows.Security.Credentials.PasswordVault'\n    selection_rename_credman:\n        ScriptBlockText|contains|all:\n            - 'New-Object'\n            - 'Microsoft.CSharp.CSharpCodeProvider'\n            - '[System.Runtime.InteropServices.RuntimeEnvironment]::GetRuntimeDirectory())'\n            - 'Collections.ArrayList'\n            - 'System.CodeDom.Compiler.CompilerParameters'\n    condition: 1 of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_dsinternals_cmdlets.yml","content":"title: DSInternals Suspicious PowerShell Cmdlets - ScriptBlock\nid: 846c7a87-8e14-4569-9d49-ecfd4276a01c\nrelated:\n    - id: 43d91656-a9b2-4541-b7e2-6a9bd3a13f4e\n      type: similar\nstatus: test\ndescription: |\n    Detects execution and usage of the DSInternals PowerShell module. Which can be used to perform what might be considered as suspicious activity such as dumping DPAPI backup keys or manipulating NTDS.DIT files.\n    The DSInternals PowerShell Module exposes several internal features of Active Directory and Azure Active Directory. These include FIDO2 and NGC key auditing, offline ntds.dit file manipulation, password auditing, DC recovery from IFM backups and password hash calculation.\nreferences:\n    - https://github.com/MichaelGrafnetter/DSInternals/blob/39ee8a69bbdc1cfd12c9afdd7513b4788c4895d4/Src/DSInternals.PowerShell/DSInternals.psd1\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2024-06-26\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Add-ADDBSidHistory'\n            - 'Add-ADNgcKey'\n            - 'Add-ADReplNgcKey'\n            - 'ConvertFrom-ADManagedPasswordBlob'\n            - 'ConvertFrom-GPPrefPassword'\n            - 'ConvertFrom-ManagedPasswordBlob'\n            - 'ConvertFrom-UnattendXmlPassword'\n            - 'ConvertFrom-UnicodePassword'\n            - 'ConvertTo-AADHash'\n            - 'ConvertTo-GPPrefPassword'\n            - 'ConvertTo-KerberosKey'\n            - 'ConvertTo-LMHash'\n            - 'ConvertTo-MsoPasswordHash'\n            - 'ConvertTo-NTHash'\n            - 'ConvertTo-OrgIdHash'\n            - 'ConvertTo-UnicodePassword'\n            - 'Disable-ADDBAccount'\n            - 'Enable-ADDBAccount'\n            - 'Get-ADDBAccount'\n            - 'Get-ADDBBackupKey'\n            - 'Get-ADDBDomainController'\n            - 'Get-ADDBGroupManagedServiceAccount'\n            - 'Get-ADDBKdsRootKey'\n            - 'Get-ADDBSchemaAttribute'\n            - 'Get-ADDBServiceAccount'\n            - 'Get-ADDefaultPasswordPolicy'\n            - 'Get-ADKeyCredential' # Covers 'Get-ADKeyCredentialLink'\n            - 'Get-ADPasswordPolicy'\n            - 'Get-ADReplAccount'\n            - 'Get-ADReplBackupKey'\n            - 'Get-ADReplicationAccount'\n            - 'Get-ADSIAccount'\n            - 'Get-AzureADUserEx'\n            - 'Get-BootKey'\n            - 'Get-KeyCredential'\n            - 'Get-LsaBackupKey'\n            - 'Get-LsaPolicy' # Covers 'Get-LsaPolicyInformation'\n            - 'Get-SamPasswordPolicy'\n            - 'Get-SysKey'\n            - 'Get-SystemKey'\n            - 'New-ADDBRestoreFromMediaScript'\n            - 'New-ADKeyCredential' # Covers 'New-ADKeyCredentialLink'\n            - 'New-ADNgcKey'\n            - 'New-NTHashSet'\n            - 'Remove-ADDBObject'\n            - 'Save-DPAPIBlob'\n            - 'Set-ADAccountPasswordHash'\n            - 'Set-ADDBAccountPassword' # Covers 'Set-ADDBAccountPasswordHash'\n            - 'Set-ADDBBootKey'\n            - 'Set-ADDBDomainController'\n            - 'Set-ADDBPrimaryGroup'\n            - 'Set-ADDBSysKey'\n            - 'Set-AzureADUserEx'\n            - 'Set-LsaPolicy' # Covers 'Set-LSAPolicyInformation'\n            - 'Set-SamAccountPasswordHash'\n            - 'Set-WinUserPasswordHash'\n            - 'Test-ADDBPasswordQuality'\n            - 'Test-ADPasswordQuality'\n            - 'Test-ADReplPasswordQuality'\n            - 'Test-PasswordQuality'\n            - 'Unlock-ADDBAccount'\n            - 'Write-ADNgcKey'\n            - 'Write-ADReplNgcKey'\n    condition: selection\nfalsepositives:\n    - Legitimate usage of DSInternals for administration or audit purpose.\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_download_com_cradles.yml","content":"title: Potential COM Objects Download Cradles Usage - PS Script\nid: 3c7d1587-3b13-439f-9941-7d14313dbdfe\nrelated:\n    - id: 02b64f1b-3f33-4e67-aede-ef3b0a5a8fcf\n      type: similar\nstatus: test\ndescription: Detects usage of COM objects that can be abused to download files in PowerShell by CLSID\nreferences:\n    - https://learn.microsoft.com/en-us/dotnet/api/system.type.gettypefromclsid?view=net-7.0\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=57\nauthor: frack113\ndate: 2022-12-25\ntags:\n    - attack.command-and-control\n    - attack.t1105\nlogsource:\n    product: windows\n    category: ps_script\n    definition: Script Block Logging must be enable\ndetection:\n    selection_1:\n        ScriptBlockText|contains: '[Type]::GetTypeFromCLSID('\n    selection_2:\n        ScriptBlockText|contains:\n            - '0002DF01-0000-0000-C000-000000000046'\n            - 'F6D90F16-9C73-11D3-B32E-00C04F990BB4'\n            - 'F5078F35-C551-11D3-89B9-0000F81FE221'\n            - '88d96a0a-f192-11d4-a65f-0040963251e5'\n            - 'AFBA6B42-5692-48EA-8141-DC517DCF0EF1'\n            - 'AFB40FFD-B609-40A3-9828-F88BBE11E4E3'\n            - '88d96a0b-f192-11d4-a65f-0040963251e5'\n            - '2087c2f4-2cef-4953-a8ab-66779b670495'\n            - '000209FF-0000-0000-C000-000000000046'\n            - '00024500-0000-0000-C000-000000000046'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use of the library\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_dotnet_assembly_from_file.yml","content":"title: Potential In-Memory Execution Using Reflection.Assembly\nid: ddcd88cb-7f62-4ce5-86f9-1704190feb0a\nstatus: test\ndescription: Detects usage of \"Reflection.Assembly\" load functions to dynamically load assemblies in memory\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=50\nauthor: frack113\ndate: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.t1620\nlogsource:\n    product: windows\n    category: ps_script\n    definition: Script Block Logging must be enable\ndetection:\n    selection:\n        ScriptBlockText|contains: '[Reflection.Assembly]::load'\n    condition: selection\nfalsepositives:\n    - Legitimate use of the library\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_disable_windows_optional_feature.yml","content":"title: Disable-WindowsOptionalFeature Command PowerShell\nid: 99c4658d-2c5e-4d87-828d-7c066ca537c3\nstatus: test\ndescription: |\n    Detect built in PowerShell cmdlet Disable-WindowsOptionalFeature, Deployment Image Servicing and Management tool.\n    Similar to DISM.exe, this cmdlet is used to enumerate, install, uninstall, configure, and update features and packages in Windows images\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/5b67c9b141fa3918017f8fa44f2f88f0b1ecb9e1/atomics/T1562.001/T1562.001.md\n    - https://learn.microsoft.com/en-us/powershell/module/dism/disable-windowsoptionalfeature?view=windowsserver2022-ps\nauthor: frack113\ndate: 2022-09-10\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmd:\n        ScriptBlockText|contains|all:\n            - 'Disable-WindowsOptionalFeature'\n            - '-Online'\n            - '-FeatureName'\n    selection_feature:\n        # Add any important windows features\n        ScriptBlockText|contains:\n            - 'Windows-Defender-Gui'\n            - 'Windows-Defender-Features'\n            - 'Windows-Defender'\n            - 'Windows-Defender-ApplicationGuard'\n            # - 'Containers-DisposableClientVM' # Windows Sandbox\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_disable_psreadline_command_history.yml","content":"title: Disable Powershell Command History\nid: 602f5669-6927-4688-84db-0d4b7afb2150\nstatus: test\ndescription: Detects scripts or commands that disabled the Powershell command history by removing psreadline module\nreferences:\n    - https://twitter.com/DissectMalware/status/1062879286749773824\nauthor: Ali Alwashali\ndate: 2022-08-21\ntags:\n    - attack.defense-evasion\n    - attack.t1070.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - Remove-Module\n            - psreadline\n    condition: selection\nfalsepositives:\n    - Legitimate script that disables the command history\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_directoryservices_accountmanagement.yml","content":"title: Manipulation of User Computer or Group Security Principals Across AD\nid: b29a93fb-087c-4b5b-a84d-ee3309e69d08\nstatus: test\ndescription: |\n    Adversaries may create a domain account to maintain access to victim systems.\n    Domain accounts are those managed by Active Directory Domain Services where access and permissions are configured across systems and services that are part of that domain..\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1136.002/T1136.002.md#atomic-test-3---create-a-new-domain-account-using-powershell\n    - https://learn.microsoft.com/en-us/dotnet/api/system.directoryservices.accountmanagement?view=net-8.0\nauthor: frack113\ndate: 2021-12-28\ntags:\n    - attack.persistence\n    - attack.t1136.002\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: System.DirectoryServices.AccountManagement\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_directorysearcher.yml","content":"title: DirectorySearcher Powershell Exploitation\nid: 1f6399cf-2c80-4924-ace1-6fcff3393480\nstatus: test\ndescription: Enumerates Active Directory to determine computers that are joined to the domain\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1018/T1018.md#atomic-test-15---enumerate-domain-computers-within-active-directory-using-directorysearcher\nauthor: frack113\ndate: 2022-02-12\ntags:\n    - attack.discovery\n    - attack.t1018\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'New-Object '\n            - 'System.DirectoryServices.DirectorySearcher'\n            - '.PropertiesToLoad.Add'\n            - '.findall()'\n            - 'Properties.name'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_detect_vm_env.yml","content":"title: Powershell Detect Virtualization Environment\nid: d93129cd-1ee0-479f-bc03-ca6f129882e3\nstatus: test\ndescription: |\n    Adversaries may employ various system checks to detect and avoid virtualization and analysis environments.\n    This may include changing behaviors based on the results of checks for the presence of artifacts indicative of a virtual machine environment (VME) or sandbox\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1497.001/T1497.001.md\n    - https://techgenix.com/malicious-powershell-scripts-evade-detection/\nauthor: frack113, Duc.Le-GTSC\ndate: 2021-08-03\nmodified: 2022-03-03\ntags:\n    - attack.discovery\n    - attack.defense-evasion\n    - attack.t1497.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_action:\n        ScriptBlockText|contains:\n            - Get-WmiObject\n            - gwmi\n    selection_module:\n        ScriptBlockText|contains:\n            - MSAcpi_ThermalZoneTemperature\n            - Win32_ComputerSystem\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_create_volume_shadow_copy.yml","content":"title: Create Volume Shadow Copy with Powershell\nid: afd12fed-b0ec-45c9-a13d-aa86625dac81\nstatus: test\ndescription: Adversaries may attempt to access or create a copy of the Active Directory domain database in order to steal credential information\nreferences:\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1&viewFallbackFrom=powershell-7\nauthor: frack113\ndate: 2022-01-12\ntags:\n    - attack.credential-access\n    - attack.t1003.003\n    - attack.ds0005\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - Win32_ShadowCopy\n            - ').Create('\n            - ClientAccessible\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_create_local_user.yml","content":"title: PowerShell Create Local User\nid: 243de76f-4725-4f2e-8225-a8a69b15ad61\nstatus: test\ndescription: Detects creation of a local user via PowerShell\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1136.001/T1136.001.md\nauthor: '@ROxPinTeddy'\ndate: 2020-04-11\nmodified: 2022-12-25\ntags:\n    - attack.execution\n    - attack.t1059.001\n    - attack.persistence\n    - attack.t1136.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: 'New-LocalUser'\n    condition: selection\nfalsepositives:\n    - Legitimate user creation\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_cor_profiler.yml","content":"title: Registry-Free Process Scope COR_PROFILER\nid: 23590215-4702-4a70-8805-8dc9e58314a2\nstatus: test\ndescription: |\n    Adversaries may leverage the COR_PROFILER environment variable to hijack the execution flow of programs that load the .NET CLR.\n    The COR_PROFILER is a .NET Framework feature which allows developers to specify an unmanaged (or external of .NET) profiling DLL to be loaded into each .NET process that loads the Common Language Runtime (CLR).\n    These profiliers are designed to monitor, troubleshoot, and debug managed code executed by the .NET CLR.\n    (Citation: Microsoft Profiling Mar 2017)\n    (Citation: Microsoft COR_PROFILER Feb 2013)\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1574.012/T1574.012.md#atomic-test-3---registry-free-process-scope-cor_profiler\nauthor: frack113\ndate: 2021-12-30\ntags:\n    - attack.privilege-escalation\n    - attack.defense-evasion\n    - attack.persistence\n    - attack.t1574.012\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - '$env:COR_ENABLE_PROFILING'\n            - '$env:COR_PROFILER'\n            - '$env:COR_PROFILER_PATH'\n    condition: selection\nfalsepositives:\n    - Legitimate administrative script\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_copy_item_system_directory.yml","content":"title: Powershell Install a DLL in System Directory\nid: 63bf8794-9917-45bc-88dd-e1b5abc0ecfd\nstatus: test\ndescription: Uses PowerShell to install/copy a file into a system directory such as \"System32\" or \"SysWOW64\"\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1556.002/T1556.002.md#atomic-test-1---install-and-register-password-filter-dll\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2021-12-27\nmodified: 2024-01-22\ntags:\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.credential-access\n    - attack.t1556.002\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|re: '(Copy-Item|cpi) .{2,128} -Destination .{1,32}\\\\Windows\\\\(System32|SysWOW64)'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_computer_discovery_get_adcomputer.yml","content":"title: Computer Discovery And Export Via Get-ADComputer Cmdlet - PowerShell\nid: db885529-903f-4c5d-9864-28fe199e6370\nrelated:\n    - id: 435e10e4-992a-4281-96f3-38b11106adde\n      type: similar\nstatus: test\ndescription: Detects usage of the Get-ADComputer cmdlet to collect computer information and output it to a file\nreferences:\n    - http://blog.talosintelligence.com/2022/09/lazarus-three-rats.html\n    - https://www.microsoft.com/en-us/security/blog/2022/10/18/defenders-beware-a-case-for-post-ransomware-investigations/\n    - https://www.cisa.gov/uscert/sites/default/files/publications/aa22-320a_joint_csa_iranian_government-sponsored_apt_actors_compromise_federal%20network_deploy_crypto%20miner_credential_harvester.pdf\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2022-11-17\ntags:\n    - attack.discovery\n    - attack.t1033\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Get-ADComputer '\n            - ' -Filter \\*'\n        ScriptBlockText|contains:\n            - ' | Select '\n            - 'Out-File'\n            - 'Set-Content'\n            - 'Add-Content'\n    condition: selection\nfalsepositives:\n    - Legitimate admin scripts may use the same technique, it's better to exclude specific computers or users who execute these commands or scripts often\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_cmdlet_scheduled_task.yml","content":"title: Powershell Create Scheduled Task\nid: 363eccc0-279a-4ccf-a3ab-24c2e63b11fb\nstatus: test\ndescription: Adversaries may abuse the Windows Task Scheduler to perform task scheduling for initial or recurring execution of malicious code\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1053.005/T1053.005.md#atomic-test-4---powershell-cmdlet-scheduled-task\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1053.005/T1053.005.md#atomic-test-6---wmi-invoke-cimmethod-scheduled-task\nauthor: frack113\ndate: 2021-12-28\nmodified: 2025-10-07\ntags:\n    - attack.privilege-escalation\n    - attack.execution\n    - attack.persistence\n    - attack.t1053.005\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains:\n            - 'New-ScheduledTaskAction'\n            - 'New-ScheduledTaskTrigger'\n            - 'New-ScheduledTaskPrincipal'\n            - 'New-ScheduledTaskSettingsSet'\n            - 'New-ScheduledTask'\n            - 'Register-ScheduledTask'\n    selection_cimmethod:\n        ScriptBlockText|contains|all:\n            - 'Invoke-CimMethod'\n            - '-ClassName'\n            - 'PS_ScheduledTask'\n            - '-NameSpace'\n            - 'Root\\Microsoft\\Windows\\TaskScheduler'\n    filter_main_legitimate_scripts:\n        ScriptBlockText|contains|all:\n            - 'Microsoft.PowerShell.Core\\Export-ModuleMember'\n            - 'Microsoft.Management.Infrastructure.CimInstance'\n            - '__cmdletization_methodParameter'\n    condition: 1 of selection_* and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_clear_powershell_history.yml","content":"title: Clear PowerShell History - PowerShell\nid: 26b692dc-1722-49b2-b496-a8258aa6371d\nrelated:\n    - id: dfba4ce1-e0ea-495f-986e-97140f31af2d\n      type: derived\nstatus: test\ndescription: Detects keywords that could indicate clearing PowerShell history\nreferences:\n    - https://gist.github.com/hook-s3c/7363a856c3cdbadeb71085147f042c1a\nauthor: Ilyas Ochkov, Jonhnathan Ribeiro, Daniil Yugoslavskiy, oscd.community\ndate: 2022-01-25\nmodified: 2022-12-02\ntags:\n    - attack.defense-evasion\n    - attack.t1070.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection1a:\n        ScriptBlockText|contains:\n            - 'del'\n            - 'Remove-Item'\n            - 'rm'\n    selection1b:\n        ScriptBlockText|contains: '(Get-PSReadlineOption).HistorySavePath'\n    selection_2:\n        ScriptBlockText|contains|all:\n            - 'Set-PSReadlineOption'\n            - 'â€“HistorySaveStyle'  # not sure if the homoglyph â€“/- is intended, just checking for both\n            - 'SaveNothing'\n    selection_3:\n        ScriptBlockText|contains|all:\n            - 'Set-PSReadlineOption'\n            - '-HistorySaveStyle'\n            - 'SaveNothing'\n    condition: 1 of selection_* or all of selection1*\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_clearing_windows_console_history.yml","content":"title: Clearing Windows Console History\nid: bde47d4b-9987-405c-94c7-b080410e8ea7\nstatus: test\ndescription: Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised account to conceal the actions undertaken during an intrusion.\nreferences:\n    - https://stefanos.cloud/blog/kb/how-to-clear-the-powershell-command-history/\n    - https://www.shellhacks.com/clear-history-powershell/\n    - https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics\nauthor: Austin Songer @austinsonger\ndate: 2021-11-25\nmodified: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.t1070\n    - attack.t1070.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection1:\n        ScriptBlockText|contains: Clear-History\n    selection2a:\n        ScriptBlockText|contains:\n            - Remove-Item\n            - rm\n    selection2b:\n        ScriptBlockText|contains:\n            - ConsoleHost_history.txt\n            - (Get-PSReadlineOption).HistorySavePath\n    condition: selection1 or selection2a and selection2b\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_capture_screenshots.yml","content":"title: Windows Screen Capture with CopyFromScreen\nid: d4a11f63-2390-411c-9adf-d791fd152830\nstatus: test\ndescription: |\n    Adversaries may attempt to take screen captures of the desktop to gather information over the course of an operation.\n    Screen capturing functionality may be included as a feature of a remote access tool used in post-compromise operations\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1113/T1113.md#atomic-test-6---windows-screen-capture-copyfromscreen\nauthor: frack113\ndate: 2021-12-28\nmodified: 2022-07-07\ntags:\n    - attack.collection\n    - attack.t1113\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains: '.CopyFromScreen'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_automated_collection.yml","content":"title: Automated Collection Command PowerShell\nid: c1dda054-d638-4c16-afc8-53e007f3fbc5\nstatus: test\ndescription: Once established within a system or network, an adversary may use automated techniques for collecting internal data.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1119/T1119.md\nauthor: frack113\ndate: 2021-07-28\nmodified: 2022-12-25\ntags:\n    - attack.collection\n    - attack.t1119\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_ext:\n        ScriptBlockText|contains:\n            - '.doc'\n            - '.docx'\n            - '.xls'\n            - '.xlsx'\n            - '.ppt'\n            - '.pptx'\n            - '.rtf'\n            - '.pdf'\n            - '.txt'\n    selection_cmd:\n        ScriptBlockText|contains|all:\n            - 'Get-ChildItem'\n            - ' -Recurse '\n            - ' -Include '\n    condition: all of selection*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_audio_exfiltration.yml","content":"title: Potential Data Exfiltration Via Audio File\nid: e4f93c99-396f-47c8-bb0f-201b1fa69034\nstatus: test\ndescription: Detects potential exfiltration attempt via audio file using PowerShell\nreferences:\n    - https://github.com/gtworek/PSBits/blob/e97cbbb173b31cbc4d37244d3412de0a114dacfb/NoDLP/bin2wav.ps1\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-16\ntags:\n    - attack.exfiltration\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_main:\n        ScriptBlockText|contains|all:\n            - '[System.Math]::'\n            - '[IO.FileMode]::'\n            - 'BinaryWriter'\n    selection_header_wav:\n        ScriptBlockText|contains|all:\n            # Byte chunks from the WAV header used in the example POC\n            # You can extend this for different audio formats by adding different selections\n            - '0x52'\n            - '0x49'\n            - '0x46'\n            - '0x57'\n            - '0x41'\n            - '0x56'\n            - '0x45'\n            - '0xAC'\n    condition: selection_main and 1 of selection_header_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_as_rep_roasting.yml","content":"title: Get-ADUser Enumeration Using UserAccountControl Flags\nid: 96c982fe-3d08-4df4-bed2-eb14e02f21c8\nstatus: test\ndescription: Detects AS-REP roasting is an attack that is often-overlooked. It is not very common as you have to explicitly set accounts that do not require pre-authentication.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1069.002/T1069.002.md#atomic-test-11---get-aduser-enumeration-using-useraccountcontrol-flags-as-rep-roasting\n    - https://shellgeek.com/useraccountcontrol-flags-to-manipulate-properties/\nauthor: frack113\ndate: 2022-03-17\ntags:\n    - attack.discovery\n    - attack.t1033\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        # 4194304 DONT_REQ_PREAUTH\n        ScriptBlockText|contains|all:\n            - 'Get-ADUser'\n            - '-Filter'\n            - 'useraccountcontrol'\n            - '-band'\n            - '4194304'\n    condition: selection\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_apt_silence_eda.yml","content":"title: Silence.EDA Detection\nid: 3ceb2083-a27f-449a-be33-14ec1b7cc973\nstatus: test\ndescription: Detects Silence EmpireDNSAgent as described in the Group-IP report\nreferences:\n    - https://www.group-ib.com/resources/threat-research/silence_2.0.going_global.pdf\nauthor: Alina Stepchenkova, Group-IB, oscd.community\ndate: 2019-11-01\nmodified: 2023-04-03\ntags:\n    - attack.execution\n    - attack.t1059.001\n    - attack.command-and-control\n    - attack.t1071.004\n    - attack.t1572\n    - attack.impact\n    - attack.t1529\n    - attack.g0091\n    - attack.s0363\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    empire:\n        # better to randomise the order\n        ScriptBlockText|contains|all:\n            - 'System.Diagnostics.Process'\n            - 'Stop-Computer'\n            - 'Restart-Computer'\n            - 'Exception in execution'\n            - '$cmdargs'\n            - 'Close-Dnscat2Tunnel'\n    dnscat:\n        # better to randomise the order\n        ScriptBlockText|contains|all:\n            - 'set type=$LookupType`nserver'\n            - '$Command | nslookup 2>&1 | Out-String'\n            - 'New-RandomDNSField'\n            - '[Convert]::ToString($SYNOptions, 16)'\n            - '$Session.Dead = $True'\n            - '$Session[\"Driver\"] -eq'\n    condition: empire and dnscat\nfalsepositives:\n    - Unknown\nlevel: critical\n"},{"path":"powershell\\powershell_script\\posh_ps_amsi_null_bits_bypass.yml","content":"title: Potential AMSI Bypass Script Using NULL Bits\nid: fa2559c8-1197-471d-9cdd-05a0273d4522\nrelated:\n    - id: 92a974db-ab84-457f-9ec0-55db83d7a825\n      type: similar\nstatus: test\ndescription: Detects usage of special strings/null bits in order to potentially bypass AMSI functionalities\nreferences:\n    - https://github.com/r00t-3xp10it/hacking-material-books/blob/43cb1e1932c16ff1f58b755bc9ab6b096046853f/obfuscation/simple_obfuscation.md#amsi-bypass-using-null-bits-satoshi\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-04\nmodified: 2023-05-09\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - \"if(0){{{0}}}' -f $(0 -as [char]) +\"\n            - \"#<NULL>\"\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_amsi_bypass_pattern_nov22.yml","content":"title: AMSI Bypass Pattern Assembly GetType\nid: e0d6c087-2d1c-47fd-8799-3904103c5a98\nstatus: test\ndescription: Detects code fragments found in small and obfuscated AMSI bypass PowerShell scripts\nreferences:\n    - https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/\n    - https://twitter.com/cyb3rops/status/1588574518057979905?s=20&t=A7hh93ONM7ni1Rj1jO5OaA\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-11-09\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\n    - attack.execution\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - '[Ref].Assembly.GetType'\n            - 'SetValue($null,$true)'\n            - 'NonPublic,Static'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_adrecon_execution.yml","content":"title: PowerShell ADRecon Execution\nid: bf72941a-cba0-41ea-b18c-9aca3925690d\nstatus: test\ndescription: Detects execution of ADRecon.ps1 for AD reconnaissance which has been reported to be actively used by FIN7\nreferences:\n    - https://github.com/sense-of-security/ADRecon/blob/11881a24e9c8b207f31b56846809ce1fb189bcc9/ADRecon.ps1\n    - https://bi-zone.medium.com/from-pentest-to-apt-attack-cybercriminal-group-fin7-disguises-its-malware-as-an-ethical-hackers-c23c9a75e319\nauthor: Bhabesh Raj\ndate: 2021-07-16\nmodified: 2022-09-06\ntags:\n    - attack.discovery\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            - 'Function Get-ADRExcelComOb'\n            - 'Get-ADRGPO'\n            - 'Get-ADRDomainController'\n            - 'ADRecon-Report.xlsx' # Default\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_add_windows_capability.yml","content":"title: Add Windows Capability Via PowerShell Script\nid: 155c7fd5-47b4-49b2-bbeb-eb4fab335429\nrelated:\n    - id: b36d01a3-ddaf-4804-be18-18a6247adfcd\n      type: similar\nstatus: test\ndescription: Detects usage of the \"Add-WindowsCapability\" cmdlet to add Windows capabilities. Notable capabilities could be \"OpenSSH\" and others.\nreferences:\n    - https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse?tabs=powershell\n    - https://www.virustotal.com/gui/file/af1c82237b6e5a3a7cdbad82cc498d298c67845d92971bada450023d1335e267/content\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-22\nmodified: 2023-05-09\ntags:\n    - attack.execution\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmdlet:\n        ScriptBlockText|contains: 'Add-WindowsCapability '\n    selection_capa:\n        ScriptBlockText|contains: '-Name OpenSSH.' # For both \"OpenSSH.Server\" and \"OpenSSH.Client\"\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate usage of the capabilities by administrators or users. Add additional filters accordingly.\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_add_dnsclient_rule.yml","content":"title: Powershell Add Name Resolution Policy Table Rule\nid: 4368354e-1797-463c-bc39-a309effbe8d7\nstatus: test\ndescription: |\n  Detects powershell scripts that adds a Name Resolution Policy Table (NRPT) rule for the specified namespace.\n  This will bypass the default DNS server and uses a specified server for answering the query.\nreferences:\n    - https://twitter.com/NathanMcNulty/status/1569497348841287681\n    - https://learn.microsoft.com/en-us/powershell/module/dnsclient/add-dnsclientnrptrule?view=windowsserver2022-ps\nauthor: Borna Talebi\ndate: 2021-09-14\nmodified: 2022-10-09\ntags:\n    - attack.impact\n    - attack.t1565\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection:\n        ScriptBlockText|contains|all:\n            - 'Add-DnsClientNrptRule'\n            - '-Namesp'\n            - '-NameSe'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_script\\posh_ps_active_directory_module_dll_import.yml","content":"title: Potential Active Directory Enumeration Using AD Module - PsScript\nid: 9e620995-f2d8-4630-8430-4afd89f77604\nrelated:\n    - id: 70bc5215-526f-4477-963c-a47a5c9ebd12\n      type: similar\n    - id: 74176142-4684-4d8a-8b0a-713257e7df8e\n      type: similar\nstatus: test\ndescription: Detects usage of the \"Import-Module\" cmdlet to load the \"Microsoft.ActiveDirectory.Management.dl\" DLL. Which is often used by attackers to perform AD enumeration.\nreferences:\n    - https://github.com/samratashok/ADModule\n    - https://twitter.com/cyb3rops/status/1617108657166061568?s=20\n    - https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/active-directory-enumeration-with-ad-module-without-rsat-or-admin-privileges\nauthor: frack113, Nasreddine Bencherchali\ndate: 2023-01-22\ntags:\n    - attack.reconnaissance\n    - attack.discovery\n    - attack.impact\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enable'\ndetection:\n    selection_generic:\n        ScriptBlockText|contains|all:\n            - 'Import-Module '\n            - 'Microsoft.ActiveDirectory.Management.dll'\n    selection_specific:\n        ScriptBlockText|contains: 'ipmo Microsoft.ActiveDirectory.Management.dll'\n    condition: 1 of selection_*\nfalsepositives:\n    - Legitimate use of the library for administrative activity\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_access_to_browser_login_data.yml","content":"title: Access to Browser Login Data\nid: fc028194-969d-4122-8abe-0470d5b8f12f\nrelated:\n    - id: 98f4c75c-3089-44f3-b733-b327b9cd9c9d\n      type: obsolete\n    - id: 47147b5b-9e17-4d76-b8d2-7bac24c5ce1b\n      type: similar\nstatus: test\ndescription: |\n    Adversaries may acquire credentials from web browsers by reading files specific to the target browser.\n    Web browsers commonly save credentials such as website usernames and passwords so that they do not need to be entered manually in the future.\n    Web browsers typically store the credentials in an encrypted format within a credential store.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1555.003/T1555.003.md\nauthor: frack113\ndate: 2022-01-30\ntags:\n    - attack.credential-access\n    - attack.t1555.003\nlogsource:\n    product: windows\n    category: ps_script\n    definition: 'Requirements: Script Block Logging must be enabled'\ndetection:\n    selection_cmd:\n        ScriptBlockText|contains|all:\n            - Copy-Item\n            - '-Destination'\n    selection_path:\n        ScriptBlockText|contains:\n            - '\\Opera Software\\Opera Stable\\Login Data'\n            - '\\Mozilla\\Firefox\\Profiles'\n            - '\\Microsoft\\Edge\\User Data\\Default'\n            - '\\Google\\Chrome\\User Data\\Default\\Login Data'\n            - '\\Google\\Chrome\\User Data\\Default\\Login Data For Account'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_script\\posh_ps_aadinternals_cmdlets_execution.yml","content":"title: AADInternals PowerShell Cmdlets Execution - PsScript\nid: 91e69562-2426-42ce-a647-711b8152ced6\nrelated:\n    - id: c86500e9-a645-4680-98d7-f882c70c1ea3\n      type: similar\nstatus: test\ndescription: Detects ADDInternals Cmdlet execution. A tool for administering Azure AD and Office 365. Which can be abused by threat actors to attack Azure AD or Office 365.\nreferences:\n    - https://o365blog.com/aadinternals/\n    - https://github.com/Gerenios/AADInternals\nauthor: Austin Songer (@austinsonger), Nasreddine Bencherchali (Nextron Systems), Swachchhanda Shrawan Poudel (Nextron Systems)\ndate: 2022-12-23\nmodified: 2025-02-06\ntags:\n    - attack.execution\n    - attack.reconnaissance\n    - attack.discovery\n    - attack.credential-access\n    - attack.impact\nlogsource:\n    product: windows\n    category: ps_script\n    definition: Script Block Logging must be enable\ndetection:\n    selection:\n        ScriptBlockText|contains:\n            # Since most of the cmdlets use a unique enough string which is \"-AADInt\" we only used that portion. For a complete list please check the references linked above\n            - 'Add-AADInt'\n            - 'ConvertTo-AADInt'\n            - 'Disable-AADInt'\n            - 'Enable-AADInt'\n            - 'Export-AADInt'\n            - 'Find-AADInt'\n            - 'Get-AADInt'\n            - 'Grant-AADInt'\n            - 'Initialize-AADInt'\n            - 'Install-AADInt'\n            - 'Invoke-AADInt'\n            - 'Join-AADInt'\n            - 'New-AADInt'\n            - 'Open-AADInt'\n            - 'Read-AADInt'\n            - 'Register-AADInt'\n            - 'Remove-AADInt'\n            - 'Reset-AADInt'\n            - 'Resolve-AADInt'\n            - 'Restore-AADInt'\n            - 'Save-AADInt'\n            - 'Search-AADInt'\n            - 'Send-AADInt'\n            - 'Set-AADInt'\n            - 'Start-AADInt'\n            - 'Unprotect-AADInt'\n            - 'Update-AADInt'\n    condition: selection\nfalsepositives:\n    - Legitimate use of the library for administrative activity\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_syncappvpublishingserver_exe.yml","content":"title: SyncAppvPublishingServer Bypass Powershell Restriction - PS Module\nid: fe5ce7eb-dad8-467c-84a9-31ec23bd644a\nrelated:\n    - id: fde7929d-8beb-4a4c-b922-be9974671667\n      type: derived\n    - id: 9f7aa113-9da6-4a8d-907c-5f1a4b908299\n      type: derived\nstatus: test\ndescription: Detects SyncAppvPublishingServer process execution which usually utilized by adversaries to bypass PowerShell execution restrictions.\nreferences:\n    - https://lolbas-project.github.io/lolbas/Binaries/Syncappvpublishingserver/\nauthor: 'Ensar Åžamil, @sblmsrsn, OSCD Community'\ndate: 2020-10-05\nmodified: 2022-12-02\ntags:\n    - attack.defense-evasion\n    - attack.t1218\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        ContextInfo|contains: 'SyncAppvPublishingServer.exe'\n    condition: selection\nfalsepositives:\n    - App-V clients\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_zip_compress.yml","content":"title: Zip A Folder With PowerShell For Staging In Temp  - PowerShell Module\nid: daf7eb81-35fd-410d-9d7a-657837e602bb # PowerShell Module\nrelated:\n    - id: 71ff406e-b633-4989-96ec-bc49d825a412 # PowerShell Classic\n      type: similar\n    - id: b7a3c9a3-09ea-4934-8864-6a32cacd98d9 # PowerShell Script\n      type: similar\n    - id: 85a8e5ba-bd03-4bfb-bbfa-a4409a8f8b98 # Process Creation\n      type: similar\nstatus: test\ndescription: |\n    Detects PowerShell scripts that make use of the \"Compress-Archive\" Cmdlet in order to compress folders and files where the output is stored in a potentially suspicious location that is used often by malware for exfiltration.\n    An adversary might compress data (e.g., sensitive documents) that is collected prior to exfiltration in order to make it portable and minimize the amount of data sent over the network.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1074.001/T1074.001.md\n    - https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-347a\nauthor: Nasreddine Bencherchali (Nextron Systems), frack113\ndate: 2021-07-20\nmodified: 2023-12-18\ntags:\n    - attack.collection\n    - attack.t1074.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        ContextInfo|contains|all:\n            - 'Compress-Archive -Path*-DestinationPath $env:TEMP'\n            - 'Compress-Archive -Path*-DestinationPath*\\AppData\\Local\\Temp\\'\n            - 'Compress-Archive -Path*-DestinationPath*:\\Windows\\Temp\\'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_smb_share_reco.yml","content":"title: Suspicious Get Information for SMB Share - PowerShell Module\nid: 6942bd25-5970-40ab-af49-944247103358\nstatus: test\ndescription: |\n    Adversaries may look for folders and drives shared on remote systems as a means of identifying sources of information to gather as a precursor for Collection and\n    to identify potential systems of interest for Lateral Movement.\n    Networks often contain shared network drives and folders that enable users to access file directories on various systems across a network.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1069.002/T1069.002.md\nauthor: frack113\ndate: 2021-12-15\nmodified: 2022-12-02\ntags:\n    - attack.discovery\n    - attack.t1069.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        - Payload|contains: get-smbshare\n        - ContextInfo|contains: get-smbshare\n    condition: selection\nfalsepositives:\n    - Administrator script\nlevel: low\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_reset_computermachinepassword.yml","content":"title: Suspicious Computer Machine Password by PowerShell\nid: e3818659-5016-4811-a73c-dde4679169d2\nstatus: test\ndescription: |\n    The Reset-ComputerMachinePassword cmdlet changes the computer account password that the computers use to authenticate to the domain controllers in the domain.\n    You can use it to reset the password of the local computer.\nreferences:\n    - https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/reset-computermachinepassword?view=powershell-5.1\n    - https://thedfirreport.com/2022/02/21/qbot-and-zerologon-lead-to-full-domain-compromise/\nauthor: frack113\ndate: 2022-02-21\ntags:\n    - attack.privilege-escalation\n    - attack.persistence\n    - attack.defense-evasion\n    - attack.initial-access\n    - attack.t1078\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        ContextInfo|contains: 'Reset-ComputerMachinePassword'\n    condition: selection\nfalsepositives:\n    - Administrator PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_local_group_reco.yml","content":"title: Suspicious Get Local Groups Information\nid: cef24b90-dddc-4ae1-a09a-8764872f69fc\nrelated:\n    - id: fa6a5a45-3ee2-4529-aa14-ee5edc9e29cb\n      type: similar\nstatus: test\ndescription: |\n    Detects the use of PowerShell modules and cmdlets to gather local group information.\n    Adversaries may use local system permission groups to determine which groups exist and which users belong to a particular group such as the local administrators group.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1069.001/T1069.001.md\nauthor: frack113\ndate: 2021-12-12\nmodified: 2025-08-22\ntags:\n    - attack.discovery\n    - attack.t1069.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_localgroup:\n        - Payload|contains:\n              - 'get-localgroup '\n              - 'get-localgroupmember '\n        - ContextInfo|contains:\n              - 'get-localgroup '\n              - 'get-localgroupmember '\n    selection_wmi_module:\n        - Payload|contains:\n              - 'get-wmiobject '\n              - 'gwmi '\n              - 'get-ciminstance '\n              - 'gcim '\n        - ContextInfo|contains|all:\n              - 'get-wmiobject '\n              - 'gwmi '\n              - 'get-ciminstance '\n              - 'gcim '\n    selection_wmi_class:\n        - Payload|contains: 'win32_group'\n        - ContextInfo|contains: 'win32_group'\n    condition: selection_localgroup or all of selection_wmi_*\nfalsepositives:\n    - Administrator script\nlevel: low\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_invocation_specific.yml","content":"title: Suspicious PowerShell Invocations - Specific - PowerShell Module\nid: 8ff28fdd-e2fa-4dfa-aeda-ef3d61c62090\nrelated:\n    - id: fce5f582-cc00-41e1-941a-c6fabf0fdb8c\n      type: obsolete\n    - id: ae7fbf8e-f3cb-49fd-8db4-5f3bed522c71\n      type: similar\n    - id: 536e2947-3729-478c-9903-745aaffe60d2\n      type: similar\nstatus: test\ndescription: Detects suspicious PowerShell invocation command parameters\nreferences:\n    - Internal Research\n    - https://github.com/HackTricks-wiki/hacktricks/blob/e4c7b21b8f36c97c35b7c622732b38a189ce18f7/src/windows-hardening/windows-local-privilege-escalation/privilege-escalation-with-autorun-binaries.md\nauthor: Florian Roth (Nextron Systems), Jonhnathan Ribeiro\ndate: 2017-03-05\nmodified: 2025-02-17\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_convert_b64:\n        ContextInfo|contains|all:\n            - '-nop'\n            - ' -w '\n            - 'hidden'\n            - ' -c '\n            - '[Convert]::FromBase64String'\n    selection_iex:\n        ContextInfo|contains|all:\n            - ' -w '\n            - 'hidden'\n            - '-noni'\n            - '-nop'\n            - ' -c '\n            - 'iex'\n            - 'New-Object'\n    selection_enc:\n        ContextInfo|contains|all:\n            - ' -w '\n            - 'hidden'\n            - '-ep'\n            - 'bypass'\n            - '-Enc'\n    selection_reg:\n        ContextInfo|contains|all:\n            - 'powershell'\n            - 'reg'\n            - 'add'\n        ContextInfo|contains:\n            - '\\software\\microsoft\\windows\\currentversion\\run'\n            - '\\software\\wow6432node\\microsoft\\windows\\currentversion\\run'\n            - '\\software\\microsoft\\windows\\currentversion\\policies\\explorer\\run'\n    selection_webclient:\n        ContextInfo|contains|all:\n            - 'bypass'\n            - '-noprofile'\n            - '-windowstyle'\n            - 'hidden'\n            - 'new-object'\n            - 'system.net.webclient'\n            - '.download'\n    selection_iex_webclient:\n        ContextInfo|contains|all:\n            - 'iex'\n            - 'New-Object'\n            - 'Net.WebClient'\n            - '.Download'\n    filter_chocolatey:\n        ContextInfo|contains:\n            - \"(New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1\"\n            - 'Write-ChocolateyWarning'\n    condition: 1 of selection_* and not 1 of filter_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_invocation_generic.yml","content":"title: Suspicious PowerShell Invocations - Generic - PowerShell Module\nid: bbb80e91-5746-4fbe-8898-122e2cafdbf4\nrelated:\n    - id: 3d304fda-78aa-43ed-975c-d740798a49c1\n      type: derived\n    - id: ed965133-513f-41d9-a441-e38076a0798f\n      type: similar\nstatus: test\ndescription: Detects suspicious PowerShell invocation command parameters\nreferences:\n    - Internal Research\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-03-12\nmodified: 2023-01-03\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_encoded:\n        ContextInfo|contains:\n            - ' -enc '\n            - ' -EncodedCommand '\n            - ' -ec '\n    selection_hidden:\n        ContextInfo|contains:\n            - ' -w hidden '\n            - ' -window hidden '\n            - ' -windowstyle hidden '\n            - ' -w 1 '\n    selection_noninteractive:\n        ContextInfo|contains:\n            - ' -noni '\n            - ' -noninteractive '\n    condition: all of selection*\nfalsepositives:\n    - Very special / sneaky PowerShell scripts\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_get_nettcpconnection.yml","content":"title: Use Get-NetTCPConnection - PowerShell Module\nid: aff815cc-e400-4bf0-a47a-5d8a2407d4e1\nstatus: test\ndescription: Adversaries may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1049/T1049.md#atomic-test-2---system-network-connections-discovery-with-powershell\nauthor: frack113\ndate: 2021-12-10\nmodified: 2022-12-02\ntags:\n    - attack.discovery\n    - attack.t1049\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        ContextInfo|contains: 'Get-NetTCPConnection'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_download.yml","content":"title: Suspicious PowerShell Download - PoshModule\nid: de41232e-12e8-49fa-86bc-c05c7e722df9\nrelated:\n    - id: 65531a81-a694-4e31-ae04-f8ba5bc33759\n      type: derived\nstatus: test\ndescription: Detects suspicious PowerShell download command\nreferences:\n    - https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-8.0\n    - https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-8.0\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-03-05\nmodified: 2023-01-20\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_webclient_:\n        ContextInfo|contains: 'System.Net.WebClient'\n    selection_function:\n        ContextInfo|contains:\n            - '.DownloadFile('\n            - '.DownloadString('\n    condition: all of selection_*\nfalsepositives:\n    - PowerShell scripts that download content from the Internet\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_susp_ad_group_reco.yml","content":"title: AD Groups Or Users Enumeration Using PowerShell - PoshModule\nid: 815bfc17-7fc6-4908-a55e-2f37b98cedb4\nstatus: test\ndescription: |\n    Adversaries may attempt to find domain-level groups and permission settings.\n    The knowledge of domain-level permission groups can help adversaries determine which groups exist and which users belong to a particular group.\n    Adversaries may use this information to determine which users have elevated permissions, such as domain administrators.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1069.002/T1069.002.md\nauthor: frack113\ndate: 2021-12-15\nmodified: 2023-01-20\ntags:\n    - attack.discovery\n    - attack.t1069.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_ad_principal:\n        - Payload|contains: 'get-ADPrincipalGroupMembership'\n        - ContextInfo|contains: 'get-ADPrincipalGroupMembership'\n    selection_get_aduser:\n        - Payload|contains|all:\n              - get-aduser\n              - '-f '\n              - '-pr '\n              - DoesNotRequirePreAuth\n        - ContextInfo|contains|all:\n              - get-aduser\n              - '-f '\n              - '-pr '\n              - DoesNotRequirePreAuth\n    condition: 1 of selection_*\nfalsepositives:\n    - Administrator script\nlevel: low\n"},{"path":"powershell\\powershell_module\\posh_pm_remote_powershell_session.yml","content":"title: Remote PowerShell Session (PS Module)\nid: 96b9f619-aa91-478f-bacb-c3e50f8df575\nstatus: test\ndescription: Detects remote PowerShell sessions\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190511-RemotePwshExecution/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g, Tim Shelton\ndate: 2019-08-10\nmodified: 2023-01-20\ntags:\n    - attack.execution\n    - attack.t1059.001\n    - attack.lateral-movement\n    - attack.t1021.006\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        ContextInfo|contains|all:\n            - ' = ServerRemoteHost ' #  HostName: 'ServerRemoteHost'  french : Nom dâ€™hÃ´te =\n            - 'wsmprovhost.exe'      #  HostApplication|contains: 'wsmprovhost.exe' french  Application hÃ´te =\n    filter_pwsh_archive:\n        ContextInfo|contains: '\\Windows\\system32\\WindowsPowerShell\\v1.0\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1'\n    condition: selection and not 1 of filter_*\nfalsepositives:\n    - Legitimate use remote PowerShell sessions\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_remotefxvgpudisablement_abuse.yml","content":"title: Potential RemoteFXvGPUDisablement.EXE Abuse - PowerShell Module\nid: 38a7625e-b2cb-485d-b83d-aff137d859f4\nrelated:\n    - id: a6fc3c46-23b8-4996-9ea2-573f4c4d88c5 # ProcCreation\n      type: similar\n    - id: f65e22f9-819e-4f96-9c7b-498364ae7a25 # PS Classic\n      type: similar\n    - id: cacef8fc-9d3d-41f7-956d-455c6e881bc5 # PS ScriptBlock\n      type: similar\nstatus: test\ndescription: Detects PowerShell module creation where the module Contents are set to \"function Get-VMRemoteFXPhysicalVideoAdapter\". This could be a sign of potential abuse of the \"RemoteFXvGPUDisablement.exe\" binary which is known to be vulnerable to module load-order hijacking.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1218/T1218.md\n    - https://github.com/redcanaryco/AtomicTestHarnesses/blob/7e1e4da116801e3d6fcc6bedb207064577e40572/TestHarnesses/T1218_SignedBinaryProxyExecution/InvokeRemoteFXvGPUDisablementCommand.ps1\nauthor: Nasreddine Bencherchali (Nextron Systems), frack113\ndate: 2021-07-13\nmodified: 2023-05-09\ntags:\n    - attack.defense-evasion\n    - attack.t1218\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        Payload|contains: 'ModuleContents=function Get-VMRemoteFXPhysicalVideoAdapter {'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_malicious_commandlets.yml","content":"title: Malicious PowerShell Commandlets - PoshModule\nid: 7d0d0329-0ef1-4e84-a9f5-49500f9d7c6c\nrelated:\n    - id: 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6\n      type: similar\n    - id: 02030f2f-6199-49ec-b258-ea71b07e03dc\n      type: similar\nstatus: test\ndescription: Detects Commandlet names from well-known PowerShell exploitation frameworks\nreferences:\n    - https://adsecurity.org/?p=2921\n    - https://github.com/S3cur3Th1sSh1t/PowerSharpPack/tree/master/PowerSharpBinaries\n    - https://github.com/BC-SECURITY/Invoke-ZeroLogon/blob/111d17c7fec486d9bb23387e2e828b09a26075e4/Invoke-ZeroLogon.ps1\n    - https://github.com/xorrior/RandomPS-Scripts/blob/848c919bfce4e2d67b626cbcf4404341cfe3d3b6/Get-DXWebcamVideo.ps1\n    - https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/6f23bb41f9675d7e2d32bacccff75e931ae00554/OfficeMemScraper.ps1\n    - https://github.com/dafthack/DomainPasswordSpray/blob/b13d64a5834694aa73fd2aea9911a83027c465a7/DomainPasswordSpray.ps1\n    - https://unit42.paloaltonetworks.com/threat-assessment-black-basta-ransomware/ # Invoke-TotalExec\n    - https://research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/ # Invoke-TotalExec\n    - https://github.com/calebstewart/CVE-2021-1675 # Invoke-Nightmare\n    - https://github.com/BloodHoundAD/BloodHound/blob/0927441f67161cc6dc08a53c63ceb8e333f55874/Collectors/AzureHound.ps1\n    - https://bloodhound.readthedocs.io/en/latest/data-collection/azurehound.html\n    - https://github.com/HarmJ0y/DAMP\n    - https://github.com/samratashok/nishang\n    - https://github.com/DarkCoderSc/PowerRunAsSystem/\n    - https://github.com/besimorhino/powercat\n    - https://github.com/Kevin-Robertson/Powermad\n    - https://github.com/adrecon/ADRecon\n    - https://github.com/adrecon/AzureADRecon\n    - https://github.com/sadshade/veeam-creds/blob/6010eaf31ba41011b58d6af3950cffbf6f5cea32/Veeam-Get-Creds.ps1\n    - https://github.com/The-Viper-One/Invoke-PowerDPAPI/\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-20\nmodified: 2025-07-06\ntags:\n    - attack.execution\n    - attack.discovery\n    - attack.t1482\n    - attack.t1087\n    - attack.t1087.001\n    - attack.t1087.002\n    - attack.t1069.001\n    - attack.t1069.002\n    - attack.t1069\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        Payload|contains:\n            # Note: Please ensure alphabetical order when adding new entries\n            - 'Add-Exfiltration'\n            - 'Add-Persistence'\n            - 'Add-RegBackdoor'\n            - 'Add-RemoteRegBackdoor'\n            - 'Add-ScrnSaveBackdoor'\n            - 'BadSuccessor'\n            - 'Check-VM'\n            - 'ConvertTo-Rc4ByteStream'\n            - 'Decrypt-Hash'\n            - 'Disable-ADIDNSNode'\n            - 'Disable-MachineAccount'\n            - 'Do-Exfiltration'\n            - 'Enable-ADIDNSNode'\n            - 'Enable-MachineAccount'\n            - 'Enabled-DuplicateToken'\n            - 'Exploit-Jboss'\n            - 'Export-ADR' # # ADRecon related cmdlets\n            - 'Export-ADRCSV' # # ADRecon related cmdlets\n            - 'Export-ADRExcel' # # ADRecon related cmdlets\n            - 'Export-ADRHTML' # # ADRecon related cmdlets\n            - 'Export-ADRJSON' # # ADRecon related cmdlets\n            - 'Export-ADRXML' # # ADRecon related cmdlets\n            - 'Find-Fruit'\n            - 'Find-GPOLocation'\n            - 'Find-TrustedDocuments'\n            - 'Get-ADIDNS' # Covers: Get-ADIDNSNodeAttribute, Get-ADIDNSNodeOwner, Get-ADIDNSNodeTombstoned, Get-ADIDNSPermission, Get-ADIDNSZone\n            - 'Get-ApplicationHost'\n            - 'Get-ChromeDump'\n            - 'Get-ClipboardContents'\n            - 'Get-FoxDump'\n            - 'Get-GPPPassword'\n            - 'Get-IndexedItem'\n            - 'Get-KerberosAESKey'\n            - 'Get-Keystrokes'\n            - 'Get-LSASecret'\n            - 'Get-MachineAccountAttribute'\n            - 'Get-MachineAccountCreator'\n            - 'Get-PassHashes'\n            - 'Get-RegAlwaysInstallElevated'\n            - 'Get-RegAutoLogon'\n            - 'Get-RemoteBootKey'\n            - 'Get-RemoteCachedCredential'\n            - 'Get-RemoteLocalAccountHash'\n            - 'Get-RemoteLSAKey'\n            - 'Get-RemoteMachineAccountHash'\n            - 'Get-RemoteNLKMKey'\n            - 'Get-RickAstley'\n            - 'Get-Screenshot'\n            - 'Get-SecurityPackages'\n            - 'Get-ServiceFilePermission'\n            - 'Get-ServicePermission'\n            - 'Get-ServiceUnquoted'\n            - 'Get-SiteListPassword'\n            - 'Get-System'\n            - 'Get-TimedScreenshot'\n            - 'Get-UnattendedInstallFile'\n            - 'Get-Unconstrained'\n            - 'Get-USBKeystrokes'\n            - 'Get-VaultCredential'\n            - 'Get-VulnAutoRun'\n            - 'Get-VulnSchTask'\n            - 'Grant-ADIDNSPermission'\n            - 'Gupt-Backdoor'\n            - 'HTTP-Login'\n            - 'Install-ServiceBinary'\n            - 'Install-SSP'\n            - 'Invoke-ACLScanner'\n            - 'Invoke-ADRecon' # # ADRecon related cmdlets\n            - 'Invoke-ADSBackdoor'\n            - 'Invoke-AgentSmith'\n            - 'Invoke-AllChecks'\n            - 'Invoke-ARPScan'\n            - 'Invoke-AzureHound'\n            - 'Invoke-BackdoorLNK'\n            - 'Invoke-BadPotato'\n            - 'Invoke-BetterSafetyKatz'\n            - 'Invoke-BypassUAC'\n            - 'Invoke-Carbuncle'\n            - 'Invoke-Certify'\n            - 'Invoke-ConPtyShell'\n            - 'Invoke-CredentialInjection'\n            - 'Invoke-DAFT'\n            - 'Invoke-DCSync'\n            - 'Invoke-DinvokeKatz'\n            - 'Invoke-DllInjection'\n            - 'Invoke-DNSUpdate'\n            - 'Invoke-DomainPasswordSpray'\n            - 'Invoke-DowngradeAccount'\n            - 'Invoke-EgressCheck'\n            - 'Invoke-Eyewitness'\n            - 'Invoke-FakeLogonScreen'\n            - 'Invoke-Farmer'\n            - 'Invoke-Get-RBCD-Threaded'\n            - 'Invoke-Gopher'\n            - 'Invoke-Grouper' # Also Covers Invoke-GrouperX\n            - 'Invoke-HandleKatz'\n            - 'Invoke-ImpersonatedProcess'\n            - 'Invoke-ImpersonateSystem'\n            - 'Invoke-InteractiveSystemPowerShell'\n            - 'Invoke-Internalmonologue'\n            - 'Invoke-Inveigh'\n            - 'Invoke-InveighRelay'\n            - 'Invoke-KrbRelay'\n            - 'Invoke-LdapSignCheck'\n            - 'Invoke-Lockless'\n            - 'Invoke-MalSCCM'\n            - 'Invoke-Mimikatz'\n            - 'Invoke-Mimikittenz'\n            - 'Invoke-MITM6'\n            - 'Invoke-NanoDump'\n            - 'Invoke-NetRipper'\n            - 'Invoke-Nightmare'\n            - 'Invoke-NinjaCopy'\n            - 'Invoke-OfficeScrape'\n            - 'Invoke-OxidResolver'\n            - 'Invoke-P0wnedshell'\n            - 'Invoke-Paranoia'\n            - 'Invoke-PortScan'\n            - 'Invoke-PoshRatHttp' # Also Covers Invoke-PoshRatHttps\n            - 'Invoke-PostExfil'\n            - 'Invoke-PowerDump'\n            - 'Invoke-PowerDPAPI'\n            - 'Invoke-PowerShellTCP'\n            - 'Invoke-PowerShellWMI'\n            - 'Invoke-PPLDump'\n            - 'Invoke-PsExec'\n            - 'Invoke-PSInject'\n            - 'Invoke-PsUaCme'\n            - 'Invoke-ReflectivePEInjection'\n            - 'Invoke-ReverseDNSLookup'\n            - 'Invoke-Rubeus'\n            - 'Invoke-RunAs'\n            - 'Invoke-SafetyKatz'\n            - 'Invoke-SauronEye'\n            - 'Invoke-SCShell'\n            - 'Invoke-Seatbelt'\n            - 'Invoke-ServiceAbuse'\n            - 'Invoke-ShadowSpray'\n            - 'Invoke-Sharp' # Covers all \"Invoke-Sharp\" variants\n            - 'Invoke-Shellcode'\n            - 'Invoke-SMBScanner'\n            - 'Invoke-Snaffler'\n            - 'Invoke-Spoolsample'\n            - 'Invoke-SpraySinglePassword'\n            - 'Invoke-SSHCommand'\n            - 'Invoke-StandIn'\n            - 'Invoke-StickyNotesExtract'\n            - 'Invoke-SystemCommand'\n            - 'Invoke-Tasksbackdoor'\n            - 'Invoke-Tater'\n            - 'Invoke-Thunderfox'\n            - 'Invoke-ThunderStruck'\n            - 'Invoke-TokenManipulation'\n            - 'Invoke-Tokenvator'\n            - 'Invoke-TotalExec'\n            - 'Invoke-UrbanBishop'\n            - 'Invoke-UserHunter'\n            - 'Invoke-VoiceTroll'\n            - 'Invoke-Whisker'\n            - 'Invoke-WinEnum'\n            - 'Invoke-winPEAS'\n            - 'Invoke-WireTap'\n            - 'Invoke-WmiCommand'\n            - 'Invoke-WMIExec'\n            - 'Invoke-WScriptBypassUAC'\n            - 'Invoke-Zerologon'\n            - 'MailRaider'\n            - 'New-ADIDNSNode'\n            - 'New-DNSRecordArray'\n            - 'New-HoneyHash'\n            - 'New-InMemoryModule'\n            - 'New-MachineAccount'\n            - 'New-SOASerialNumberArray'\n            - 'Out-Minidump'\n            - 'Port-Scan'\n            - 'PowerBreach'\n            - 'powercat '\n            - 'PowerUp'\n            - 'PowerView'\n            - 'Remove-ADIDNSNode'\n            - 'Remove-MachineAccount'\n            - 'Remove-Update'\n            - 'Rename-ADIDNSNode'\n            - 'Revoke-ADIDNSPermission'\n            - 'Set-ADIDNSNode' # Covers: Set-ADIDNSNodeAttribute, Set-ADIDNSNodeOwner\n            - 'Set-MacAttribute'\n            - 'Set-MachineAccountAttribute'\n            - 'Set-Wallpaper'\n            - 'Show-TargetScreen'\n            - 'Start-CaptureServer'\n            - 'Start-Dnscat2'\n            - 'Start-WebcamRecorder'\n            - 'Veeam-Get-Creds'\n            - 'VolumeShadowCopyTools'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_via_var.yml","content":"title: Invoke-Obfuscation VAR++ LAUNCHER OBFUSCATION - PowerShell Module\nid: f3c89218-8c3d-4ba9-9974-f1d8e6a1b4a6\nrelated:\n    - id: e54f5149-6ba3-49cf-b153-070d24679126\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via VAR++ LAUNCHER\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task27)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-13\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|re: '(?i)&&set.*(\\{\\d\\}){2,}\\\\\"\\s+?-f.*&&.*cmd.*/c' # FPs with |\\/r\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_via_use_rundll32.yml","content":"title: Invoke-Obfuscation Via Use Rundll32 - PowerShell Module\nid: 88a22f69-62f9-4b8a-aa00-6b0212f2f05a\nrelated:\n    - id: a5a30a6e-75ca-4233-8b8c-42e0f2037d3b\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via use Rundll32 in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009\nauthor: Nikita Nazarov, oscd.community\ndate: 2019-10-08\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|contains|all:\n            - '&&'\n            - 'rundll32'\n            - 'shell32.dll'\n            - 'shellexec_rundll'\n        Payload|contains:\n            - 'value'\n            - 'invoke'\n            - 'comspec'\n            - 'iex'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_via_use_mhsta.yml","content":"title: Invoke-Obfuscation Via Use MSHTA - PowerShell Module\nid: 07ad2ea8-6a55-4ac6-bf3e-91b8e59676eb\nrelated:\n    - id: e55a5195-4724-480e-a77e-3ebe64bd3759\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via use MSHTA in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task31)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-08\nmodified: 2023-01-04\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        Payload|contains|all:\n            - 'set'\n            - '&&'\n            - 'mshta'\n            - 'vbscript:createobject'\n            - '.run'\n            - '(window.close)'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_via_use_clip.yml","content":"title: Invoke-Obfuscation Via Use Clip - PowerShell Module\nid: ebdf49d8-b89c-46c9-8fdf-2c308406f6bd\nrelated:\n    - id: db92dd33-a3ad-49cf-8c2c-608c3e30ace0\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via use Clip.exe in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task29)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-09\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|re: '(?i)echo.*clip.*&&.*(Clipboard|i`?n`?v`?o`?k`?e`?)'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_via_stdin.yml","content":"title: Invoke-Obfuscation Via Stdin - PowerShell Module\nid: c72aca44-8d52-45ad-8f81-f96c4d3c755e\nrelated:\n    - id: 86b896ba-ffa1-4fea-83e3-ee28a4c915c7\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via Stdin in Scripts\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task28)\nauthor: Nikita Nazarov, oscd.community\ndate: 2020-10-12\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|re: '(?i)(set).*&&\\s?set.*(environment|invoke|\\$?\\{?input).*&&.*\"'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_via_rundll.yml","content":"title: Invoke-Obfuscation RUNDLL LAUNCHER - PowerShell Module\nid: a23791fe-8846-485a-b16b-ca691e1b03d4\nrelated:\n    - id: e6cb92b4-b470-4eb8-8a9d-d63e8583aae0\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via RUNDLL LAUNCHER\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task 23)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-18\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|contains|all:\n            - 'rundll32.exe'\n            - 'shell32.dll'\n            - 'shellexec_rundll'\n            - 'powershell'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_via_compress.yml","content":"title: Invoke-Obfuscation COMPRESS OBFUSCATION - PowerShell Module\nid: 7034cbbb-cc55-4dc2-8dad-36c0b942e8f1\nrelated:\n    - id: 20e5497e-331c-4cd5-8d36-935f6e2a9a07\n      type: derived\nstatus: test\ndescription: Detects Obfuscated Powershell via COMPRESS OBFUSCATION\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009 # (Task 19)\nauthor: Timur Zinniatullin, oscd.community\ndate: 2020-10-18\nmodified: 2022-11-29\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|contains|all:\n            - 'new-object'\n            - 'text.encoding]::ascii'\n        Payload|contains:\n            - 'system.io.compression.deflatestream'\n            - 'system.io.streamreader'\n        Payload|endswith: 'readtoend'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_var.yml","content":"title: Invoke-Obfuscation VAR+ Launcher - PowerShell Module\nid: 6bfb8fa7-b2e7-4f6c-8d9d-824e5d06ea9e\nrelated:\n    - id: 0adfbc14-0ed1-11eb-adc1-0242ac120002\n      type: derived\nstatus: test\ndescription: Detects Obfuscated use of Environment Variables to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 24)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-15\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|re: 'cmd.{0,5}(?:/c|/r)(?:\\s|)\"set\\s[a-zA-Z]{3,6}.*(?:\\{\\d\\}){1,}\\\\\"\\s+?-f(?:.*\\)){1,}.*\"'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_stdin.yml","content":"title: Invoke-Obfuscation STDIN+ Launcher - PowerShell Module\nid: 9ac8b09b-45de-4a07-9da1-0de8c09304a3\nrelated:\n    - id: 779c8c12-0eb1-11eb-adc1-0242ac120002\n      type: derived\nstatus: test\ndescription: Detects Obfuscated use of stdin to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 25)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-15\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|re: 'cmd.{0,5}(?:/c|/r).+powershell.+(?:\\$\\{?input\\}?|noexit).+\"'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_obfuscated_iex.yml","content":"title: Invoke-Obfuscation Obfuscated IEX Invocation - PowerShell Module\nid: 2f211361-7dce-442d-b78a-c04039677378\nrelated:\n    - id: 1b9dc62e-6e9e-42a3-8990-94d7a10007f7\n      type: derived\nstatus: test\ndescription: Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the code block cited in the reference section below\nreferences:\n    - https://github.com/danielbohannon/Invoke-Obfuscation/blob/f20e7f843edd0a3a7716736e9eddfa423395dd26/Out-ObfuscatedStringCommand.ps1#L873-L888\nauthor: Daniel Bohannon (@Mandiant/@FireEye), oscd.community\ndate: 2019-11-08\nmodified: 2022-12-31\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_payload:\n        - Payload|re: '\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\['\n        - Payload|re: '\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\['\n        - Payload|re: '\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\['\n        - Payload|re: '\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}'\n        - Payload|re: '\\*mdr\\*\\W\\s*\\)\\.Name'\n        - Payload|re: '\\$VerbosePreference\\.ToString\\('\n        - Payload|re: '\\[String\\]\\s*\\$VerbosePreference'\n    condition: selection_payload\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_invoke_obfuscation_clip.yml","content":"title: Invoke-Obfuscation CLIP+ Launcher - PowerShell Module\nid: a136cde0-61ad-4a61-9b82-8dc490e60dd2\nrelated:\n    - id: 73e67340-0d25-11eb-adc1-0242ac120002\n      type: derived\nstatus: test\ndescription: Detects Obfuscated use of Clip.exe to execute PowerShell\nreferences:\n    - https://github.com/SigmaHQ/sigma/issues/1009  # (Task 26)\nauthor: Jonathan Cheong, oscd.community\ndate: 2020-10-13\nmodified: 2024-04-05\ntags:\n    - attack.defense-evasion\n    - attack.t1027\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|re: 'cmd.{0,5}(?:/c|/r).+clip(?:\\.exe)?.{0,4}&&.+clipboard]::\\(\\s\\\\\"\\{\\d\\}.+-f.+\"'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_hktl_evil_winrm_execution.yml","content":"title: HackTool - Evil-WinRm Execution - PowerShell Module\nid: 9fe55ea2-4cd6-4491-8a54-dd6871651b51\nstatus: test\ndescription: |\n    Detects the execution of Evil-WinRM via PowerShell Module logs by leveraging the hardcoded strings inside the utility.\nreferences:\n    - https://github.com/Hackplayers/evil-winrm/blob/7514b055d67ec19836e95c05bd63e7cc47c4c2aa/evil-winrm.rb\n    - https://github.com/search?q=repo%3AHackplayers%2Fevil-winrm++shell.run%28&type=code\nauthor: Nasreddine Bencherchali (Nextron Systems)\ndate: 2024-02-25\ntags:\n    - attack.lateral-movement\nlogsource:\n    product: windows\n    category: ps_module\ndetection:\n    selection_wsm:\n        ContextInfo|contains:\n            - ':\\Windows\\System32\\wsmprovhost.exe'\n            - ':\\Windows\\SysWOW64\\wsmprovhost.exe'\n    selection_payload_1:\n        Payload|contains:\n            - value=\"(get-location).path # https://github.com/Hackplayers/evil-winrm/blob/7514b055d67ec19836e95c05bd63e7cc47c4c2aa/evil-winrm.rb#L592\n            - value=\"(get-item*).length # https://github.com/Hackplayers/evil-winrm/blob/7514b055d67ec19836e95c05bd63e7cc47c4c2aa/evil-winrm.rb#L490\n            - 'Invoke-Binary ' # https://github.com/Hackplayers/evil-winrm/blob/7514b055d67ec19836e95c05bd63e7cc47c4c2aa/evil-winrm.rb#L740\n            - Donut-Loader -process_id*-donutfile # https://github.com/Hackplayers/evil-winrm/blob/7514b055d67ec19836e95c05bd63e7cc47c4c2aa/evil-winrm.rb#L761\n            - Bypass-4MSI\n            - IEX ([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($a))).replace('???','')\n    selection_payload_2:\n        Payload|contains|all:\n            - $servicios = Get-ItemProperty \"registry::HKLM\\System\\CurrentControlSet\\Services\\\"\n            - Where-Object {$_.imagepath -notmatch \"system\" -and $_.imagepath -ne $null } | Select-Object pschildname,imagepath\n    selection_payload_3:\n        Payload|contains|all:\n            - $a +=  \\\"$($_.FullName.Replace('\\\\','/'))/\\\"}else{  $a += \\\"$($_.FullName.Replace('\\\\', '/'))\\\" } # https://github.com/Hackplayers/evil-winrm/blob/7514b055d67ec19836e95c05bd63e7cc47c4c2aa/evil-winrm.rb#L1001\n            - $a=@();$\n    condition: selection_wsm and 1 of selection_payload_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_get_clipboard.yml","content":"title: PowerShell Get Clipboard\nid: 4cbd4f12-2e22-43e3-882f-bff3247ffb78\nstatus: test\ndescription: A General detection for the Get-Clipboard commands in PowerShell logs. This could be an adversary capturing clipboard contents.\nreferences:\n    - https://github.com/OTRF/detection-hackathon-apt29/issues/16\n    - https://github.com/OTRF/ThreatHunter-Playbook/blob/2d4257f630f4c9770f78d0c1df059f891ffc3fec/docs/evals/apt29/detections/7.A.2_F4609F7E-C4DB-4327-91D4-59A58C962A02.md\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2020-05-02\nmodified: 2023-01-04\ntags:\n    - attack.collection\n    - attack.t1115\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        Payload|contains: 'Get-Clipboard'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_get_addbaccount.yml","content":"title: Suspicious Get-ADDBAccount Usage\nid: b140afd9-474b-4072-958e-2ebb435abd68\nstatus: test\ndescription: Detects suspicious invocation of the Get-ADDBAccount script that reads from a ntds.dit file and may be used to get access to credentials without using any credential dumpers\nreferences:\n    - https://www.n00py.io/2022/03/manipulating-user-passwords-without-mimikatz/\n    - https://github.com/MichaelGrafnetter/DSInternals/blob/7ba59c12ee9a1cb430d7dc186a3366842dd612c8/Documentation/PowerShell/Get-ADDBAccount.md\nauthor: Florian Roth (Nextron Systems)\ndate: 2022-03-16\ntags:\n    - attack.credential-access\n    - attack.t1003.003\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        Payload|contains|all:\n            - 'Get-ADDBAccount'\n            - 'BootKey '\n            - 'DatabasePath '\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_exploit_scripts.yml","content":"title: Malicious PowerShell Scripts - PoshModule\nid: 41025fd7-0466-4650-a813-574aaacbe7f4\nrelated:\n    - id: f331aa1f-8c53-4fc3-b083-cc159bc971cb\n      type: similar\n    - id: bf7286e7-c0be-460b-a7e8-5b2e07ecc2f2\n      type: obsolete\nstatus: test\ndescription: Detects the execution of known offensive powershell scripts used for exploitation or reconnaissance\nreferences:\n    - https://github.com/PowerShellMafia/PowerSploit\n    - https://github.com/NetSPI/PowerUpSQL\n    - https://github.com/CsEnox/EventViewer-UACBypass\n    - https://web.archive.org/web/20210511204621/https://github.com/AlsidOfficial/WSUSpendu\n    - https://github.com/nettitude/Invoke-PowerThIEf\n    - https://github.com/S3cur3Th1sSh1t/WinPwn\n    - https://github.com/S3cur3Th1sSh1t/PowerSharpPack/tree/master/PowerSharpBinaries\n    - https://github.com/BC-SECURITY/Invoke-ZeroLogon/blob/111d17c7fec486d9bb23387e2e828b09a26075e4/Invoke-ZeroLogon.ps1\n    - https://github.com/xorrior/RandomPS-Scripts/blob/848c919bfce4e2d67b626cbcf4404341cfe3d3b6/Get-DXWebcamVideo.ps1\n    - https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/6f23bb41f9675d7e2d32bacccff75e931ae00554/OfficeMemScraper.ps1\n    - https://github.com/dafthack/DomainPasswordSpray/blob/b13d64a5834694aa73fd2aea9911a83027c465a7/DomainPasswordSpray.ps1\n    - https://unit42.paloaltonetworks.com/threat-assessment-black-basta-ransomware/ # Invoke-TotalExec\n    - https://research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/ # Invoke-TotalExec\n    - https://github.com/HarmJ0y/DAMP\n    - https://github.com/samratashok/nishang\n    - https://github.com/DarkCoderSc/PowerRunAsSystem/\n    - https://github.com/besimorhino/powercat\n    - https://github.com/sadshade/veeam-creds/blob/6010eaf31ba41011b58d6af3950cffbf6f5cea32/Veeam-Get-Creds.ps1\n    - https://github.com/The-Viper-One/Invoke-PowerDPAPI/\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2023-01-23\nmodified: 2025-07-06\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_generic:\n        ContextInfo|contains:\n            - 'Add-ConstrainedDelegationBackdoor.ps1'\n            - 'Add-Exfiltration.ps1'\n            - 'Add-Persistence.ps1'\n            - 'Add-RegBackdoor.ps1'\n            - 'Add-RemoteRegBackdoor.ps1'\n            - 'Add-ScrnSaveBackdoor.ps1'\n            - 'BadSuccessor.ps1'\n            - 'Check-VM.ps1'\n            - 'ConvertTo-ROT13.ps1'\n            - 'Copy-VSS.ps1'\n            - 'Create-MultipleSessions.ps1'\n            - 'DNS_TXT_Pwnage.ps1'\n            - 'dnscat2.ps1'\n            - 'Do-Exfiltration.ps1'\n            - 'DomainPasswordSpray.ps1'\n            - 'Download_Execute.ps1'\n            - 'Download-Execute-PS.ps1'\n            - 'Enabled-DuplicateToken.ps1'\n            - 'Enable-DuplicateToken.ps1'\n            - 'Execute-Command-MSSQL.ps1'\n            - 'Execute-DNSTXT-Code.ps1'\n            - 'Execute-OnTime.ps1'\n            - 'ExetoText.ps1'\n            - 'Exploit-Jboss.ps1'\n            - 'Find-AVSignature.ps1'\n            - 'Find-Fruit.ps1'\n            - 'Find-GPOLocation.ps1'\n            - 'Find-TrustedDocuments.ps1'\n            - 'FireBuster.ps1'\n            - 'FireListener.ps1'\n            - 'Get-ApplicationHost.ps1'\n            - 'Get-ChromeDump.ps1'\n            - 'Get-ClipboardContents.ps1'\n            - 'Get-ComputerDetail.ps1'\n            - 'Get-FoxDump.ps1'\n            - 'Get-GPPAutologon.ps1'\n            - 'Get-GPPPassword.ps1'\n            - 'Get-IndexedItem.ps1'\n            - 'Get-Keystrokes.ps1'\n            - 'Get-LSASecret.ps1'\n            - 'Get-MicrophoneAudio.ps1'\n            - 'Get-PassHashes.ps1'\n            - 'Get-PassHints.ps1'\n            - 'Get-RegAlwaysInstallElevated.ps1'\n            - 'Get-RegAutoLogon.ps1'\n            - 'Get-RickAstley.ps1'\n            - 'Get-Screenshot.ps1'\n            - 'Get-SecurityPackages.ps1'\n            - 'Get-ServiceFilePermission.ps1'\n            - 'Get-ServicePermission.ps1'\n            - 'Get-ServiceUnquoted.ps1'\n            - 'Get-SiteListPassword.ps1'\n            - 'Get-System.ps1'\n            - 'Get-TimedScreenshot.ps1'\n            - 'Get-UnattendedInstallFile.ps1'\n            - 'Get-Unconstrained.ps1'\n            - 'Get-USBKeystrokes.ps1'\n            - 'Get-VaultCredential.ps1'\n            - 'Get-VulnAutoRun.ps1'\n            - 'Get-VulnSchTask.ps1'\n            - 'Get-WebConfig.ps1'\n            - 'Get-WebCredentials.ps1'\n            - 'Get-WLAN-Keys.ps1'\n            - 'Gupt-Backdoor.ps1'\n            - 'HTTP-Backdoor.ps1'\n            - 'HTTP-Login.ps1'\n            - 'Install-ServiceBinary.ps1'\n            - 'Install-SSP.ps1'\n            - 'Invoke-ACLScanner.ps1'\n            - 'Invoke-ADSBackdoor.ps1'\n            - 'Invoke-AmsiBypass.ps1'\n            - 'Invoke-ARPScan.ps1'\n            - 'Invoke-BackdoorLNK.ps1'\n            - 'Invoke-BadPotato.ps1'\n            - 'Invoke-BetterSafetyKatz.ps1'\n            - 'Invoke-BruteForce.ps1'\n            - 'Invoke-BypassUAC.ps1'\n            - 'Invoke-Carbuncle.ps1'\n            - 'Invoke-Certify.ps1'\n            - 'Invoke-ConPtyShell.ps1'\n            - 'Invoke-CredentialInjection.ps1'\n            - 'Invoke-CredentialsPhish.ps1'\n            - 'Invoke-DAFT.ps1'\n            - 'Invoke-DCSync.ps1'\n            - 'Invoke-Decode.ps1'\n            - 'Invoke-DinvokeKatz.ps1'\n            - 'Invoke-DllInjection.ps1'\n            - 'Invoke-DowngradeAccount.ps1'\n            - 'Invoke-EgressCheck.ps1'\n            - 'Invoke-Encode.ps1'\n            - 'Invoke-EventViewer.ps1'\n            - 'Invoke-Eyewitness.ps1'\n            - 'Invoke-FakeLogonScreen.ps1'\n            - 'Invoke-Farmer.ps1'\n            - 'Invoke-Get-RBCD-Threaded.ps1'\n            - 'Invoke-Gopher.ps1'\n            - 'Invoke-Grouper2.ps1'\n            - 'Invoke-Grouper3.ps1'\n            - 'Invoke-HandleKatz.ps1'\n            - 'Invoke-Interceptor.ps1'\n            - 'Invoke-Internalmonologue.ps1'\n            - 'Invoke-Inveigh.ps1'\n            - 'Invoke-InveighRelay.ps1'\n            - 'Invoke-JSRatRegsvr.ps1'\n            - 'Invoke-JSRatRundll.ps1'\n            - 'Invoke-KrbRelay.ps1'\n            - 'Invoke-KrbRelayUp.ps1'\n            - 'Invoke-LdapSignCheck.ps1'\n            - 'Invoke-Lockless.ps1'\n            - 'Invoke-MalSCCM.ps1'\n            - 'Invoke-Mimikatz.ps1'\n            - 'Invoke-MimikatzWDigestDowngrade.ps1'\n            - 'Invoke-Mimikittenz.ps1'\n            - 'Invoke-MITM6.ps1'\n            - 'Invoke-NanoDump.ps1'\n            - 'Invoke-NetRipper.ps1'\n            - 'Invoke-NetworkRelay.ps1'\n            - 'Invoke-NinjaCopy.ps1'\n            - 'Invoke-OxidResolver.ps1'\n            - 'Invoke-P0wnedshell.ps1'\n            - 'Invoke-P0wnedshellx86.ps1'\n            - 'Invoke-Paranoia.ps1'\n            - 'Invoke-PortScan.ps1'\n            - 'Invoke-PoshRatHttp.ps1'\n            - 'Invoke-PoshRatHttps.ps1'\n            - 'Invoke-PostExfil.ps1'\n            - 'Invoke-PowerDump.ps1'\n            - 'Invoke-PowerDPAPI.ps1'\n            - 'Invoke-PowerShellIcmp.ps1'\n            - 'Invoke-PowerShellTCP.ps1'\n            - 'Invoke-PowerShellTcpOneLine.ps1'\n            - 'Invoke-PowerShellTcpOneLineBind.ps1'\n            - 'Invoke-PowerShellUdp.ps1'\n            - 'Invoke-PowerShellUdpOneLine.ps1'\n            - 'Invoke-PowerShellWMI.ps1'\n            - 'Invoke-PowerThIEf.ps1'\n            - 'Invoke-PPLDump.ps1'\n            - 'Invoke-Prasadhak.ps1'\n            - 'Invoke-PsExec.ps1'\n            - 'Invoke-PsGcat.ps1'\n            - 'Invoke-PsGcatAgent.ps1'\n            - 'Invoke-PSInject.ps1'\n            - 'Invoke-PsUaCme.ps1'\n            - 'Invoke-ReflectivePEInjection.ps1'\n            - 'Invoke-ReverseDNSLookup.ps1'\n            - 'Invoke-Rubeus.ps1'\n            - 'Invoke-RunAs.ps1'\n            - 'Invoke-SafetyKatz.ps1'\n            - 'Invoke-SauronEye.ps1'\n            - 'Invoke-SCShell.ps1'\n            - 'Invoke-Seatbelt.ps1'\n            - 'Invoke-ServiceAbuse.ps1'\n            - 'Invoke-SessionGopher.ps1'\n            - 'Invoke-ShellCode.ps1'\n            - 'Invoke-SMBScanner.ps1'\n            - 'Invoke-Snaffler.ps1'\n            - 'Invoke-Spoolsample.ps1'\n            - 'Invoke-SSHCommand.ps1'\n            - 'Invoke-SSIDExfil.ps1'\n            - 'Invoke-StandIn.ps1'\n            - 'Invoke-StickyNotesExtract.ps1'\n            - 'Invoke-Tater.ps1'\n            - 'Invoke-Thunderfox.ps1'\n            - 'Invoke-ThunderStruck.ps1'\n            - 'Invoke-TokenManipulation.ps1'\n            - 'Invoke-Tokenvator.ps1'\n            - 'Invoke-TotalExec.ps1'\n            - 'Invoke-UrbanBishop.ps1'\n            - 'Invoke-UserHunter.ps1'\n            - 'Invoke-VoiceTroll.ps1'\n            - 'Invoke-Whisker.ps1'\n            - 'Invoke-WinEnum.ps1'\n            - 'Invoke-winPEAS.ps1'\n            - 'Invoke-WireTap.ps1'\n            - 'Invoke-WmiCommand.ps1'\n            - 'Invoke-WScriptBypassUAC.ps1'\n            - 'Invoke-Zerologon.ps1'\n            - 'Keylogger.ps1'\n            - 'MailRaider.ps1'\n            - 'New-HoneyHash.ps1'\n            - 'OfficeMemScraper.ps1'\n            - 'Offline_Winpwn.ps1'\n            - 'Out-CHM.ps1'\n            - 'Out-DnsTxt.ps1'\n            - 'Out-Excel.ps1'\n            - 'Out-HTA.ps1'\n            - 'Out-Java.ps1'\n            - 'Out-JS.ps1'\n            - 'Out-Minidump.ps1'\n            - 'Out-RundllCommand.ps1'\n            - 'Out-SCF.ps1'\n            - 'Out-SCT.ps1'\n            - 'Out-Shortcut.ps1'\n            - 'Out-WebQuery.ps1'\n            - 'Out-Word.ps1'\n            - 'Parse_Keys.ps1'\n            - 'Port-Scan.ps1'\n            - 'PowerBreach.ps1'\n            - 'powercat.ps1'\n            - 'PowerRunAsSystem.psm1'\n            - 'PowerSharpPack.ps1'\n            - 'PowerUp.ps1'\n            - 'PowerUpSQL.ps1'\n            - 'PowerView.ps1'\n            - 'PSAsyncShell.ps1'\n            - 'RemoteHashRetrieval.ps1'\n            - 'Remove-Persistence.ps1'\n            - 'Remove-PoshRat.ps1'\n            - 'Remove-Update.ps1'\n            - 'Run-EXEonRemote.ps1'\n            - 'Schtasks-Backdoor.ps1'\n            - 'Set-DCShadowPermissions.ps1'\n            - 'Set-MacAttribute.ps1'\n            - 'Set-RemotePSRemoting.ps1'\n            - 'Set-RemoteWMI.ps1'\n            - 'Set-Wallpaper.ps1'\n            - 'Show-TargetScreen.ps1'\n            - 'Speak.ps1'\n            - 'Start-CaptureServer.ps1'\n            - 'Start-WebcamRecorder.ps1'\n            - 'StringToBase64.ps1'\n            - 'TexttoExe.ps1'\n            - 'Veeam-Get-Creds.ps1'\n            - 'VolumeShadowCopyTools.ps1'\n            - 'WinPwn.ps1'\n            - 'WSUSpendu.ps1'\n    selection_invoke_sharp:\n        ContextInfo|contains|all:\n            - 'Invoke-Sharp' # Covers all \"Invoke-Sharp\" variants\n            - '.ps1'\n    condition: 1 of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_module\\posh_pm_decompress_commands.yml","content":"title: PowerShell Decompress Commands\nid: 1ddc1472-8e52-4f7d-9f11-eab14fc171f5\nrelated:\n    - id: 81fbdce6-ee49-485a-908d-1a728c5dcb09\n      type: derived\nstatus: test\ndescription: A General detection for specific decompress commands in PowerShell logs. This could be an adversary decompressing files.\nreferences:\n    - https://github.com/OTRF/detection-hackathon-apt29/issues/8\n    - https://github.com/OTRF/ThreatHunter-Playbook/blob/2d4257f630f4c9770f78d0c1df059f891ffc3fec/docs/evals/apt29/detections/4.A.3_09F29912-8E93-461E-9E89-3F06F6763383.md\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2020-05-02\nmodified: 2022-12-25\ntags:\n    - attack.defense-evasion\n    - attack.t1140\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|contains: 'Expand-Archive'\n    condition: selection_4103\nfalsepositives:\n    - Unknown\nlevel: informational\n"},{"path":"powershell\\powershell_module\\posh_pm_clear_powershell_history.yml","content":"title: Clear PowerShell History - PowerShell Module\nid: f99276ad-d122-4989-a09a-d00904a5f9d2\nrelated:\n    - id: dfba4ce1-e0ea-495f-986e-97140f31af2d\n      type: derived\nstatus: test\ndescription: Detects keywords that could indicate clearing PowerShell history\nreferences:\n    - https://gist.github.com/hook-s3c/7363a856c3cdbadeb71085147f042c1a\nauthor: Ilyas Ochkov, Jonhnathan Ribeiro, Daniil Yugoslavskiy, oscd.community\ndate: 2019-10-25\nmodified: 2022-12-02\ntags:\n    - attack.defense-evasion\n    - attack.t1070.003\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_1a_payload:\n        Payload|contains:\n            - 'del'\n            - 'Remove-Item'\n            - 'rm'\n    selection_1b_payload:\n        Payload|contains: '(Get-PSReadlineOption).HistorySavePath'\n    selection_payload_2:\n        Payload|contains|all:\n            - 'Set-PSReadlineOption'\n            - 'â€“HistorySaveStyle'  # not sure if the homoglyph â€“/- is intended, just checking for both\n            - 'SaveNothing'\n    selection_payload_3:\n        Payload|contains|all:\n            - 'Set-PSReadlineOption'\n            - '-HistorySaveStyle'\n            - 'SaveNothing'\n    condition: 1 of selection_payload_* or all of selection_1*\nfalsepositives:\n    - Legitimate PowerShell scripts\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_bad_opsec_artifacts.yml","content":"title: Bad Opsec Powershell Code Artifacts\nid: 8d31a8ce-46b5-4dd6-bdc3-680931f1db86\nrelated:\n    - id: 73e733cc-1ace-3212-a107-ff2523cc9fc3\n      type: derived\nstatus: test\ndescription: |\n    focuses on trivial artifacts observed in variants of prevalent offensive ps1 payloads, including\n    Cobalt Strike Beacon, PoshC2, Powerview, Letmein, Empire, Powersploit, and other attack payloads\n    that often undergo minimal changes by attackers due to bad opsec.\nreferences:\n    - https://newtonpaul.com/analysing-fileless-malware-cobalt-strike-beacon/\n    - https://labs.sentinelone.com/top-tier-russian-organized-cybercrime-group-unveils-fileless-stealthy-powertrick-backdoor-for-high-value-targets/\n    - https://www.mdeditor.tw/pl/pgRt\nauthor: 'ok @securonix invrep_de, oscd.community'\ndate: 2020-10-09\nmodified: 2022-12-25\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_4103:\n        Payload|contains:\n            - '$DoIt'\n            - 'harmj0y'\n            - 'mattifestation'\n            - '_RastaMouse'\n            - 'tifkin_'\n            - '0xdeadbeef'\n    condition: selection_4103\nfalsepositives:\n    - 'Moderate-to-low; Despite the shorter length/lower entropy for some of these, because of high specificity, fp appears to be fairly limited in many environments.'\nlevel: critical\n"},{"path":"powershell\\powershell_module\\posh_pm_alternate_powershell_hosts.yml","content":"title: Alternate PowerShell Hosts - PowerShell Module\nid: 64e8e417-c19a-475a-8d19-98ea705394cc\nstatus: test\ndescription: Detects alternate PowerShell hosts potentially bypassing detections looking for powershell.exe\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190610-PwshAlternateHosts/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-08-11\nmodified: 2025-10-17\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection:\n        ContextInfo|contains: '*'\n    filter_powershell:\n        # This filter covers the following use cases\n        #   - When powershell is called directly from commandline via keyword powershell or powershell.exe\n        #   - Or called via path but not with full \"\".exe\". Example: C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell\n        ContextInfo|contains:\n            - '= powershell' # Host Application=...powershell.exe or Application hote=...powershell.exe in French Win10 event\n            - '= C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell'\n            - '= C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell'\n            # In some cases powershell was invoked with inverted slashes\n            - '= C:/Windows/System32/WindowsPowerShell/v1.0/powershell'\n            - '= C:/Windows/SysWOW64/WindowsPowerShell/v1.0/powershell'\n            # In some cases \\??\\C:.. is used\n            - '= \\\\\\?\\?\\C:Windows\\System32\\WindowsPowerShell\\v1.0\\powershell'\n            - '= \\\\\\?\\?\\C:Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell'\n    filter_sdiagnhost:\n        ContextInfo|contains: '= C:\\WINDOWS\\System32\\sdiagnhost.exe -Embedding' # When MSDT is launched for example\n    filter_citrix:\n        ContextInfo|contains: 'ConfigSyncRun.exe'\n    filter_adace:  # Active Directory Administrative Center Enhancements\n        ContextInfo|contains: 'C:\\Windows\\system32\\dsac.exe'\n    filter_winrm:\n        ContextInfo|contains: 'C:\\Windows\\system32\\wsmprovhost.exe -Embedding'\n    filter_help_update:\n        Payload|contains:\n            - 'Update-Help'\n            - 'Failed to update Help for the module'\n    condition: selection and not 1 of filter_*\nfalsepositives:\n    - Programs using PowerShell directly without invocation of a dedicated interpreter\n    - MSP Detection Searcher\n    - Citrix ConfigSync.ps1\nlevel: medium\n"},{"path":"powershell\\powershell_module\\posh_pm_active_directory_module_dll_import.yml","content":"title: Potential Active Directory Enumeration Using AD Module - PsModule\nid: 74176142-4684-4d8a-8b0a-713257e7df8e\nrelated:\n    - id: 70bc5215-526f-4477-963c-a47a5c9ebd12\n      type: similar\n    - id: 9e620995-f2d8-4630-8430-4afd89f77604\n      type: similar\nstatus: test\ndescription: Detects usage of the \"Import-Module\" cmdlet to load the \"Microsoft.ActiveDirectory.Management.dl\" DLL. Which is often used by attackers to perform AD enumeration.\nreferences:\n    - https://github.com/samratashok/ADModule\n    - https://twitter.com/cyb3rops/status/1617108657166061568?s=20\n    - https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/active-directory-enumeration-with-ad-module-without-rsat-or-admin-privileges\nauthor: Nasreddine Bencherchali (Nextron Systems), frack113\ndate: 2023-01-22\ntags:\n    - attack.reconnaissance\n    - attack.discovery\n    - attack.impact\nlogsource:\n    product: windows\n    category: ps_module\n    definition: 0ad03ef1-f21b-4a79-8ce8-e6900c54b65b\ndetection:\n    selection_cmdlet:\n        Payload|contains:\n            - 'Import-Module '\n            - 'ipmo '\n    selection_dll:\n        Payload|contains: 'Microsoft.ActiveDirectory.Management.dll'\n    condition: all of selection_*\nfalsepositives:\n    - Legitimate use of the library for administrative activity\nlevel: medium\n"},{"path":"powershell\\powershell_classic\\posh_pc_wsman_com_provider_no_powershell.yml","content":"title: Suspicious Non PowerShell WSMAN COM Provider\nid: df9a0e0e-fedb-4d6c-8668-d765dfc92aa7\nstatus: test\ndescription: Detects suspicious use of the WSMAN provider without PowerShell.exe as the host application.\nreferences:\n    - https://twitter.com/chadtilbury/status/1275851297770610688\n    - https://bohops.com/2020/05/12/ws-management-com-another-approach-for-winrm-lateral-movement/\n    - https://github.com/bohops/WSMan-WinRM\nauthor: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)\ndate: 2020-06-24\nmodified: 2025-10-22\ntags:\n    - attack.execution\n    - attack.t1059.001\n    - attack.lateral-movement\n    - attack.t1021.003\nlogsource:\n    product: windows\n    service: powershell-classic\ndetection:\n    selection:\n        Data|contains: 'ProviderName=WSMan'\n    filter_main_ps:\n        Data|contains:\n            - 'HostApplication=powershell'\n            - 'HostApplication=C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell'\n            - 'HostApplication=C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell'\n            # In some cases powershell was invoked with inverted slashes\n            - 'HostApplication=C:/Windows/System32/WindowsPowerShell/v1.0/powershell'\n            - 'HostApplication=C:/Windows/SysWOW64/WindowsPowerShell/v1.0/powershell'\n    filter_main_host_application_null:\n        # Note: Since we're using the raw data field to match. There is no easy way to filter out cases where the \"HostApplication\" field is null (i.e doesn't exist). We're practically forced to use a regex.\n        # If you're already mapping and extracting the field, then obviously use that directly.\n        Data|re: 'HostId=[a-zA-Z0-9-]{36}\\s+EngineVersion='\n    filter_optional_hexnode:\n        Data|contains: 'HostApplication=C:\\Hexnode\\Hexnode Agent\\Current\\HexnodeAgent.exe'\n    condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_classic\\posh_pc_tamper_windows_defender_set_mp.yml","content":"title: Tamper Windows Defender - PSClassic\nid: ec19ebab-72dc-40e1-9728-4c0b805d722c\nrelated:\n    - id: 14c71865-6cd3-44ae-adaa-1db923fae5f2\n      type: similar\nstatus: test\ndescription: Attempting to disable scheduled scanning and other parts of Windows Defender ATP or set default actions to allow.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2021-06-07\nmodified: 2024-01-02\ntags:\n    - attack.defense-evasion\n    - attack.t1562.001\nlogsource:\n    product: windows\n    category: ps_classic_provider_start\ndetection:\n    selection_set_mppreference:\n        Data|contains: 'Set-MpPreference'\n    selection_options_bool_allow:\n        Data|contains:\n            - '-dbaf $true'\n            - '-dbaf 1'\n            - '-dbm $true'\n            - '-dbm 1'\n            - '-dips $true'\n            - '-dips 1'\n            - '-DisableArchiveScanning $true'\n            - '-DisableArchiveScanning 1'\n            - '-DisableBehaviorMonitoring $true'\n            - '-DisableBehaviorMonitoring 1'\n            - '-DisableBlockAtFirstSeen $true'\n            - '-DisableBlockAtFirstSeen 1'\n            - '-DisableCatchupFullScan $true'\n            - '-DisableCatchupFullScan 1'\n            - '-DisableCatchupQuickScan $true'\n            - '-DisableCatchupQuickScan 1'\n            - '-DisableIntrusionPreventionSystem $true'\n            - '-DisableIntrusionPreventionSystem 1'\n            - '-DisableIOAVProtection $true'\n            - '-DisableIOAVProtection 1'\n            - '-DisableRealtimeMonitoring $true'\n            - '-DisableRealtimeMonitoring 1'\n            - '-DisableRemovableDriveScanning $true'\n            - '-DisableRemovableDriveScanning 1'\n            - '-DisableScanningMappedNetworkDrivesForFullScan $true'\n            - '-DisableScanningMappedNetworkDrivesForFullScan 1'\n            - '-DisableScanningNetworkFiles $true'\n            - '-DisableScanningNetworkFiles 1'\n            - '-DisableScriptScanning $true'\n            - '-DisableScriptScanning 1'\n            - '-MAPSReporting $false'\n            - '-MAPSReporting 0'\n            - '-drdsc $true'\n            - '-drdsc 1'\n            - '-drtm $true'\n            - '-drtm 1'\n            - '-dscrptsc $true'\n            - '-dscrptsc 1'\n            - '-dsmndf $true'\n            - '-dsmndf 1'\n            - '-dsnf $true'\n            - '-dsnf 1'\n            - '-dss $true'\n            - '-dss 1'\n    selection_options_actions_func:\n        Data|contains:\n            - 'HighThreatDefaultAction Allow'\n            - 'htdefac Allow'\n            - 'LowThreatDefaultAction Allow'\n            - 'ltdefac Allow'\n            - 'ModerateThreatDefaultAction Allow'\n            - 'mtdefac Allow'\n            - 'SevereThreatDefaultAction Allow'\n            - 'stdefac Allow'\n    condition: selection_set_mppreference and 1 of selection_options_*\nfalsepositives:\n    - Legitimate PowerShell scripts that disable Windows Defender for troubleshooting purposes. Must be investigated.\nlevel: high\n"},{"path":"powershell\\powershell_classic\\posh_pc_susp_zip_compress.yml","content":"title: Zip A Folder With PowerShell For Staging In Temp - PowerShell\nid: 71ff406e-b633-4989-96ec-bc49d825a412 # PowerShell Classic\nrelated:\n    - id: daf7eb81-35fd-410d-9d7a-657837e602bb # PowerShell Module\n      type: similar\n    - id: b7a3c9a3-09ea-4934-8864-6a32cacd98d9 # PowerShell Script\n      type: similar\n    - id: 85a8e5ba-bd03-4bfb-bbfa-a4409a8f8b98 # Process Creation\n      type: similar\nstatus: test\ndescription: |\n    Detects PowerShell scripts that make use of the \"Compress-Archive\" Cmdlet in order to compress folders and files where the output is stored in a potentially suspicious location that is used often by malware for exfiltration.\n    An adversary might compress data (e.g., sensitive documents) that is collected prior to exfiltration in order to make it portable and minimize the amount of data sent over the network.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1074.001/T1074.001.md\n    - https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-347a\nauthor: Nasreddine Bencherchali (Nextron Systems), frack113\ndate: 2021-07-20\nmodified: 2023-12-18\ntags:\n    - attack.collection\n    - attack.t1074.001\nlogsource:\n    product: windows\n    service: powershell-classic\ndetection:\n    selection:\n        Data|contains:\n            - 'Compress-Archive -Path*-DestinationPath $env:TEMP'\n            - 'Compress-Archive -Path*-DestinationPath*\\AppData\\Local\\Temp\\'\n            - 'Compress-Archive -Path*-DestinationPath*:\\Windows\\Temp\\'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_classic\\posh_pc_susp_get_nettcpconnection.yml","content":"title: Use Get-NetTCPConnection\nid: b366adb4-d63d-422d-8a2c-186463b5ded0\nstatus: test\ndescription: Adversaries may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1049/T1049.md#atomic-test-2---system-network-connections-discovery-with-powershell\nauthor: frack113\ndate: 2021-12-10\nmodified: 2023-10-27\ntags:\n    - attack.discovery\n    - attack.t1049\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection:\n        Data|contains: 'Get-NetTCPConnection'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_classic\\posh_pc_susp_download.yml","content":"title: Suspicious PowerShell Download\nid: 3236fcd0-b7e3-4433-b4f8-86ad61a9af2d\nrelated:\n    - id: 65531a81-a694-4e31-ae04-f8ba5bc33759\n      type: derived\nstatus: test\ndescription: Detects suspicious PowerShell download command\nreferences:\n    - https://www.trendmicro.com/en_us/research/22/j/lv-ransomware-exploits-proxyshell-in-attack.html\nauthor: Florian Roth (Nextron Systems)\ndate: 2017-03-05\nmodified: 2023-10-27\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection_webclient:\n        Data|contains: 'Net.WebClient'\n    selection_download:\n        Data|contains:\n            - '.DownloadFile('\n            - '.DownloadString('\n    condition: all of selection_*\nfalsepositives:\n    - PowerShell scripts that download content from the Internet\nlevel: medium\n"},{"path":"powershell\\powershell_classic\\posh_pc_renamed_powershell.yml","content":"title: Renamed Powershell Under Powershell Channel\nid: 30a8cb77-8eb3-4cfb-8e79-ad457c5a4592\nstatus: test\ndescription: |\n    Detects a renamed Powershell execution, which is a common technique used to circumvent security controls and bypass detection logic that's dependent on process names and process paths.\nreferences:\n    - https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse\nauthor: Harish Segar, frack113\ndate: 2020-06-29\nmodified: 2025-01-20\ntags:\n    - attack.execution\n    - attack.defense-evasion\n    - attack.t1059.001\n    - attack.t1036.003\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection:\n        Data|contains: 'HostName=ConsoleHost'\n    # Note: Powershell Logging Data is localized. Meaning that \"HostApplication\" field will be translated to a different field on a non english layout. This rule doesn't take this into account due to the sheer amount of possibilities. It's up to the user to add these cases.\n    filter_main_ps:\n        Data|contains:\n            - 'HostApplication=powershell'\n            - 'HostApplication=C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell'\n            - 'HostApplication=C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell'\n            # In some cases powershell was invoked with inverted slashes\n            - 'HostApplication=C:/Windows/System32/WindowsPowerShell/v1.0/powershell'\n            - 'HostApplication=C:/Windows/SysWOW64/WindowsPowerShell/v1.0/powershell'\n            - 'HostApplication=C:\\\\\\\\WINDOWS\\\\\\\\system32\\\\\\\\WindowsPowerShell\\\\\\\\v1.0\\\\\\\\powershell.exe'\n            - 'HostApplication=C:\\\\\\\\WINDOWS\\\\\\\\SysWOW64\\\\\\\\WindowsPowerShell\\\\\\\\v1.0\\\\\\\\powershell.exe'\n    filter_main_host_application_null:\n        # Note: Since we're using the raw data field to match. There is no easy way to filter out cases where the \"HostApplication\" field is null (i.e doesn't exist). We're practically forced to use a regex.\n        # If you're already mapping and extracting the field, then obviously use that directly.\n        Data|re: 'HostId=[a-zA-Z0-9-]{36}\\s+EngineVersion='\n    condition: selection and not 1 of filter_main_*\nfalsepositives:\n    - Unknown\nlevel: low\n"},{"path":"powershell\\powershell_classic\\posh_pc_remote_powershell_session.yml","content":"title: Remote PowerShell Session (PS Classic)\nid: 60167e5c-84b2-4c95-a7ac-86281f27c445\nrelated:\n    - id: 96b9f619-aa91-478f-bacb-c3e50f8df575\n      type: derived\nstatus: test\ndescription: Detects remote PowerShell sessions\nreferences:\n    - https://threathunterplaybook.com/hunts/windows/190511-RemotePwshExecution/notebook.html\nauthor: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019-08-10\nmodified: 2024-01-03\ntags:\n    - attack.execution\n    - attack.t1059.001\n    - attack.lateral-movement\n    - attack.t1021.006\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection:\n        Data|contains|all:\n            - 'HostName=ServerRemoteHost'\n            - 'wsmprovhost.exe'\n    condition: selection\nfalsepositives:\n    - Legitimate use remote PowerShell sessions\n# Note: Increase the level to \"medium\" in environments that do not leverage PowerShell remoting\nlevel: low\n"},{"path":"powershell\\powershell_classic\\posh_pc_remotefxvgpudisablement_abuse.yml","content":"title: Potential RemoteFXvGPUDisablement.EXE Abuse\nid: f65e22f9-819e-4f96-9c7b-498364ae7a25\nrelated:\n    - id: a6fc3c46-23b8-4996-9ea2-573f4c4d88c5 # ProcCreation\n      type: similar\n    - id: 38a7625e-b2cb-485d-b83d-aff137d859f4 # PS Module\n      type: similar\n    - id: cacef8fc-9d3d-41f7-956d-455c6e881bc5 # PS ScriptBlock\n      type: similar\nstatus: test\ndescription: Detects PowerShell module creation where the module Contents are set to \"function Get-VMRemoteFXPhysicalVideoAdapter\". This could be a sign of potential abuse of  the \"RemoteFXvGPUDisablement.exe\" binary which is known to be vulnerable to module load-order hijacking.\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1218/T1218.md\n    - https://github.com/redcanaryco/AtomicTestHarnesses/blob/7e1e4da116801e3d6fcc6bedb207064577e40572/TestHarnesses/T1218_SignedBinaryProxyExecution/InvokeRemoteFXvGPUDisablementCommand.ps1\nauthor: frack113, Nasreddine Bencherchali (Nextron Systems)\ndate: 2021-07-13\nmodified: 2023-05-09\ntags:\n    - attack.defense-evasion\n    - attack.t1218\nlogsource:\n    product: windows\n    service: powershell-classic\n    definition: fields have to be extract from event\ndetection:\n    selection:\n        Data|contains: 'ModuleContents=function Get-VMRemoteFXPhysicalVideoAdapter {'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_classic\\posh_pc_powercat.yml","content":"title: Netcat The Powershell Version\nid: c5b20776-639a-49bf-94c7-84f912b91c15\nrelated:\n    - id: bf7286e7-c0be-460b-a7e8-5b2e07ecc2f2\n      type: derived\nstatus: test\ndescription: Adversaries may use a non-application layer protocol for communication between host and C2 server or among infected hosts within a network\nreferences:\n    - https://nmap.org/ncat/\n    - https://github.com/besimorhino/powercat\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1095/T1095.md\nauthor: frack113\ndate: 2021-07-21\nmodified: 2023-10-27\ntags:\n    - attack.command-and-control\n    - attack.t1095\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection:\n        Data|contains:\n            - 'powercat '\n            - 'powercat.ps1'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_classic\\posh_pc_exe_calling_ps.yml","content":"title: PowerShell Called from an Executable Version Mismatch\nid: c70e019b-1479-4b65-b0cc-cd0c6093a599\nstatus: test\ndescription: Detects PowerShell called from an executable by the version mismatch method\nreferences:\n    - https://adsecurity.org/?p=2921\nauthor: Sean Metcalf (source), Florian Roth (Nextron Systems)\ndate: 2017-03-05\nmodified: 2023-10-27\ntags:\n    - attack.defense-evasion\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection_engine:\n        Data|contains:\n            - 'EngineVersion=2.'\n            - 'EngineVersion=4.'\n            - 'EngineVersion=5.'\n    selection_host:\n        Data|contains: 'HostVersion=3.'\n    condition: all of selection_*\nfalsepositives:\n    - Unknown\nlevel: high\n"},{"path":"powershell\\powershell_classic\\posh_pc_downgrade_attack.yml","content":"title: PowerShell Downgrade Attack - PowerShell\nid: 6331d09b-4785-4c13-980f-f96661356249\nstatus: test\ndescription: Detects PowerShell downgrade attack by comparing the host versions with the actually used engine version 2.0\nreferences:\n    - http://www.leeholmes.com/blog/2017/03/17/detecting-and-preventing-powershell-downgrade-attacks/\nauthor: Florian Roth (Nextron Systems), Lee Holmes (idea), Harish Segar (improvements)\ndate: 2017-03-22\nmodified: 2023-10-27\ntags:\n    - attack.defense-evasion\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection:\n        Data|contains: 'EngineVersion=2.'\n    filter_main:\n        Data|contains: 'HostVersion=2.'\n    condition: selection and not filter_main\nfalsepositives:\n    - Unknown\nlevel: medium\n"},{"path":"powershell\\powershell_classic\\posh_pc_delete_volume_shadow_copies.yml","content":"title: Delete Volume Shadow Copies Via WMI With PowerShell\nid: 87df9ee1-5416-453a-8a08-e8d4a51e9ce1\nstatus: stable\ndescription: Shadow Copies deletion using operating systems utilities via PowerShell\nreferences:\n    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1490/T1490.md\n    - https://www.fortinet.com/blog/threat-research/stomping-shadow-copies-a-second-look-into-deletion-methods\nauthor: frack113\ndate: 2021-06-03\nmodified: 2023-10-27\ntags:\n    - attack.impact\n    - attack.t1490\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection:\n        Data|contains|all:\n            - 'Get-WmiObject'\n            - 'Win32_ShadowCopy'\n        Data|contains:\n            - 'Delete()'\n            - 'Remove-WmiObject'\n    condition: selection\nfalsepositives:\n    - Legitimate Administrator deletes Shadow Copies using operating systems utilities for legitimate reason\nlevel: high\n"},{"path":"powershell\\powershell_classic\\posh_pc_abuse_nslookup_with_dns_records.yml","content":"title: Nslookup PowerShell Download Cradle\nid: 999bff6d-dc15-44c9-9f5c-e1051bfc86e1\nrelated:\n    - id: 1b3b01c7-84e9-4072-86e5-fc285a41ff23\n      type: similar\nstatus: test\ndescription: Detects a powershell download cradle using nslookup. This cradle uses nslookup to extract payloads from DNS records.\nreferences:\n    - https://twitter.com/Alh4zr3d/status/1566489367232651264\nauthor: Sai Prashanth Pulisetti @pulisettis, Aishwarya Singam\ndate: 2022-12-10\nmodified: 2025-02-25\ntags:\n    - attack.execution\n    - attack.t1059.001\nlogsource:\n    product: windows\n    category: ps_classic_start\ndetection:\n    selection:\n        Data|contains|all:\n            - 'powershell'\n            - 'nslookup'\n            - '[1]'\n        Data|contains:\n            - '-q=txt http'\n            - '-querytype=txt http'\n            - '-type=txt http'\n    condition: selection\nfalsepositives:\n    - Unknown\nlevel: medium\n"}]